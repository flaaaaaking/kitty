<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>ğŸ€ åƒè¯è®°å½•å™¨</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      :root {
        --pink: #ff69b4;
        --pink2: #ffb6c1;
        --bg: #fff3f8;
        --card: #ffffff;
        --ink: #333;
        --muted: #777;
        --bad: #ff3b6b;
        --ok: #19a974;
        --warn: #ff8a00;
        --line: rgba(255, 105, 180, 0.16);
      }
      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: "PingFang SC", "Microsoft YaHei", system-ui, -apple-system,
          Segoe UI, Arial, sans-serif;
        color: var(--ink);
        display: flex;
        justify-content: center;
        background: radial-gradient(
          1200px 800px at 20% 0%,
          #ffe3f0 0%,
          var(--bg) 45%,
          #ffffff 100%
        );
      }

      /* âœ… é«˜çº§å¯çˆ±è£…é¥°å±‚ï¼šè½¯ç³–äº‘æœµ + æ¨±èŠ± + æ˜Ÿæ˜Ÿç‚¹å…‰ */
      .decor {
        position: fixed;
        inset: 0;
        pointer-events: none;
        z-index: 0;
        overflow: hidden;
      }
      .decor::before {
        content: "";
        position: absolute;
        inset: -40px;
        background: radial-gradient(
            circle at 12% 10%,
            rgba(255, 182, 193, 0.55),
            transparent 28%
          ),
          radial-gradient(
            circle at 88% 14%,
            rgba(255, 105, 180, 0.22),
            transparent 30%
          ),
          radial-gradient(
            circle at 18% 82%,
            rgba(255, 182, 193, 0.32),
            transparent 32%
          ),
          radial-gradient(
            circle at 82% 78%,
            rgba(255, 105, 180, 0.18),
            transparent 34%
          );
        opacity: 0.9;
      }
      .decor .cloud {
        position: absolute;
        width: 240px;
        height: 120px;
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.96),
          rgba(255, 240, 248, 0.96)
        );
        border: 1px solid rgba(255, 105, 180, 0.14);
        border-radius: 999px;
        box-shadow: 0 22px 55px rgba(255, 105, 180, 0.12);
        filter: blur(0.1px);
      }
      .decor .cloud::before,
      .decor .cloud::after {
        content: "";
        position: absolute;
        background: inherit;
        border: inherit;
        border-radius: 999px;
      }
      .decor .cloud::before {
        width: 120px;
        height: 96px;
        left: 22px;
        top: -36px;
      }
      .decor .cloud::after {
        width: 150px;
        height: 120px;
        right: 18px;
        top: -52px;
      }

      .decor .cloud.c1 {
        left: -80px;
        top: 110px;
        transform: rotate(-6deg);
        opacity: 0.72;
      }
      .decor .cloud.c2 {
        right: -100px;
        top: 260px;
        transform: rotate(8deg);
        opacity: 0.68;
      }
      .decor .cloud.c3 {
        left: -110px;
        bottom: 120px;
        transform: rotate(4deg);
        opacity: 0.58;
      }

      .decor .sparkle {
        position: absolute;
        width: 12px;
        height: 12px;
        background: radial-gradient(
          circle,
          rgba(255, 105, 180, 0.6),
          rgba(255, 105, 180, 0)
        );
        border-radius: 999px;
        opacity: 0.75;
      }
      .decor .s1 {
        left: 18%;
        top: 18%;
      }
      .decor .s2 {
        left: 74%;
        top: 22%;
      }
      .decor .s3 {
        left: 84%;
        top: 64%;
      }
      .decor .s4 {
        left: 22%;
        top: 72%;
      }
      .decor .s5 {
        left: 52%;
        top: 10%;
      }
      .decor .s6 {
        left: 58%;
        top: 86%;
      }

      .decor .petal {
        position: absolute;
        width: 18px;
        height: 18px;
        background: radial-gradient(
          circle at 30% 30%,
          rgba(255, 182, 193, 0.85),
          rgba(255, 105, 180, 0.22)
        );
        border-radius: 60% 40% 60% 40%;
        transform: rotate(18deg);
        opacity: 0.65;
        filter: blur(0.15px);
      }
      .decor .p1 {
        left: 10%;
        top: 42%;
      }
      .decor .p2 {
        left: 84%;
        top: 40%;
      }
      .decor .p3 {
        left: 76%;
        top: 84%;
      }
      .decor .p4 {
        left: 18%;
        top: 88%;
      }
      .decor .p5 {
        left: 90%;
        top: 16%;
      }

      .app {
        width: 100%;
        max-width: 520px;
        padding: 18px 14px 52px;
        position: relative;
        z-index: 1;
      }

      .header {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        margin-bottom: 6px;
        padding-top: 6px;
      }
      .logo {
        width: 46px;
        height: 46px;
        border-radius: 16px;
        background: linear-gradient(135deg, var(--pink2), var(--pink));
        display: grid;
        place-items: center;
        font-size: 22px;
        box-shadow: 0 12px 28px rgba(255, 105, 180, 0.26);
        user-select: none;
      }
      h1 {
        font-size: 20px;
        margin: 0;
        letter-spacing: 0.2px;
      }
      .sub {
        margin: 2px 0 0 0;
        text-align: center;
        color: var(--muted);
        font-size: 12px;
      }

      .tabs {
        display: flex;
        gap: 8px;
        margin: 12px 0 6px;
      }
      .tab {
        flex: 1;
        padding: 10px 12px;
        border-radius: 999px;
        border: 1px solid var(--line);
        background: #fff;
        cursor: pointer;
        font-weight: 900;
      }
      .tab.active {
        background: linear-gradient(135deg, var(--pink), #ff4fa6);
        color: #fff;
        border: none;
      }

      .card {
        background: var(--card);
        border-radius: 22px;
        padding: 16px;
        margin: 12px 0;
        box-shadow: 0 16px 34px rgba(17, 17, 17, 0.08);
        border: 1px solid var(--line);
        position: relative;
        overflow: hidden;
      }
      .card::after {
        content: "";
        position: absolute;
        right: -18px;
        top: -18px;
        width: 78px;
        height: 78px;
        background: radial-gradient(
            circle at 30% 30%,
            rgba(255, 105, 180, 0.25),
            transparent 58%
          ),
          radial-gradient(
            circle at 70% 60%,
            rgba(255, 182, 193, 0.35),
            transparent 62%
          );
        transform: rotate(18deg);
        border-radius: 28px;
        pointer-events: none;
      }

      .card h2 {
        margin: 0 0 10px 0;
        font-size: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .card h2::before {
        content: "ğŸŒ¸";
        display: inline-block;
        transform: translateY(-1px);
      }

      .row {
        display: flex;
        gap: 10px;
        align-items: center;
      }
      .grow {
        flex: 1;
      }

      .btn {
        appearance: none;
        border: 0;
        background: linear-gradient(135deg, var(--pink), #ff4fa6);
        color: #fff;
        padding: 12px 14px;
        border-radius: 999px;
        font-weight: 950;
        cursor: pointer;
        box-shadow: 0 10px 18px rgba(255, 105, 180, 0.22);
      }
      .btn:active {
        transform: translateY(1px);
      }
      .btn.secondary {
        background: #fff;
        color: var(--ink);
        border: 1px solid var(--line);
        box-shadow: none;
        font-weight: 850;
      }
      .btn.danger {
        background: linear-gradient(135deg, #ff3b6b, #ff6b9b);
      }

      .hint {
        color: var(--muted);
        font-size: 12px;
        margin-top: 8px;
        line-height: 1.45;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        border: 1px solid var(--line);
        background: #fff7fb;
        padding: 6px 10px;
        border-radius: 999px;
        font-size: 12px;
        color: var(--muted);
      }
      .tag-ok {
        color: var(--ok);
        font-weight: 950;
      }
      .tag-warn {
        color: var(--warn);
        font-weight: 950;
      }
      .tag-bad {
        color: var(--bad);
        font-weight: 950;
      }

      input,
      select,
      textarea {
        width: 100%;
        padding: 10px 12px;
        border-radius: 14px;
        border: 1px solid var(--line);
        background: #fff;
        outline: none;
        font-size: 14px;
      }
      textarea {
        min-height: 70px;
        resize: vertical;
      }
      label {
        font-size: 12px;
        color: var(--muted);
        display: block;
        margin: 10px 0 6px;
      }
      .grid2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }

      .list {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-top: 8px;
      }
      .item {
        border: 1px solid var(--line);
        border-radius: 18px;
        padding: 12px;
        background: #fff;
      }
      .item-title {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
      }
      .name {
        font-weight: 950;
      }
      .meta {
        color: var(--muted);
        font-size: 12px;
        margin-top: 6px;
        line-height: 1.45;
      }
      .divider {
        height: 1px;
        background: var(--line);
        margin: 10px 0;
      }

      .checkline {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        padding: 10px 0;
      }
      .check-left {
        display: flex;
        flex-direction: column;
        gap: 3px;
      }
      .check-title {
        font-weight: 900;
      }
      .check-sub {
        font-size: 12px;
        color: var(--muted);
      }
      .checkbox {
        width: 26px;
        height: 26px;
        border-radius: 10px;
        border: 1px solid var(--line);
        display: grid;
        place-items: center;
        cursor: pointer;
        user-select: none;
        background: #fff;
        box-shadow: 0 10px 16px rgba(255, 105, 180, 0.1);
      }
      .checkbox.on {
        background: #ffe3f0;
        border-color: #ffc0da;
      }
      .checkbox.on::after {
        content: "âœ…";
        font-size: 14px;
      }

      .calendar {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 8px;
        margin-top: 10px;
      }
      .day {
        background: #fff7fb;
        border: 1px solid var(--line);
        border-radius: 14px;
        padding: 10px 6px;
        text-align: center;
        font-size: 13px;
      }
      .day.done {
        background: #ffe3f0;
        font-weight: 950;
      }
      .day.miss {
        background: #fff0f0;
        border-color: rgba(255, 59, 107, 0.25);
        font-weight: 950;
      }

      .footer-actions {
        display: flex;
        gap: 10px;
        margin-top: 10px;
        flex-wrap: wrap;
      }
      .mono {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", monospace;
      }
      .hidden {
        display: none;
      }
    </style>
  </head>

  <body>
    <!-- è£…é¥°å±‚ï¼ˆä¸ä¼šå½±å“ç‚¹å‡»ï¼‰ -->
    <div class="decor" aria-hidden="true">
      <div class="cloud c1"></div>
      <div class="cloud c2"></div>
      <div class="cloud c3"></div>

      <div class="sparkle s1"></div>
      <div class="sparkle s2"></div>
      <div class="sparkle s3"></div>
      <div class="sparkle s4"></div>
      <div class="sparkle s5"></div>
      <div class="sparkle s6"></div>

      <div class="petal p1"></div>
      <div class="petal p2"></div>
      <div class="petal p3"></div>
      <div class="petal p4"></div>
      <div class="petal p5"></div>
    </div>

    <div class="app">
      <div class="header">
        <div class="logo">ğŸ€</div>
        <div>
          <h1>æ²»æ„ˆç³»åƒè¯è®°å½•å™¨</h1>
          <div class="sub">å•æ–‡ä»¶ Â· æœ¬åœ°ä¿å­˜ Â· åŒå‡»å°±èƒ½ç”¨</div>
        </div>
      </div>

      <div class="tabs">
        <button class="tab active" id="tabToday">ä»Šæ—¥æ‰“å¡</button>
        <button class="tab" id="tabMeds">æˆ‘çš„è¯ç®±</button>
        <button class="tab" id="tabStats">æ—¥å†ç»Ÿè®¡</button>
      </div>

      <!-- ä»Šæ—¥ -->
      <section id="viewToday">
        <div class="card">
          <h2>ä»Šå¤©è¦åƒä»€ä¹ˆ</h2>
          <div class="pill">æ—¥æœŸï¼š<span class="mono" id="todayKey"></span></div>
          <div class="list" id="todayList"></div>

          <div class="divider"></div>

          <div class="row">
            <button class="btn grow" id="btnMarkAll">ä¸€é”®å…¨éƒ¨æ ‡è®°å·²æœç”¨</button>
          </div>
          <div class="hint" id="todayHint"></div>
        </div>
      </section>

      <!-- è¯ç®± -->
      <section id="viewMeds" class="hidden">
        <div class="card">
          <h2>æ·»åŠ æ–°è¯</h2>

          <label>è¯ç‰©åç§°</label>
          <input id="fName" placeholder="æ¯”å¦‚ï¼šè‰é…¸è‰¾å¸è¥¿é…æ™®å…°" />

          <div class="grid2">
            <div>
              <label>è§„æ ¼/å‰‚é‡ï¼ˆå±•ç¤ºç”¨ï¼‰</label>
              <input id="fSpec" placeholder="æ¯”å¦‚ï¼š10mg/ç‰‡" />
            </div>
            <div>
              <label>å•æ¬¡ç”¨é‡</label>
              <input id="fDose" placeholder="æ¯”å¦‚ï¼š1ç‰‡ / 1ç²’ / 10ml" />
            </div>
          </div>

          <div class="grid2">
            <div>
              <label>æ¯å¤©æ¬¡æ•°</label>
              <select id="fTimes">
                <option value="1">1 æ¬¡</option>
                <option value="2" selected>2 æ¬¡</option>
                <option value="3">3 æ¬¡</option>
                <option value="4">4 æ¬¡</option>
              </select>
            </div>
            <div>
              <label>æœç”¨æ—¶é—´ï¼ˆé€—å·åˆ†éš”ï¼‰</label>
              <input id="fSchedule" placeholder="08:00,20:00" />
            </div>
          </div>

          <div class="grid2">
            <div>
              <label>æ€»æ•°é‡ï¼ˆåº“å­˜ï¼‰</label>
              <input id="fStock" type="number" min="0" placeholder="æ¯”å¦‚ï¼š30" />
            </div>
            <div>
              <label>ä½åº“å­˜æé†’ï¼ˆâ‰¤ï¼‰</label>
              <input id="fLow" type="number" min="0" placeholder="æ¯”å¦‚ï¼š7" />
            </div>
          </div>

          <label>å¤‡æ³¨</label>
          <textarea
            id="fNote"
            placeholder="æ¯”å¦‚ï¼šé¥­åæœç”¨ / å¯èƒ½å—œç¡ / ä¸èƒ½å–é…’"
          ></textarea>

          <div class="footer-actions">
            <button class="btn grow" id="btnAdd">æ·»åŠ åˆ°è¯ç®±</button>
            <button class="btn secondary" id="btnSeed">å¿«é€Ÿå¡«å……ç¤ºä¾‹</button>
          </div>
          <div class="hint">
            æ—¶é—´ç”¨ 24 å°æ—¶åˆ¶ï¼Œä¾‹å¦‚
            08:00,20:00ï¼›åº“å­˜ä¼šåœ¨ä½ æ¯æ¬¡æ‰“å¡æ—¶è‡ªåŠ¨æ‰£å‡ï¼ˆæ¯å‹¾ä¸€æ¬¡æ‰£ 1ï¼‰ã€‚
          </div>
        </div>

        <div class="card">
          <h2>æˆ‘çš„è¯ç®±</h2>
          <div class="list" id="medList"></div>
        </div>

        <div class="card">
          <h2>å¤‡ä»½ä¸è¿ç§»</h2>
          <div class="row" style="gap: 10px; flex-wrap: wrap">
            <button class="btn secondary" id="btnExport">å¯¼å‡º JSON</button>
            <button class="btn secondary" id="btnImport">å¯¼å…¥ JSON</button>
            <button class="btn danger" id="btnReset">æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
          </div>
          <textarea
            class="mono"
            id="backupBox"
            placeholder="å¯¼å‡ºä¼šå‡ºç°åœ¨è¿™é‡Œï¼›å¯¼å…¥è¯·æŠŠ JSON ç²˜è´´åˆ°è¿™é‡Œ"
          ></textarea>
          <div class="hint">å¯¼å…¥ä¼šè¦†ç›–æœ¬åœ°æ•°æ®ï¼Œå»ºè®®å…ˆå¯¼å‡ºä¸€ä»½ä¿å­˜ã€‚</div>
        </div>
      </section>

      <!-- ç»Ÿè®¡ -->
      <section id="viewStats" class="hidden">
        <div class="card">
          <h2>æœ¬æœˆæ—¥å†</h2>
          <div class="pill">âœ… å…¨éƒ¨å®Œæˆã€€âš ï¸ æœ‰æ¼æœã€€ç©ºç™½ = æ²¡è®°å½•</div>
          <div class="calendar" id="calendar"></div>
          <div class="hint" id="statHint"></div>
        </div>

        <div class="card">
          <h2>æ¦‚è§ˆ</h2>
          <div class="list" id="overview"></div>
        </div>
      </section>
    </div>

    <script>
      const STORE_KEY = "kitty-med-v3";
      const now = new Date();
      const todayKey = new Date(now.getTime() - now.getTimezoneOffset() * 60000)
        .toISOString()
        .slice(0, 10);

      function load() {
        try {
          return JSON.parse(localStorage.getItem(STORE_KEY) || "");
        } catch {
          return null;
        }
      }
      function save() {
        localStorage.setItem(STORE_KEY, JSON.stringify(state));
      }
      function uid() {
        return (
          "m_" + Math.random().toString(16).slice(2) + Date.now().toString(16)
        );
      }
      function hhmm(d) {
        return (
          String(d.getHours()).padStart(2, "0") +
          ":" +
          String(d.getMinutes()).padStart(2, "0")
        );
      }

      const state = load() || { meds: [], records: {} };

      // tabs
      const tabToday = document.getElementById("tabToday");
      const tabMeds = document.getElementById("tabMeds");
      const tabStats = document.getElementById("tabStats");
      const viewToday = document.getElementById("viewToday");
      const viewMeds = document.getElementById("viewMeds");
      const viewStats = document.getElementById("viewStats");

      function setTab(which) {
        tabToday.classList.toggle("active", which === "today");
        tabMeds.classList.toggle("active", which === "meds");
        tabStats.classList.toggle("active", which === "stats");
        viewToday.classList.toggle("hidden", which !== "today");
        viewMeds.classList.toggle("hidden", which !== "meds");
        viewStats.classList.toggle("hidden", which !== "stats");
      }
      tabToday.onclick = () => setTab("today");
      tabMeds.onclick = () => setTab("meds");
      tabStats.onclick = () => setTab("stats");

      // helpers
      function parseSchedule(str, times) {
        const arr = (str || "")
          .split(",")
          .map((s) => s.trim())
          .filter(Boolean);
        if (arr.length >= times) return arr.slice(0, times);
        const defaults = ["08:00", "12:00", "18:00", "22:00"];
        while (arr.length < times) arr.push(defaults[arr.length] || "");
        return arr;
      }
      function getMedById(id) {
        return state.meds.find((m) => m.id === id);
      }
      function hasAnyTaken(entries) {
        return entries.some((e) => e.taken);
      }

      function recomputeSummary(dateKey) {
        const rec = state.records[dateKey];
        if (!rec) return;
        const entries = rec.entries || [];
        const total = entries.length;
        const done = entries.filter((e) => e.taken).length;
        rec.summary = {
          allTaken: total > 0 && done === total,
          miss: total > 0 && done < total && hasAnyTaken(entries),
        };
        save();
      }

      // today
      document.getElementById("todayKey").textContent = todayKey;
      const todayList = document.getElementById("todayList");
      const todayHint = document.getElementById("todayHint");
      const btnMarkAll = document.getElementById("btnMarkAll");

      function buildTodayPlan() {
        if (!state.records[todayKey]) {
          const entries = [];
          for (const med of state.meds) {
            const times = parseInt(med.timesPerDay || 1, 10);
            const schedule = parseSchedule(med.schedule, times);
            for (let i = 0; i < times; i++) {
              entries.push({
                id: uid(),
                medId: med.id,
                name: med.name,
                dose: med.dose || "",
                scheduledTime: schedule[i] || "",
                taken: false,
                takenTime: "",
              });
            }
          }
          state.records[todayKey] = {
            entries,
            summary: { allTaken: false, miss: false },
          };
          save();
        }
      }

      function renderToday() {
        buildTodayPlan();
        const rec = state.records[todayKey];
        const entries = rec.entries || [];

        if (state.meds.length === 0) {
          todayList.innerHTML = `<div class="hint">ä½ è¿˜æ²¡æœ‰æ·»åŠ è¯ç‰©ã€‚å»ã€Œæˆ‘çš„è¯ç®±ã€æ·»åŠ åï¼Œå›åˆ°è¿™é‡Œå°±èƒ½æ‰“å¡ã€‚</div>`;
          todayHint.textContent = "";
          btnMarkAll.disabled = true;
          btnMarkAll.style.opacity = 0.6;
          return;
        }

        btnMarkAll.disabled = entries.length === 0;
        btnMarkAll.style.opacity = entries.length === 0 ? 0.6 : 1;

        todayList.innerHTML = "";
        entries.forEach((e) => {
          const med = getMedById(e.medId);
          const stock = med ? Number(med.stock ?? 0) : 0;
          const low = med ? Number(med.lowStock ?? 0) : 0;
          const warn = med && stock <= low;
          const lowTag = warn ? ` <span class="tag-warn">ä½åº“å­˜</span>` : "";

          const line = document.createElement("div");
          line.className = "item";
          line.innerHTML = `
          <div class="item-title">
            <div class="name">${med ? med.name : e.name}</div>
            <div class="pill">ğŸ•’ ${e.scheduledTime || "æœªè®¾ç½®æ—¶é—´"}</div>
          </div>
          <div class="meta">
            ğŸ’Š ç”¨é‡ï¼š${e.dose || (med ? med.dose : "â€”")}ã€€ğŸ“¦ åº“å­˜ï¼š${
            med ? stock : "â€”"
          }${lowTag}
            <br/>ğŸ“ å¤‡æ³¨ï¼š${med && med.note ? med.note : "â€”"}
          </div>
          <div class="divider"></div>
          <div class="checkline">
            <div class="check-left">
              <div class="check-title">${
                e.taken
                  ? '<span class="tag-ok">å·²æœç”¨</span>'
                  : '<span class="tag-bad">æœªæœç”¨</span>'
              }</div>
              <div class="check-sub">${
                e.taken ? `è®°å½•æ—¶é—´ï¼š${e.takenTime}` : "ç‚¹å‡»å³ä¾§æ‰“å¡"
              }</div>
            </div>
            <div class="checkbox ${e.taken ? "on" : ""}" data-id="${
            e.id
          }"></div>
          </div>
        `;
          todayList.appendChild(line);
        });

        todayList.querySelectorAll(".checkbox").forEach((box) => {
          box.onclick = () => {
            const id = box.getAttribute("data-id");
            const rec = state.records[todayKey];
            const entry = rec.entries.find((x) => x.id === id);
            if (!entry) return;

            entry.taken = !entry.taken;
            entry.takenTime = entry.taken ? hhmm(new Date()) : "";

            const med = getMedById(entry.medId);
            if (med) {
              const stock = Number(med.stock || 0);
              if (entry.taken) med.stock = Math.max(0, stock - 1);
              else med.stock = stock + 1;
            }

            recomputeSummary(todayKey);
            save();
            renderToday();
            renderCalendar();
            renderOverview();
          };
        });

        recomputeSummary(todayKey);
        const total = entries.length;
        const done = entries.filter((e) => e.taken).length;
        const pct = total ? Math.round((done / total) * 100) : 0;
        todayHint.innerHTML = `ä»Šæ—¥è¿›åº¦ï¼š<span class="tag-ok">${done}</span> / ${total}ï¼ˆ${pct}%ï¼‰`;
      }

      btnMarkAll.onclick = () => {
        buildTodayPlan();
        const rec = state.records[todayKey];
        const entries = rec.entries || [];
        const nowStr = hhmm(new Date());

        entries.forEach((e) => {
          if (!e.taken) {
            e.taken = true;
            e.takenTime = nowStr;
            const med = getMedById(e.medId);
            if (med) {
              const stock = Number(med.stock || 0);
              med.stock = Math.max(0, stock - 1);
            }
          }
        });

        recomputeSummary(todayKey);
        save();
        renderToday();
        renderCalendar();
        renderOverview();
      };

      // meds
      const fName = document.getElementById("fName");
      const fSpec = document.getElementById("fSpec");
      const fDose = document.getElementById("fDose");
      const fTimes = document.getElementById("fTimes");
      const fSchedule = document.getElementById("fSchedule");
      const fStock = document.getElementById("fStock");
      const fLow = document.getElementById("fLow");
      const fNote = document.getElementById("fNote");
      const btnAdd = document.getElementById("btnAdd");
      const btnSeed = document.getElementById("btnSeed");
      const medList = document.getElementById("medList");

      function renderMeds() {
        medList.innerHTML = "";
        if (state.meds.length === 0) {
          medList.innerHTML = `<div class="hint">è¯ç®±è¿˜æ˜¯ç©ºçš„ã€‚å…ˆæ·»åŠ ä¸€ä¸ªè¯ç‰©å§ã€‚</div>`;
          return;
        }

        state.meds.forEach((m) => {
          const stock = Number(m.stock || 0);
          const low = Number(m.lowStock || 0);
          const tag =
            stock <= low
              ? `<span class="tag-warn">ä½åº“å­˜</span>`
              : `<span class="tag-ok">æ­£å¸¸</span>`;

          const div = document.createElement("div");
          div.className = "item";
          div.innerHTML = `
          <div class="item-title">
            <div class="name">${m.name}</div>
            <div class="pill">ğŸ“… æ¯æ—¥ ${m.timesPerDay} æ¬¡</div>
          </div>
          <div class="meta">
            ğŸ’  è§„æ ¼ï¼š${m.spec || "â€”"}ã€€ğŸ’Š å•æ¬¡ï¼š${m.dose || "â€”"}
            <br/>ğŸ•’ æ—¶é—´ï¼š${m.schedule || "â€”"}
            <br/>ğŸ“¦ åº“å­˜ï¼š${stock}ï¼ˆé˜ˆå€¼ â‰¤ ${low}ï¼‰ ${tag}
            <br/>ğŸ“ å¤‡æ³¨ï¼š${m.note || "â€”"}
          </div>
          <div class="footer-actions">
            <button class="btn secondary grow" data-act="addstock" data-id="${
              m.id
            }">è¡¥å…… +10</button>
            <button class="btn danger" data-act="del" data-id="${
              m.id
            }">åˆ é™¤</button>
          </div>
        `;
          medList.appendChild(div);
        });

        medList.querySelectorAll("button").forEach((btn) => {
          btn.onclick = () => {
            const id = btn.getAttribute("data-id");
            const act = btn.getAttribute("data-act");
            const med = getMedById(id);
            if (!med) return;

            if (act === "addstock") {
              med.stock = Number(med.stock || 0) + 10;
            }
            if (act === "del") {
              if (
                !confirm(
                  "ç¡®å®šåˆ é™¤è¿™ä¸ªè¯ç‰©å—ï¼Ÿï¼ˆä¸ä¼šåˆ é™¤å†å²è®°å½•ï¼Œä½†ä»Šå¤©è®¡åˆ’ä¼šé‡å»ºï¼‰"
                )
              )
                return;
              state.meds = state.meds.filter((x) => x.id !== id);
              delete state.records[todayKey];
            }
            save();
            renderMeds();
            renderToday();
            renderCalendar();
            renderOverview();
          };
        });
      }

      btnAdd.onclick = () => {
        const name = fName.value.trim();
        if (!name) {
          alert("è¯·å¡«å†™è¯ç‰©åç§°");
          return;
        }

        const med = {
          id: uid(),
          name,
          spec: fSpec.value.trim(),
          dose: fDose.value.trim(),
          timesPerDay: parseInt(fTimes.value, 10),
          schedule: fSchedule.value.trim(),
          stock: Number(fStock.value || 0),
          lowStock: Number(fLow.value || 0),
          note: fNote.value.trim(),
        };

        state.meds.push(med);
        save();
        delete state.records[todayKey];

        [fName, fSpec, fDose, fSchedule, fStock, fLow, fNote].forEach(
          (x) => (x.value = "")
        );
        renderMeds();
        renderToday();
        renderCalendar();
        renderOverview();
        alert("å·²æ·»åŠ åˆ°è¯ç®± âœ…");
      };

      btnSeed.onclick = () => {
        fName.value = "ç»´ç”Ÿç´ C";
        fSpec.value = "100mg/ç‰‡";
        fDose.value = "1ç‰‡";
        fTimes.value = "2";
        fSchedule.value = "08:00,20:00";
        fStock.value = "30";
        fLow.value = "7";
        fNote.value = "é¥­åæœç”¨";
      };

      // backup
      const backupBox = document.getElementById("backupBox");
      document.getElementById("btnExport").onclick = () => {
        backupBox.value = JSON.stringify(state, null, 2);
        backupBox.focus();
        backupBox.select();
      };
      document.getElementById("btnImport").onclick = () => {
        const txt = backupBox.value.trim();
        if (!txt) {
          alert("è¯·å…ˆæŠŠ JSON ç²˜è´´åˆ°æ–‡æœ¬æ¡†é‡Œ");
          return;
        }
        try {
          const obj = JSON.parse(txt);
          if (!obj || typeof obj !== "object" || !obj.meds || !obj.records)
            throw new Error("bad");
          localStorage.setItem(STORE_KEY, JSON.stringify(obj));
          location.reload();
        } catch {
          alert("å¯¼å…¥å¤±è´¥ï¼šJSON ä¸åˆæ³•æˆ–ç»“æ„ä¸å¯¹");
        }
      };
      document.getElementById("btnReset").onclick = () => {
        if (!confirm("ç¡®å®šæ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€")) return;
        localStorage.removeItem(STORE_KEY);
        location.reload();
      };

      // stats
      const calendar = document.getElementById("calendar");
      const statHint = document.getElementById("statHint");
      const overview = document.getElementById("overview");

      function renderCalendar() {
        calendar.innerHTML = "";
        const y = now.getFullYear();
        const m = now.getMonth();
        const days = new Date(y, m + 1, 0).getDate();

        let doneDays = 0,
          missDays = 0,
          recordDays = 0;

        for (let i = 1; i <= days; i++) {
          const d = new Date(y, m, i);
          const k = new Date(d.getTime() - d.getTimezoneOffset() * 60000)
            .toISOString()
            .slice(0, 10);
          const rec = state.records[k];

          const div = document.createElement("div");
          div.className = "day";

          let mark = "";
          if (rec && rec.entries && rec.entries.length > 0) {
            recordDays++;
            recomputeSummary(k);
            if (rec.summary.allTaken) {
              div.classList.add("done");
              mark = "âœ…";
              doneDays++;
            } else if (rec.summary.miss) {
              div.classList.add("miss");
              mark = "âš ï¸";
              missDays++;
            }
          }

          div.textContent = i + (mark ? " " + mark : "");
          calendar.appendChild(div);
        }

        const rate = recordDays ? Math.round((doneDays / recordDays) * 100) : 0;
        statHint.innerHTML = `æœ¬æœˆï¼šè®°å½•å¤©æ•° <span class="tag-ok">${recordDays}</span>ï¼Œå…¨å®Œæˆ <span class="tag-ok">${doneDays}</span>ï¼Œæ¼æœ <span class="tag-bad">${missDays}</span>ï¼ŒæŒ‰æ—¶ç‡ï¼ˆä»…å¯¹å·²è®°å½•æ—¥ï¼‰â‰ˆ <span class="tag-ok">${rate}%</span>`;
      }

      function renderOverview() {
        overview.innerHTML = "";
        let streak = 0;
        for (let offset = 0; offset < 120; offset++) {
          const d = new Date(now);
          d.setDate(now.getDate() - offset);
          const k = new Date(d.getTime() - d.getTimezoneOffset() * 60000)
            .toISOString()
            .slice(0, 10);
          const rec = state.records[k];
          if (rec && rec.entries && rec.entries.length > 0) {
            recomputeSummary(k);
            if (rec.summary.allTaken) streak++;
            else break;
          } else break;
        }

        const lowOnes = state.meds
          .map((m) => {
            const stock = Number(m.stock || 0);
            const low = Number(m.lowStock || 0);
            return { m, stock, low, warn: stock <= low };
          })
          .filter((x) => x.warn);

        const blocks = [];
        blocks.push(
          `<div class="item"><div class="name">è¿ç»­å…¨å®Œæˆå¤©æ•°</div><div class="meta"><span class="tag-ok">${streak}</span> å¤©</div></div>`
        );

        if (lowOnes.length) {
          const lines = lowOnes
            .map((x) => `â€¢ ${x.m.name}ï¼ˆåº“å­˜ ${x.stock} â‰¤ é˜ˆå€¼ ${x.low}ï¼‰`)
            .join("<br/>");
          blocks.push(
            `<div class="item"><div class="name">ä½åº“å­˜æé†’</div><div class="meta">${lines}</div></div>`
          );
        } else {
          blocks.push(
            `<div class="item"><div class="name">ä½åº“å­˜æé†’</div><div class="meta"><span class="tag-ok">æ— </span></div></div>`
          );
        }

        overview.innerHTML = blocks.join("");
      }

      // init
      renderMeds();
      renderToday();
      renderCalendar();
      renderOverview();
    </script>
  </body>
</html>
