<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Hello Kitty ç”¨è¯è®°å½•å™¨</title>
  <style>
    :root{
      --bg:#fff5fb;
      --panel:#ffffff;
      --text:#222;
      --muted:#6b7280;
      --border:rgba(0,0,0,.08);
      --shadow:0 12px 30px rgba(0,0,0,.08);
      --accent:#ff4fa3;
      --accent2:#ff8cc7;
      --good:#16a34a;
      --warn:#f59e0b;
      --bad:#ef4444;
      --radius:18px;
      --font: ui-rounded, "SF Pro Rounded","PingFang SC","Microsoft YaHei","Noto Sans SC",system-ui,-apple-system,Segoe UI,Arial,sans-serif;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
    }

    /* ===== Themes (skin) ===== */
    html[data-theme="kitty"]{
      --bg:#fff5fb; --panel:#ffffff; --text:#231f20; --muted:#6b7280;
      --border:rgba(255,79,163,.18);
      --accent:#ff4fa3; --accent2:#ff8cc7;
      --shadow:0 16px 34px rgba(255,79,163,.12);
    }
    html[data-theme="blue"]{
      --bg:#eff7ff; --panel:#ffffff; --text:#0f172a; --muted:#475569;
      --border:rgba(59,130,246,.18);
      --accent:#3b82f6; --accent2:#93c5fd;
      --shadow:0 18px 38px rgba(59,130,246,.14);
    }
    html[data-theme="mint"]{
      --bg:#eefcf6; --panel:#ffffff; --text:#052e2b; --muted:#155e63;
      --border:rgba(16,185,129,.18);
      --accent:#10b981; --accent2:#86efac;
      --shadow:0 18px 38px rgba(16,185,129,.14);
    }
    html[data-theme="noir"]{
      --bg:#0b1020; --panel:#0f172a; --text:#e5e7eb; --muted:#94a3b8;
      --border:rgba(148,163,184,.18);
      --accent:#a78bfa; --accent2:#60a5fa;
      --shadow:0 18px 44px rgba(0,0,0,.40);
    }
    html[data-theme="minimal"]{
      --bg:#ffffff; --panel:#ffffff; --text:#111827; --muted:#6b7280;
      --border:rgba(17,24,39,.12);
      --accent:#111827; --accent2:#6b7280;
      --shadow:0 10px 26px rgba(0,0,0,.06);
    }

    /* ===== Global ===== */
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--font);
      background:var(--bg);
      color:var(--text);
      min-height:100vh;
    }
    a{color:inherit}
    .wrap{
      max-width:1080px;
      margin:0 auto;
      padding:22px 18px 80px;
    }
    .row{display:flex; gap:14px; flex-wrap:wrap}
    .grid{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }
    .card{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .card-h{
      padding:14px 16px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      border-bottom:1px solid var(--border);
      gap:10px;
    }
    .card-b{padding:14px 16px}
    .title{
      display:flex; align-items:center; gap:10px;
      font-weight:800; letter-spacing:.2px;
    }
    .subtitle{color:var(--muted); font-size:13px}
    .pill{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      color:var(--muted);
      background:rgba(255,255,255,.6);
      display:inline-flex; gap:8px; align-items:center;
    }
    html[data-theme="noir"] .pill{background:rgba(255,255,255,.06)}
    .btn{
      appearance:none;
      border:1px solid var(--border);
      background:rgba(255,255,255,.7);
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:700;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
    }
    html[data-theme="noir"] .btn{background:rgba(255,255,255,.06)}
    .btn.primary{
      background:linear-gradient(135deg,var(--accent),var(--accent2));
      color:#fff;
      border-color:transparent;
    }
    .btn.danger{
      background:rgba(239,68,68,.12);
      border-color:rgba(239,68,68,.28);
      color:var(--bad);
    }
    .btn.ghost{
      background:transparent;
    }
    .btn.small{padding:8px 10px; border-radius:11px; font-size:13px}
    .btn:active{transform:translateY(1px)}
    .controls{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}

    .kv{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      font-size:13px; color:var(--muted);
    }

    .select, .input{
      border:1px solid var(--border);
      background:rgba(255,255,255,.65);
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      font-family:var(--font);
      outline:none;
    }
    html[data-theme="noir"] .select, html[data-theme="noir"] .input{background:rgba(255,255,255,.06)}
    .input{width:100%}
    .label{font-size:12px; color:var(--muted); margin:8px 0 6px}
    .hr{height:1px; background:var(--border); margin:12px 0}

    /* ===== Decor & Motion toggles ===== */
    .decor{
      position:absolute; inset:0;
      pointer-events:none;
      opacity:.95;
    }
    .bg-pattern{
      position:absolute; inset:0;
      background:
        radial-gradient(circle at 18px 18px, rgba(255,255,255,.7) 0 3px, transparent 4px) 0 0/34px 34px,
        radial-gradient(circle at 18px 18px, rgba(0,0,0,.03) 0 3px, transparent 4px) 17px 17px/34px 34px;
      mix-blend-mode:soft-light;
      opacity:.6;
    }
    html[data-theme="noir"] .bg-pattern{opacity:.22; mix-blend-mode:screen}
    html[data-theme="minimal"] .bg-pattern{opacity:.25}
    .corner-bow{
      position:absolute;
      width:86px; height:86px;
      right:-10px; top:-10px;
      opacity:.25;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.10));
    }
    html[data-theme="noir"] .corner-bow{opacity:.18}
    .corner-bow svg{width:100%; height:100%}

    html.decor-off .decor,
    html.decor-off .bg-pattern,
    html.decor-off .corner-bow{display:none!important}

    html.motion-off *{
      animation:none!important;
      transition:none!important;
      scroll-behavior:auto!important;
    }

    .floaty{
      animation: floaty 3.2s ease-in-out infinite;
    }
    @keyframes floaty{
      0%,100%{transform:translateY(0)}
      50%{transform:translateY(-4px)}
    }

    /* ===== Header ===== */
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      margin-bottom:14px;
      gap:10px;
      flex-wrap:wrap;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.6);
    }
    html[data-theme="noir"] .brand{background:rgba(255,255,255,.06)}
    .logo{
      width:40px; height:40px; border-radius:14px;
      background:linear-gradient(135deg,var(--accent),var(--accent2));
      display:grid; place-items:center;
      color:#fff; font-weight:900;
      box-shadow:0 14px 26px rgba(0,0,0,.10);
    }
    .brand strong{font-size:14px}
    .brand small{display:block; color:var(--muted); margin-top:2px}

    /* ===== Calendar ===== */
    .cal{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:8px;
    }
    .cal-head{
      font-size:12px; color:var(--muted);
      text-align:center;
      padding:6px 0;
    }
    .day{
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px;
      min-height:74px;
      background:rgba(255,255,255,.55);
      position:relative;
      cursor:pointer;
    }
    html[data-theme="noir"] .day{background:rgba(255,255,255,.05)}
    .day:hover{outline:2px solid rgba(0,0,0,.03)}
    html[data-theme="noir"] .day:hover{outline:2px solid rgba(255,255,255,.08)}
    .day .n{font-weight:900; font-size:13px}
    .day .m{position:absolute; right:10px; top:10px; font-size:13px; opacity:.95}
    .day .mini{
      position:absolute; left:10px; bottom:10px;
      font-size:11px; color:var(--muted);
    }
    .day.today{
      border-color:rgba(0,0,0,.18);
      outline:2px solid rgba(0,0,0,.04);
    }
    html[data-theme="noir"] .day.today{
      border-color:rgba(255,255,255,.22);
      outline:2px solid rgba(255,255,255,.10);
    }
    .status-ok{color:var(--good)}
    .status-warn{color:var(--warn)}
    .status-bad{color:var(--bad)}
    .status-part{color:var(--accent)}

    /* ===== Today list ===== */
    .dose{
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      background:rgba(255,255,255,.55);
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
    }
    html[data-theme="noir"] .dose{background:rgba(255,255,255,.05)}
    .dose strong{display:block; font-size:14px}
    .dose small{color:var(--muted)}
    .tag{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      font-size:12px;
      color:var(--muted);
    }
    .ok{background:rgba(22,163,74,.10); border-color:rgba(22,163,74,.25); color:var(--good)}
    .miss{background:rgba(245,158,11,.10); border-color:rgba(245,158,11,.25); color:var(--warn)}
    .late{background:rgba(239,68,68,.10); border-color:rgba(239,68,68,.25); color:var(--bad)}
    .part{background:rgba(255,79,163,.10); border-color:rgba(255,79,163,.25); color:var(--accent)}

    /* ===== Med list ===== */
    .med{
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      background:rgba(255,255,255,.55);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    html[data-theme="noir"] .med{background:rgba(255,255,255,.05)}
    .med .left{display:flex; gap:10px; align-items:center}
    .med .ico{
      width:40px; height:40px; border-radius:14px;
      background:linear-gradient(135deg,var(--accent),var(--accent2));
      display:grid; place-items:center;
      color:#fff; font-weight:900;
      flex:0 0 auto;
      box-shadow:0 14px 26px rgba(0,0,0,.10);
    }
    .med .meta strong{display:block}
    .med .meta small{color:var(--muted)}

    /* ===== Modal ===== */
    .mask{
      position:fixed; inset:0;
      background:rgba(0,0,0,.48);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:50;
    }
    .mask.show{display:flex}
    .modal{
      width:min(620px, 100%);
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow:0 26px 70px rgba(0,0,0,.22);
      overflow:hidden;
      position:relative;
    }
    .modal .mh{padding:14px 16px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; gap:10px}
    .modal .mb{padding:14px 16px}
    .modal .mf{padding:14px 16px; border-top:1px solid var(--border); display:flex; justify-content:flex-end; gap:10px; flex-wrap:wrap}

    /* ===== Footer ===== */
    .author{
      position:fixed;
      right:14px; bottom:12px;
      font-family:var(--mono);
      font-size:12px;
      opacity:.55;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.55);
      backdrop-filter: blur(10px);
      z-index:10;
    }
    html[data-theme="noir"] .author{background:rgba(255,255,255,.06); opacity:.62}
  </style>
</head>

<body>
  <div class="wrap" id="app">
    <div class="topbar">
      <div class="brand">
        <div class="logo floaty" id="logoText">ğŸ€</div>
        <div>
          <strong id="appName">Hello Kitty ç”¨è¯è®°å½•å™¨</strong>
          <small id="modeLine">æ¨¡å¼ï¼šâ€”</small>
        </div>
      </div>

      <div class="controls">
        <select class="select" id="themeSel" title="çš®è‚¤">
          <option value="kitty">ğŸ€ Kitty ç²‰</option>
          <option value="blue">ğŸ’  Blue è“</option>
          <option value="mint">ğŸƒ Mint è–„è·</option>
          <option value="noir">ğŸŒ™ å¤œçŒ«</option>
          <option value="minimal">â€¢ æç®€</option>
        </select>

        <button class="btn small" id="toggleDecor">è£…é¥°ï¼šå¼€</button>
        <button class="btn small" id="toggleMotion">åŠ¨æ•ˆï¼šå¼€</button>

        <button class="btn small" id="copyShare">å¤åˆ¶åˆ†äº«é“¾æ¥</button>
        <button class="btn small" id="copyPrivate">å¤åˆ¶æˆ‘çš„ç§å¯†é“¾æ¥</button>
      </div>
    </div>

    <div class="grid">
      <!-- Left: Calendar -->
      <div class="card" id="calCard">
        <div class="decor">
          <div class="bg-pattern"></div>
          <div class="corner-bow" aria-hidden="true">
            <svg viewBox="0 0 120 120" fill="none">
              <path d="M30 50c-10-10-22-12-28-2s2 26 22 28c18 2 22-14 24-22 2-10-6-4-18-4z" fill="currentColor" opacity=".85"/>
              <path d="M90 50c10-10 22-12 28-2s-2 26-22 28c-18 2-22-14-24-22-2-10 6-4 18-4z" fill="currentColor" opacity=".85"/>
              <circle cx="60" cy="58" r="12" fill="currentColor" opacity=".95"/>
              <path d="M52 58c-10-8-14-18-8-24s16 0 22 10c4 6-4 14-14 14z" fill="currentColor" opacity=".75"/>
              <path d="M68 58c10-8 14-18 8-24s-16 0-22 10c-4 6 4 14 14 14z" fill="currentColor" opacity=".75"/>
            </svg>
          </div>
        </div>

        <div class="card-h">
          <div>
            <div class="title"><span id="calEmoji">ğŸ“…</span><span id="calTitle">â€”</span></div>
            <div class="subtitle" id="hintBar">â€”</div>
          </div>
          <div class="controls">
            <button class="btn small" id="prevM">â† ä¸Šæœˆ</button>
            <button class="btn small" id="toToday">ä»Šå¤©</button>
            <button class="btn small" id="nextM">ä¸‹æœˆ â†’</button>
          </div>
        </div>

        <div class="card-b">
          <div class="cal" id="calGrid"></div>
        </div>
      </div>

      <!-- Right: Today + Meds -->
      <div class="row" style="flex-direction:column">
        <div class="card" id="todayCard">
          <div class="decor">
            <div class="bg-pattern"></div>
          </div>
          <div class="card-h">
            <div>
              <div class="title"><span id="todayEmoji">ğŸ’Š</span><span>ä»Šæ—¥ç”¨è¯</span></div>
              <div class="subtitle" id="todaySub">â€”</div>
            </div>
            <div class="controls">
              <button class="btn small primary" id="quickMark">ä¸€é”®æŒ‰è®¡åˆ’æ‰“å¡</button>
              <button class="btn small" id="openBackfill">è¡¥å½•/æ”¹è®°å½•</button>
            </div>
          </div>
          <div class="card-b" id="todayList"></div>
        </div>

        <div class="card" id="medCard">
          <div class="decor">
            <div class="bg-pattern"></div>
          </div>
          <div class="card-h">
            <div>
              <div class="title"><span id="medEmoji">ğŸ§°</span><span>æˆ‘çš„è¯ç®±</span></div>
              <div class="subtitle">è¯åã€å‰‚é‡ã€æœç”¨æ—¶é—´ï¼ˆçº¯å‰ç«¯ï¼‰</div>
            </div>
            <div class="controls">
              <button class="btn small primary" id="openMedEditor">æ·»åŠ è¯ç‰©</button>
              <button class="btn small danger" id="resetGuest" title="æ¸…ç©ºå½“å‰è®¾å¤‡è®¿å®¢æ•°æ®ï¼ˆä¸å½±å“ç§å¯†æ•°æ®ï¼‰">æ¸…ç©ºè®¿å®¢</button>
            </div>
          </div>
          <div class="card-b" id="medList"></div>
        </div>

        <div class="card">
          <div class="card-h">
            <div>
              <div class="title"><span id="statEmoji">ğŸ“ˆ</span><span>æœ¬æœˆç»Ÿè®¡</span></div>
              <div class="subtitle">æŒ‰è®¡åˆ’å®Œæˆç‡ã€è¿ç»­å¤©æ•°</div>
            </div>
          </div>
          <div class="card-b" id="stats"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="author">FLAAAAKING</div>

  <!-- Modal: Med Editor -->
  <div class="mask" id="maskMed">
    <div class="modal">
      <div class="mh">
        <div class="title"><span id="medModalEmoji">â•</span><span id="medModalTitle">æ·»åŠ /ç¼–è¾‘è¯ç‰©</span></div>
        <button class="btn small" id="closeMed">å…³é—­</button>
      </div>
      <div class="mb">
        <div class="label">è¯ç‰©åç§°</div>
        <input class="input" id="mName" placeholder="ä¾‹å¦‚ï¼šç¢³é…¸é”‚ç¼“é‡Šç‰‡" />

        <div class="row">
          <div style="flex:1">
            <div class="label">å•æ¬¡å‰‚é‡ï¼ˆæ•°å­—ï¼‰</div>
            <input class="input" id="mDose" placeholder="ä¾‹å¦‚ï¼š1" />
          </div>
          <div style="flex:1">
            <div class="label">å•ä½</div>
            <input class="input" id="mUnit" placeholder="ä¾‹å¦‚ï¼šç‰‡ / ç²’ / mg" />
          </div>
        </div>

        <div class="row">
          <div style="flex:1">
            <div class="label">æ¯æ—¥æ¬¡æ•°</div>
            <select class="select" id="mTimes">
              <option value="1">1 æ¬¡</option>
              <option value="2" selected>2 æ¬¡</option>
              <option value="3">3 æ¬¡</option>
              <option value="4">4 æ¬¡</option>
            </select>
          </div>
          <div style="flex:1">
            <div class="label">æ—¶é—´ç‚¹ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰</div>
            <input class="input" id="mSchedule" placeholder="08:00,20:00" />
          </div>
        </div>

        <div class="label">å›¾æ ‡ï¼ˆå¯å¡« emojiï¼‰</div>
        <input class="input" id="mIcon" placeholder="ä¾‹å¦‚ï¼šğŸ’Š / ğŸƒ / ğŸŒ™" />

        <div class="hr"></div>
        <div class="pill" id="medModalHint">æç¤ºï¼šæ¯æ—¥æ¬¡æ•°ä¸æ—¶é—´ç‚¹å»ºè®®ä¸€è‡´ï¼ˆä¾‹å¦‚ 2 æ¬¡â†’ä¸¤ä¸ªæ—¶é—´ï¼‰</div>
      </div>
      <div class="mf">
        <button class="btn danger" id="delMed" style="display:none">åˆ é™¤</button>
        <button class="btn" id="cancelMed">å–æ¶ˆ</button>
        <button class="btn primary" id="saveMed">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <!-- Modal: Backfill -->
  <div class="mask" id="maskBack">
    <div class="modal">
      <div class="mh">
        <div class="title"><span>ğŸ§·</span><span>è¡¥å½• / ä¿®æ”¹è®°å½•ï¼ˆæ›´â€œç¡®è®¤æ„Ÿâ€ï¼‰</span></div>
        <button class="btn small" id="closeBack">å…³é—­</button>
      </div>
      <div class="mb">
        <div class="row">
          <div style="flex:1">
            <div class="label">æ—¥æœŸ</div>
            <input class="input" id="bfDate" type="date" />
          </div>
          <div style="flex:1">
            <div class="label">è¯ç‰©</div>
            <select class="select" id="bfMed"></select>
          </div>
        </div>

        <div class="row">
          <div style="flex:1">
            <div class="label">è®¡åˆ’æ—¶é—´ç‚¹</div>
            <select class="select" id="bfSlot"></select>
          </div>
          <div style="flex:1">
            <div class="label">å®é™…æœç”¨æ—¶é—´ï¼ˆå¯ç•™ç©º=æŒ‰è®¡åˆ’æ—¶é—´ï¼‰</div>
            <input class="input" id="bfTakenAt" type="time" />
          </div>
        </div>

        <div class="row">
          <div style="flex:1">
            <div class="label">çŠ¶æ€</div>
            <select class="select" id="bfStatus">
              <option value="taken">å·²æœç”¨ âœ…</option>
              <option value="missed">æ¼æœ âš ï¸</option>
              <option value="clear">æ¸…é™¤æ­¤æ¡è®°å½• ğŸ§½</option>
            </select>
          </div>
          <div style="flex:1">
            <div class="label">å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</div>
            <input class="input" id="bfNote" placeholder="ä¾‹å¦‚ï¼šé¥­åè¡¥æœ / å¤´æ™•æ‰€ä»¥å»¶å" />
          </div>
        </div>

        <div class="hr"></div>
        <div class="pill" id="bfPreview">å°†è¦æ‰§è¡Œï¼šâ€”</div>
      </div>
      <div class="mf">
        <button class="btn" id="bfCancel">å–æ¶ˆ</button>
        <button class="btn primary" id="bfConfirm">æˆ‘ç¡®è®¤æ‰§è¡Œ</button>
      </div>
    </div>
  </div>

<script>
(function(){
  /* =========================
     Workspace / Privacy
     - widï¼šURL ?wid=xxx ï¼ˆå·¥ä½œåŒºï¼‰
     - kï¼šURL hash #k=xxx ï¼ˆç§å¯†é’¥åŒ™ï¼Œä»…ä½ è®¾å¤‡ä½¿ç”¨ï¼‰
     è§„åˆ™ï¼š
       1) å¸¦ #k ä¸”åŒ¹é…æœ¬è®¾å¤‡ä¿å­˜çš„ ownerKey => ç§å¯†æ¨¡å¼ï¼šè¯»å†™ç§å¯†æ•°æ®
       2) å…¶ä»–æƒ…å†µ => è®¿å®¢æ¨¡å¼ï¼šæ°¸è¿œä»ç©ºæ¨¡æ¿å¼€å§‹ï¼ˆå¯åœ¨æœ¬è®¾å¤‡è‡ªå·±å¡«ï¼Œä¸å½±å“ç§å¯†ï¼‰
     ========================= */

  function makeId(len=12){
    const chars = "ABCDEFGHJKMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz23456789";
    let s=""; for(let i=0;i<len;i++) s += chars[Math.floor(Math.random()*chars.length)];
    return s;
  }
  function getWid(){
    const u = new URL(location.href);
    return u.searchParams.get("wid");
  }
  function setWid(wid){
    const u = new URL(location.href);
    u.searchParams.set("wid", wid);
    history.replaceState(null,"",u.toString());
  }
  function getHashKey(){
    const h = (location.hash || "").replace(/^#/,"");
    const sp = new URLSearchParams(h);
    return sp.get("k");
  }
  function setHashKey(k){
    const sp = new URLSearchParams((location.hash||"").replace(/^#/,""));
    sp.set("k", k);
    location.hash = sp.toString();
  }

  let WID = getWid();
  if(!WID){
    WID = makeId(12);
    setWid(WID);
  }

  const OWNER_KEY_STORAGE = `kitty_owner_key__${WID}`;
  let ownerKey = localStorage.getItem(OWNER_KEY_STORAGE);
  if(!ownerKey){
    ownerKey = makeId(18);
    localStorage.setItem(OWNER_KEY_STORAGE, ownerKey);
  }

  // è‡ªåŠ¨æŠŠâ€œç§å¯†é’¥åŒ™â€å†™è¿›å½“å‰è®¾å¤‡çš„URLï¼ˆä½ è‡ªå·±ç”¨æ›´çœå¿ƒï¼‰
  // åˆ†äº«æ—¶ç”¨â€œå¤åˆ¶åˆ†äº«é“¾æ¥â€æŒ‰é’®ï¼ˆä¸ä¼šå¸¦ #kï¼‰
  if(!getHashKey()){
    setHashKey(ownerKey);
  }

  const hashKey = getHashKey();
  const isPrivate = (hashKey && hashKey === ownerKey);

  const STORE_PRIVATE = `kitty_private__${WID}`;          // ä½ çš„çœŸå®æ•°æ®
  const STORE_GUEST   = `kitty_guest__${WID}__${makeId(6)}`; // è®¿å®¢ï¼šæ¯è®¾å¤‡æ¯æ¬¡éš”ç¦»ï¼ˆä¸ç¢°ç§å¯†ï¼‰

  const STORAGE_PRIVATE = localStorage;
  const STORAGE_GUEST = localStorage; // è®¿å®¢ä¹Ÿå¯æœ¬æœºä¿å­˜ï¼Œä½†æ°¸è¿œä¸ç§å¯†éš”ç¦»

  const THEME_EMOJI = {
    kitty:   { logo:"ğŸ€", cal:"ğŸ“…", pill:"ğŸ’Š", med:"ğŸ§°", stat:"ğŸ“ˆ", tag:"ğŸ€", ok:"âœ…", warn:"âš ï¸", edit:"âœï¸", add:"â•" },
    blue:    { logo:"ğŸ’ ", cal:"ğŸ—“ï¸", pill:"ğŸ’Š", med:"ğŸ§°", stat:"ğŸ“Š", tag:"ğŸ’ ", ok:"âœ…", warn:"âš ï¸", edit:"ğŸ› ï¸", add:"â•" },
    mint:    { logo:"ğŸƒ", cal:"ğŸ“†", pill:"ğŸ«§", med:"ğŸ§°", stat:"ğŸ“ˆ", tag:"ğŸƒ", ok:"âœ…", warn:"âš ï¸", edit:"âœï¸", add:"â•" },
    noir:    { logo:"ğŸŒ™", cal:"ğŸ—“ï¸", pill:"ğŸ’Š", med:"ğŸ§°", stat:"ğŸ“‰", tag:"ğŸŒ™", ok:"âœ…", warn:"âš ï¸", edit:"âœï¸", add:"â•" },
    minimal: { logo:"â€¢",  cal:"",   pill:"",   med:"",   stat:"",   tag:"â€¢",  ok:"âœ“",  warn:"!",  edit:"e",  add:"+"  }
  };

  function E(key){
    const t = state.ui.theme || "kitty";
    const p = THEME_EMOJI[t] || THEME_EMOJI.kitty;
    return (p[key] ?? "");
  }

  // Default empty template (è®¿å®¢ä¸é¦–æ¬¡éƒ½ä»ç©ºå¼€å§‹)
  function defaultState(){
    return {
      v: 3,
      ui: { theme: "kitty", decor: true, motion: true },
      meds: [], // {id,name,dose,unit,icon,times, schedule[]}
      records: {} // date -> { medId -> { slotTime -> {status,takenAt,note} } }
    };
  }

  function loadState(){
    try{
      if(isPrivate){
        const raw = STORAGE_PRIVATE.getItem(STORE_PRIVATE);
        return raw ? JSON.parse(raw) : null;
      }else{
        // è®¿å®¢æ°¸è¿œä»ç©ºæ¨¡æ¿å¼€å§‹ï¼ˆä½ çš„è¦æ±‚ï¼šå…¶ä»–è®¾å¤‡ç‚¹è¿›å»éƒ½æ˜¯æœªå¡«çŠ¶æ€ï¼‰
        // å¦‚æœä½ å¸Œæœ›è®¿å®¢ä¹Ÿèƒ½â€œä¸‹æ¬¡è¿˜èƒ½çœ‹åˆ°è‡ªå·±å¡«çš„â€ï¼ŒæŠŠä¸‹é¢ return null æ”¹æˆè¯»å– STORAGE_GUEST.getItem(STORE_GUEST)
        return null;
      }
    }catch(e){
      return null;
    }
  }

  function saveState(){
    try{
      if(isPrivate){
        STORAGE_PRIVATE.setItem(STORE_PRIVATE, JSON.stringify(state));
      }else{
        // è®¿å®¢é»˜è®¤ä¸ä¿å­˜ï¼šä¿è¯â€œå›åˆ°æœªå¡«çŠ¶æ€â€
        // å¦‚è¦ä¿å­˜è®¿å®¢è‡ªå·±æ•°æ®ï¼šSTORAGE_GUEST.setItem(STORE_GUEST, JSON.stringify(state))
      }
    }catch(e){}
  }

  function ymd(d){
    const yyyy=d.getFullYear();
    const mm=String(d.getMonth()+1).padStart(2,"0");
    const dd=String(d.getDate()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}`;
  }
  function parseHM(s){
    const [h,m]=String(s||"00:00").split(":").map(x=>parseInt(x,10));
    return (isFinite(h)?h:0)*60 + (isFinite(m)?m:0);
  }
  function fmtDateCN(d){
    return `${d.getFullYear()}å¹´${d.getMonth()+1}æœˆ${d.getDate()}æ—¥`;
  }
  function sameDay(a,b){
    return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();
  }

  let state = loadState() || defaultState();
  let view = new Date();
  view.setDate(1);

  /* ===== DOM ===== */
  const $ = (id)=>document.getElementById(id);

  const themeSel = $("themeSel");
  const toggleDecor = $("toggleDecor");
  const toggleMotion = $("toggleMotion");
  const copyShare = $("copyShare");
  const copyPrivate = $("copyPrivate");

  const calTitle = $("calTitle");
  const calGrid = $("calGrid");
  const calEmoji = $("calEmoji");
  const hintBar = $("hintBar");

  const prevM = $("prevM");
  const nextM = $("nextM");
  const toToday = $("toToday");

  const todaySub = $("todaySub");
  const todayList = $("todayList");
  const quickMark = $("quickMark");
  const openBackfill = $("openBackfill");

  const medList = $("medList");
  const openMedEditor = $("openMedEditor");
  const resetGuest = $("resetGuest");

  const stats = $("stats");

  const modeLine = $("modeLine");
  const logoText = $("logoText");
  const todayEmoji = $("todayEmoji");
  const medEmoji = $("medEmoji");
  const statEmoji = $("statEmoji");

  // Med modal
  const maskMed = $("maskMed");
  const closeMed = $("closeMed");
  const cancelMed = $("cancelMed");
  const saveMedBtn = $("saveMed");
  const delMedBtn = $("delMed");

  const mName = $("mName");
  const mDose = $("mDose");
  const mUnit = $("mUnit");
  const mTimes = $("mTimes");
  const mSchedule = $("mSchedule");
  const mIcon = $("mIcon");
  const medModalTitle = $("medModalTitle");
  const medModalEmoji = $("medModalEmoji");

  // Backfill modal
  const maskBack = $("maskBack");
  const closeBack = $("closeBack");
  const bfDate = $("bfDate");
  const bfMed = $("bfMed");
  const bfSlot = $("bfSlot");
  const bfTakenAt = $("bfTakenAt");
  const bfStatus = $("bfStatus");
  const bfNote = $("bfNote");
  const bfPreview = $("bfPreview");
  const bfCancel = $("bfCancel");
  const bfConfirm = $("bfConfirm");

  let editingMedId = null;

  function applyUi(){
    document.documentElement.dataset.theme = state.ui.theme || "kitty";

    document.documentElement.classList.toggle("decor-off", !state.ui.decor);
    document.documentElement.classList.toggle("motion-off", !state.ui.motion);

    themeSel.value = state.ui.theme;

    toggleDecor.textContent = `è£…é¥°ï¼š${state.ui.decor ? "å¼€" : "å…³"}`;
    toggleMotion.textContent = `åŠ¨æ•ˆï¼š${state.ui.motion ? "å¼€" : "å…³"}`;

    logoText.textContent = E("logo") || "ğŸ€";
    calEmoji.textContent = E("cal") || "ğŸ“…";
    todayEmoji.textContent = E("pill") || "ğŸ’Š";
    medEmoji.textContent = E("med") || "ğŸ§°";
    statEmoji.textContent = E("stat") || "ğŸ“ˆ";

    modeLine.textContent = isPrivate
      ? `æ¨¡å¼ï¼šç§å¯†ï¼ˆä»…æ­¤è®¾å¤‡å¯è§ï¼‰${E("ok")}`
      : `æ¨¡å¼ï¼šè®¿å®¢ï¼ˆé»˜è®¤ç©ºç™½ï¼‰${E("warn")}`;

    hintBar.textContent = isPrivate
      ? `æç¤ºï¼šåˆ†äº«ç»™åˆ«äººè¯·ç”¨â€œå¤åˆ¶åˆ†äº«é“¾æ¥â€ï¼ˆä¸ä¼šå¸¦ç§å¯†é’¥åŒ™ï¼‰`
      : `æç¤ºï¼šè¿™æ˜¯è®¿å®¢æ¨¡å¼ï¼šè¯ç®±ä¸æ‰“å¡é»˜è®¤ç©ºç™½ï¼Œéœ€è¦ä½ æ‰‹åŠ¨å¡«å†™`;

    $("appName").textContent = "Hello Kitty ç”¨è¯è®°å½•å™¨";
  }

  function ensureDateRecord(dateStr){
    if(!state.records[dateStr]) state.records[dateStr] = {};
    return state.records[dateStr];
  }

  function getDosePlanForDate(dateStr){
    // è¿”å› [{med, slotTime}]
    const out = [];
    for(const med of state.meds){
      const sch = Array.isArray(med.schedule) ? med.schedule : [];
      for(const t of sch){
        out.push({ med, slotTime: t });
      }
    }
    out.sort((a,b)=>parseHM(a.slotTime)-parseHM(b.slotTime));
    return out;
  }

  function getDoseStatus(dateStr, medId, slotTime){
    const day = state.records[dateStr];
    if(!day) return null;
    const m = day[medId];
    if(!m) return null;
    return m[slotTime] || null;
  }

  function setDoseStatus(dateStr, medId, slotTime, payload){
    const day = ensureDateRecord(dateStr);
    if(!day[medId]) day[medId] = {};
    if(payload === null){
      if(day[medId] && day[medId][slotTime]) delete day[medId][slotTime];
      if(day[medId] && Object.keys(day[medId]).length===0) delete day[medId];
    }else{
      day[medId][slotTime] = payload;
    }
    if(Object.keys(day).length===0) delete state.records[dateStr];
    saveState();
  }

  function calcDaySummary(dateStr){
    const plan = getDosePlanForDate(dateStr);
    if(plan.length===0) return { total:0, taken:0, missed:0, none:true };
    let taken=0, missed=0;
    for(const p of plan){
      const s = getDoseStatus(dateStr, p.med.id, p.slotTime);
      if(!s) continue;
      if(s.status==="taken") taken++;
      if(s.status==="missed") missed++;
    }
    return { total:plan.length, taken, missed, none:false };
  }

  function renderCalendar(){
    const y = view.getFullYear();
    const m = view.getMonth();
    calTitle.textContent = `${y}å¹´${m+1}æœˆ`;

    calGrid.innerHTML = "";
    const heads = ["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"];
    for(const h of heads){
      const el = document.createElement("div");
      el.className = "cal-head";
      el.textContent = h;
      calGrid.appendChild(el);
    }

    const first = new Date(y,m,1);
    const startDow = first.getDay();
    const daysInMonth = new Date(y,m+1,0).getDate();

    // 6å‘¨å¸ƒå±€ï¼š42æ ¼
    const cells = 42;
    const today = new Date();

    for(let i=0;i<cells;i++){
      const dayNum = i - startDow + 1;
      const cell = document.createElement("div");
      cell.className = "day";

      if(dayNum < 1 || dayNum > daysInMonth){
        cell.style.opacity = ".35";
        cell.style.cursor = "default";
        cell.innerHTML = `<div class="n"> </div>`;
        calGrid.appendChild(cell);
        continue;
      }

      const d = new Date(y,m,dayNum);
      if(sameDay(d, today)) cell.classList.add("today");

      const dateStr = ymd(d);
      const sum = calcDaySummary(dateStr);

      // status emoji
      let mark = "";
      let mini = "";
      if(sum.total===0){
        mark = "";
        mini = "æ— è®¡åˆ’";
      }else{
        const done = sum.taken;
        const miss = sum.missed;
        const filled = done + miss;
        if(filled===0){
          mark = "";
          mini = `${sum.total}é¡¹æœªå¡«`;
        }else if(done===sum.total && miss===0){
          mark = `<span class="status-ok">${E("ok")||"âœ…"}</span>`;
          mini = `å…¨å®Œæˆ ${done}/${sum.total}`;
        }else if(miss>0 && done===0){
          mark = `<span class="status-bad">${E("warn")||"âš ï¸"}</span>`;
          mini = `æ¼æœ ${miss}/${sum.total}`;
        }else{
          mark = `<span class="status-part">${E("tag")||"ğŸ€"}</span>`;
          mini = `å·²å¡« ${filled}/${sum.total}`;
        }
      }

      cell.innerHTML = `
        <div class="n">${dayNum}</div>
        <div class="m">${mark}</div>
        <div class="mini">${mini}</div>
      `;

      cell.addEventListener("click", ()=>{
        // ç‚¹å‡»æ—¥æœŸï¼šæ‰“å¼€è¡¥å½•å¹¶é»˜è®¤é€‰ä¸­è¯¥æ—¥
        openBackfillModal(dateStr);
      });

      calGrid.appendChild(cell);
    }
  }

  function renderToday(){
    const now = new Date();
    const dateStr = ymd(now);
    todaySub.textContent = `${fmtDateCN(now)} Â· ${isPrivate ? "ç§å¯†æ¨¡å¼" : "è®¿å®¢æ¨¡å¼"}`;

    const plan = getDosePlanForDate(dateStr);
    if(plan.length===0){
      todayList.innerHTML = `<div class="pill">${E("warn")||"âš ï¸"} ä½ çš„è¯ç®±è¿˜æ²¡æœ‰è¯ç‰©ã€‚å…ˆå»â€œæˆ‘çš„è¯ç®±â€æ·»åŠ ã€‚</div>`;
      return;
    }

    let html = `<div class="row" style="flex-direction:column">`;
    for(const p of plan){
      const s = getDoseStatus(dateStr, p.med.id, p.slotTime);
      const doseText = `${p.med.dose || ""}${p.med.unit || ""}`.trim();
      const icon = (p.med.icon || E("pill") || "ğŸ’Š");
      let tagClass = "tag";
      let tagText = `æœªå¡«`;
      if(s){
        if(s.status==="taken"){ tagClass = "tag ok"; tagText = `å·²æœç”¨ ${E("ok")||"âœ…"} ${s.takenAt || p.slotTime}`; }
        if(s.status==="missed"){ tagClass = "tag miss"; tagText = `æ¼æœ ${E("warn")||"âš ï¸"}`; }
      }
      html += `
        <div class="dose">
          <div>
            <strong>${icon} ${p.med.name}</strong>
            <small>è®¡åˆ’ï¼š${p.slotTime} Â· å•æ¬¡ï¼š${doseText || "-"}</small>
          </div>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end">
            <span class="${tagClass}">${tagText}</span>
            <button class="btn small primary" data-act="take" data-med="${p.med.id}" data-slot="${p.slotTime}">${E("ok")||"âœ…"} æ ‡è®°å·²æœ</button>
            <button class="btn small" data-act="miss" data-med="${p.med.id}" data-slot="${p.slotTime}">${E("warn")||"âš ï¸"} æ ‡è®°æ¼æœ</button>
          </div>
        </div>
      `;
    }
    html += `</div>`;
    todayList.innerHTML = html;

    todayList.querySelectorAll("button[data-act]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const act = btn.getAttribute("data-act");
        const medId = btn.getAttribute("data-med");
        const slot = btn.getAttribute("data-slot");
        if(act==="take"){
          setDoseStatus(dateStr, medId, slot, { status:"taken", takenAt: now.toTimeString().slice(0,5), note:"" });
        }else{
          setDoseStatus(dateStr, medId, slot, { status:"missed", takenAt:"", note:"" });
        }
        renderAll();
      });
    });
  }

  function renderMeds(){
    if(state.meds.length===0){
      medList.innerHTML = `<div class="pill">${E("warn")||"âš ï¸"} è¯ç®±ä¸ºç©ºã€‚ç‚¹å‡»å³ä¸Šè§’â€œæ·»åŠ è¯ç‰©â€ã€‚</div>`;
      return;
    }
    let html = `<div class="row" style="flex-direction:column">`;
    for(const med of state.meds){
      const icon = med.icon || E("pill") || "ğŸ’Š";
      const doseText = `${med.dose || ""}${med.unit || ""}`.trim();
      const sch = (med.schedule || []).join(", ");
      html += `
        <div class="med">
          <div class="left">
            <div class="ico">${icon}</div>
            <div class="meta">
              <strong>${med.name}</strong>
              <small>å•æ¬¡ï¼š${doseText || "-"} Â· è®¡åˆ’ï¼š${sch || "-"}</small>
            </div>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
            <button class="btn small" data-edit="${med.id}">${E("edit")||"âœï¸"} ç¼–è¾‘</button>
          </div>
        </div>
      `;
    }
    html += `</div>`;
    medList.innerHTML = html;

    medList.querySelectorAll("button[data-edit]").forEach(b=>{
      b.addEventListener("click", ()=>{
        const id = b.getAttribute("data-edit");
        openMedModal(id);
      });
    });
  }

  function renderStats(){
    const y = view.getFullYear();
    const m = view.getMonth();
    const start = new Date(y,m,1);
    const end = new Date(y,m+1,0);
    let totalPlan=0, totalTaken=0, totalMiss=0;

    let streak=0;
    // è¿ç»­å¤©æ•°ï¼šä»ä»Šå¤©å¾€å›ï¼Œå…¨éƒ¨è®¡åˆ’é¡¹éƒ½â€œå·²æœç”¨â€æ‰ç®—
    const today = new Date();
    for(let i=0;i<60;i++){
      const d = new Date(today);
      d.setDate(today.getDate()-i);
      const ds = ymd(d);
      const plan = getDosePlanForDate(ds);
      if(plan.length===0) break;
      let ok = true;
      for(const p of plan){
        const s = getDoseStatus(ds, p.med.id, p.slotTime);
        if(!s || s.status!=="taken"){ ok=false; break; }
      }
      if(ok) streak++;
      else break;
    }

    for(let d=new Date(start); d<=end; d.setDate(d.getDate()+1)){
      const ds = ymd(d);
      const sum = calcDaySummary(ds);
      totalPlan += sum.total;
      totalTaken += sum.taken;
      totalMiss += sum.missed;
    }

    let rate = totalPlan===0 ? 0 : Math.round((totalTaken/totalPlan)*100);
    stats.innerHTML = `
      <div class="row">
        <div class="pill">${E("ok")||"âœ…"} æŒ‰è®¡åˆ’å®Œæˆç‡ï¼š<b style="color:var(--text)">${rate}%</b></div>
        <div class="pill">ğŸ“Œ å·²æœç”¨ï¼š<b style="color:var(--text)">${totalTaken}</b> / ${totalPlan}</div>
        <div class="pill">${E("warn")||"âš ï¸"} æ ‡è®°æ¼æœï¼š<b style="color:var(--text)">${totalMiss}</b></div>
        <div class="pill">ğŸ”¥ è¿ç»­å…¨å®Œæˆï¼š<b style="color:var(--text)">${streak}</b> å¤©</div>
      </div>
    `;
  }

  function renderAll(){
    applyUi();
    renderCalendar();
    renderToday();
    renderMeds();
    renderStats();
  }

  /* ===== Med modal logic ===== */
  function openMedModal(id){
    editingMedId = id || null;

    if(editingMedId){
      const med = state.meds.find(x=>x.id===editingMedId);
      if(!med) return;
      medModalTitle.textContent = "ç¼–è¾‘è¯ç‰©";
      medModalEmoji.textContent = E("edit") || "âœï¸";
      delMedBtn.style.display = "";
      mName.value = med.name || "";
      mDose.value = med.dose || "";
      mUnit.value = med.unit || "";
      mTimes.value = String(med.times || (med.schedule||[]).length || 2);
      mSchedule.value = (med.schedule || []).join(",");
      mIcon.value = med.icon || "";
    }else{
      medModalTitle.textContent = "æ·»åŠ è¯ç‰©";
      medModalEmoji.textContent = E("add") || "â•";
      delMedBtn.style.display = "none";
      mName.value = "";
      mDose.value = "";
      mUnit.value = "";
      mTimes.value = "2";
      mSchedule.value = "08:00,20:00";
      mIcon.value = "";
    }

    maskMed.classList.add("show");
  }
  function closeMedModal(){
    maskMed.classList.remove("show");
  }
  function normalizeSchedule(str){
    const parts = String(str||"").split(",").map(s=>s.trim()).filter(Boolean);
    // ç®€å•å»é‡å¹¶æ’åº
    const uniq = Array.from(new Set(parts));
    uniq.sort((a,b)=>parseHM(a)-parseHM(b));
    return uniq;
  }

  saveMedBtn.addEventListener("click", ()=>{
    const name = mName.value.trim();
    if(!name){ alert("è¯ç‰©åç§°ä¸èƒ½ä¸ºç©º"); return; }

    const dose = mDose.value.trim();
    const unit = mUnit.value.trim();
    const icon = mIcon.value.trim();
    const sch = normalizeSchedule(mSchedule.value);

    const times = parseInt(mTimes.value,10) || sch.length || 1;
    // è‹¥æ—¶é—´ç‚¹ä¸ºç©ºï¼ŒæŒ‰æ¬¡æ•°ç»™é»˜è®¤
    const defaults = ["08:00","13:00","18:00","22:00"];
    const schedule = sch.length ? sch.slice(0, times) : defaults.slice(0, times);

    if(editingMedId){
      const idx = state.meds.findIndex(x=>x.id===editingMedId);
      if(idx<0) return;
      state.meds[idx] = {
        ...state.meds[idx],
        name, dose, unit, icon,
        times,
        schedule
      };
    }else{
      state.meds.push({
        id: "m_" + makeId(10),
        name, dose, unit, icon,
        times,
        schedule
      });
    }

    saveState();
    closeMedModal();
    renderAll();
  });

  delMedBtn.addEventListener("click", ()=>{
    if(!editingMedId) return;
    if(!confirm("ç¡®è®¤åˆ é™¤è¯¥è¯ç‰©ï¼Ÿï¼ˆä¸ä¼šè‡ªåŠ¨åˆ é™¤å†å²è®°å½•ï¼‰")) return;
    state.meds = state.meds.filter(x=>x.id!==editingMedId);
    saveState();
    closeMedModal();
    renderAll();
  });

  closeMed.addEventListener("click", closeMedModal);
  cancelMed.addEventListener("click", closeMedModal);
  maskMed.addEventListener("click", (e)=>{ if(e.target===maskMed) closeMedModal(); });

  openMedEditor.addEventListener("click", ()=>openMedModal(null));

  /* ===== Backfill modal logic (smarter confirmation) ===== */
  function openBackfillModal(dateStr){
    if(state.meds.length===0){
      alert("è¯ç®±ä¸ºç©ºï¼Œå…ˆæ·»åŠ è¯ç‰©ã€‚");
      return;
    }
    maskBack.classList.add("show");

    // date
    const d = dateStr ? new Date(dateStr) : new Date();
    bfDate.value = ymd(d);

    // meds
    bfMed.innerHTML = state.meds.map(m=>`<option value="${m.id}">${(m.icon||"ğŸ’Š")} ${m.name}</option>`).join("");
    bfMed.value = state.meds[0].id;

    refreshSlots();
    bfTakenAt.value = "";
    bfStatus.value = "taken";
    bfNote.value = "";
    refreshPreview();
  }
  function closeBackfillModal(){
    maskBack.classList.remove("show");
  }

  function refreshSlots(){
    const med = state.meds.find(x=>x.id===bfMed.value);
    const sch = (med && med.schedule) ? med.schedule : [];
    bfSlot.innerHTML = sch.map(t=>`<option value="${t}">${t}</option>`).join("");
    if(sch.length===0){
      bfSlot.innerHTML = `<option value="08:00">08:00</option>`;
    }
    bfSlot.value = bfSlot.options[0].value;
  }

  function refreshPreview(){
    const dateStr = bfDate.value;
    const med = state.meds.find(x=>x.id===bfMed.value);
    const slot = bfSlot.value;
    const status = bfStatus.value;
    const takenAt = (bfTakenAt.value || slot);
    const note = bfNote.value.trim();

    let line = `æ—¥æœŸ ${dateStr} Â· ${(med?.icon||"ğŸ’Š")} ${med?.name||"-"} Â· æ§½ä½ ${slot} Â· `;
    if(status==="taken"){
      line += `æ ‡è®°ä¸º å·²æœç”¨ âœ…ï¼ˆæ—¶é—´ï¼š${takenAt}ï¼‰`;
    }else if(status==="missed"){
      line += `æ ‡è®°ä¸º æ¼æœ âš ï¸`;
    }else{
      line += `æ¸…é™¤æ­¤æ¡è®°å½• ğŸ§½`;
    }
    if(note) line += ` Â· å¤‡æ³¨ï¼šâ€œ${note}â€`;
    bfPreview.textContent = "å°†è¦æ‰§è¡Œï¼š" + line;
  }

  bfMed.addEventListener("change", ()=>{ refreshSlots(); refreshPreview(); });
  bfDate.addEventListener("change", refreshPreview);
  bfSlot.addEventListener("change", refreshPreview);
  bfTakenAt.addEventListener("input", refreshPreview);
  bfStatus.addEventListener("change", refreshPreview);
  bfNote.addEventListener("input", refreshPreview);

  bfConfirm.addEventListener("click", ()=>{
    const dateStr = bfDate.value;
    const medId = bfMed.value;
    const slot = bfSlot.value;
    const status = bfStatus.value;
    const note = bfNote.value.trim();

    // äºŒæ¬¡ç¡®è®¤æ„Ÿï¼šç”¨ confirm å†åŠ ä¸€é“é—¸
    if(!confirm(bfPreview.textContent.replace("å°†è¦æ‰§è¡Œï¼š","ç¡®è®¤æ‰§è¡Œï¼š\n"))){
      return;
    }

    if(status==="clear"){
      setDoseStatus(dateStr, medId, slot, null);
    }else if(status==="taken"){
      setDoseStatus(dateStr, medId, slot, { status:"taken", takenAt:(bfTakenAt.value || slot), note });
    }else{
      setDoseStatus(dateStr, medId, slot, { status:"missed", takenAt:"", note });
    }

    closeBackfillModal();
    renderAll();
  });

  bfCancel.addEventListener("click", closeBackfillModal);
  closeBack.addEventListener("click", closeBackfillModal);
  maskBack.addEventListener("click", (e)=>{ if(e.target===maskBack) closeBackfillModal(); });

  openBackfill.addEventListener("click", ()=>openBackfillModal(null));

  /* ===== Quick Mark (today) ===== */
  quickMark.addEventListener("click", ()=>{
    const dateStr = ymd(new Date());
    const plan = getDosePlanForDate(dateStr);
    if(plan.length===0){ alert("ä»Šå¤©æ²¡æœ‰è®¡åˆ’é¡¹ã€‚"); return; }
    if(!confirm(`ç¡®è®¤ï¼šå°†ä»Šå¤©æ‰€æœ‰è®¡åˆ’é¡¹ç»Ÿä¸€æ ‡è®°ä¸ºâ€œå·²æœç”¨â€å—ï¼Ÿ`)) return;
    for(const p of plan){
      setDoseStatus(dateStr, p.med.id, p.slotTime, { status:"taken", takenAt:p.slotTime, note:"" });
    }
    renderAll();
  });

  /* ===== Month nav ===== */
  prevM.addEventListener("click", ()=>{
    view.setMonth(view.getMonth()-1);
    renderAll();
  });
  nextM.addEventListener("click", ()=>{
    view.setMonth(view.getMonth()+1);
    renderAll();
  });
  toToday.addEventListener("click", ()=>{
    view = new Date();
    view.setDate(1);
    renderAll();
  });

  /* ===== UI toggles ===== */
  themeSel.addEventListener("change", ()=>{
    state.ui.theme = themeSel.value;
    saveState();
    renderAll();
  });

  toggleDecor.addEventListener("click", ()=>{
    state.ui.decor = !state.ui.decor;
    saveState();
    renderAll();
  });
  toggleMotion.addEventListener("click", ()=>{
    state.ui.motion = !state.ui.motion;
    saveState();
    renderAll();
  });

  /* ===== Copy links ===== */
  function cleanUrl(withWid){
    const u = new URL(location.href);
    // åˆ é™¤ç§å¯† hash
    u.hash = "";
    if(!withWid) u.searchParams.delete("wid");
    return u.toString();
  }
  function privateUrl(){
    // å¸¦ wid + å¸¦ #kï¼ˆç§å¯†é’¥åŒ™ï¼‰
    const u = new URL(location.href);
    if(!u.searchParams.get("wid")) u.searchParams.set("wid", WID);
    const sp = new URLSearchParams((u.hash||"").replace(/^#/,""));
    sp.set("k", ownerKey);
    u.hash = sp.toString();
    return u.toString();
  }

  async function copyText(t){
    try{
      await navigator.clipboard.writeText(t);
      alert("å·²å¤åˆ¶");
    }catch(e){
      prompt("å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ï¼š", t);
    }
  }

  copyShare.addEventListener("click", ()=>{
    // åˆ†äº«é“¾æ¥ï¼šä¸å¸¦ #kï¼Œé»˜è®¤è®¿å®¢ç©ºç™½ï¼›æ˜¯å¦ä¿ç•™ wid æ— æ‰€è°“ï¼Œè¿™é‡Œç»™â€œå¹²å‡€å…¥å£â€ï¼ˆä¸å¸¦ widï¼‰
    copyText(cleanUrl(false));
  });
  copyPrivate.addEventListener("click", ()=>{
    // ç§å¯†é“¾æ¥ï¼šä½ è‡ªå·±å¤šè®¾å¤‡ä½¿ç”¨ï¼ˆè°æ‹¿åˆ°å°±èƒ½çœ‹ï¼Œåˆ«å¤–å‘ï¼‰
    copyText(privateUrl());
  });

  /* ===== Reset guest (current device) ===== */
  resetGuest.addEventListener("click", ()=>{
    if(!confirm("ç¡®è®¤ï¼šæ¸…ç©ºè®¿å®¢æ¨¡å¼ä¸‹çš„å¡«å†™ï¼Ÿï¼ˆç§å¯†æ•°æ®ä¸å—å½±å“ï¼‰")) return;
    state = defaultState();
    // è®¿å®¢é»˜è®¤ä¸ä¿å­˜ï¼Œæœ¬æŒ‰é’®åªæ˜¯æŠŠå½“å‰é¡µé¢å˜å›ç©º
    renderAll();
  });

  /* ===== Safety: night theme text contrast already handled by theme vars ===== */

  /* ===== boot ===== */
  applyUi();
  renderAll();

})();
</script>
</body>
</html>
