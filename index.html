<!DOCTYPE html>
<html lang="zh-CN" data-theme="kitty">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ç”¨è¯è®°å½•å™¨</title>
    <meta
      name="description"
      content="Katyç”¨è¯è®°å½•å™¨ï¼šæœ¬åœ°ä¿å­˜ã€å¯è¡¥å½•ã€å¯ç¼–è¾‘ã€12æ¬¾çš®è‚¤ã€‚ä½œè€…ï¼šFLAAAAKING"
    />
    <style>
      /* =========================
        ç”¨è¯è®°å½•å™¨ (Single HTML)
       Author: FLAAAAKING
       ========================= */

      :root {
        --bg: #fff5fb;
        --panel: #ffffff;
        --text: #231f20;
        --muted: #6b7280;
        --border: rgba(255, 79, 163, 0.18);
        --accent: #ff4fa3;
        --accent2: #ff8cc7;
        --shadow: 0 16px 34px rgba(255, 79, 163, 0.12);
        --radius: 22px;
        --radius-sm: 16px;
        --gap: 14px;
        --ring: 0 0 0 4px rgba(255, 79, 163, 0.12);

        --font: ui-rounded, "SF Pro Rounded", "PingFang SC", "Microsoft YaHei",
          "Noto Sans SC", system-ui, -apple-system, Segoe UI, Arial, sans-serif;
        --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;

        --emoji-ok: "âœ…";
        --emoji-warn: "âš ï¸";
        --emoji-pill: "ğŸ’Š";
        --emoji-plus: "â•";
        --emoji-edit: "âœï¸";
        --emoji-trash: "ğŸ—‘ï¸";
        --emoji-save: "ğŸ’¾";
        --emoji-copy: "ğŸ”—";
        --emoji-cal: "ğŸ—“ï¸";
        --emoji-theme: "ğŸ€";
        --emoji-lock: "ğŸ”’";
        --emoji-user: "ğŸ‘¤";
        --emoji-stats: "ğŸ“ˆ";
      }

      /* ===== Themes (12 skins) ===== */
      html[data-theme="kitty"] {
        --bg: #fff5fb;
        --panel: #ffffff;
        --text: #231f20;
        --muted: #6b7280;
        --border: rgba(255, 79, 163, 0.18);
        --accent: #ff4fa3;
        --accent2: #ff8cc7;
        --shadow: 0 16px 34px rgba(255, 79, 163, 0.12);
      }
      html[data-theme="milktea"] {
        --bg: #fbf4ec;
        --panel: #ffffff;
        --text: #2b2520;
        --muted: #6b5b4b;
        --border: rgba(176, 120, 72, 0.18);
        --accent: #b07848;
        --accent2: #e7c9a6;
        --shadow: 0 16px 34px rgba(176, 120, 72, 0.12);
        --emoji-theme: "ğŸ§‹";
      }
      html[data-theme="peach"] {
        --bg: #fff2ee;
        --panel: #ffffff;
        --text: #2a1f1e;
        --muted: #7a5a55;
        --border: rgba(255, 122, 104, 0.18);
        --accent: #ff7a68;
        --accent2: #ffd1c8;
        --shadow: 0 16px 34px rgba(255, 122, 104, 0.12);
        --emoji-theme: "ğŸ‘";
      }
      html[data-theme="mint"] {
        --bg: #eefcf6;
        --panel: #ffffff;
        --text: #052e2b;
        --muted: #155e63;
        --border: rgba(16, 185, 129, 0.18);
        --accent: #10b981;
        --accent2: #86efac;
        --shadow: 0 18px 38px rgba(16, 185, 129, 0.14);
        --emoji-theme: "ğŸƒ";
      }
      html[data-theme="blue"] {
        --bg: #eff7ff;
        --panel: #ffffff;
        --text: #0f172a;
        --muted: #475569;
        --border: rgba(59, 130, 246, 0.18);
        --accent: #3b82f6;
        --accent2: #93c5fd;
        --shadow: 0 18px 38px rgba(59, 130, 246, 0.14);
        --emoji-theme: "ğŸ’ ";
      }
      html[data-theme="skyglass"] {
        --bg: #eef6ff;
        --panel: rgba(255, 255, 255, 0.72);
        --text: #0b1220;
        --muted: #3b556f;
        --border: rgba(255, 255, 255, 0.4);
        --accent: #38bdf8;
        --accent2: #a5f3fc;
        --shadow: 0 22px 46px rgba(56, 189, 248, 0.16);
        --emoji-theme: "ğŸ«§";
      }
      html[data-theme="night"] {
        --bg: #0b1020;
        --panel: #0f172a;
        --text: #e5e7eb;
        --muted: #94a3b8;
        --border: rgba(148, 163, 184, 0.18);
        --accent: #a78bfa;
        --accent2: #60a5fa;
        --shadow: 0 18px 44px rgba(0, 0, 0, 0.4);
        --emoji-theme: "ğŸŒ™";
        --ring: 0 0 0 4px rgba(167, 139, 250, 0.18);
      }
      html[data-theme="moonlight"] {
        --bg: #0f172a;
        --panel: #111c33;
        --text: #eaf0ff;
        --muted: #a9b4d6;
        --border: rgba(167, 139, 250, 0.18);
        --accent: #c4b5fd;
        --accent2: #93c5fd;
        --shadow: 0 18px 44px rgba(0, 0, 0, 0.36);
        --emoji-theme: "ğŸŒ•";
        --ring: 0 0 0 4px rgba(196, 181, 253, 0.18);
      }
      html[data-theme="ink"] {
        --bg: #07080c;
        --panel: #0b0d14;
        --text: #f3f4f6;
        --muted: #9ca3af;
        --border: rgba(243, 244, 246, 0.14);
        --accent: #ffffff;
        --accent2: #9ca3af;
        --shadow: 0 18px 46px rgba(0, 0, 0, 0.55);
        --emoji-theme: "ğŸ–¤";
        --ring: 0 0 0 4px rgba(255, 255, 255, 0.1);
        --emoji-ok: "âœ“";
        --emoji-warn: "!";
      }
      html[data-theme="minimal"] {
        --bg: #ffffff;
        --panel: #ffffff;
        --text: #111827;
        --muted: #6b7280;
        --border: rgba(17, 24, 39, 0.12);
        --accent: #111827;
        --accent2: #6b7280;
        --shadow: 0 10px 26px rgba(0, 0, 0, 0.06);
        --emoji-theme: "â€¢";
        --emoji-ok: "âœ“";
        --emoji-warn: "!";
      }
      html[data-theme="monogrey"] {
        --bg: #f3f4f6;
        --panel: #ffffff;
        --text: #111827;
        --muted: #6b7280;
        --border: rgba(17, 24, 39, 0.12);
        --accent: #374151;
        --accent2: #9ca3af;
        --shadow: 0 12px 28px rgba(0, 0, 0, 0.08);
        --emoji-theme: "â¬›";
        --emoji-ok: "âœ“";
        --emoji-warn: "!";
      }
      html[data-theme="clinic"] {
        --bg: #f7fbff;
        --panel: #ffffff;
        --text: #0f172a;
        --muted: #475569;
        --border: rgba(2, 132, 199, 0.16);
        --accent: #0284c7;
        --accent2: #7dd3fc;
        --shadow: 0 16px 34px rgba(2, 132, 199, 0.1);
        --emoji-theme: "ğŸ©º";
      }

      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family: var(--font);
        background: var(--bg);
        color: var(--text);
        line-height: 1.35;
        overflow-x: hidden;
      }

      .wrap {
        min-height: 100%;
        padding: 26px 16px 56px;
        display: flex;
        justify-content: center;
      }

      .shell {
        width: min(1080px, 100%);
        display: grid;
        grid-template-columns: 360px 1fr;
        gap: 18px;
        align-items: start;
      }

      @media (max-width: 980px) {
        .shell {
          grid-template-columns: 1fr;
        }
      }

      .bg-layer {
        position: fixed;
        inset: 0;
        pointer-events: none;
        z-index: -1;
      }

      .bg-pattern {
        position: absolute;
        inset: 0;
        background: radial-gradient(
              circle at 16px 16px,
              rgba(255, 255, 255, 0.78) 0 3px,
              transparent 4px
            )
            0 0/34px 34px,
          radial-gradient(
              circle at 16px 16px,
              rgba(0, 0, 0, 0.035) 0 3px,
              transparent 4px
            )
            17px 17px/34px 34px,
          radial-gradient(
            closest-side at 20% 30%,
            rgba(255, 79, 163, 0.1),
            transparent 60%
          ),
          radial-gradient(
            closest-side at 80% 20%,
            rgba(255, 140, 199, 0.1),
            transparent 60%
          ),
          radial-gradient(
            closest-side at 75% 85%,
            rgba(255, 79, 163, 0.08),
            transparent 55%
          ),
          radial-gradient(
            closest-side at 25% 85%,
            rgba(255, 140, 199, 0.08),
            transparent 55%
          );
        mix-blend-mode: soft-light;
        opacity: 0.55;
      }
      html[data-theme="milktea"] .bg-pattern {
        background: radial-gradient(
              circle at 16px 16px,
              rgba(255, 255, 255, 0.74) 0 3px,
              transparent 4px
            )
            0 0/34px 34px,
          radial-gradient(
              circle at 16px 16px,
              rgba(0, 0, 0, 0.03) 0 3px,
              transparent 4px
            )
            17px 17px/34px 34px,
          radial-gradient(
            closest-side at 22% 28%,
            rgba(176, 120, 72, 0.1),
            transparent 60%
          ),
          radial-gradient(
            closest-side at 82% 22%,
            rgba(231, 201, 166, 0.14),
            transparent 60%
          ),
          radial-gradient(
            closest-side at 78% 85%,
            rgba(176, 120, 72, 0.08),
            transparent 55%
          ),
          radial-gradient(
            closest-side at 24% 86%,
            rgba(231, 201, 166, 0.1),
            transparent 55%
          );
        opacity: 0.5;
      }
      html[data-theme="peach"] .bg-pattern {
        background: radial-gradient(
              circle at 16px 16px,
              rgba(255, 255, 255, 0.74) 0 3px,
              transparent 4px
            )
            0 0/34px 34px,
          radial-gradient(
              circle at 16px 16px,
              rgba(0, 0, 0, 0.03) 0 3px,
              transparent 4px
            )
            17px 17px/34px 34px,
          radial-gradient(
            closest-side at 22% 28%,
            rgba(255, 122, 104, 0.1),
            transparent 60%
          ),
          radial-gradient(
            closest-side at 82% 22%,
            rgba(255, 209, 200, 0.14),
            transparent 60%
          ),
          radial-gradient(
            closest-side at 78% 85%,
            rgba(255, 122, 104, 0.08),
            transparent 55%
          ),
          radial-gradient(
            closest-side at 24% 86%,
            rgba(255, 209, 200, 0.1),
            transparent 55%
          );
        opacity: 0.5;
      }
      html[data-theme="mint"] .bg-pattern {
        background: radial-gradient(
              circle at 16px 16px,
              rgba(255, 255, 255, 0.74) 0 3px,
              transparent 4px
            )
            0 0/34px 34px,
          radial-gradient(
              circle at 16px 16px,
              rgba(0, 0, 0, 0.03) 0 3px,
              transparent 4px
            )
            17px 17px/34px 34px,
          radial-gradient(
            closest-side at 22% 28%,
            rgba(16, 185, 129, 0.1),
            transparent 60%
          ),
          radial-gradient(
            closest-side at 82% 22%,
            rgba(134, 239, 172, 0.14),
            transparent 60%
          ),
          radial-gradient(
            closest-side at 78% 85%,
            rgba(16, 185, 129, 0.08),
            transparent 55%
          ),
          radial-gradient(
            closest-side at 24% 86%,
            rgba(134, 239, 172, 0.1),
            transparent 55%
          );
        opacity: 0.5;
      }
      html[data-theme="blue"] .bg-pattern {
        background: radial-gradient(
              circle at 16px 16px,
              rgba(255, 255, 255, 0.74) 0 3px,
              transparent 4px
            )
            0 0/34px 34px,
          radial-gradient(
              circle at 16px 16px,
              rgba(0, 0, 0, 0.03) 0 3px,
              transparent 4px
            )
            17px 17px/34px 34px,
          radial-gradient(
            closest-side at 22% 28%,
            rgba(59, 130, 246, 0.1),
            transparent 60%
          ),
          radial-gradient(
            closest-side at 82% 22%,
            rgba(147, 197, 253, 0.14),
            transparent 60%
          ),
          radial-gradient(
            closest-side at 78% 85%,
            rgba(59, 130, 246, 0.08),
            transparent 55%
          ),
          radial-gradient(
            closest-side at 24% 86%,
            rgba(147, 197, 253, 0.1),
            transparent 55%
          );
        opacity: 0.48;
      }
      html[data-theme="skyglass"] .bg-pattern {
        background: radial-gradient(
              circle at 16px 16px,
              rgba(255, 255, 255, 0.7) 0 3px,
              transparent 4px
            )
            0 0/34px 34px,
          radial-gradient(
              circle at 16px 16px,
              rgba(0, 0, 0, 0.02) 0 3px,
              transparent 4px
            )
            17px 17px/34px 34px,
          radial-gradient(
            closest-side at 20% 30%,
            rgba(56, 189, 248, 0.12),
            transparent 60%
          ),
          radial-gradient(
            closest-side at 80% 20%,
            rgba(165, 243, 252, 0.14),
            transparent 60%
          ),
          radial-gradient(
            closest-side at 75% 85%,
            rgba(56, 189, 248, 0.08),
            transparent 55%
          ),
          radial-gradient(
            closest-side at 25% 85%,
            rgba(165, 243, 252, 0.1),
            transparent 55%
          );
        opacity: 0.42;
      }
      html[data-theme="night"] .bg-pattern,
      html[data-theme="moonlight"] .bg-pattern {
        background: radial-gradient(
              circle at 14px 14px,
              rgba(255, 255, 255, 0.16) 0 2px,
              transparent 3px
            )
            0 0/34px 34px,
          radial-gradient(
              circle at 14px 14px,
              rgba(96, 165, 250, 0.1) 0 2px,
              transparent 3px
            )
            17px 17px/34px 34px,
          radial-gradient(
            closest-side at 22% 28%,
            rgba(167, 139, 250, 0.18),
            transparent 58%
          ),
          radial-gradient(
            closest-side at 82% 22%,
            rgba(96, 165, 250, 0.16),
            transparent 58%
          ),
          radial-gradient(
            closest-side at 78% 85%,
            rgba(167, 139, 250, 0.12),
            transparent 55%
          ),
          radial-gradient(
            closest-side at 24% 86%,
            rgba(96, 165, 250, 0.1),
            transparent 55%
          );
        opacity: 0.26;
        mix-blend-mode: screen;
      }
      html[data-theme="ink"] .bg-pattern {
        background: radial-gradient(
              circle at 14px 14px,
              rgba(255, 255, 255, 0.1) 0 2px,
              transparent 3px
            )
            0 0/34px 34px,
          radial-gradient(
              circle at 14px 14px,
              rgba(255, 255, 255, 0.06) 0 2px,
              transparent 3px
            )
            17px 17px/34px 34px;
        opacity: 0.18;
        mix-blend-mode: screen;
      }
      html[data-theme="minimal"] .bg-pattern,
      html[data-theme="monogrey"] .bg-pattern,
      html[data-theme="clinic"] .bg-pattern {
        opacity: 0.18;
        mix-blend-mode: normal;
      }

      .corner-bow {
        position: absolute;
        width: 92px;
        height: 92px;
        right: -12px;
        top: -12px;
        opacity: 0.24;
        filter: drop-shadow(0 12px 22px rgba(0, 0, 0, 0.12));
        transform: rotate(8deg);
        color: var(--accent);
      }
      html[data-theme="night"] .corner-bow,
      html[data-theme="moonlight"] .corner-bow {
        opacity: 0.16;
      }
      html[data-theme="ink"] .corner-bow {
        opacity: 0.12;
      }
      html[data-theme="minimal"] .corner-bow,
      html[data-theme="monogrey"] .corner-bow,
      html[data-theme="clinic"] .corner-bow {
        opacity: 0.14;
      }

      .corner-bow svg {
        width: 100%;
        height: 100%;
      }
      .corner-bow svg .bow-fill {
        fill: currentColor;
      }

      .brand {
        position: relative;
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 18px 18px 14px;
        overflow: hidden;
      }

      .brand-top {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }

      .title {
        display: flex;
        align-items: center;
        gap: 10px;
        min-width: 0;
      }

      .logo {
        width: 44px;
        height: 44px;
        border-radius: 16px;
        background: radial-gradient(
            circle at 30% 30%,
            rgba(255, 255, 255, 0.9),
            rgba(255, 255, 255, 0) 55%
          ),
          linear-gradient(135deg, var(--accent2), var(--accent));
        border: 1px solid rgba(255, 255, 255, 0.35);
        box-shadow: 0 10px 18px rgba(0, 0, 0, 0.06);
        display: grid;
        place-items: center;
        flex: 0 0 auto;
        position: relative;
        overflow: hidden;
      }

      .logo::after {
        content: "";
        position: absolute;
        inset: -20%;
        background: radial-gradient(
            circle at 20% 20%,
            rgba(255, 255, 255, 0.55),
            transparent 45%
          ),
          radial-gradient(
            circle at 80% 30%,
            rgba(255, 255, 255, 0.35),
            transparent 50%
          );
        transform: rotate(12deg);
        opacity: 0.65;
      }

      .logo span {
        position: relative;
        z-index: 1;
        font-size: 20px;
        filter: drop-shadow(0 3px 6px rgba(0, 0, 0, 0.12));
      }

      .title h1 {
        margin: 0;
        font-size: 18px;
        letter-spacing: 0.2px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .title p {
        margin: 4px 0 0;
        color: var(--muted);
        font-size: 12px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .controls {
        display: flex;
        align-items: center;
        gap: 8px;
        flex: 0 0 auto;
      }

      .pill {
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.72);
        color: var(--text);
        padding: 8px 10px;
        border-radius: 999px;
        font-size: 12px;
        box-shadow: 0 10px 18px rgba(0, 0, 0, 0.04);
        user-select: none;
        display: flex;
        align-items: center;
        gap: 8px;
        max-width: 240px;
      }
      html[data-theme="night"] .pill,
      html[data-theme="moonlight"] .pill,
      html[data-theme="ink"] .pill {
        background: rgba(255, 255, 255, 0.06);
      }

      .select,
      .input {
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.78);
        color: var(--text);
        padding: 10px 12px;
        border-radius: 14px;
        outline: none;
        transition: box-shadow 0.18s ease, transform 0.08s ease;
        font-size: 13px;
      }
      html[data-theme="night"] .select,
      html[data-theme="night"] .input,
      html[data-theme="moonlight"] .select,
      html[data-theme="moonlight"] .input,
      html[data-theme="ink"] .select,
      html[data-theme="ink"] .input {
        background: rgba(255, 255, 255, 0.06);
      }

      .select:focus,
      .input:focus {
        box-shadow: var(--ring);
      }

      .btn {
        border: 1px solid var(--border);
        background: linear-gradient(135deg, var(--accent2), var(--accent));
        color: #fff;
        padding: 10px 12px;
        border-radius: 14px;
        cursor: pointer;
        font-weight: 600;
        font-size: 13px;
        box-shadow: 0 14px 28px rgba(0, 0, 0, 0.08);
        transition: transform 0.08s ease, box-shadow 0.18s ease,
          filter 0.18s ease;
        user-select: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        justify-content: center;
        white-space: nowrap;
      }
      .btn:hover {
        filter: brightness(1.02);
      }
      .btn:active {
        transform: translateY(1px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.08);
      }

      .btn.ghost {
        background: rgba(255, 255, 255, 0.72);
        color: var(--text);
        box-shadow: 0 12px 22px rgba(0, 0, 0, 0.04);
      }
      html[data-theme="night"] .btn.ghost,
      html[data-theme="moonlight"] .btn.ghost,
      html[data-theme="ink"] .btn.ghost {
        background: rgba(255, 255, 255, 0.06);
      }

      .btn.danger {
        background: linear-gradient(
          135deg,
          rgba(239, 68, 68, 0.95),
          rgba(244, 63, 94, 0.95)
        );
        border-color: rgba(244, 63, 94, 0.3);
      }

      .card {
        position: relative;
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 16px;
        overflow: hidden;
      }

      .card h2 {
        margin: 0 0 10px;
        font-size: 14px;
        letter-spacing: 0.2px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .sub {
        color: var(--muted);
        font-size: 12px;
        margin-top: -6px;
        margin-bottom: 12px;
      }

      .grid {
        display: grid;
        gap: var(--gap);
      }

      .row {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
      }

      .row > * {
        flex: 1 1 auto;
      }
      .row .tight {
        flex: 0 0 auto;
      }

      .sep {
        height: 1px;
        background: rgba(0, 0, 0, 0.06);
        margin: 12px 0;
      }
      html[data-theme="night"] .sep,
      html[data-theme="moonlight"] .sep,
      html[data-theme="ink"] .sep {
        background: rgba(255, 255, 255, 0.1);
      }

      .kpi {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
      }
      @media (max-width: 980px) {
        .kpi {
          grid-template-columns: repeat(3, 1fr);
        }
      }
      @media (max-width: 420px) {
        .kpi {
          grid-template-columns: 1fr;
        }
      }

      .kpi .box {
        border: 1px solid var(--border);
        border-radius: 18px;
        padding: 12px;
        background: rgba(255, 255, 255, 0.66);
        box-shadow: 0 12px 22px rgba(0, 0, 0, 0.04);
      }
      html[data-theme="night"] .kpi .box,
      html[data-theme="moonlight"] .kpi .box,
      html[data-theme="ink"] .kpi .box {
        background: rgba(255, 255, 255, 0.06);
      }

      .kpi .num {
        font-size: 18px;
        font-weight: 800;
        margin: 2px 0 4px;
        letter-spacing: 0.2px;
      }
      .kpi .lab {
        font-size: 12px;
        color: var(--muted);
      }

      /* ===== Calendar ===== */
      .cal-head {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
      }
      .cal-head .month {
        font-weight: 800;
        letter-spacing: 0.3px;
      }
      .cal-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 8px;
        user-select: none;
      }
      .dow {
        text-align: center;
        font-size: 12px;
        color: var(--muted);
        padding: 6px 0;
      }
      .day {
        border: 1px solid rgba(0, 0, 0, 0.06);
        border-radius: 16px;
        background: rgba(255, 255, 255, 0.66);
        padding: 10px 10px 8px;
        min-height: 62px;
        cursor: pointer;
        transition: transform 0.08s ease, box-shadow 0.18s ease,
          border-color 0.18s ease;
        position: relative;
        overflow: hidden;
      }
      html[data-theme="night"] .day,
      html[data-theme="moonlight"] .day,
      html[data-theme="ink"] .day {
        background: rgba(255, 255, 255, 0.06);
        border-color: rgba(255, 255, 255, 0.1);
      }
      .day:hover {
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.06);
      }
      .day:active {
        transform: translateY(1px);
      }

      .day .dnum {
        font-weight: 800;
        font-size: 12px;
        opacity: 0.95;
      }
      .day .mark {
        margin-top: 6px;
        font-size: 12px;
        display: flex;
        gap: 6px;
        align-items: center;
        flex-wrap: wrap;
        color: var(--muted);
      }
      .day.is-out {
        opacity: 0.45;
      }
      .day.is-today {
        border-color: rgba(255, 79, 163, 0.35);
        box-shadow: var(--ring);
      }
      html[data-theme="blue"] .day.is-today {
        border-color: rgba(59, 130, 246, 0.35);
      }
      html[data-theme="mint"] .day.is-today {
        border-color: rgba(16, 185, 129, 0.35);
      }
      html[data-theme="night"] .day.is-today {
        border-color: rgba(167, 139, 250, 0.35);
      }
      html[data-theme="moonlight"] .day.is-today {
        border-color: rgba(196, 181, 253, 0.35);
      }
      html[data-theme="clinic"] .day.is-today {
        border-color: rgba(2, 132, 199, 0.32);
      }

      .day.is-selected {
        border-color: rgba(0, 0, 0, 0.12);
        box-shadow: 0 16px 30px rgba(0, 0, 0, 0.08);
      }
      html[data-theme="night"] .day.is-selected,
      html[data-theme="moonlight"] .day.is-selected,
      html[data-theme="ink"] .day.is-selected {
        border-color: rgba(255, 255, 255, 0.16);
        box-shadow: 0 16px 30px rgba(0, 0, 0, 0.45);
      }

      .badge {
        display: inline-flex;
        gap: 6px;
        align-items: center;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.72);
        font-size: 12px;
        box-shadow: 0 10px 18px rgba(0, 0, 0, 0.04);
      }
      html[data-theme="night"] .badge,
      html[data-theme="moonlight"] .badge,
      html[data-theme="ink"] .badge {
        background: rgba(255, 255, 255, 0.06);
      }

      /* ===== Lists ===== */
      .list {
        display: grid;
        gap: 10px;
      }
      .item {
        border: 1px solid rgba(0, 0, 0, 0.06);
        border-radius: 18px;
        padding: 12px;
        background: rgba(255, 255, 255, 0.66);
        box-shadow: 0 12px 22px rgba(0, 0, 0, 0.04);
        display: grid;
        gap: 8px;
      }
      html[data-theme="night"] .item,
      html[data-theme="moonlight"] .item,
      html[data-theme="ink"] .item {
        background: rgba(255, 255, 255, 0.06);
        border-color: rgba(255, 255, 255, 0.1);
      }

      .item .top {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 10px;
      }
      .item .name {
        font-weight: 800;
        display: flex;
        gap: 8px;
        align-items: center;
        min-width: 0;
      }
      .item .name .txt {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .item .meta {
        color: var(--muted);
        font-size: 12px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
      .item .acts {
        display: flex;
        gap: 8px;
        flex: 0 0 auto;
      }

      .mini {
        font-size: 12px;
        padding: 8px 10px;
        border-radius: 14px;
      }

      /* ===== Modal ===== */
      .modal {
        position: fixed;
        inset: 0;
        display: none;
        place-items: center;
        background: rgba(0, 0, 0, 0.4);
        z-index: 50;
        padding: 18px;
      }
      .modal.open {
        display: grid;
      }
      .modal .panel {
        width: min(720px, 100%);
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 26px;
        box-shadow: 0 30px 80px rgba(0, 0, 0, 0.2);
        overflow: hidden;
      }
      .modal .panel .head {
        padding: 14px 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid rgba(0, 0, 0, 0.06);
        background: rgba(255, 255, 255, 0.5);
      }
      html[data-theme="night"] .modal .panel .head,
      html[data-theme="moonlight"] .modal .panel .head,
      html[data-theme="ink"] .modal .panel .head {
        background: rgba(255, 255, 255, 0.04);
        border-bottom-color: rgba(255, 255, 255, 0.1);
      }
      .modal .panel .head .ttl {
        font-weight: 900;
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .modal .panel .body {
        padding: 16px;
        display: grid;
        gap: 12px;
      }
      .modal .panel .foot {
        padding: 14px 16px;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        border-top: 1px solid rgba(0, 0, 0, 0.06);
        background: rgba(255, 255, 255, 0.5);
      }
      html[data-theme="night"] .modal .panel .foot,
      html[data-theme="moonlight"] .modal .panel .foot,
      html[data-theme="ink"] .modal .panel .foot {
        background: rgba(255, 255, 255, 0.04);
        border-top-color: rgba(255, 255, 255, 0.1);
      }

      .two {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      @media (max-width: 620px) {
        .two {
          grid-template-columns: 1fr;
        }
      }

      .hint {
        color: var(--muted);
        font-size: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .footer {
        margin-top: 10px;
        color: var(--muted);
        font-size: 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
      }
      .author {
        position: fixed;
        right: 14px;
        bottom: 12px;
        z-index: 10;
        padding: 8px 10px;
        border-radius: 999px;
        border: 1px solid rgba(0, 0, 0, 0.08);
        background: rgba(255, 255, 255, 0.72);
        color: rgba(17, 24, 39, 0.7);
        font-size: 12px;
        box-shadow: 0 10px 18px rgba(0, 0, 0, 0.06);
        backdrop-filter: blur(10px);
        user-select: none;
      }
      html[data-theme="night"] .author,
      html[data-theme="moonlight"] .author,
      html[data-theme="ink"] .author {
        border-color: rgba(255, 255, 255, 0.12);
        background: rgba(255, 255, 255, 0.06);
        color: rgba(229, 231, 235, 0.7);
      }

      .toast {
        position: fixed;
        left: 50%;
        bottom: 16px;
        transform: translateX(-50%);
        background: rgba(17, 24, 39, 0.92);
        color: #fff;
        padding: 10px 12px;
        border-radius: 999px;
        font-size: 12px;
        box-shadow: 0 16px 30px rgba(0, 0, 0, 0.2);
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.18s ease, transform 0.18s ease;
        z-index: 60;
      }
      .toast.show {
        opacity: 1;
        transform: translateX(-50%) translateY(-6px);
      }

      /* Accessibility helpers */
      .sr {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }

      /* Decorative bow SVG */
      .bow-svg {
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="bg-layer">
      <div class="bg-pattern"></div>
    </div>

    <div class="wrap">
      <div class="shell">
        <!-- LEFT -->
        <div class="grid">
          <section class="brand">
            <div class="corner-bow" aria-hidden="true">
              <svg
                viewBox="0 0 120 120"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  class="bow-fill"
                  d="M44 58c-9-14-30-22-36-8-6 14 15 27 30 25 6-1 8-3 6-7z"
                />
                <path
                  class="bow-fill"
                  d="M76 58c9-14 30-22 36-8 6 14-15 27-30 25-6-1-8-3-6-7z"
                />
                <path
                  class="bow-fill"
                  d="M60 50c-10 0-18 8-18 18 0 8 6 14 18 14s18-6 18-14c0-10-8-18-18-18z"
                />
                <path
                  class="bow-fill"
                  d="M55 82c-2 10-8 18-10 24 7-2 17-8 23-12 6 4 16 10 23 12-2-6-8-14-10-24-8 3-17 3-26 0z"
                  opacity=".9"
                />
              </svg>
            </div>

            <div class="brand-top">
              <div class="title">
                <div class="logo" aria-hidden="true"><span>ğŸ’Š</span></div>
                <div style="min-width: 0">
                  <h1 id="appName">ç”¨è¯è®°å½•å™¨</h1>
                  <p id="modeLine">å½“å‰å·¥ä½œåŒºï¼šæˆ‘çš„è®°å½•</p>
                </div>
              </div>

              <div class="controls">
                <select class="select" id="themeSel" title="çš®è‚¤">
                  <option value="kitty">ğŸ€ Katy Pinkï¼ˆé»˜è®¤ï¼‰</option>
                  <option value="milktea">ğŸ§‹ Milk Tea å¥¶èŒ¶</option>
                  <option value="peach">ğŸ‘ Peach Bloom èœœæ¡ƒ</option>
                  <option value="mint">ğŸƒ Mint Fresh è–„è·</option>
                  <option value="blue">ğŸ’  Blue Calm é™è“</option>
                  <option value="skyglass">ğŸ«§ Sky Glass å¤©ç©ºç»ç’ƒ</option>
                  <option value="night">ğŸŒ™ Night Cat å¤œçŒ«</option>
                  <option value="moonlight">ğŸŒ• Moonlight æœˆå…‰</option>
                  <option value="ink">ğŸ–¤ Ink Black å¢¨é»‘</option>
                  <option value="minimal">â€¢ Minimal Paper æç®€çº¸</option>
                  <option value="monogrey">â¬› Mono Grey å•è‰²ç°</option>
                  <option value="clinic">ğŸ©º Clinic White åŒ»ç–—ç™½</option>
                </select>
              </div>
            </div>

            <div class="sep"></div>

            <div class="row">
              <span class="pill" id="hintBar"
                >åˆ†äº«ç»™åˆ«äººï¼šç”¨å³ä¸Šè§’â€œå¤åˆ¶åˆ†äº«é“¾æ¥â€</span
              >
              <button
                class="btn ghost tight"
                id="copyShareBtn"
                title="å¤åˆ¶åˆ†äº«é“¾æ¥"
              >
                <span>ğŸ”—</span><span>å¤åˆ¶åˆ†äº«é“¾æ¥</span>
              </button>
            </div>

            <div class="footer">
              <span class="hint"
                ><span id="privacyIcon">ğŸ”’</span
                ><span id="privacyText">æœ¬æœºè®°å½•ï¼ˆå¸¦é’¥åŒ™é“¾æ¥ï¼‰</span></span
              >
              <span class="hint"
                ><span>ğŸ—“ï¸</span><span id="todayText"></span
              ></span>
            </div>
          </section>

          <section class="card">
            <h2>ğŸ“ˆ æœ¬æœˆæ¦‚è§ˆ</h2>
            <div class="sub">åŸºäºâ€œåº”æœç”¨æ¬¡æ•°â€è®¡ç®—ï¼Œæ”¯æŒè¡¥å½•ä¸å›å¡«ã€‚</div>
            <div class="kpi">
              <div class="box">
                <div class="num" id="kpiRate">0%</div>
                <div class="lab">æŒ‰æ—¶å®Œæˆç‡</div>
              </div>
              <div class="box">
                <div class="num" id="kpiStreak">0</div>
                <div class="lab">è¿ç»­å®Œæˆå¤©æ•°</div>
              </div>
              <div class="box">
                <div class="num" id="kpiMiss">0</div>
                <div class="lab">æœ¬æœˆæ¼è®°/æœªå®Œæˆ</div>
              </div>
            </div>
          </section>

          <section class="card">
            <h2>ğŸ§° æˆ‘çš„è¯ç®±</h2>
            <div class="sub">
              æ”¯æŒæ–°å¢ã€ç¼–è¾‘ã€åˆ é™¤ï¼›æ¯ä¸ªè¯å¯è®¾â€œæ¯æ—¥æ¬¡æ•°ã€æ—¶é—´ç‚¹ã€å•æ¬¡å‰‚é‡ã€å‰©ä½™æ•°é‡ã€ä½é‡æé†’â€ã€‚
            </div>
            <div class="row">
              <button class="btn tight" id="addMedBtn">
                <span>â•</span><span>æ·»åŠ è¯ç‰©</span>
              </button>
              <button class="btn ghost tight" id="exportBtn">
                <span>ğŸ’¾</span><span>å¯¼å‡ºJSON</span>
              </button>
              <label class="btn ghost tight" style="cursor: pointer">
                <span>ğŸ“¥</span><span>å¯¼å…¥JSON</span>
                <input
                  class="sr"
                  type="file"
                  id="importFile"
                  accept="application/json"
                />
              </label>
            </div>
            <div class="sep"></div>
            <div class="list" id="medList"></div>
          </section>
        </div>

        <!-- RIGHT -->
        <div class="grid">
          <section class="card">
            <div class="cal-head">
              <div class="row" style="gap: 8px; flex-wrap: nowrap">
                <button
                  class="btn ghost tight mini"
                  id="prevMonthBtn"
                  title="ä¸Šä¸ªæœˆ"
                >
                  â†
                </button>
                <div class="month" id="monthText">â€”</div>
                <button
                  class="btn ghost tight mini"
                  id="nextMonthBtn"
                  title="ä¸‹ä¸ªæœˆ"
                >
                  â†’
                </button>
              </div>
              <div class="row" style="justify-content: flex-end">
                <button class="btn ghost tight mini" id="goTodayBtn">
                  å›åˆ°ä»Šå¤©
                </button>
              </div>
            </div>
            <div class="cal-grid" id="calDow"></div>
            <div class="cal-grid" id="calGrid"></div>
            <div class="sep"></div>
            <div class="hint">
              ç‚¹å‡»æŸä¸€å¤©å¯â€œè¡¥å½•/å›å¡«â€ã€‚è¡¥å½•ä¼šæœ‰æ˜ç¡®çš„ç¡®è®¤æç¤ºï¼Œé¿å…è¯¯æ“ä½œã€‚
            </div>
          </section>

          <section class="card" id="dayCard">
            <h2>ğŸ—“ï¸ <span id="selDateText">é€‰æ‹©ä¸€ä¸ªæ—¥æœŸ</span></h2>
            <div class="sub" id="selDateSub">
              ä½ å¯ä»¥åœ¨è¿™é‡Œå¯¹å½“å¤©è¿›è¡Œæ‰“å¡ã€è¡¥å½•ã€æˆ–ä¸€é”®æ ‡è®°ã€‚
            </div>

            <div class="row">
              <button class="btn tight" id="markAllBtn">
                <span>âœ…</span><span>ä¸€é”®å®Œæˆå½“å¤©</span>
              </button>
              <button class="btn ghost tight" id="clearDayBtn">
                <span>ğŸ§½</span><span>æ¸…ç©ºå½“å¤©è®°å½•</span>
              </button>
            </div>

            <div class="sep"></div>
            <div class="list" id="doseList"></div>
          </section>
        </div>
      </div>
    </div>

    <div class="author">FLAAAAKING</div>

    <!-- Modal: Medication Editor -->
    <div
      class="modal"
      id="medModal"
      role="dialog"
      aria-modal="true"
      aria-labelledby="medModalTitle"
    >
      <div class="panel">
        <div class="head">
          <div class="ttl" id="medModalTitle">ğŸ’Š è¯ç‰©ä¿¡æ¯</div>
          <button class="btn ghost mini" id="closeMedModal">âœ•</button>
        </div>
        <div class="body">
          <div class="two">
            <label>
              <div class="hint">è¯ç‰©åç§°</div>
              <input
                class="input"
                id="mName"
                placeholder="ä¾‹å¦‚ï¼šç¢³é…¸é”‚ç¼“é‡Šç‰‡"
              />
            </label>
            <label>
              <div class="hint">å›¾æ ‡ï¼ˆå¯ç”¨emojiï¼‰</div>
              <input class="input" id="mIcon" placeholder="ä¾‹å¦‚ï¼šğŸ’Š" />
            </label>
          </div>

          <div class="two">
            <label>
              <div class="hint">è§„æ ¼/å‰‚é‡è¯´æ˜ï¼ˆå±•ç¤ºç”¨ï¼‰</div>
              <input class="input" id="mSpec" placeholder="ä¾‹å¦‚ï¼š300mg/ç‰‡" />
            </label>
            <label>
              <div class="hint">å•æ¬¡å‰‚é‡</div>
              <input
                class="input"
                id="mDose"
                placeholder="ä¾‹å¦‚ï¼š1ç‰‡ / 2ç²’ / 10ml"
              />
            </label>
          </div>

          <div class="two">
            <label>
              <div class="hint">æ¯æ—¥æ¬¡æ•°ï¼ˆ1-6ï¼‰</div>
              <input
                class="input"
                id="mTimes"
                type="number"
                min="1"
                max="6"
                placeholder="ä¾‹å¦‚ï¼š2"
              />
            </label>
            <label>
              <div class="hint">æœç”¨æ—¶é—´ç‚¹ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰</div>
              <input
                class="input"
                id="mSchedule"
                placeholder="ä¾‹å¦‚ï¼š08:00, 20:00"
              />
            </label>
          </div>

          <div class="two">
            <label>
              <div class="hint">å‰©ä½™æ•°é‡ï¼ˆå¯ç©ºï¼‰</div>
              <input
                class="input"
                id="mStock"
                type="number"
                min="0"
                placeholder="ä¾‹å¦‚ï¼š30"
              />
            </label>
            <label>
              <div class="hint">ä½é‡æé†’é˜ˆå€¼ï¼ˆå¯ç©ºï¼‰</div>
              <input
                class="input"
                id="mLow"
                type="number"
                min="0"
                placeholder="ä¾‹å¦‚ï¼š7"
              />
            </label>
          </div>

          <label>
            <div class="hint">å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</div>
            <input
              class="input"
              id="mNote"
              placeholder="ä¾‹å¦‚ï¼šé¥­åæœç”¨ / é¿å…ç©ºè…¹"
            />
          </label>

          <div class="hint" id="medModalHint">
            ä¿å­˜åä¼šç«‹å³åº”ç”¨åˆ°æ—¥å†ä¸å½“å¤©æ‰“å¡åˆ—è¡¨ã€‚
          </div>
        </div>
        <div class="foot">
          <button class="btn ghost" id="cancelMedBtn">å–æ¶ˆ</button>
          <button class="btn" id="saveMedBtn">
            <span>ğŸ’¾</span><span>ä¿å­˜</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Modal: Confirm -->
    <div
      class="modal"
      id="confirmModal"
      role="dialog"
      aria-modal="true"
      aria-labelledby="confirmTitle"
    >
      <div class="panel">
        <div class="head">
          <div class="ttl" id="confirmTitle">ç¡®è®¤æ“ä½œ</div>
          <button class="btn ghost mini" id="closeConfirm">âœ•</button>
        </div>
        <div class="body">
          <div id="confirmText" style="font-weight: 700"></div>
          <div class="hint" id="confirmSub"></div>
        </div>
        <div class="foot">
          <button class="btn ghost" id="confirmNo">å–æ¶ˆ</button>
          <button class="btn" id="confirmYes">ç¡®è®¤</button>
        </div>
      </div>
    </div>

    <div class="toast" id="toast">å·²å®Œæˆ</div>

    <script>
      /* =========================
       Data rules (Privacy model)
       - "ç§å¯†é’¥åŒ™é“¾æ¥"ï¼šURL å¸¦ ?k=xxxx çš„è®¾å¤‡ï¼Œè¯»å†™ localStorage çš„ç§å¯†ç©ºé—´
       - åˆ†äº«é“¾æ¥ä¸å¸¦ kï¼šè®¿å®¢é»˜è®¤ç©ºç™½ï¼ˆå„è‡ªè®¾å¤‡ç‹¬ç«‹ï¼‰
       - ä½ ä¸éœ€è¦æ”¹ä»£ç æ¥ç»™æœ‹å‹ç”¨ï¼šåˆ†äº«é“¾æ¥å³å¯
       ========================= */

      const $ = (id) => document.getElementById(id);

      const DOW = ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"];

      const THEME_EMOJI = {
        kitty: "ğŸ€",
        milktea: "ğŸ§‹",
        peach: "ğŸ‘",
        mint: "ğŸƒ",
        blue: "ğŸ’ ",
        skyglass: "ğŸ«§",
        night: "ğŸŒ™",
        moonlight: "ğŸŒ•",
        ink: "ğŸ–¤",
        minimal: "â€¢",
        monogrey: "â¬›",
        clinic: "ğŸ©º",
      };

      const DEFAULT_MEDS = [
        {
          id: uid(),
          name: "è‰é…¸è‰¾å¸è¥¿é…æ™®å…°ç‰‡",
          icon: "ğŸ’Š",
          spec: "10mg/ç‰‡",
          dose: "1ç‰‡",
          timesPerDay: 1,
          schedule: ["09:00"],
          stock: null,
          lowStock: null,
          note: "é¥­åæ›´èˆ’æœ",
        },
        {
          id: uid(),
          name: "ç¢³é…¸é”‚ç¼“é‡Šç‰‡",
          icon: "ğŸŸ£",
          spec: "300mg/ç‰‡",
          dose: "1ç‰‡",
          timesPerDay: 2,
          schedule: ["09:00", "21:00"],
          stock: null,
          lowStock: null,
          note: "æŒ‰åŒ»å˜±",
        },
        {
          id: uid(),
          name: "ç›é…¸å“Œå”‘å—ª/åŠ©çœ è¯ï¼ˆç¤ºä¾‹ï¼‰",
          icon: "ğŸŒ™",
          spec: "æŒ‰åŒ»å˜±",
          dose: "1ç²’",
          timesPerDay: 1,
          schedule: ["23:30"],
          stock: null,
          lowStock: null,
          note: "ç¡å‰",
        },
      ];

      const DEFAULT_STATE = {
        theme: "kitty",
        meds: DEFAULT_MEDS,
        records: {}, // dateKey -> { doses: {doseKey: {taken:boolean, takenAt:string}}, note?:string }
        selectedDate: null,
        calYear: null,
        calMonth: null,
      };

      function uid() {
        return (
          "m_" + Math.random().toString(16).slice(2) + Date.now().toString(16)
        );
      }

      function pad2(n) {
        return (n < 10 ? "0" : "") + n;
      }

      function dateKey(d) {
        const y = d.getFullYear(),
          m = pad2(d.getMonth() + 1),
          da = pad2(d.getDate());
        return `${y}-${m}-${da}`;
      }

      function parseDateKey(key) {
        const [y, m, d] = key.split("-").map(Number);
        return new Date(y, m - 1, d);
      }

      function startOfMonth(y, m0) {
        return new Date(y, m0, 1);
      }
      function endOfMonth(y, m0) {
        return new Date(y, m0 + 1, 0);
      }

      function getQueryK() {
        const u = new URL(location.href);
        return u.searchParams.get("k");
      }

      function ensurePrivateKey() {
        const u = new URL(location.href);
        let k = u.searchParams.get("k");
        if (!k) {
          k =
            "k_" +
            Math.random().toString(36).slice(2, 10) +
            Math.random().toString(36).slice(2, 10);
          u.searchParams.set("k", k);
          history.replaceState(null, "", u.toString());
        }
        return k;
      }

      function storageKey() {
        const k = getQueryK();
        // ç§å¯†ï¼šå¸¦ kï¼›è®¿å®¢ï¼šä¸å¸¦ kï¼ˆé»˜è®¤ç©ºç™½ï¼‰
        return k ? `katy_med_tracker::${k}` : `katy_med_tracker::guest`;
      }

      function isPrivate() {
        return !!getQueryK();
      }

      function loadState() {
        const raw = localStorage.getItem(storageKey());
        if (!raw) {
          // ç§å¯†ç©ºé—´é¦–æ¬¡ï¼šç»™é»˜è®¤è¯ç®±ï¼›è®¿å®¢ç©ºé—´é¦–æ¬¡ï¼šç©ºç™½
          if (isPrivate()) {
            return structuredClone(DEFAULT_STATE);
          } else {
            const blank = structuredClone(DEFAULT_STATE);
            blank.meds = [];
            blank.records = {};
            return blank;
          }
        }
        try {
          const s = JSON.parse(raw);
          return hydrate(s);
        } catch (e) {
          // å®¹é”™ï¼šåæ•°æ®å°±é‡ç½®
          const fallback = isPrivate()
            ? structuredClone(DEFAULT_STATE)
            : (() => {
                const b = structuredClone(DEFAULT_STATE);
                b.meds = [];
                b.records = {};
                return b;
              })();
          return fallback;
        }
      }

      function saveState() {
        localStorage.setItem(storageKey(), JSON.stringify(state));
      }

      function hydrate(s) {
        // å®¹é”™è¡¥å­—æ®µ
        if (!s.theme) s.theme = "kitty";
        if (!Array.isArray(s.meds)) s.meds = [];
        if (!s.records || typeof s.records !== "object") s.records = {};
        if (!("selectedDate" in s)) s.selectedDate = null;
        const now = new Date();
        if (s.calYear == null) s.calYear = now.getFullYear();
        if (s.calMonth == null) s.calMonth = now.getMonth();
        return s;
      }

      function toast(msg) {
        const t = $("toast");
        t.textContent = msg;
        t.classList.add("show");
        clearTimeout(toast._t);
        toast._t = setTimeout(() => t.classList.remove("show"), 1400);
      }

      // ===== Confirm modal (safe feeling) =====
      let confirmResolve = null;
      function confirmBox({
        title = "ç¡®è®¤æ“ä½œ",
        text = "ç¡®å®šå—ï¼Ÿ",
        sub = "æ­¤æ“ä½œä¼šç«‹å³ç”Ÿæ•ˆã€‚",
        yes = "ç¡®è®¤",
        no = "å–æ¶ˆ",
      }) {
        $("confirmTitle").textContent = title;
        $("confirmText").textContent = text;
        $("confirmSub").textContent = sub;
        $("confirmYes").textContent = yes;
        $("confirmNo").textContent = no;
        $("confirmModal").classList.add("open");
        return new Promise((res) => {
          confirmResolve = res;
        });
      }
      function closeConfirm(val) {
        $("confirmModal").classList.remove("open");
        const r = confirmResolve;
        confirmResolve = null;
        if (r) r(val);
      }

      // ===== State =====
      // ç§å¯†å·¥ä½œåŒºï¼šç¡®ä¿ URL æœ‰ kï¼ˆä½ è‡ªå·±ä½¿ç”¨æ—¶æ¨èå¼€å¯ï¼‰
      // è®¿å®¢ï¼šåˆ†äº«é“¾æ¥ä¸å¸¦ kï¼ˆæœ‹å‹æ‰“å¼€å°±æ˜¯ç©ºç™½ï¼‰
      // ä½ ç°åœ¨è¦â€œè‡ªå·±ç”¨â€â€”â€”é»˜è®¤è‡ªåŠ¨ç”Ÿæˆ k
      const myKey = ensurePrivateKey();

      let state = loadState();

      // ===== UI init =====
      $("todayText").textContent = dateKey(new Date());
      $("privacyIcon").textContent = isPrivate() ? "ğŸ”’" : "ğŸ‘¤";
      $("privacyText").textContent = isPrivate()
        ? "æœ¬æœºè®°å½•ï¼ˆå¸¦é’¥åŒ™é“¾æ¥ï¼‰"
        : "è®¿å®¢ï¼ˆç©ºç™½å·¥ä½œåŒºï¼‰";
      $("hintBar").textContent = isPrivate()
        ? "åˆ†äº«ç»™åˆ«äººï¼šç”¨å³ä¸Šè§’â€œå¤åˆ¶åˆ†äº«é“¾æ¥â€"
        : "ä»ç©ºç™½å¼€å§‹ï¼šæ·»åŠ è¯ç‰©åå³å¯æ‰“å¡";
      $("modeLine").textContent = isPrivate()
        ? "å½“å‰å·¥ä½œåŒºï¼šæˆ‘çš„è®°å½•"
        : "å½“å‰å·¥ä½œåŒºï¼šæ–°è®°å½•";

      // Apply theme
      function applyTheme(theme) {
        document.documentElement.setAttribute("data-theme", theme);
        $("themeSel").value = theme;
      }
      applyTheme(state.theme || "kitty");

      // Theme select
      $("themeSel").addEventListener("change", () => {
        state.theme = $("themeSel").value;
        applyTheme(state.theme);
        saveState();
        renderAll();
        toast(`${THEME_EMOJI[state.theme] || ""} å·²åˆ‡æ¢çš®è‚¤`);
      });

      // Share link (without k)
      $("copyShareBtn").addEventListener("click", async () => {
        const u = new URL(location.href);
        u.searchParams.delete("k");
        const share = u.toString();
        try {
          await navigator.clipboard.writeText(share);
          toast("ğŸ”— åˆ†äº«é“¾æ¥å·²å¤åˆ¶ï¼ˆå¯¹æ–¹æ‰“å¼€æ˜¯ç©ºç™½ï¼‰");
        } catch (e) {
          prompt("å¤åˆ¶æ­¤é“¾æ¥å‘ç»™å¯¹æ–¹ï¼ˆå¯¹æ–¹æ‰“å¼€æ˜¯ç©ºç™½ï¼‰", share);
        }
      });

      // Export/Import
      $("exportBtn").addEventListener("click", () => {
        const u = new URL(location.href);
        // å¯¼å‡ºï¼šä»…å½“å‰å·¥ä½œåŒºï¼ˆç§å¯†/è®¿å®¢ï¼‰
        const data = JSON.stringify(state, null, 2);
        const blob = new Blob([data], { type: "application/json" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `katy-med-tracker-${
          isPrivate() ? "private" : "guest"
        }-${Date.now()}.json`;
        a.click();
        setTimeout(() => URL.revokeObjectURL(a.href), 1500);
      });

      $("importFile").addEventListener("change", async (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        const text = await file.text();
        try {
          const obj = JSON.parse(text);
          const ok = await confirmBox({
            title: "å¯¼å…¥æ•°æ®",
            text: "ç¡®å®šå¯¼å…¥è¿™ä»½æ•°æ®å—ï¼Ÿ",
            sub: "å¯¼å…¥ä¼šè¦†ç›–å½“å‰å·¥ä½œåŒºçš„è¯ç®±ä¸æ‰“å¡è®°å½•ã€‚",
            yes: "ç¡®è®¤å¯¼å…¥",
            no: "å–æ¶ˆ",
          });
          if (!ok) return;
          state = hydrate(obj);
          applyTheme(state.theme);
          saveState();
          renderAll();
          toast("ğŸ“¥ å¯¼å…¥å®Œæˆ");
        } catch (err) {
          toast("å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶ä¸æ˜¯æœ‰æ•ˆJSON");
        } finally {
          e.target.value = "";
        }
      });

      // ===== Calendar controls =====
      const now = new Date();
      if (state.calYear == null) state.calYear = now.getFullYear();
      if (state.calMonth == null) state.calMonth = now.getMonth();

      $("prevMonthBtn").addEventListener("click", () => {
        state.calMonth--;
        if (state.calMonth < 0) {
          state.calMonth = 11;
          state.calYear--;
        }
        saveState();
        renderCalendar();
        renderKPIs();
      });
      $("nextMonthBtn").addEventListener("click", () => {
        state.calMonth++;
        if (state.calMonth > 11) {
          state.calMonth = 0;
          state.calYear++;
        }
        saveState();
        renderCalendar();
        renderKPIs();
      });
      $("goTodayBtn").addEventListener("click", () => {
        const d = new Date();
        state.calYear = d.getFullYear();
        state.calMonth = d.getMonth();
        state.selectedDate = dateKey(d);
        saveState();
        renderAll();
        toast("ğŸ—“ï¸ å·²å›åˆ°ä»Šå¤©");
      });

      // ===== Med modal =====
      let editingMedId = null;

      function openMedModal(med) {
        $("medModal").classList.add("open");
        editingMedId = med ? med.id : null;
        $("medModalTitle").textContent = med ? "âœï¸ ç¼–è¾‘è¯ç‰©" : "â• æ·»åŠ è¯ç‰©";

        $("mName").value = med?.name || "";
        $("mIcon").value = med?.icon || "ğŸ’Š";
        $("mSpec").value = med?.spec || "";
        $("mDose").value = med?.dose || "";
        $("mTimes").value = med?.timesPerDay ?? 1;
        $("mSchedule").value = (med?.schedule || ["09:00"]).join(", ");
        $("mStock").value = (med?.stock ?? "") === null ? "" : med?.stock ?? "";
        $("mLow").value =
          (med?.lowStock ?? "") === null ? "" : med?.lowStock ?? "";
        $("mNote").value = med?.note || "";
      }

      function closeMedModal() {
        $("medModal").classList.remove("open");
        editingMedId = null;
      }

      $("addMedBtn").addEventListener("click", () => openMedModal(null));
      $("closeMedModal").addEventListener("click", closeMedModal);
      $("cancelMedBtn").addEventListener("click", closeMedModal);

      $("saveMedBtn").addEventListener("click", async () => {
        const name = $("mName").value.trim();
        if (!name) {
          toast("è¯·å¡«å†™è¯ç‰©åç§°");
          $("mName").focus();
          return;
        }

        const icon = ($("mIcon").value.trim() || "ğŸ’Š").slice(0, 3);
        const spec = $("mSpec").value.trim();
        const dose = $("mDose").value.trim();
        const timesPerDay = Math.max(
          1,
          Math.min(6, Number($("mTimes").value || 1))
        );
        const schedule = $("mSchedule")
          .value.split(",")
          .map((s) => s.trim())
          .filter(Boolean)
          .slice(0, 6);

        while (schedule.length < timesPerDay) {
          schedule.push(pad2(9 + schedule.length * 4) + ":00");
        }
        const stockRaw = $("mStock").value.trim();
        const lowRaw = $("mLow").value.trim();
        const stock = stockRaw === "" ? null : Math.max(0, Number(stockRaw));
        const lowStock = lowRaw === "" ? null : Math.max(0, Number(lowRaw));
        const note = $("mNote").value.trim();

        const medObj = {
          id: editingMedId || uid(),
          name,
          icon,
          spec,
          dose,
          timesPerDay,
          schedule: schedule.slice(0, timesPerDay),
          stock,
          lowStock,
          note,
        };

        if (editingMedId) {
          const idx = state.meds.findIndex((m) => m.id === editingMedId);
          if (idx >= 0) state.meds[idx] = medObj;
        } else {
          state.meds.push(medObj);
        }

        // Smart: ensure records structure aligns on next render; no destructive auto-edits here
        saveState();
        closeMedModal();
        renderAll();
        toast("ğŸ’¾ å·²ä¿å­˜è¯ç‰©");
      });

      // ===== Day actions =====
      $("markAllBtn").addEventListener("click", async () => {
        if (!state.selectedDate) {
          toast("å…ˆé€‰æ‹©ä¸€ä¸ªæ—¥æœŸ");
          return;
        }
        if (state.meds.length === 0) {
          toast("å…ˆæ·»åŠ è¯ç‰©");
          return;
        }

        const key = state.selectedDate;
        const ok = await confirmBox({
          title: "ä¸€é”®å®Œæˆå½“å¤©",
          text: `ç¡®è®¤å°† ${key} çš„æ‰€æœ‰è®¡åˆ’æ ‡è®°ä¸ºâ€œå·²æœç”¨â€å—ï¼Ÿ`,
          sub: "ä¼šé€æ¡å†™å…¥â€œå·²æœç”¨æ—¶é—´â€ï¼Œä»¥é¿å…è¯¯åˆ¤ã€‚",
          yes: "ç¡®è®¤å®Œæˆ",
          no: "å–æ¶ˆ",
        });
        if (!ok) return;

        const nowStr = new Date().toLocaleTimeString([], {
          hour: "2-digit",
          minute: "2-digit",
        });
        const rec = ensureRecord(key);

        for (const d of buildDosesForDate(key)) {
          rec.doses[d.doseKey] = { taken: true, takenAt: nowStr };
        }
        state.records[key] = rec;
        saveState();
        renderAll();
        toast("âœ… å½“å¤©å·²ä¸€é”®å®Œæˆ");
      });

      $("clearDayBtn").addEventListener("click", async () => {
        if (!state.selectedDate) {
          toast("å…ˆé€‰æ‹©ä¸€ä¸ªæ—¥æœŸ");
          return;
        }
        const key = state.selectedDate;
        const ok = await confirmBox({
          title: "æ¸…ç©ºå½“å¤©è®°å½•",
          text: `ç¡®è®¤æ¸…ç©º ${key} çš„æ‰€æœ‰æ‰“å¡å—ï¼Ÿ`,
          sub: "åªæ¸…ç©ºè¯¥å¤©ï¼Œä¸å½±å“è¯ç®±ä¸å…¶å®ƒæ—¥æœŸã€‚",
          yes: "ç¡®è®¤æ¸…ç©º",
          no: "å–æ¶ˆ",
        });
        if (!ok) return;

        delete state.records[key];
        saveState();
        renderAll();
        toast("ğŸ§½ å·²æ¸…ç©ºå½“å¤©");
      });

      // ===== Render helpers =====
      function ensureRecord(dateStr) {
        const r = state.records[dateStr];
        if (r && typeof r === "object") return r;
        return { doses: {} };
      }

      function buildDosesForDate(dateStr) {
        // Doses are per-med per-schedule time. doseKey = `${medId}__${time}`
        const doses = [];
        for (const med of state.meds) {
          const times = med.timesPerDay || med.schedule?.length || 1 || 1;
          const sched =
            med.schedule && med.schedule.length ? med.schedule : ["09:00"];
          for (let i = 0; i < Math.min(times, sched.length); i++) {
            const time = sched[i] || "09:00";
            doses.push({
              medId: med.id,
              time,
              doseKey: `${med.id}__${time}`,
              med,
            });
          }
        }
        // Sort by time string
        doses.sort((a, b) => a.time.localeCompare(b.time));
        return doses;
      }

      function medStockHint(med) {
        if (med.stock == null) return "";
        const low = med.lowStock;
        if (low != null && med.stock <= low)
          return `ï¼ˆâš ï¸ å‰©ä½™ ${med.stock}ï¼Œå»ºè®®è¡¥å……ï¼‰`;
        return `ï¼ˆå‰©ä½™ ${med.stock}ï¼‰`;
      }

      function renderMeds() {
        const el = $("medList");
        el.innerHTML = "";
        if (state.meds.length === 0) {
          el.innerHTML = `<div class="hint">è¿˜æ²¡æœ‰è¯ç‰©ã€‚ç‚¹å‡»ä¸Šæ–¹â€œæ·»åŠ è¯ç‰©â€ã€‚</div>`;
          return;
        }
        for (const med of state.meds) {
          const item = document.createElement("div");
          item.className = "item";
          const stock = medStockHint(med);
          item.innerHTML = `
          <div class="top">
            <div style="min-width:0">
              <div class="name">
                <span style="font-size:18px">${escapeHtml(
                  med.icon || "ğŸ’Š"
                )}</span>
                <span class="txt">${escapeHtml(med.name)}</span>
              </div>
              <div class="meta">
                <span>${escapeHtml(med.spec || "")}</span>
                <span>å•æ¬¡ï¼š${escapeHtml(med.dose || "")}</span>
                <span>æ¯æ—¥ï¼š${Number(med.timesPerDay || 1)}æ¬¡</span>
                <span>${escapeHtml((med.schedule || []).join(" Â· "))}</span>
                ${stock ? `<span>${stock}</span>` : ``}
              </div>
              ${
                med.note
                  ? `<div class="hint">å¤‡æ³¨ï¼š${escapeHtml(med.note)}</div>`
                  : ``
              }
            </div>
            <div class="acts">
              <button class="btn ghost mini" data-act="edit" data-id="${
                med.id
              }">âœï¸</button>
              <button class="btn danger mini" data-act="del" data-id="${
                med.id
              }">ğŸ—‘ï¸</button>
            </div>
          </div>
        `;
          el.appendChild(item);
        }

        el.querySelectorAll("button[data-act]").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const act = btn.getAttribute("data-act");
            const id = btn.getAttribute("data-id");
            const med = state.meds.find((m) => m.id === id);
            if (!med) return;

            if (act === "edit") {
              openMedModal(med);
            } else if (act === "del") {
              const ok = await confirmBox({
                title: "åˆ é™¤è¯ç‰©",
                text: `ç¡®è®¤åˆ é™¤ã€Œ${med.name}ã€å—ï¼Ÿ`,
                sub: "ä¸ä¼šè‡ªåŠ¨åˆ é™¤å†å²è®°å½•ï¼Œä½†å½“å¤©åˆ—è¡¨ä¼šä¸å†ç”Ÿæˆè¯¥è¯çš„è®¡åˆ’é¡¹ã€‚",
                yes: "ç¡®è®¤åˆ é™¤",
                no: "å–æ¶ˆ",
              });
              if (!ok) return;
              state.meds = state.meds.filter((m) => m.id !== id);
              saveState();
              renderAll();
              toast("ğŸ—‘ï¸ å·²åˆ é™¤");
            }
          });
        });
      }

      function renderCalendar() {
        // DOW
        const dow = $("calDow");
        dow.innerHTML = "";
        for (const d of DOW) {
          const x = document.createElement("div");
          x.className = "dow";
          x.textContent = d;
          dow.appendChild(x);
        }

        const y = state.calYear,
          m0 = state.calMonth;
        const first = startOfMonth(y, m0);
        const last = endOfMonth(y, m0);
        $("monthText").textContent = `${y}å¹´${m0 + 1}æœˆ`;

        const grid = $("calGrid");
        grid.innerHTML = "";

        // Determine leading days
        const startWeek = first.getDay();
        const daysInMonth = last.getDate();

        // prev month tail
        const prevLast = endOfMonth(y, m0 - 1);
        const prevDays = prevLast.getDate();

        const todayKey = dateKey(new Date());
        const selectedKey = state.selectedDate;

        const totalCells = 42; // 6 weeks
        for (let i = 0; i < totalCells; i++) {
          let cellDate,
            out = false;

          if (i < startWeek) {
            // previous month
            const d = prevDays - (startWeek - 1 - i);
            cellDate = new Date(y, m0 - 1, d);
            out = true;
          } else if (i >= startWeek + daysInMonth) {
            // next month
            const d = i - (startWeek + daysInMonth) + 1;
            cellDate = new Date(y, m0 + 1, d);
            out = true;
          } else {
            // current month
            const d = i - startWeek + 1;
            cellDate = new Date(y, m0, d);
          }

          const key = dateKey(cellDate);
          const day = document.createElement("div");
          day.className = "day";
          if (out) day.classList.add("is-out");
          if (key === todayKey) day.classList.add("is-today");
          if (selectedKey && key === selectedKey)
            day.classList.add("is-selected");

          const summary = daySummary(key);

          day.innerHTML = `
          <div class="dnum">${cellDate.getDate()}</div>
          <div class="mark">${summary}</div>
        `;

          day.addEventListener("click", () => {
            state.selectedDate = key;

            // Smart month navigation: if clicked out-of-month, jump to that month
            if (out) {
              state.calYear = cellDate.getFullYear();
              state.calMonth = cellDate.getMonth();
            }
            saveState();
            renderAll();
          });

          grid.appendChild(day);
        }
      }

      function daySummary(dateStr) {
        // return small inline summary: ok/warn + counts
        const doses = buildDosesForDate(dateStr);
        if (doses.length === 0) return `<span style="opacity:.7">â€”</span>`;

        const rec = ensureRecord(dateStr);
        let taken = 0;
        for (const d of doses) {
          const v = rec.doses?.[d.doseKey];
          if (v && v.taken) taken++;
        }
        if (taken === 0)
          return `<span>${getEmoji("pill")}</span><span>0/${
            doses.length
          }</span>`;
        if (taken === doses.length)
          return `<span>${getEmoji("ok")}</span><span>${taken}/${
            doses.length
          }</span>`;
        return `<span>${getEmoji("warn")}</span><span>${taken}/${
          doses.length
        }</span>`;
      }

      function getEmoji(type) {
        const styles = getComputedStyle(document.documentElement);
        if (type === "ok")
          return (
            styles.getPropertyValue("--emoji-ok").replace(/"/g, "").trim() ||
            "âœ…"
          );
        if (type === "warn")
          return (
            styles.getPropertyValue("--emoji-warn").replace(/"/g, "").trim() ||
            "âš ï¸"
          );
        if (type === "pill")
          return (
            styles.getPropertyValue("--emoji-pill").replace(/"/g, "").trim() ||
            "ğŸ’Š"
          );
        return "";
      }

      function renderDay() {
        const key = state.selectedDate;
        $("selDateText").textContent = key ? key : "é€‰æ‹©ä¸€ä¸ªæ—¥æœŸ";
        $("selDateSub").textContent = key
          ? "å¯è¡¥å½•/å›å¡«ï¼šé€é¡¹ç¡®è®¤ï¼Œé˜²æ­¢è¯¯æ‰“å¡ã€‚"
          : "ç‚¹å‡»æ—¥å†ä»»æ„æ—¥æœŸå¼€å§‹ã€‚";

        const list = $("doseList");
        list.innerHTML = "";

        if (!key) {
          list.innerHTML = `<div class="hint">å…ˆåœ¨ä¸Šæ–¹æ—¥å†é‡Œé€‰æ‹©ä¸€å¤©ã€‚</div>`;
          return;
        }
        if (state.meds.length === 0) {
          list.innerHTML = `<div class="hint">è¯ç®±æ˜¯ç©ºçš„ã€‚å…ˆåœ¨å·¦ä¾§æ·»åŠ è¯ç‰©ã€‚</div>`;
          return;
        }

        const doses = buildDosesForDate(key);
        const rec = ensureRecord(key);

        for (const d of doses) {
          const v = rec.doses?.[d.doseKey] || { taken: false, takenAt: "" };
          const item = document.createElement("div");
          item.className = "item";

          const done = v.taken;
          const time = d.time;
          const med = d.med;

          item.innerHTML = `
          <div class="top">
            <div style="min-width:0">
              <div class="name">
                <span style="font-size:18px">${escapeHtml(
                  med.icon || "ğŸ’Š"
                )}</span>
                <span class="txt">${escapeHtml(
                  med.name
                )} <span style="opacity:.7;font-weight:700">Â· ${escapeHtml(
            time
          )}</span></span>
              </div>
              <div class="meta">
                <span>${escapeHtml(med.spec || "")}</span>
                <span>å•æ¬¡ï¼š${escapeHtml(med.dose || "")}</span>
                <span>${
                  done
                    ? `${getEmoji("ok")} å·²æœç”¨`
                    : `${getEmoji("pill")} å¾…æœç”¨`
                }</span>
                <span>${
                  done && v.takenAt ? `è®°å½•æ—¶é—´ï¼š${escapeHtml(v.takenAt)}` : ""
                }</span>
              </div>
              ${
                med.note
                  ? `<div class="hint">å¤‡æ³¨ï¼š${escapeHtml(med.note)}</div>`
                  : ``
              }
            </div>
            <div class="acts">
              <button class="btn ${
                done ? "ghost" : "tight"
              } mini" data-act="toggle" data-key="${escapeHtml(d.doseKey)}">
                ${done ? "æ’¤é”€" : "æ‰“å¡"}
              </button>
              <button class="btn ghost mini" data-act="time" data-key="${escapeHtml(
                d.doseKey
              )}">æ”¹æ—¶é—´</button>
            </div>
          </div>
        `;

          list.appendChild(item);
        }

        list.querySelectorAll("button[data-act]").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const act = btn.getAttribute("data-act");
            const doseKey = btn.getAttribute("data-key");
            const key = state.selectedDate;
            const rec = ensureRecord(key);
            const cur = rec.doses?.[doseKey] || { taken: false, takenAt: "" };

            if (act === "toggle") {
              // Smart confirm for retro-fill: if date is not today, show stronger confirmation
              const today = dateKey(new Date());
              const isPast = key !== today;
              const title = isPast ? "è¡¥å½•ç¡®è®¤" : "æ‰“å¡ç¡®è®¤";
              const text = isPast
                ? `ç¡®è®¤è¡¥å½•ï¼š${key} è¿™æ¡è®°å½•æ ‡è®°ä¸ºâ€œå·²æœç”¨â€ï¼Ÿ`
                : `ç¡®è®¤å°†è¯¥æ¡è®°å½•æ ‡è®°ä¸ºâ€œå·²æœç”¨â€ï¼Ÿ`;
              const sub = isPast
                ? "è¡¥å½•ä¼šå†™å…¥è®°å½•æ—¶é—´ã€‚ä½ å¯ä»¥éšæ—¶æ’¤é”€ã€‚"
                : "ä¼šå†™å…¥è®°å½•æ—¶é—´ã€‚ä½ å¯ä»¥éšæ—¶æ’¤é”€ã€‚";

              if (!cur.taken) {
                const ok = await confirmBox({
                  title,
                  text,
                  sub,
                  yes: "ç¡®è®¤",
                  no: "å–æ¶ˆ",
                });
                if (!ok) return;
                const nowStr = new Date().toLocaleTimeString([], {
                  hour: "2-digit",
                  minute: "2-digit",
                });
                rec.doses[doseKey] = { taken: true, takenAt: nowStr };
              } else {
                const ok = await confirmBox({
                  title: "æ’¤é”€ç¡®è®¤",
                  text: "ç¡®è®¤æ’¤é”€è¯¥æ¡â€œå·²æœç”¨â€å—ï¼Ÿ",
                  sub: "æ’¤é”€åªå½±å“è¿™ä¸€æ¡è®°å½•ã€‚",
                  yes: "ç¡®è®¤æ’¤é”€",
                  no: "å–æ¶ˆ",
                });
                if (!ok) return;
                rec.doses[doseKey] = { taken: false, takenAt: "" };
              }
              state.records[key] = rec;
              saveState();
              renderAll();
              toast(cur.taken ? "å·²æ’¤é”€" : "âœ… å·²æ‰“å¡");
            }

            if (act === "time") {
              if (!cur.taken) {
                toast("è¯·å…ˆæ‰“å¡ï¼Œå†ä¿®æ”¹è®°å½•æ—¶é—´");
                return;
              }
              const input = prompt(
                "è¾“å…¥è®°å½•æ—¶é—´ï¼ˆHH:MMï¼‰",
                cur.takenAt || "09:00"
              );
              if (input == null) return;
              const v = input.trim();
              if (!/^\d{1,2}:\d{2}$/.test(v)) {
                toast("æ ¼å¼ä¸æ­£ç¡®ï¼Œåº”ä¸º HH:MMï¼Œä¾‹å¦‚ 08:05");
                return;
              }
              rec.doses[doseKey] = { taken: true, takenAt: v };
              state.records[key] = rec;
              saveState();
              renderAll();
              toast("ğŸ•’ å·²æ›´æ–°è®°å½•æ—¶é—´");
            }
          });
        });
      }

      function renderKPIs() {
        const y = state.calYear,
          m0 = state.calMonth;
        const first = startOfMonth(y, m0);
        const last = endOfMonth(y, m0);

        let total = 0,
          done = 0,
          miss = 0;
        let streak = 0;

        // month totals
        for (let d = 1; d <= last.getDate(); d++) {
          const dk = dateKey(new Date(y, m0, d));
          const doses = buildDosesForDate(dk);
          if (doses.length === 0) continue;
          total += doses.length;

          const rec = ensureRecord(dk);
          let taken = 0;
          for (const x of doses) {
            if (rec.doses?.[x.doseKey]?.taken) taken++;
          }
          done += taken;
          if (taken < doses.length) miss += doses.length - taken;
        }

        // streak up to today within same month
        const today = new Date();
        const inSameMonth =
          today.getFullYear() === y && today.getMonth() === m0;
        if (inSameMonth) {
          for (let d = today.getDate(); d >= 1; d--) {
            const dk = dateKey(new Date(y, m0, d));
            const doses = buildDosesForDate(dk);
            if (doses.length === 0) continue;
            const rec = ensureRecord(dk);
            let taken = 0;
            for (const x of doses) {
              if (rec.doses?.[x.doseKey]?.taken) taken++;
            }
            if (taken === doses.length) streak++;
            else break;
          }
        } else {
          streak = 0;
        }

        const rate = total === 0 ? 0 : Math.round((done / total) * 100);
        $("kpiRate").textContent = `${rate}%`;
        $("kpiStreak").textContent = `${streak}`;
        $("kpiMiss").textContent = `${miss}`;
      }

      function renderAll() {
        renderMeds();
        renderCalendar();
        renderDay();
        renderKPIs();
      }

      function escapeHtml(s) {
        return String(s ?? "")
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#39;");
      }

      // ===== Confirm wiring =====
      $("closeConfirm").addEventListener("click", () => closeConfirm(false));
      $("confirmNo").addEventListener("click", () => closeConfirm(false));
      $("confirmYes").addEventListener("click", () => closeConfirm(true));
      $("confirmModal").addEventListener("click", (e) => {
        if (e.target === $("confirmModal")) closeConfirm(false);
      });

      // Close med modal by clicking outside
      $("medModal").addEventListener("click", (e) => {
        if (e.target === $("medModal")) closeMedModal();
      });

      // ===== Initial select date =====
      if (!state.selectedDate) {
        state.selectedDate = dateKey(new Date());
        saveState();
      }
      // Ensure calendar on selected date month
      if (state.selectedDate) {
        const d = parseDateKey(state.selectedDate);
        state.calYear = d.getFullYear();
        state.calMonth = d.getMonth();
      }

      // Final apply
      applyTheme(state.theme || "kitty");
      saveState();
      renderAll();
    </script>
  </body>
</html>

