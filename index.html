<!DOCTYPE html>
<html lang="zh-CN" data-theme="katy-pink">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width,initial-scale=1,viewport-fit=cover"
    />
    <title>Áî®ËçØËÆ∞ÂΩïÂô®</title>
    <style>
      :root {
        --rounded: ui-rounded, "SF Pro Rounded", "PingFang SC",
          "Microsoft YaHei", "Noto Sans SC", system-ui, -apple-system, Segoe UI,
          Arial, sans-serif;
        --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;

        --bg: #fff5fb;
        --surface: #ffffff;
        --surface2: #fff0f7;
        --text: #1f1f23;
        --muted: #6b6b74;
        --border: rgba(20, 20, 30, 0.12);
        --accent: #ff5ea8;
        --accent2: #ffd1e5;
        --danger: #ff4d4d;
        --ok: #22c7a2;
        --warn: #ff9f2f;
        --info: #2f6bff;

        --radius: 18px;
        --stroke: 1px;
        --shadow: 0 18px 46px rgba(15, 16, 26, 0.14);
        --shadow2: 0 10px 26px rgba(15, 16, 26, 0.1);

        --blur: 10px;

        --chip-bg: rgba(255, 255, 255, 0.65);
        --chip-br: rgba(20, 20, 30, 0.12);

        --motion-fast: 140ms cubic-bezier(0.2, 0.9, 0.2, 1);
        --motion-slow: 380ms cubic-bezier(0.2, 0.9, 0.2, 1);

        --decor-on: 1; /* 1=ÂºÄË£ÖÈ•∞ 0=ÂÖ≥Ë£ÖÈ•∞ */
      }

      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family: var(--font, var(--rounded));
        color: var(--text);
        background: var(--bg);
        overflow-x: hidden;
      }

      /* ËÉåÊôØ‚ÄúÂ£ÅÁ∫∏Â±Ç‚Äù */
      .wallpaper {
        position: fixed;
        inset: 0;
        z-index: -3;
        background: radial-gradient(
            1200px 800px at 18% 12%,
            color-mix(in oklab, var(--accent) 18%, transparent),
            transparent 70%
          ),
          radial-gradient(
            900px 700px at 84% 16%,
            color-mix(in oklab, var(--accent2) 34%, transparent),
            transparent 70%
          ),
          radial-gradient(
            900px 700px at 30% 86%,
            rgba(0, 0, 0, 0.04),
            transparent 70%
          ),
          linear-gradient(
            180deg,
            color-mix(in oklab, var(--bg) 92%, white),
            var(--bg)
          );
        filter: saturate(1.05);
      }
      .wallpaper::after {
        content: "";
        position: absolute;
        inset: 0;
        opacity: calc(0.55 * var(--decor-on));
        background: radial-gradient(
            1.2px 1.2px at 12% 22%,
            rgba(255, 255, 255, 0.45),
            transparent 60%
          ),
          radial-gradient(
            1.2px 1.2px at 24% 30%,
            rgba(255, 255, 255, 0.32),
            transparent 60%
          ),
          radial-gradient(
            1.2px 1.2px at 82% 20%,
            rgba(255, 255, 255, 0.35),
            transparent 60%
          ),
          radial-gradient(
            1.2px 1.2px at 74% 74%,
            rgba(255, 255, 255, 0.26),
            transparent 60%
          ),
          radial-gradient(
            1.2px 1.2px at 18% 78%,
            rgba(255, 255, 255, 0.3),
            transparent 60%
          );
        mix-blend-mode: overlay;
        pointer-events: none;
      }

      /* ÂÖ®Â±ÄÂÆπÂô® */
      .app {
        max-width: 1120px;
        margin: 0 auto;
        padding: 22px 16px 88px;
      }

      /* È°∂ÈÉ®Ê†è */
      .topbar {
        display: flex;
        gap: 14px;
        align-items: center;
        justify-content: space-between;
        padding: 14px 14px;
        border-radius: 22px;
        background: color-mix(in oklab, var(--surface) 70%, transparent);
        border: var(--stroke) solid
          color-mix(in oklab, var(--border) 70%, white);
        box-shadow: var(--shadow2);
        backdrop-filter: blur(var(--blur));
        position: sticky;
        top: 10px;
        z-index: 10;
      }
      .brand {
        display: flex;
        align-items: center;
        gap: 12px;
        min-width: 260px;
      }
      .logo {
        width: 46px;
        height: 46px;
        display: grid;
        place-items: center;
        border-radius: var(--logo-radius, 16px);
        background: var(
          --logo-bg,
          linear-gradient(
            135deg,
            color-mix(in oklab, var(--accent) 86%, white),
            color-mix(in oklab, var(--accent2) 76%, white)
          )
        );
        border: var(--stroke) solid
          color-mix(in oklab, var(--border) 55%, white);
        box-shadow: var(--logo-shadow, var(--shadow2));
        position: relative;
        overflow: hidden;
      }
      .logo::before {
        content: "";
        position: absolute;
        inset: -30%;
        opacity: calc(0.65 * var(--decor-on));
        background: radial-gradient(
            14px 14px at 20% 22%,
            rgba(255, 255, 255, 0.55),
            transparent 62%
          ),
          radial-gradient(
            24px 24px at 72% 66%,
            rgba(255, 255, 255, 0.3),
            transparent 66%
          ),
          conic-gradient(
            from 180deg at 50% 50%,
            rgba(255, 255, 255, 0.16),
            transparent 40%,
            rgba(255, 255, 255, 0.12)
          );
        transform: rotate(12deg);
        pointer-events: none;
      }
      .brand h1 {
        margin: 0;
        font-size: 15px;
        letter-spacing: 0.2px;
        line-height: 1.1;
        font-weight: 920;
      }
      .brand .sub {
        margin-top: 4px;
        font-size: 12px;
        color: var(--muted);
        font-weight: 650;
      }

      .top-actions {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: flex-end;
      }

      /* Âç°Áâá/ÊåâÈíÆÔºà‰∏ªÈ¢òÊùêË¥®Â±ÇÊîØÊåÅÔºâ */
      .card {
        position: relative;
        overflow: hidden;
        background: var(
          --card-surface,
          color-mix(in oklab, var(--surface) 94%, transparent)
        );
        border: var(--stroke) solid var(--card-border, var(--border));
        border-radius: var(--card-radius, var(--radius));
        box-shadow: var(--card-shadow, var(--shadow2));
        backdrop-filter: blur(var(--blur));
      }
      .card::before {
        content: "";
        position: absolute;
        inset: 0;
        pointer-events: none;
        background: var(--card-overlay, none);
        opacity: calc(var(--card-overlay-opacity, 0) * var(--decor-on));
        mix-blend-mode: var(--card-overlay-blend, normal);
      }
      .card::after {
        content: "";
        position: absolute;
        inset: 0;
        pointer-events: none;
        border-radius: inherit;
        box-shadow: var(--card-glow, none);
        outline: var(--card-outline, none);
        opacity: var(--card-outline-opacity, 1);
      }

      .btn {
        appearance: none;
        border: none;
        cursor: pointer;
        border-radius: var(--btn-radius, 14px);
        padding: 10px 12px;
        font-weight: 840;
        background: var(
          --btn-bg,
          linear-gradient(
            135deg,
            color-mix(in oklab, var(--accent) 92%, white) 0%,
            color-mix(in oklab, var(--accent2) 72%, white) 100%
          )
        );
        color: var(--btn-text, color-mix(in oklab, var(--text) 14%, black));
        box-shadow: var(--btn-shadow, var(--shadow2));
        border: var(--btn-border, none);
        transition: transform var(--motion-fast), box-shadow var(--motion-fast),
          filter var(--motion-fast);
        user-select: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        line-height: 1;
        white-space: nowrap;
      }
      .btn:hover {
        transform: translateY(-1px);
        box-shadow: var(--btn-shadow-hover, var(--shadow));
        filter: saturate(1.06);
      }
      .btn:active {
        transform: translateY(0px) scale(0.99);
      }
      .btn:disabled {
        opacity: 0.55;
        cursor: not-allowed;
        transform: none;
      }

      .btn.secondary {
        background: var(
          --btn-secondary-bg,
          color-mix(in oklab, var(--surface2) 84%, transparent)
        );
        border: var(--btn-secondary-border, var(--stroke) solid var(--border));
        color: var(--btn-secondary-text, var(--text));
        box-shadow: var(
          --btn-secondary-shadow,
          0 6px 14px rgba(20, 20, 30, 0.06)
        );
      }
      .btn.ghost {
        background: transparent;
        border: var(--btn-ghost-border, var(--stroke) solid var(--border));
        color: var(--btn-ghost-text, var(--text));
        box-shadow: none;
      }
      .btn.danger {
        background: var(
          --btn-danger-bg,
          linear-gradient(
            135deg,
            color-mix(in oklab, var(--danger) 92%, white),
            color-mix(in oklab, var(--danger) 70%, white)
          )
        );
        color: var(--btn-danger-text, white);
        box-shadow: 0 12px 24px rgba(255, 77, 77, 0.18);
      }
      .btn.small {
        padding: 8px 10px;
        font-weight: 820;
        font-size: 12px;
        border-radius: 12px;
      }

      .chip {
        display: inline-flex;
        gap: 8px;
        align-items: center;
        padding: 7px 10px;
        border-radius: var(--chip-radius, 999px);
        background: var(--chip-bg);
        border: var(--stroke) solid var(--chip-br);
        font-size: 12px;
        font-weight: 780;
        color: color-mix(in oklab, var(--text) 86%, var(--muted));
        user-select: none;
        backdrop-filter: blur(var(--blur));
      }

      /* Â∏ÉÂ±Ä */
      .grid {
        margin-top: 16px;
        display: grid;
        grid-template-columns: 1.1fr 0.9fr;
        gap: 14px;
        align-items: start;
      }
      @media (max-width: 980px) {
        .grid {
          grid-template-columns: 1fr;
        }
        .brand {
          min-width: unset;
        }
        .topbar {
          position: static;
        }
      }

      .section-title {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        padding: 14px 14px 10px;
      }
      .section-title h2 {
        margin: 0;
        font-size: 14px;
        font-weight: 930;
        letter-spacing: 0.2px;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .section-title .meta {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
        justify-content: flex-end;
      }
      .pad {
        padding: 14px;
      }

      /* Êó•ÂéÜ */
      .cal-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        padding: 0 14px 12px;
      }
      .cal-head .month {
        font-weight: 960;
        letter-spacing: 0.2px;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .cal-head .month small {
        color: var(--muted);
        font-weight: 800;
      }
      .cal-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 8px;
        padding: 0 14px 14px;
      }
      .dow {
        font-size: 12px;
        color: var(--muted);
        font-weight: 850;
        text-align: center;
        padding: 6px 0;
        user-select: none;
      }
      .day {
        position: relative;
        border-radius: 14px;
        border: var(--stroke) solid
          color-mix(in oklab, var(--border) 70%, white);
        background: color-mix(in oklab, var(--surface) 80%, transparent);
        padding: 10px 10px 8px;
        cursor: pointer;
        min-height: 64px;
        transition: transform var(--motion-fast), box-shadow var(--motion-fast),
          border-color var(--motion-fast);
        box-shadow: 0 10px 18px rgba(15, 16, 26, 0.06);
        overflow: hidden;
      }
      .day:hover {
        transform: translateY(-1px);
        box-shadow: 0 14px 24px rgba(15, 16, 26, 0.1);
      }
      .day.muted {
        opacity: 0.45;
      }
      .day.selected {
        border-color: color-mix(in oklab, var(--accent) 55%, var(--border));
        box-shadow: 0 16px 30px rgba(15, 16, 26, 0.12);
        outline: 2px solid color-mix(in oklab, var(--accent) 26%, transparent);
        outline-offset: 2px;
      }
      .day .n {
        font-weight: 960;
        font-size: 13px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
      }
      .badge {
        display: inline-flex;
        gap: 6px;
        align-items: center;
        font-size: 11px;
        padding: 4px 8px;
        border-radius: 999px;
        border: var(--stroke) solid rgba(255, 255, 255, 0.55);
        background: rgba(255, 255, 255, 0.25);
        backdrop-filter: blur(var(--blur));
      }
      .badge.ok {
        background: color-mix(in oklab, var(--ok) 18%, transparent);
        border-color: color-mix(in oklab, var(--ok) 28%, transparent);
      }
      .badge.warn {
        background: color-mix(in oklab, var(--warn) 18%, transparent);
        border-color: color-mix(in oklab, var(--warn) 28%, transparent);
      }
      .badge.miss {
        background: color-mix(in oklab, var(--danger) 16%, transparent);
        border-color: color-mix(in oklab, var(--danger) 26%, transparent);
      }

      .day .spark {
        position: absolute;
        inset: -30%;
        opacity: calc(0.45 * var(--decor-on));
        background: radial-gradient(
            14px 14px at 22% 22%,
            rgba(255, 255, 255, 0.55),
            transparent 60%
          ),
          radial-gradient(
            18px 18px at 78% 32%,
            rgba(255, 255, 255, 0.28),
            transparent 62%
          ),
          radial-gradient(
            22px 22px at 36% 78%,
            rgba(255, 255, 255, 0.22),
            transparent 62%
          ),
          radial-gradient(
            220px 220px at 30% 20%,
            color-mix(in oklab, var(--accent) 16%, transparent),
            transparent 62%
          );
        transform: rotate(12deg);
        pointer-events: none;
      }

      /* ‰ªäÊó•/Ë°•ÂΩï */
      .date-line {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        flex-wrap: wrap;
        margin-bottom: 10px;
      }
      .date-line .left {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
      }
      .date-pill {
        font-weight: 950;
        letter-spacing: 0.2px;
        padding: 8px 10px;
        border-radius: 999px;
        background: color-mix(in oklab, var(--surface2) 84%, transparent);
        border: var(--stroke) solid
          color-mix(in oklab, var(--border) 70%, white);
        box-shadow: 0 8px 16px rgba(15, 16, 26, 0.06);
      }
      .hint {
        font-size: 12px;
        color: var(--muted);
        font-weight: 750;
      }

      .dose-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-top: 10px;
      }
      .dose {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 10px;
        padding: 12px 12px;
        border-radius: 16px;
        border: var(--stroke) solid
          color-mix(in oklab, var(--border) 70%, white);
        background: color-mix(in oklab, var(--surface) 80%, transparent);
        box-shadow: 0 10px 18px rgba(15, 16, 26, 0.06);
        position: relative;
        overflow: hidden;
      }
      .dose::before {
        content: "";
        position: absolute;
        inset: -40%;
        opacity: calc(0.4 * var(--decor-on));
        background: radial-gradient(
            18px 18px at 22% 22%,
            rgba(255, 255, 255, 0.55),
            transparent 62%
          ),
          radial-gradient(
            260px 260px at 20% 10%,
            color-mix(in oklab, var(--accent) 12%, transparent),
            transparent 60%
          );
        transform: rotate(10deg);
        pointer-events: none;
      }
      .dose .left {
        display: flex;
        gap: 12px;
        align-items: flex-start;
        position: relative;
        z-index: 1;
      }
      .icon {
        width: 40px;
        height: 40px;
        display: grid;
        place-items: center;
        border-radius: 14px;
        background: color-mix(in oklab, var(--accent2) 52%, white);
        border: var(--stroke) solid
          color-mix(in oklab, var(--border) 60%, white);
        box-shadow: 0 8px 14px rgba(15, 16, 26, 0.08);
        font-size: 18px;
        flex: none;
        position: relative;
        overflow: hidden;
      }
      .icon::after {
        content: "";
        position: absolute;
        inset: -40%;
        opacity: calc(0.55 * var(--decor-on));
        background: conic-gradient(
          from 180deg at 50% 50%,
          rgba(255, 255, 255, 0.22),
          transparent 35%,
          rgba(255, 255, 255, 0.12)
        );
        transform: rotate(8deg);
        pointer-events: none;
      }
      .dose .name {
        font-weight: 950;
        font-size: 13px;
        line-height: 1.2;
        margin-top: 2px;
      }
      .dose .desc {
        margin-top: 6px;
        font-size: 12px;
        color: var(--muted);
        font-weight: 780;
        display: flex;
        flex-wrap: wrap;
        gap: 8px 10px;
        align-items: center;
      }
      .dose .right {
        display: flex;
        flex-direction: column;
        gap: 8px;
        align-items: flex-end;
        justify-content: center;
        position: relative;
        z-index: 2;
      }
      .state {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 7px 10px;
        border-radius: 999px;
        border: var(--stroke) solid
          color-mix(in oklab, var(--border) 70%, white);
        background: rgba(255, 255, 255, 0.18);
        font-size: 12px;
        font-weight: 860;
        backdrop-filter: blur(var(--blur));
        user-select: none;
      }
      .state.taken {
        border-color: color-mix(in oklab, var(--ok) 35%, var(--border));
        background: color-mix(in oklab, var(--ok) 16%, transparent);
      }
      .state.missed {
        border-color: color-mix(in oklab, var(--danger) 35%, var(--border));
        background: color-mix(in oklab, var(--danger) 16%, transparent);
      }
      .minirow {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        justify-content: flex-end;
      }

      /* ËçØÁÆ± */
      .med-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .med {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 10px;
        padding: 12px 12px;
        border-radius: 16px;
        border: var(--stroke) solid
          color-mix(in oklab, var(--border) 70%, white);
        background: color-mix(in oklab, var(--surface) 80%, transparent);
        box-shadow: 0 10px 18px rgba(15, 16, 26, 0.06);
        position: relative;
        overflow: hidden;
      }
      .med::before {
        content: "";
        position: absolute;
        inset: -40%;
        opacity: calc(0.35 * var(--decor-on));
        background: radial-gradient(
            20px 20px at 22% 22%,
            rgba(255, 255, 255, 0.55),
            transparent 62%
          ),
          radial-gradient(
            240px 240px at 80% 30%,
            color-mix(in oklab, var(--accent2) 24%, transparent),
            transparent 62%
          );
        transform: rotate(12deg);
        pointer-events: none;
      }
      .med .left {
        display: flex;
        gap: 12px;
        align-items: flex-start;
        position: relative;
        z-index: 1;
      }
      .med .name {
        font-weight: 950;
        font-size: 13px;
        line-height: 1.2;
        margin-top: 2px;
      }
      .med .desc {
        margin-top: 6px;
        font-size: 12px;
        color: var(--muted);
        font-weight: 780;
        display: flex;
        flex-wrap: wrap;
        gap: 8px 10px;
      }
      .med .right {
        display: flex;
        gap: 8px;
        align-items: center;
        justify-content: flex-end;
        position: relative;
        z-index: 2;
      }

      .low {
        color: color-mix(in oklab, var(--danger) 80%, var(--text));
        font-weight: 900;
      }

      /* ÁªüËÆ° */
      .stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
      }
      @media (max-width: 520px) {
        .stats {
          grid-template-columns: 1fr;
        }
      }
      .stat {
        padding: 12px 12px;
        border-radius: 16px;
        border: var(--stroke) solid
          color-mix(in oklab, var(--border) 70%, white);
        background: color-mix(in oklab, var(--surface) 78%, transparent);
        box-shadow: 0 10px 18px rgba(15, 16, 26, 0.06);
        position: relative;
        overflow: hidden;
      }
      .stat::before {
        content: "";
        position: absolute;
        inset: -40%;
        opacity: calc(0.3 * var(--decor-on));
        background: radial-gradient(
            220px 220px at 20% 10%,
            color-mix(in oklab, var(--accent) 12%, transparent),
            transparent 60%
          ),
          radial-gradient(
            260px 260px at 88% 70%,
            color-mix(in oklab, var(--accent2) 22%, transparent),
            transparent 62%
          );
        transform: rotate(10deg);
        pointer-events: none;
      }
      .stat .k {
        font-size: 12px;
        color: var(--muted);
        font-weight: 820;
        position: relative;
        z-index: 1;
      }
      .stat .v {
        margin-top: 6px;
        font-size: 20px;
        font-weight: 980;
        letter-spacing: 0.2px;
        position: relative;
        z-index: 1;
      }

      /* ÂºπÁ™ó */
      .overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.34);
        display: none;
        z-index: 40;
        align-items: center;
        justify-content: center;
        padding: 18px;
      }
      .overlay.show {
        display: flex;
      }
      .modal {
        width: min(680px, 96vw);
        border-radius: 22px;
        background: color-mix(in oklab, var(--surface) 75%, transparent);
        border: var(--stroke) solid
          color-mix(in oklab, var(--border) 70%, white);
        box-shadow: 0 26px 70px rgba(0, 0, 0, 0.35);
        backdrop-filter: blur(18px);
        overflow: hidden;
        position: relative;
      }
      .modal::before {
        content: "";
        position: absolute;
        inset: -30%;
        opacity: calc(0.55 * var(--decor-on));
        background: radial-gradient(
            280px 280px at 20% 12%,
            color-mix(in oklab, var(--accent) 16%, transparent),
            transparent 62%
          ),
          radial-gradient(
            320px 320px at 86% 26%,
            color-mix(in oklab, var(--accent2) 26%, transparent),
            transparent 62%
          ),
          radial-gradient(
            18px 18px at 22% 22%,
            rgba(255, 255, 255, 0.55),
            transparent 62%
          ),
          radial-gradient(
            22px 22px at 78% 30%,
            rgba(255, 255, 255, 0.28),
            transparent 62%
          );
        transform: rotate(10deg);
        pointer-events: none;
      }
      .modal header {
        padding: 14px 14px 10px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        position: relative;
        z-index: 1;
      }
      .modal header h3 {
        margin: 0;
        font-size: 14px;
        font-weight: 960;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .modal .body {
        padding: 0 14px 14px;
        position: relative;
        z-index: 1;
      }
      .form {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-top: 10px;
      }
      @media (max-width: 720px) {
        .form {
          grid-template-columns: 1fr;
        }
      }
      label {
        display: flex;
        flex-direction: column;
        gap: 6px;
        font-size: 12px;
        font-weight: 850;
        color: color-mix(in oklab, var(--text) 86%, var(--muted));
      }
      input,
      textarea,
      select {
        width: 100%;
        padding: 10px 10px;
        border-radius: 14px;
        border: var(--stroke) solid
          color-mix(in oklab, var(--border) 70%, white);
        background: rgba(255, 255, 255, 0.45);
        color: var(--text);
        outline: none;
        font-size: 13px;
        font-weight: 780;
        box-shadow: 0 10px 18px rgba(15, 16, 26, 0.06);
      }
      textarea {
        min-height: 80px;
        resize: vertical;
      }
      input:focus,
      textarea:focus,
      select:focus {
        border-color: color-mix(in oklab, var(--accent) 55%, var(--border));
        box-shadow: 0 0 0 4px
            color-mix(in oklab, var(--accent) 18%, transparent),
          0 12px 22px rgba(15, 16, 26, 0.08);
        background: rgba(255, 255, 255, 0.65);
      }
      .modal footer {
        padding: 12px 14px 14px;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        flex-wrap: wrap;
        position: relative;
        z-index: 1;
      }

      /* Toast */
      .toast {
        position: fixed;
        left: 50%;
        transform: translateX(-50%);
        bottom: 16px;
        z-index: 60;
        display: none;
        width: min(820px, 92vw);
        padding: 12px 12px;
        border-radius: 18px;
        background: color-mix(in oklab, var(--surface) 70%, transparent);
        border: var(--stroke) solid
          color-mix(in oklab, var(--border) 70%, white);
        box-shadow: 0 22px 60px rgba(0, 0, 0, 0.28);
        backdrop-filter: blur(18px);
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }
      .toast.show {
        display: flex;
      }
      .toast .msg {
        font-size: 13px;
        font-weight: 860;
        color: var(--text);
      }
      .toast .act {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: flex-end;
      }

      /* È°µËÑö‰ΩúËÄÖ */
      .author {
        position: fixed;
        right: 12px;
        bottom: 10px;
        z-index: 5;
        font-size: 11px;
        font-weight: 850;
        color: color-mix(in oklab, var(--muted) 82%, var(--text));
        padding: 6px 10px;
        border-radius: 999px;
        border: var(--stroke) solid
          color-mix(in oklab, var(--border) 70%, white);
        background: color-mix(in oklab, var(--surface) 60%, transparent);
        backdrop-filter: blur(16px);
        box-shadow: 0 12px 22px rgba(0, 0, 0, 0.12);
        user-select: none;
      }

      /* ÂÖ≥Âä®Êïà */
      body.motion-off * {
        transition: none !important;
        animation: none !important;
        scroll-behavior: auto !important;
      }
      /* ÂÖ≥Ë£ÖÈ•∞ */
      body.decor-off {
        --decor-on: 0;
      }

      /* =========================================================
      12 Â•ó‰∏ªÈ¢òÔºàÊØèÂ•ó‰∏ç‰ªÖÊç¢Ëâ≤ÔºåËøòÊç¢ÊùêË¥®/Ëæπ/ÂÖâÊôï/ËäØÁâáÂΩ¢ÊÄÅ/Â≠ó‰ΩìÁ≠ñÁï•Ôºâ
    ========================================================= */

      /* 1) Katy Pink ¬∑ Sticker Kawaii */
      html[data-theme="katy-pink"] {
        --bg: #fff5fb;
        --surface: #ffffff;
        --surface2: #fff0f7;
        --text: #1f1f23;
        --muted: #6b6b74;
        --border: rgba(20, 20, 30, 0.12);
        --accent: #ff5ea8;
        --accent2: #ffd1e5;
        --font: var(--rounded);

        --card-radius: 22px;
        --card-surface: color-mix(
          in oklab,
          #ffffff 92%,
          rgba(255, 255, 255, 0.2)
        );
        --card-border: rgba(20, 20, 30, 0.1);
        --card-shadow: 0 10px 28px rgba(20, 20, 30, 0.1);
        --card-overlay-opacity: 0.55;
        --card-overlay: radial-gradient(
            14px 14px at 10% 18%,
            rgba(255, 94, 168, 0.18),
            transparent 60%
          ),
          radial-gradient(
            12px 12px at 22% 32%,
            rgba(255, 94, 168, 0.14),
            transparent 60%
          ),
          radial-gradient(
            10px 10px at 85% 24%,
            rgba(255, 209, 229, 0.22),
            transparent 60%
          ),
          radial-gradient(
            18px 18px at 72% 78%,
            rgba(255, 94, 168, 0.1),
            transparent 60%
          ),
          repeating-radial-gradient(
            circle at 20% 20%,
            rgba(255, 94, 168, 0.1) 0 1px,
            transparent 1px 18px
          );
        --card-outline: 2px solid rgba(255, 94, 168, 0.2);
        --card-glow: 0 0 0 8px rgba(255, 94, 168, 0.06) inset;

        --btn-radius: 16px;
        --btn-bg: linear-gradient(135deg, #ff5ea8 0%, #ffd1e5 100%);
        --btn-text: #2b0017;
        --btn-shadow: 0 10px 20px rgba(255, 94, 168, 0.18);
        --btn-shadow-hover: 0 14px 28px rgba(255, 94, 168, 0.22);

        --chip-radius: 999px;
        --logo-radius: 16px;
      }

      /* 2) Milk Tea ¬∑ Paper Warm */
      html[data-theme="milk-tea"] {
        --bg: #fbf6ef;
        --surface: #ffffff;
        --surface2: #f4ede3;
        --text: #1f1f23;
        --muted: #6b675f;
        --border: rgba(25, 20, 15, 0.14);
        --accent: #d48b6a;
        --accent2: #f2d3b9;
        --font: var(--rounded);

        --card-radius: 18px;
        --card-surface: #fffdf9;
        --card-border: rgba(25, 20, 15, 0.16);
        --card-shadow: 0 12px 26px rgba(25, 20, 15, 0.1);
        --card-overlay-opacity: 0.4;
        --card-overlay: radial-gradient(
            90px 90px at 22% 38%,
            rgba(212, 139, 106, 0.12),
            transparent 60%
          ),
          radial-gradient(
            140px 140px at 70% 36%,
            rgba(212, 139, 106, 0.1),
            transparent 62%
          ),
          radial-gradient(
            120px 120px at 28% 72%,
            rgba(0, 0, 0, 0.03),
            transparent 60%
          ),
          repeating-linear-gradient(
            0deg,
            rgba(0, 0, 0, 0.025) 0 1px,
            transparent 1px 28px
          );
        --card-overlay-blend: multiply;
        --card-outline: 1px solid rgba(212, 139, 106, 0.18);

        --btn-radius: 14px;
        --btn-bg: linear-gradient(135deg, #d48b6a 0%, #f2d3b9 100%);
        --btn-text: #24170f;
        --btn-shadow: 0 10px 18px rgba(212, 139, 106, 0.16);

        --chip-radius: 14px;
        --chip-bg: rgba(255, 255, 255, 0.7);
        --chip-br: rgba(25, 20, 15, 0.1);
      }

      /* 3) Peach Bloom ¬∑ Petals */
      html[data-theme="peach-bloom"] {
        --bg: #fff3ee;
        --surface: #ffffff;
        --surface2: #ffe7dc;
        --text: #1f1f23;
        --muted: #6d645f;
        --border: rgba(25, 20, 15, 0.12);
        --accent: #ff7a4a;
        --accent2: #ffd2bf;
        --font: var(--rounded);

        --card-radius: 22px;
        --card-surface: color-mix(
          in oklab,
          #ffffff 88%,
          rgba(255, 255, 255, 0.25)
        );
        --card-shadow: 0 14px 30px rgba(25, 20, 15, 0.1);
        --card-overlay-opacity: 0.55;
        --card-overlay: conic-gradient(
            from 210deg at 24% 34%,
            rgba(255, 122, 74, 0.16),
            transparent 40%
          ),
          conic-gradient(
            from 120deg at 78% 28%,
            rgba(255, 210, 191, 0.22),
            transparent 48%
          ),
          radial-gradient(
            220px 220px at 30% 70%,
            rgba(255, 122, 74, 0.1),
            transparent 60%
          ),
          radial-gradient(
            260px 260px at 86% 70%,
            rgba(255, 210, 191, 0.14),
            transparent 62%
          );
        --card-glow: 0 0 0 10px rgba(255, 122, 74, 0.05) inset;

        --btn-radius: 16px;
        --btn-bg: linear-gradient(135deg, #ff7a4a 0%, #ffd2bf 100%);
        --btn-text: #2a0b00;
        --btn-shadow: 0 12px 22px rgba(255, 122, 74, 0.18);

        --chip-radius: 999px;
      }

      /* 4) Clinic White ¬∑ Form */
      html[data-theme="clinic-white"] {
        --bg: #f6f8fb;
        --surface: #ffffff;
        --surface2: #eef3fb;
        --text: #101218;
        --muted: #596274;
        --border: rgba(16, 18, 24, 0.16);
        --accent: #4a86ff;
        --accent2: #cfe0ff;
        --font: var(--mono);

        --card-radius: 12px;
        --card-surface: #ffffff;
        --card-border: rgba(16, 18, 24, 0.18);
        --card-shadow: 0 12px 22px rgba(16, 18, 24, 0.1);
        --card-overlay-opacity: 0.65;
        --card-overlay: repeating-linear-gradient(
            0deg,
            rgba(16, 18, 24, 0.05) 0 1px,
            transparent 1px 24px
          ),
          repeating-linear-gradient(
            90deg,
            rgba(16, 18, 24, 0.035) 0 1px,
            transparent 1px 30px
          );
        --card-outline: 1px solid rgba(74, 134, 255, 0.18);

        --btn-radius: 12px;
        --btn-bg: linear-gradient(135deg, #4a86ff 0%, #cfe0ff 100%);
        --btn-text: #0b1224;
        --btn-border: 1px solid rgba(16, 18, 24, 0.1);
        --btn-shadow: 0 10px 18px rgba(74, 134, 255, 0.16);

        --chip-radius: 10px;
        --chip-bg: rgba(255, 255, 255, 0.85);
        --chip-br: rgba(16, 18, 24, 0.12);
      }

      /* 5) Blue Calm ¬∑ Glass */
      html[data-theme="blue-calm"] {
        --bg: #f3f7ff;
        --surface: #ffffff;
        --surface2: #e9f0ff;
        --text: #0f1320;
        --muted: #55607a;
        --border: rgba(15, 19, 32, 0.16);
        --accent: #2f6bff;
        --accent2: #c7d7ff;
        --font: var(--mono);

        --card-radius: 18px;
        --card-surface: color-mix(
          in oklab,
          #ffffff 68%,
          rgba(255, 255, 255, 0.35)
        );
        --card-border: rgba(47, 107, 255, 0.22);
        --card-shadow: 0 14px 30px rgba(15, 19, 32, 0.14);
        --card-overlay-opacity: 0.55;
        --card-overlay: linear-gradient(
            180deg,
            rgba(255, 255, 255, 0.35),
            rgba(255, 255, 255, 0.1)
          ),
          radial-gradient(
            240px 240px at 20% 18%,
            rgba(47, 107, 255, 0.12),
            transparent 60%
          ),
          radial-gradient(
            280px 280px at 86% 30%,
            rgba(199, 215, 255, 0.2),
            transparent 62%
          );
        --card-outline: 1px solid rgba(255, 255, 255, 0.45);
        --card-glow: 0 0 0 10px rgba(47, 107, 255, 0.05) inset;

        --btn-radius: 16px;
        --btn-bg: linear-gradient(
          135deg,
          rgba(47, 107, 255, 0.92),
          rgba(199, 215, 255, 0.92)
        );
        --btn-text: #07102a;
        --btn-shadow: 0 14px 26px rgba(47, 107, 255, 0.18);

        --chip-radius: 999px;
      }

      /* 6) Mint Fresh ¬∑ Breath */
      html[data-theme="mint-fresh"] {
        --bg: #f2fffb;
        --surface: #ffffff;
        --surface2: #e6fff6;
        --text: #0f1717;
        --muted: #4c6a64;
        --border: rgba(15, 23, 23, 0.14);
        --accent: #22c7a2;
        --accent2: #bff4e7;
        --font: var(--rounded);

        --card-radius: 22px;
        --card-surface: color-mix(
          in oklab,
          #ffffff 78%,
          rgba(255, 255, 255, 0.28)
        );
        --card-border: rgba(34, 199, 162, 0.2);
        --card-shadow: 0 14px 30px rgba(15, 23, 23, 0.1);
        --card-overlay-opacity: 0.55;
        --card-overlay: radial-gradient(
            18px 18px at 18% 22%,
            rgba(34, 199, 162, 0.18),
            transparent 65%
          ),
          radial-gradient(
            22px 22px at 32% 44%,
            rgba(34, 199, 162, 0.14),
            transparent 65%
          ),
          radial-gradient(
            26px 26px at 80% 28%,
            rgba(34, 199, 162, 0.14),
            transparent 65%
          ),
          radial-gradient(
            30px 30px at 72% 72%,
            rgba(34, 199, 162, 0.12),
            transparent 65%
          ),
          radial-gradient(
            320px 320px at 20% 20%,
            rgba(191, 244, 231, 0.3),
            transparent 62%
          );
        --card-outline: 1px solid rgba(255, 255, 255, 0.55);

        --btn-radius: 18px;
        --btn-bg: linear-gradient(135deg, #22c7a2 0%, #bff4e7 100%);
        --btn-text: #041a13;
        --btn-shadow: 0 12px 22px rgba(34, 199, 162, 0.16);

        --chip-radius: 999px;
      }

      /* 7) Night Cat ¬∑ NeonÔºàÂ∑≤‰øÆÊ≠£ÔºöÂ≠ó‰Ωì/ÂØπÊØîÂ∫¶ÂèØËØªÔºâ */
      html[data-theme="night-cat"] {
        --bg: #0f1420;
        --surface: #151c2b;
        --surface2: #0f1726;
        --text: #eef1f8;
        --muted: #a7b0c6;
        --border: rgba(255, 255, 255, 0.12);
        --accent: #7aa2ff;
        --accent2: #2a3c68;
        --font: var(--rounded);

        --chip-bg: rgba(255, 255, 255, 0.08);
        --chip-br: rgba(255, 255, 255, 0.14);

        --card-radius: 18px;
        --card-surface: rgba(21, 28, 43, 0.86);
        --card-border: rgba(122, 162, 255, 0.22);
        --card-shadow: 0 18px 44px rgba(0, 0, 0, 0.45);
        --card-overlay-opacity: 0.55;
        --card-overlay: radial-gradient(
            1.4px 1.4px at 12% 22%,
            rgba(255, 255, 255, 0.38),
            transparent 60%
          ),
          radial-gradient(
            1.2px 1.2px at 24% 30%,
            rgba(255, 255, 255, 0.26),
            transparent 60%
          ),
          radial-gradient(
            1.3px 1.3px at 82% 20%,
            rgba(255, 255, 255, 0.3),
            transparent 60%
          ),
          radial-gradient(
            280px 280px at 20% 18%,
            rgba(122, 162, 255, 0.18),
            transparent 60%
          ),
          radial-gradient(
            320px 320px at 86% 30%,
            rgba(179, 140, 255, 0.1),
            transparent 62%
          );
        --card-glow: 0 0 0 1px rgba(122, 162, 255, 0.18) inset,
          0 0 40px rgba(122, 162, 255, 0.1);

        --btn-radius: 16px;
        --btn-bg: linear-gradient(
          135deg,
          rgba(122, 162, 255, 0.95),
          rgba(42, 60, 104, 0.95)
        );
        --btn-text: #eef1ff;
        --btn-border: 1px solid rgba(255, 255, 255, 0.12);
        --btn-shadow: 0 16px 28px rgba(0, 0, 0, 0.32);

        --btn-secondary-bg: rgba(255, 255, 255, 0.06);
        --btn-secondary-border: 1px solid rgba(255, 255, 255, 0.14);
        --btn-secondary-text: #eef1f8;
      }

      /* 8) Moonlight ¬∑ Soft Night */
      html[data-theme="moonlight"] {
        --bg: #11152a;
        --surface: #171c36;
        --surface2: #111c35;
        --text: #eff1ff;
        --muted: #b2b8d6;
        --border: rgba(255, 255, 255, 0.12);
        --accent: #b38cff;
        --accent2: #2d2a66;
        --font: var(--rounded);

        --chip-bg: rgba(255, 255, 255, 0.08);
        --chip-br: rgba(255, 255, 255, 0.14);

        --card-radius: 22px;
        --card-surface: rgba(23, 28, 54, 0.86);
        --card-border: rgba(179, 140, 255, 0.22);
        --card-shadow: 0 18px 46px rgba(0, 0, 0, 0.45);
        --card-overlay-opacity: 0.55;
        --card-overlay: radial-gradient(
            420px 420px at 72% 18%,
            rgba(255, 255, 255, 0.14),
            transparent 60%
          ),
          radial-gradient(
            520px 520px at 72% 18%,
            rgba(179, 140, 255, 0.14),
            transparent 62%
          ),
          radial-gradient(
            320px 320px at 18% 66%,
            rgba(122, 162, 255, 0.12),
            transparent 62%
          ),
          repeating-linear-gradient(
            0deg,
            rgba(255, 255, 255, 0.03) 0 1px,
            transparent 1px 26px
          );
        --card-glow: 0 0 0 1px rgba(179, 140, 255, 0.18) inset;

        --btn-radius: 18px;
        --btn-bg: linear-gradient(
          135deg,
          rgba(179, 140, 255, 0.92),
          rgba(45, 42, 102, 0.96)
        );
        --btn-text: #f4f2ff;
        --btn-border: 1px solid rgba(255, 255, 255, 0.12);
      }

      /* 9) Ink Black ¬∑ Terminal */
      html[data-theme="ink-black"] {
        --bg: #090a0f;
        --surface: #0f111a;
        --surface2: #0a0d14;
        --text: #f4f6ff;
        --muted: #b1b6c8;
        --border: rgba(255, 255, 255, 0.12);
        --accent: #e7e9ff;
        --accent2: #2a2f45;
        --font: var(--mono);

        --chip-bg: rgba(255, 255, 255, 0.07);
        --chip-br: rgba(255, 255, 255, 0.12);

        --card-radius: 12px;
        --card-surface: rgba(15, 17, 26, 0.92);
        --card-border: rgba(231, 233, 255, 0.18);
        --card-shadow: 0 22px 60px rgba(0, 0, 0, 0.55);
        --card-overlay-opacity: 0.55;
        --card-overlay: repeating-linear-gradient(
            0deg,
            rgba(255, 255, 255, 0.05) 0 1px,
            transparent 1px 18px
          ),
          radial-gradient(
            520px 520px at 20% 20%,
            rgba(231, 233, 255, 0.06),
            transparent 62%
          );
        --card-outline: 1px solid rgba(231, 233, 255, 0.12);

        --btn-radius: 10px;
        --btn-bg: linear-gradient(
          135deg,
          rgba(231, 233, 255, 0.18),
          rgba(42, 47, 69, 0.72)
        );
        --btn-text: #f4f6ff;
        --btn-border: 1px solid rgba(255, 255, 255, 0.14);
        --btn-shadow: 0 14px 26px rgba(0, 0, 0, 0.38);

        --btn-secondary-bg: rgba(255, 255, 255, 0.05);
        --btn-secondary-border: 1px solid rgba(255, 255, 255, 0.12);
        --btn-secondary-text: #f4f6ff;
      }

      /* 10) Minimal Paper ¬∑ Editorial */
      html[data-theme="minimal-paper"] {
        --bg: #fbfbfb;
        --surface: #ffffff;
        --surface2: #f3f3f3;
        --text: #111111;
        --muted: #5a5a5a;
        --border: rgba(0, 0, 0, 0.14);
        --accent: #111111;
        --accent2: #dfdfdf;
        --font: var(--mono);

        --card-radius: 14px;
        --card-surface: #ffffff;
        --card-border: rgba(0, 0, 0, 0.16);
        --card-shadow: 0 14px 28px rgba(0, 0, 0, 0.1);
        --card-overlay-opacity: 0.35;
        --card-overlay: repeating-linear-gradient(
          0deg,
          rgba(0, 0, 0, 0.035) 0 1px,
          transparent 1px 26px
        );
        --card-outline: 1px dashed rgba(0, 0, 0, 0.18);

        --btn-radius: 12px;
        --btn-bg: linear-gradient(180deg, #111111, #2a2a2a);
        --btn-text: #ffffff;
        --btn-shadow: 0 10px 18px rgba(0, 0, 0, 0.18);

        --btn-secondary-bg: rgba(0, 0, 0, 0.04);
        --btn-secondary-border: 1px solid rgba(0, 0, 0, 0.14);
        --btn-secondary-text: #111111;

        --chip-radius: 12px;
        --chip-bg: rgba(0, 0, 0, 0.04);
        --chip-br: rgba(0, 0, 0, 0.1);

        --logo-bg: linear-gradient(180deg, #111111, #3a3a3a);
        --logo-shadow: 0 8px 16px rgba(0, 0, 0, 0.12);
      }

      /* 11) Mono Grey ¬∑ Blueprint */
      html[data-theme="mono-grey"] {
        --bg: #f4f5f7;
        --surface: #ffffff;
        --surface2: #eceef2;
        --text: #15171b;
        --muted: #5e6570;
        --border: rgba(0, 0, 0, 0.12);
        --accent: #3a3f49;
        --accent2: #d7dbe3;
        --font: var(--mono);

        --card-radius: 14px;
        --card-surface: #ffffff;
        --card-border: rgba(0, 0, 0, 0.14);
        --card-shadow: 0 14px 26px rgba(0, 0, 0, 0.1);
        --card-overlay-opacity: 0.55;
        --card-overlay: repeating-linear-gradient(
            0deg,
            rgba(58, 63, 73, 0.05) 0 1px,
            transparent 1px 24px
          ),
          repeating-linear-gradient(
            90deg,
            rgba(58, 63, 73, 0.035) 0 1px,
            transparent 1px 28px
          ),
          radial-gradient(
            420px 420px at 82% 18%,
            rgba(0, 0, 0, 0.04),
            transparent 62%
          );
        --card-outline: 1px solid rgba(58, 63, 73, 0.12);

        --btn-radius: 12px;
        --btn-bg: linear-gradient(135deg, #3a3f49 0%, #d7dbe3 100%);
        --btn-text: #101318;
        --btn-shadow: 0 10px 18px rgba(0, 0, 0, 0.12);

        --chip-radius: 10px;
      }

      /* 12) Archive ¬∑ Label System */
      html[data-theme="archive"] {
        --bg: #faf9f5;
        --surface: #ffffff;
        --surface2: #f1efe7;
        --text: #15130f;
        --muted: #6c665b;
        --border: rgba(21, 19, 15, 0.13);
        --accent: #ff8c00;
        --accent2: #ffe2bf;
        --font: var(--mono);

        --card-radius: 14px;
        --card-surface: #fffef9;
        --card-border: rgba(21, 19, 15, 0.16);
        --card-shadow: 0 14px 28px rgba(21, 19, 15, 0.1);
        --card-overlay-opacity: 0.55;
        --card-overlay: linear-gradient(
            90deg,
            rgba(255, 140, 0, 0.16) 0 10px,
            transparent 10px 100%
          ),
          linear-gradient(
            90deg,
            rgba(80, 140, 255, 0.12) 0 6px,
            transparent 6px 100%
          ),
          repeating-linear-gradient(
            0deg,
            rgba(0, 0, 0, 0.04) 0 1px,
            transparent 1px 26px
          );
        --card-outline: 1px solid rgba(255, 140, 0, 0.16);

        --btn-radius: 12px;
        --btn-bg: linear-gradient(135deg, #ff8c00 0%, #ffe2bf 100%);
        --btn-text: #2a1500;
        --btn-shadow: 0 12px 22px rgba(255, 140, 0, 0.16);

        --chip-radius: 10px;
        --chip-bg: rgba(255, 255, 255, 0.78);
        --chip-br: rgba(21, 19, 15, 0.12);
      }
    </style>
  </head>

  <body>
    <div class="wallpaper" aria-hidden="true"></div>

    <div class="app" id="app">
      <div class="topbar">
        <div class="brand">
          <div class="logo" aria-hidden="true">üéÄ</div>
          <div>
            <h1>Áî®ËçØËÆ∞ÂΩïÂô®</h1>
            <div class="sub">Êó•ÂéÜ ¬∑ ËçØÁÆ± </div>
          </div>
        </div>

        <div class="top-actions">
          <span class="chip" id="chipStorage">üíæ Êú¨Âú∞‰øùÂ≠ò</span>
          <button class="btn secondary small" id="btnDecor">‚ú® Ë£ÖÈ•∞ÔºöÂºÄ</button>
          <button class="btn secondary small" id="btnMotion">
            üéûÔ∏è Âä®ÊïàÔºöÂºÄ
          </button>

          <select
            id="themeSelect"
            class="btn secondary small"
            style="padding: 9px 10px; cursor: pointer"
          >
            <option value="katy-pink">üéÄ Katy Pink</option>
            <option value="milk-tea">üßã Milk Tea</option>
            <option value="peach-bloom">üçë Peach Bloom</option>
            <option value="clinic-white">üßæ Clinic White</option>
            <option value="blue-calm">ü´ß Blue Calm</option>
            <option value="mint-fresh">üåø Mint Fresh</option>
            <option value="night-cat">üåô Night Cat</option>
            <option value="moonlight">üíú Moonlight</option>
            <option value="ink-black">‚å®Ô∏è Ink Black</option>
            <option value="minimal-paper">üìÑ Minimal Paper</option>
            <option value="mono-grey">üìê Mono Grey</option>
            <option value="archive">üè∑Ô∏è Archive</option>
          </select>

          <button class="btn small" id="btnAddMed">‚ûï Ê∑ªÂä†ËçØÁâ©</button>
          <button class="btn secondary small" id="btnTools">üß∞ Â∑•ÂÖ∑</button>
        </div>
      </div>

      <div class="grid">
        <!-- Â∑¶ÔºöÊó•ÂéÜ + ÈÄâ‰∏≠Êó•ÊúüÁî®ËçØ -->
        <div class="card">
          <div class="section-title">
            <h2>üóìÔ∏è ÊúçËçØÊó•ÂéÜ</h2>
            <div class="meta">
              <span class="chip" id="monthRate">üìà Êú¨ÊúàÔºö--%</span>
              <span class="chip" id="streak">üî• ËøûÁª≠Ôºö--</span>
            </div>
          </div>

          <div class="cal-head">
            <div class="month" id="monthLabel">--</div>
            <div class="meta">
              <button class="btn secondary small" id="prevMonth">‚óÄ</button>
              <button class="btn secondary small" id="todayBtn">üìç ‰ªäÂ§©</button>
              <button class="btn secondary small" id="nextMonth">‚ñ∂</button>
            </div>
          </div>

          <div class="cal-grid" id="dowRow"></div>
          <div class="cal-grid" id="calGrid"></div>
        </div>

        <!-- Âè≥Ôºö‰ªäÊó•/Ë°•ÂΩï + ËçØÁÆ± + ÁªüËÆ° -->
        <div style="display: flex; flex-direction: column; gap: 14px">
          <div class="card">
            <div class="section-title">
              <h2>üíä ÂΩìÂ§©Áî®ËçØ / Ë°•ÂΩï</h2>
              <div class="meta">
                <span class="chip" id="selSummary">‚úÖ -- / --</span>
                <button class="btn secondary small" id="markAllBtn">
                  ‰∏ÄÈîÆÂÖ®Â∑≤Êúç
                </button>
              </div>
            </div>
            <div class="pad">
              <div class="date-line">
                <div class="left">
                  <span class="date-pill" id="selectedDatePill">--</span>
                  <span class="hint" id="selectedHint"
                    >ÁÇπÂáªÊó•ÂéÜÊüêÂ§©Âç≥ÂèØË°•ÂΩï / ‰øÆÊîπ</span
                  >
                </div>
                <div class="minirow">
                  <button class="btn secondary small" id="btnQuickMissed">
                    ‚ö†Ô∏è Ê†áËÆ∞ÊºèÊúç
                  </button>
                  <button class="btn secondary small" id="btnClearDay">
                    üßº Ê∏ÖÁ©∫ÂΩìÂ§©ËÆ∞ÂΩï
                  </button>
                </div>
              </div>

              <div class="dose-list" id="doseList"></div>
              <div
                class="hint"
                id="emptyDoseHint"
                style="margin-top: 10px; display: none"
              >
                ÁõÆÂâçËçØÁÆ±‰∏∫Á©∫„ÄÇÂÖàÁÇπ‚ÄúÊ∑ªÂä†ËçØÁâ©‚ÄùÔºåÂÜçÂõûÂà∞ËøôÈáåÊâìÂç°„ÄÇ
              </div>
            </div>
          </div>

          <div class="card">
            <div class="section-title">
              <h2>üéí ÊàëÁöÑËçØÁÆ±</h2>
              <div class="meta">
                <span class="chip" id="medCount">üì¶ --</span>
                <button class="btn secondary small" id="btnReset">
                  üß™ Êñ∞Âª∫Á©∫ÁôΩËçØÁÆ±
                </button>
              </div>
            </div>
            <div class="pad">
              <div class="med-list" id="medList"></div>
              <div
                class="hint"
                id="emptyMedHint"
                style="margin-top: 10px; display: none"
              >
                ËøòÊ≤°ÊúâËçØÁâ©„ÄÇÊ∑ªÂä†Âêé‰ºöËá™Âä®ÁîüÊàêÊØèÊó•ËÆ°Âàí„ÄÇ
              </div>
            </div>
          </div>

          <div class="card">
            <div class="section-title">
              <h2>üìä ÁªüËÆ°</h2>
              <div class="meta">
                <span class="chip" id="totalDosesChip">üßÆ Êú¨ÊúàÂâÇÈáèÔºö--</span>
              </div>
            </div>
            <div class="pad">
              <div class="stats">
                <div class="stat">
                  <div class="k">Êú¨ÊúàÊåâÊó∂Áéá</div>
                  <div class="v" id="statRate">--%</div>
                </div>
                <div class="stat">
                  <div class="k">Êú¨ÊúàÂ∑≤Êúç</div>
                  <div class="v" id="statTaken">--</div>
                </div>
                <div class="stat">
                  <div class="k">Êú¨ÊúàÊºèÊúç</div>
                  <div class="v" id="statMissed">--</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ‰ΩúËÄÖ -->
    <div class="author">FLAAAAKING</div>

    <!-- ÂºπÁ™óÔºöÊ∑ªÂä†/ÁºñËæëËçØÁâ© -->
    <div class="overlay" id="modalOverlay">
      <div
        class="modal"
        role="dialog"
        aria-modal="true"
        aria-labelledby="modalTitle"
      >
        <header>
          <h3 id="modalTitle">‚ûï Ê∑ªÂä†ËçØÁâ©</h3>
          <button class="btn ghost small" id="modalClose">‚úñ</button>
        </header>
        <div class="body">
          <div class="hint" id="modalHint">
            Â°´ÂÜôÊ∏ÖÊ•öÔºöÂêçÁß∞„ÄÅÂçïÊ¨°ÂâÇÈáè„ÄÅÊØèÊó•Ê¨°Êï∞/Êó∂Èó¥„ÄÅÂ∫ìÂ≠òÔºàÂèØÈÄâÔºâ
          </div>

          <div class="form">
            <label
              >ËçØÁâ©ÂêçÁß∞
              <input
                id="fName"
                placeholder="‰æãÂ¶ÇÔºöÁ¢≥ÈÖ∏ÈîÇÁºìÈáäÁâá"
                maxlength="40"
              />
            </label>

            <label
              >ÂõæÊ†áÔºàEmojiÔºâ
              <input
                id="fIcon"
                placeholder="‰æãÂ¶ÇÔºöüíä / üç¨ / üßÉ"
                maxlength="4"
              />
            </label>

            <label
              >ËßÑÊ†º/ÂâÇÈáèÔºàÊòæÁ§∫Áî®Ôºâ
              <input id="fDose" placeholder="‰æãÂ¶ÇÔºö300mg/Áâá" maxlength="30" />
            </label>

            <label
              >ÂçïÊ¨°Áî®ÈáèÔºàÊòæÁ§∫Áî®Ôºâ
              <input
                id="fUnit"
                placeholder="‰æãÂ¶ÇÔºö1Áâá / 2Á≤í / 10ml"
                maxlength="20"
              />
            </label>

            <label
              >ÊØèÊó•Ê¨°Êï∞
              <select id="fTimes">
                <option value="1">1 Ê¨°</option>
                <option value="2" selected>2 Ê¨°</option>
                <option value="3">3 Ê¨°</option>
                <option value="4">4 Ê¨°</option>
              </select>
            </label>

            <label
              >ÊúçÁî®Êó∂Èó¥ÔºàÁî®ÈÄóÂè∑ÂàÜÈöîÔºå24Â∞èÊó∂Âà∂Ôºâ
              <input
                id="fSchedule"
                placeholder="‰æãÂ¶ÇÔºö08:00,20:00"
                maxlength="60"
              />
            </label>

            <label
              >ÊÄªÂ∫ìÂ≠òÔºàÂèØÈÄâÔºâ
              <input
                id="fStock"
                type="number"
                min="0"
                step="1"
                placeholder="‰æãÂ¶ÇÔºö30"
              />
            </label>

            <label
              >‰ΩéÈáèÊèêÈÜíÔºàÂèØÈÄâÔºâ
              <input
                id="fLow"
                type="number"
                min="0"
                step="1"
                placeholder="‰æãÂ¶ÇÔºö7"
              />
            </label>

            <label style="grid-column: 1/-1"
              >Â§áÊ≥®ÔºàÂèØÈÄâÔºâ
              <textarea
                id="fNote"
                placeholder="‰æãÂ¶ÇÔºöÈ•≠ÂêéÊúçÁî® / ÂøåÈÖí / ËßÇÂØüÂóúÁù°ÊÉÖÂÜµ"
              ></textarea>
            </label>
          </div>
        </div>
        <footer>
          <button class="btn secondary" id="modalCancel">ÂèñÊ∂à</button>
          <button class="btn danger" id="modalDelete" style="display: none">
            Âà†Èô§
          </button>
          <button class="btn" id="modalSave">‰øùÂ≠ò</button>
        </footer>
      </div>
    </div>

    <!-- ÂºπÁ™óÔºöÂ∑•ÂÖ∑ -->
    <div class="overlay" id="toolsOverlay">
      <div
        class="modal"
        role="dialog"
        aria-modal="true"
        aria-labelledby="toolsTitle"
      >
        <header>
          <h3 id="toolsTitle">üß∞ Â∑•ÂÖ∑</h3>
          <button class="btn ghost small" id="toolsClose">‚úñ</button>
        </header>
        <div class="body">
          <div class="hint">
            ÂØºÂá∫/ÂØºÂÖ•Áî®‰∫éÂ§á‰ªΩËøÅÁßªÔºà‰ªçÁÑ∂ÊòØÊú¨Âú∞Êñá‰ª∂Ôºå‰∏ç‰ºö‰∏ä‰∫ëÔºâ„ÄÇ
          </div>
          <div
            style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 12px"
          >
            <button class="btn secondary" id="btnExport">‚¨áÔ∏è ÂØºÂá∫JSON</button>
            <button class="btn secondary" id="btnImport">‚¨ÜÔ∏è ÂØºÂÖ•JSON</button>
            <input
              id="fileImport"
              type="file"
              accept="application/json"
              style="display: none"
            />
            <button class="btn danger" id="btnWipeAll">üß® Ê∏ÖÁ©∫ÂÖ®ÈÉ®Êï∞ÊçÆ</button>
          </div>
          <div class="hint" style="margin-top: 12px">
            ÈöêÁßÅËØ¥ÊòéÔºöÊï∞ÊçÆÂ≠òÂú®‰Ω†ÁöÑÊµèËßàÂô®
            localStorage„ÄÇ‰∏çÂêåËÆæÂ§á/‰∏çÂêåÊµèËßàÂô®‰∫í‰∏çÂΩ±Âìç„ÄÇ‰Ω†Êää GitHub Pages
            ÈìæÊé•ÂèëÁªôÂà´‰∫∫ÔºåÂØπÊñπ‰∏ç‰ºöÁúãÂà∞‰Ω†Êú¨Êú∫ÁöÑÊï∞ÊçÆÔºàÈô§ÈùûÂú®‰Ω†ÁöÑÂêå‰∏ÄÂè∞ËÆæÂ§á/Âêå‰∏ÄÊµèËßàÂô®ÈáåÊâìÂºÄÔºâ„ÄÇ
          </div>
        </div>
        <footer>
          <button class="btn" id="toolsOk">Â•ΩÁöÑ</button>
        </footer>
      </div>
    </div>

    <!-- ÂºπÁ™óÔºöÁ°ÆËÆ§ -->
    <div class="overlay" id="confirmOverlay">
      <div
        class="modal"
        role="dialog"
        aria-modal="true"
        aria-labelledby="confirmTitle"
        style="width: min(520px, 96vw)"
      >
        <header>
          <h3 id="confirmTitle">Á°ÆËÆ§Êìç‰Ωú</h3>
          <button class="btn ghost small" id="confirmClose">‚úñ</button>
        </header>
        <div class="body">
          <div class="hint" id="confirmText">--</div>
        </div>
        <footer>
          <button class="btn secondary" id="confirmCancel">ÂèñÊ∂à</button>
          <button class="btn" id="confirmOk">Á°ÆËÆ§</button>
        </footer>
      </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast">
      <div class="msg" id="toastMsg">--</div>
      <div class="act">
        <button class="btn secondary small" id="toastUndo">Êí§ÈîÄ</button>
        <button class="btn ghost small" id="toastClose">ÂÖ≥Èó≠</button>
      </div>
    </div>

    <script>
      (() => {
        /* =========================
     Â≠òÂÇ®‰∏éÊï∞ÊçÆÁªìÊûÑ
  ========================= */
        const STORAGE_KEY = "katy-med-tracker:v1";
        const SETTINGS_KEY = "katy-med-tracker:settings:v1";

        const pad2 = (n) => String(n).padStart(2, "0");
        const toISODate = (d) =>
          `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`;
        const fromISODate = (s) => {
          const [y, m, dd] = s.split("-").map(Number);
          return new Date(y, m - 1, dd);
        };
        const nowHHMM = () => {
          const d = new Date();
          return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
        };
        const clamp = (v, min, max) => Math.max(min, Math.min(max, v));

        const uid = () => {
          try {
            return crypto.randomUUID();
          } catch {
            return (
              "id_" + Math.random().toString(16).slice(2) + "_" + Date.now()
            );
          }
        };

        const defaultState = () => ({
          meds: [
            // ÈªòËÆ§‰∏çÊîæ‰ªª‰ΩïËçØÔºåÈÅøÂÖçÁî®Êà∑ËØØ‰ºö‚ÄúÂàÜ‰∫´Â∞±Â∏¶Êï∞ÊçÆ‚Äù
          ],
          records: {
            // "YYYY-MM-DD": { taken: { doseId: {status,takenTime,notes}}, missed: {...} }
          },
        });

        const loadState = () => {
          try {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (!raw) return defaultState();
            const s = JSON.parse(raw);
            // ËΩªÂ∫¶Ê†°È™å
            if (
              !s ||
              typeof s !== "object" ||
              !Array.isArray(s.meds) ||
              typeof s.records !== "object"
            )
              return defaultState();
            return s;
          } catch {
            return defaultState();
          }
        };

        const saveState = () => {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
          refreshStorageChip();
        };

        const loadSettings = () => {
          try {
            const raw = localStorage.getItem(SETTINGS_KEY);
            if (!raw) return null;
            return JSON.parse(raw);
          } catch {
            return null;
          }
        };
        const saveSettings = () => {
          localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
        };

        let state = loadState();
        let settings = loadSettings() || {
          theme:
            document.documentElement.getAttribute("data-theme") || "katy-pink",
          decorOn: true,
          motionOn: true,
        };

        /* =========================
     DOM
  ========================= */
        const $ = (sel) => document.querySelector(sel);

        const themeSelect = $("#themeSelect");
        const btnDecor = $("#btnDecor");
        const btnMotion = $("#btnMotion");

        const monthLabel = $("#monthLabel");
        const prevMonth = $("#prevMonth");
        const nextMonth = $("#nextMonth");
        const todayBtn = $("#todayBtn");
        const dowRow = $("#dowRow");
        const calGrid = $("#calGrid");

        const selectedDatePill = $("#selectedDatePill");
        const selectedHint = $("#selectedHint");
        const doseList = $("#doseList");
        const emptyDoseHint = $("#emptyDoseHint");
        const selSummary = $("#selSummary");
        const markAllBtn = $("#markAllBtn");
        const btnQuickMissed = $("#btnQuickMissed");
        const btnClearDay = $("#btnClearDay");

        const medList = $("#medList");
        const emptyMedHint = $("#emptyMedHint");
        const medCount = $("#medCount");

        const statRate = $("#statRate");
        const statTaken = $("#statTaken");
        const statMissed = $("#statMissed");
        const monthRate = $("#monthRate");
        const streak = $("#streak");
        const totalDosesChip = $("#totalDosesChip");
        const chipStorage = $("#chipStorage");

        // Modal add/edit
        const modalOverlay = $("#modalOverlay");
        const modalTitle = $("#modalTitle");
        const modalClose = $("#modalClose");
        const modalCancel = $("#modalCancel");
        const modalSave = $("#modalSave");
        const modalDelete = $("#modalDelete");

        const fName = $("#fName");
        const fIcon = $("#fIcon");
        const fDose = $("#fDose");
        const fUnit = $("#fUnit");
        const fTimes = $("#fTimes");
        const fSchedule = $("#fSchedule");
        const fStock = $("#fStock");
        const fLow = $("#fLow");
        const fNote = $("#fNote");

        // Tools
        const btnTools = $("#btnTools");
        const toolsOverlay = $("#toolsOverlay");
        const toolsClose = $("#toolsClose");
        const toolsOk = $("#toolsOk");
        const btnExport = $("#btnExport");
        const btnImport = $("#btnImport");
        const fileImport = $("#fileImport");
        const btnWipeAll = $("#btnWipeAll");

        // Confirm
        const confirmOverlay = $("#confirmOverlay");
        const confirmTitle = $("#confirmTitle");
        const confirmText = $("#confirmText");
        const confirmClose = $("#confirmClose");
        const confirmCancel = $("#confirmCancel");
        const confirmOk = $("#confirmOk");

        // Toast
        const toast = $("#toast");
        const toastMsg = $("#toastMsg");
        const toastUndo = $("#toastUndo");
        const toastClose = $("#toastClose");

        const btnAddMed = $("#btnAddMed");
        const btnReset = $("#btnReset");

        /* =========================
     ÂÖ®Â±Ä UI Áä∂ÊÄÅ
  ========================= */
        const DOW = ["Êó•", "‰∏Ä", "‰∫å", "‰∏â", "Âõõ", "‰∫î", "ÂÖ≠"];
        let viewDate = new Date(); // ÂΩìÂâçÊó•ÂéÜÊúà
        let selectedDate = new Date(); // ÈÄâ‰∏≠Êó•Êúü
        let editingMedId = null;

        // Êí§ÈîÄÊ†àÔºöÁî®‰∫é‚ÄúÂà†Èô§ËçØÁâ©‚Äù‚ÄúÂΩìÂ§©Ê∏ÖÁ©∫‚Äù‚ÄúÊ†áËÆ∞Â∑≤Êúç/ÊºèÊúç‚Äù‚Äú‰∏ÄÈîÆÂÖ®Â∑≤Êúç‚ÄùÁ≠â
        let undoStack = null; // { label, snapshot }

        /* =========================
     Â∑•ÂÖ∑ÂáΩÊï∞Ôºö‰∏ªÈ¢ò/ÂºÄÂÖ≥
  ========================= */
        function applySettings() {
          document.documentElement.setAttribute("data-theme", settings.theme);
          themeSelect.value = settings.theme;

          document.body.classList.toggle("decor-off", !settings.decorOn);
          btnDecor.textContent = settings.decorOn
            ? "‚ú® Ë£ÖÈ•∞ÔºöÂºÄ"
            : "‚ú® Ë£ÖÈ•∞ÔºöÂÖ≥";

          document.body.classList.toggle("motion-off", !settings.motionOn);
          btnMotion.textContent = settings.motionOn
            ? "üéûÔ∏è Âä®ÊïàÔºöÂºÄ"
            : "üéûÔ∏è Âä®ÊïàÔºöÂÖ≥";

          saveSettings();
        }

        function refreshStorageChip() {
          // ‰ªÖÊèêÁ§∫‚ÄúÊú¨Âú∞‰øùÂ≠ò‚ÄùÂ≠òÂú®Âç≥ÂèØÔºõÈÅøÂÖçÂºïËµ∑Áî®Êà∑‚Äú‰∫ëÂêåÊ≠•ÈîôËßâ‚Äù
          chipStorage.textContent = "üíæ Êú¨Âú∞‰øùÂ≠ò";
        }

        /* =========================
     ËÆ°ÂàíÁîüÊàêÔºöÊääËçØÁÆ± -> ÂΩìÂ§©ÂâÇÈáèÂàóË°®
     doseId ËßÑÂàôÔºömedId|HH:MM|index
  ========================= */
        function normalizeSchedule(times, scheduleStr) {
          const t = clamp(parseInt(times, 10) || 1, 1, 4);
          let arr = (scheduleStr || "")
            .split(",")
            .map((s) => s.trim())
            .filter(Boolean);

          // ‰øÆÂ§çÔºöÁî®Êà∑Â°´‰∫ÜÊ¨°Êï∞‰ΩÜÊ≤°Â°´Êó∂Èó¥ -> ÁªôÈªòËÆ§
          const defaults = ["08:00", "12:00", "18:00", "22:00"];
          if (arr.length === 0) {
            arr = defaults.slice(0, t);
          }
          // Â¶ÇÊûúÂ°´Â∞ë‰∫ÜÔºåË°•ÈΩêÔºõÂ¶ÇÊûúÂ°´Â§ö‰∫ÜÔºåÊà™Êñ≠
          while (arr.length < t) arr.push(defaults[arr.length] || "20:00");
          arr = arr.slice(0, t);

          // Ê†ºÂºè‰øÆÊ≠£
          arr = arr.map((x) => {
            const m = x.match(/^(\d{1,2}):(\d{1,2})$/);
            if (!m) return x;
            return `${pad2(clamp(+m[1], 0, 23))}:${pad2(clamp(+m[2], 0, 59))}`;
          });

          return arr;
        }

        function buildDayPlan(dateISO) {
          const doses = [];
          for (const med of state.meds) {
            const times = clamp(parseInt(med.timesPerDay, 10) || 1, 1, 4);
            const sch = normalizeSchedule(times, med.schedule || "");
            sch.forEach((hhmm, idx) => {
              doses.push({
                doseId: `${med.id}|${hhmm}|${idx}`,
                medId: med.id,
                time: hhmm,
                idx,
                name: med.name,
                icon: med.icon || "üíä",
                dosage: med.dosage || "",
                unit: med.unit || "",
                note: med.note || "",
                stock: med.stock ?? null,
                low: med.lowStockAlert ?? null,
              });
            });
          }
          // ÊéíÂ∫èÔºöÊåâÊó∂Èó¥
          doses.sort((a, b) => a.time.localeCompare(b.time));
          return doses;
        }

        function getDayRecord(dateISO) {
          if (!state.records[dateISO]) state.records[dateISO] = { doses: {} };
          if (!state.records[dateISO].doses) state.records[dateISO].doses = {};
          return state.records[dateISO];
        }

        function getDoseStatus(dateISO, doseId) {
          const rec = getDayRecord(dateISO);
          return rec.doses[doseId] || { status: "none", takenTime: null };
        }

        function setDoseStatus(dateISO, doseId, status, takenTime = null) {
          const rec = getDayRecord(dateISO);
          if (status === "none") {
            delete rec.doses[doseId];
          } else {
            rec.doses[doseId] = {
              status,
              takenTime: takenTime || (status === "taken" ? nowHHMM() : null),
            };
          }
          saveState();
        }

        function clearDay(dateISO) {
          const rec = getDayRecord(dateISO);
          rec.doses = {};
          saveState();
        }

        /* =========================
     ÁªüËÆ°ÔºöÊåâ‚ÄúÊúâËÆ°ÂàíÁöÑÂâÇÈáè‚Äù‰∏∫ÂàÜÊØç
  ========================= */
        function monthKey(d) {
          return `${d.getFullYear()}-${pad2(d.getMonth() + 1)}`;
        }
        function listMonthDates(d) {
          const y = d.getFullYear(),
            m = d.getMonth();
          const first = new Date(y, m, 1);
          const last = new Date(y, m + 1, 0);
          const arr = [];
          for (let day = 1; day <= last.getDate(); day++) {
            arr.push(`${y}-${pad2(m + 1)}-${pad2(day)}`);
          }
          return arr;
        }

        function computeMonthStats(d) {
          const dates = listMonthDates(d);
          let total = 0,
            taken = 0,
            missed = 0;

          for (const iso of dates) {
            const plan = buildDayPlan(iso);
            total += plan.length;
            const rec = state.records[iso]?.doses || {};
            for (const dose of plan) {
              const s = rec[dose.doseId]?.status || "none";
              if (s === "taken") taken++;
              if (s === "missed") missed++;
            }
          }

          const rate = total ? Math.round((taken / total) * 100) : 0;
          return { total, taken, missed, rate };
        }

        function computeStreak() {
          // ËøûÁª≠‚ÄúÂΩìÂ§©ÊâÄÊúâÂâÇÈáèÂùáÂ∑≤Êúç‚ÄùÁöÑÂ§©Êï∞ÔºàÂÄíÊé®Âà∞‰ªäÂ§©Ôºâ
          const todayISO = toISODate(new Date());
          let d = fromISODate(todayISO);
          let streak = 0;

          for (;;) {
            const iso = toISODate(d);
            const plan = buildDayPlan(iso);
            if (plan.length === 0) break;
            const rec = state.records[iso]?.doses || {};
            const allTaken = plan.every(
              (x) => (rec[x.doseId]?.status || "none") === "taken"
            );
            if (allTaken) {
              streak++;
              d.setDate(d.getDate() - 1);
            } else {
              break;
            }
          }
          return streak;
        }

        /* =========================
     Êó•ÂéÜÊ∏≤Êüì
  ========================= */
        function renderDOW() {
          dowRow.innerHTML = "";
          for (const w of DOW) {
            const div = document.createElement("div");
            div.className = "dow";
            div.textContent = w;
            dowRow.appendChild(div);
          }
        }

        function daySummary(iso) {
          const plan = buildDayPlan(iso);
          if (plan.length === 0) return { tag: "", cls: "", text: "" };

          const rec = state.records[iso]?.doses || {};
          let taken = 0,
            missed = 0,
            marked = 0;
          for (const dose of plan) {
            const s = rec[dose.doseId]?.status || "none";
            if (s === "taken") {
              taken++;
              marked++;
            } else if (s === "missed") {
              missed++;
              marked++;
            }
          }

          if (marked === 0) return { tag: "", cls: "", text: "" };
          if (taken === plan.length)
            return {
              tag: "‚úÖ",
              cls: "ok",
              text: `ÂÖ®Â∑≤Êúç ${taken}/${plan.length}`,
            };
          if (missed > 0 && taken === 0)
            return {
              tag: "‚ö†Ô∏è",
              cls: "miss",
              text: `ÂÖ®ÊºèÊúç ${missed}/${plan.length}`,
            };
          if (missed > 0)
            return {
              tag: "‚ö†Ô∏è",
              cls: "warn",
              text: `ÈÉ®ÂàÜ ${taken}/${plan.length}`,
            };
          return {
            tag: "üü°",
            cls: "warn",
            text: `ÈÉ®ÂàÜ ${taken}/${plan.length}`,
          };
        }

        function renderCalendar() {
          const y = viewDate.getFullYear();
          const m = viewDate.getMonth();

          monthLabel.innerHTML = `${y}Âπ¥${m + 1}Êúà <small>${monthKey(
            viewDate
          )}</small>`;

          calGrid.innerHTML = "";

          const first = new Date(y, m, 1);
          const firstDow = first.getDay();
          const last = new Date(y, m + 1, 0);
          const daysInMonth = last.getDate();

          // ÂâçÁΩÆÁ©∫Ê†ºÔºö‰∏äÊúàÂ∞æÂ∑¥
          const prevLast = new Date(y, m, 0).getDate();
          for (let i = 0; i < firstDow; i++) {
            const dayNum = prevLast - firstDow + 1 + i;
            const d = new Date(y, m - 1, dayNum);
            calGrid.appendChild(buildDayCell(d, true));
          }

          // Êú¨Êúà
          for (let day = 1; day <= daysInMonth; day++) {
            const d = new Date(y, m, day);
            calGrid.appendChild(buildDayCell(d, false));
          }

          // ÂêéÁΩÆË°•ÈΩêÔºö‰øùÊåÅ 6 Ë°åÊõ¥Á®≥ÂÆöÔºàÂèØÈÄâÔºâ
          const totalCells = firstDow + daysInMonth;
          const remaining = (7 - (totalCells % 7)) % 7;
          for (let i = 1; i <= remaining; i++) {
            const d = new Date(y, m + 1, i);
            calGrid.appendChild(buildDayCell(d, true));
          }
        }

        function buildDayCell(d, muted) {
          const iso = toISODate(d);
          const div = document.createElement("div");
          div.className = "day" + (muted ? " muted" : "");

          const selISO = toISODate(selectedDate);
          if (iso === selISO) div.classList.add("selected");

          const sum = daySummary(iso);

          div.innerHTML = `
      <div class="spark" aria-hidden="true"></div>
      <div class="n">
        <span>${d.getDate()}</span>
        ${
          sum.tag
            ? `<span class="badge ${sum.cls}">${sum.tag}</span>`
            : `<span style="opacity:.0;">.</span>`
        }
      </div>
      <div style="margin-top:8px; font-size:11px; color: var(--muted); font-weight: 800;">
        ${sum.text ? sum.text : "&nbsp;"}
      </div>
    `;

          div.addEventListener("click", () => {
            selectedDate = d;
            // Â¶ÇÊûúÁÇπÂáª‰∫Ü‰∏äÊúà/‰∏ãÊúàÁöÑÊó•ÊúüÔºåÂàáÊç¢ËßÜÂõæÊúà
            if (
              d.getMonth() !== viewDate.getMonth() ||
              d.getFullYear() !== viewDate.getFullYear()
            ) {
              viewDate = new Date(d.getFullYear(), d.getMonth(), 1);
            }
            renderAll();
          });

          return div;
        }

        /* =========================
     Âè≥‰æßÔºöÂΩìÂ§©ËÆ°ÂàíÊ∏≤ÊüìÔºàÂèØÊí§ÈîÄÔºåÂèØË°•ÂΩïÔºâ
  ========================= */
        function renderSelectedDay() {
          const iso = toISODate(selectedDate);
          selectedDatePill.textContent = iso;

          const plan = buildDayPlan(iso);

          emptyDoseHint.style.display = plan.length ? "none" : "block";

          // Ê±áÊÄª
          let taken = 0,
            missed = 0;
          for (const dose of plan) {
            const st = getDoseStatus(iso, dose.doseId).status;
            if (st === "taken") taken++;
            if (st === "missed") missed++;
          }
          selSummary.textContent = `‚úÖ ${taken} / ${plan.length}`;

          if (iso === toISODate(new Date())) {
            selectedHint.textContent = "‰ªäÂ§©ÔºöÊâìÂç°/Êí§ÈîÄÈÉΩÂèØ„ÄÇ";
          } else {
            selectedHint.textContent = "Ë°•ÂΩïÔºöÁÇπËøõÊüêÊù°ÂâÇÈáèÂèØ‚ÄúÂ∑≤Êúç/ÊºèÊúç/Ê∏ÖÁ©∫‚Äù„ÄÇ";
          }

          // ÂàóË°®
          doseList.innerHTML = "";
          if (plan.length === 0) return;

          for (const dose of plan) {
            const st = getDoseStatus(iso, dose.doseId);
            const status = st.status || "none";
            const timeText = dose.time;
            const takenTime = st.takenTime ? `¬∑ ËÆ∞ÂΩïÊó∂Èó¥ ${st.takenTime}` : "";

            const stateLabel =
              status === "taken"
                ? `‚úÖ Â∑≤Êúç ${takenTime}`
                : status === "missed"
                ? `‚ö†Ô∏è ÊºèÊúç`
                : `‚è≥ Êú™ËÆ∞ÂΩï`;

            const stateCls =
              status === "taken"
                ? "taken"
                : status === "missed"
                ? "missed"
                : "";

            const el = document.createElement("div");
            el.className = "dose";
            el.innerHTML = `
        <div class="left">
          <div class="icon">${escapeHTML(dose.icon || "üíä")}</div>
          <div>
            <div class="name">${escapeHTML(
              dose.name || "Êú™ÂëΩÂêçËçØÁâ©"
            )} <span style="color:var(--muted); font-weight:820; font-size:12px;">¬∑ ${escapeHTML(
              timeText
            )}</span></div>
            <div class="desc">
              <span class="chip">üìå ${escapeHTML(
                dose.dosage || "ËßÑÊ†ºÊú™Â°´"
              )}</span>
              <span class="chip">üç¨ ${escapeHTML(
                dose.unit || "Áî®ÈáèÊú™Â°´"
              )}</span>
              ${
                dose.note
                  ? `<span class="chip">üìù ${escapeHTML(
                      shorten(dose.note, 18)
                    )}</span>`
                  : ``
              }
            </div>
          </div>
        </div>

        <div class="right">
          <div class="state ${stateCls}">${stateLabel}</div>
          <div class="minirow">
            <button class="btn small ${
              status === "taken" ? "secondary" : ""
            }" data-act="take">‚úÖ Â∑≤Êúç</button>
            <button class="btn small ${
              status === "missed" ? "secondary" : ""
            }" data-act="miss">‚ö†Ô∏è ÊºèÊúç</button>
            <button class="btn small ghost" data-act="none">üßº Ê∏ÖÁ©∫</button>
          </div>
        </div>
      `;

            // ÁªëÂÆö‰∫ã‰ª∂ÔºàÂÖ≥ÈîÆÔºö‰øùËØÅÂèØÁÇπÔºå‰∏çË¢´‰º™ÂÖÉÁ¥†Êå°‰ΩèÔºâ
            el.querySelectorAll("button").forEach((btn) => {
              btn.addEventListener("click", (e) => {
                e.stopPropagation();
                const act = btn.getAttribute("data-act");
                snapshotUndo(`‰øÆÊîπÔºö${dose.name} ${dose.time}`);
                if (act === "take") {
                  // ‚ÄúËÅ™ÊòéË°•ÂΩï‚ÄùÔºöÂ¶ÇÊûúÊòØËøáÂéªÊó•ÊúüÔºåËÆ∞ÂΩïÊó∂Èó¥ÈªòËÆ§=ËÆ°ÂàíÊó∂Èó¥ÔºõÂ¶ÇÊûúÊòØ‰ªäÂ§©ÔºåÈªòËÆ§=ÂΩìÂâçÊó∂Èó¥
                  const isToday = iso === toISODate(new Date());
                  setDoseStatus(
                    iso,
                    dose.doseId,
                    "taken",
                    isToday ? nowHHMM() : dose.time
                  );
                  showToast("Â∑≤Ê†áËÆ∞‰∏∫„ÄåÂ∑≤Êúç„Äç", true);
                } else if (act === "miss") {
                  setDoseStatus(iso, dose.doseId, "missed", null);
                  showToast("Â∑≤Ê†áËÆ∞‰∏∫„ÄåÊºèÊúç„Äç", true);
                } else {
                  setDoseStatus(iso, dose.doseId, "none", null);
                  showToast("Â∑≤Ê∏ÖÁ©∫ËØ•Êù°ËÆ∞ÂΩï", true);
                }
                renderAll(false);
              });
            });

            doseList.appendChild(el);
          }
        }

        /* =========================
     ËçØÁÆ±Ê∏≤ÊüìÔºàÁºñËæë/Âà†Èô§ÂèØÁî®Ôºâ
  ========================= */
        function renderMedBox() {
          medList.innerHTML = "";

          medCount.textContent = `üì¶ ${state.meds.length} Áßç`;
          emptyMedHint.style.display = state.meds.length ? "none" : "block";

          for (const med of state.meds) {
            const sch = normalizeSchedule(med.timesPerDay, med.schedule);
            const stock =
              (med.stock ?? "") === "" || med.stock == null
                ? null
                : Number(med.stock);
            const low =
              (med.lowStockAlert ?? "") === "" || med.lowStockAlert == null
                ? null
                : Number(med.lowStockAlert);

            const lowMark =
              stock != null && low != null && stock <= low
                ? `<span class="chip low">‚õî ‰ΩéÈáèÔºö${stock}</span>`
                : stock != null
                ? `<span class="chip">üì¶ Â∫ìÂ≠òÔºö${stock}</span>`
                : "";

            const el = document.createElement("div");
            el.className = "med";
            el.innerHTML = `
        <div class="left">
          <div class="icon">${escapeHTML(med.icon || "üíä")}</div>
          <div>
            <div class="name">${escapeHTML(med.name || "Êú™ÂëΩÂêçËçØÁâ©")}</div>
            <div class="desc">
              <span class="chip">üìå ${escapeHTML(
                med.dosage || "ËßÑÊ†ºÊú™Â°´"
              )}</span>
              <span class="chip">üç¨ ${escapeHTML(med.unit || "Áî®ÈáèÊú™Â°´")}</span>
              <span class="chip">‚è∞ ${escapeHTML(sch.join(", "))}</span>
              ${lowMark}
            </div>
          </div>
        </div>
        <div class="right">
          <button class="btn secondary small" data-act="edit">‚úèÔ∏è ÁºñËæë</button>
          <button class="btn danger small" data-act="del">üóëÔ∏è Âà†Èô§</button>
        </div>
      `;

            el.querySelector('[data-act="edit"]').addEventListener(
              "click",
              (e) => {
                e.stopPropagation();
                openMedModal(med.id);
              }
            );

            el.querySelector('[data-act="del"]').addEventListener(
              "click",
              (e) => {
                e.stopPropagation();
                confirmAction(
                  "Á°ÆËÆ§Âà†Èô§ËçØÁâ©Ôºü",
                  "Âà†Èô§ÂêéÔºöËçØÁâ©‰ºö‰ªéËçØÁÆ±ÁßªÈô§ÔºõÂéÜÂè≤ÊâìÂç°ËÆ∞ÂΩï‰ªç‰øùÁïôÂú®ÂΩìÊó•ËÆ∞ÂΩïÈáåÔºà‰∏ç‰ºöËá™Âä®ÊäπÊéâÔºâ„ÄÇ",
                  () => {
                    snapshotUndo(`Âà†Èô§ËçØÁâ©Ôºö${med.name}`);
                    state.meds = state.meds.filter((x) => x.id !== med.id);
                    saveState();
                    showToast("Â∑≤Âà†Èô§ËçØÁâ©", true);
                    renderAll(false);
                  }
                );
              }
            );

            medList.appendChild(el);
          }
        }

        /* =========================
     Ê∑ªÂä†/ÁºñËæëËçØÁâ©ÂºπÁ™ó
  ========================= */
        function openMedModal(medId = null) {
          editingMedId = medId;
          modalOverlay.classList.add("show");

          const isEdit = !!medId;
          modalTitle.textContent = isEdit ? "‚úèÔ∏è ÁºñËæëËçØÁâ©" : "‚ûï Ê∑ªÂä†ËçØÁâ©";
          modalDelete.style.display = isEdit ? "inline-flex" : "none";

          const med = isEdit ? state.meds.find((m) => m.id === medId) : null;

          fName.value = med?.name || "";
          fIcon.value = med?.icon || "üíä";
          fDose.value = med?.dosage || "";
          fUnit.value = med?.unit || "";
          fTimes.value = String(
            clamp(parseInt(med?.timesPerDay, 10) || 2, 1, 4)
          );
          fSchedule.value = med?.schedule || "";
          fStock.value = (med?.stock ?? "") === "" ? "" : String(med.stock);
          fLow.value =
            (med?.lowStockAlert ?? "") === "" ? "" : String(med.lowStockAlert);
          fNote.value = med?.note || "";

          // Ëá™Âä®Áªô‰∏™ÂêàÁêÜÈªòËÆ§Êó∂Èó¥
          if (!isEdit && !fSchedule.value.trim()) {
            const t = parseInt(fTimes.value, 10);
            const defaults = ["08:00", "12:00", "18:00", "22:00"];
            fSchedule.value = defaults.slice(0, t).join(",");
          }
        }

        function closeMedModal() {
          modalOverlay.classList.remove("show");
          editingMedId = null;
        }

        function validateMedForm() {
          const name = fName.value.trim();
          if (!name) return "ËØ∑Â°´ÂÜôËçØÁâ©ÂêçÁß∞„ÄÇ";

          const times = clamp(parseInt(fTimes.value, 10) || 1, 1, 4);

          const schedule = fSchedule.value.trim();
          const arr = normalizeSchedule(times, schedule);
          // ÁÆÄÂçïÊ£ÄÊü•ÔºöÊó∂Èó¥Ê†ºÂºèÂü∫Êú¨Ê≠£Á°Æ
          for (const t of arr) {
            if (!/^\d{2}:\d{2}$/.test(t))
              return "ÊúçÁî®Êó∂Èó¥Ê†ºÂºè‰∏çÊ≠£Á°ÆÔºåËØ∑Áî® 08:00 ËøôÁßçÊ†ºÂºèÔºåÁî®ÈÄóÂè∑ÂàÜÈöî„ÄÇ";
          }

          return null;
        }

        function saveMed() {
          const err = validateMedForm();
          if (err) {
            showToast(err, false, true);
            return;
          }

          const times = clamp(parseInt(fTimes.value, 10) || 1, 1, 4);
          const scheduleArr = normalizeSchedule(times, fSchedule.value.trim());
          const schedule = scheduleArr.join(",");

          const medObj = {
            id: editingMedId || uid(),
            name: fName.value.trim(),
            icon: (fIcon.value.trim() || "üíä").slice(0, 4),
            dosage: fDose.value.trim(),
            unit: fUnit.value.trim(),
            timesPerDay: times,
            schedule,
            stock: fStock.value === "" ? null : Number(fStock.value),
            lowStockAlert: fLow.value === "" ? null : Number(fLow.value),
            note: fNote.value.trim(),
          };

          if (editingMedId) {
            snapshotUndo(`ÁºñËæëËçØÁâ©Ôºö${medObj.name}`);
            const idx = state.meds.findIndex((m) => m.id === editingMedId);
            if (idx >= 0) state.meds[idx] = medObj;
            saveState();
            showToast("Â∑≤‰øùÂ≠ò‰øÆÊîπ", true);
          } else {
            snapshotUndo(`Ê∑ªÂä†ËçØÁâ©Ôºö${medObj.name}`);
            state.meds.push(medObj);
            saveState();
            showToast("Â∑≤Ê∑ªÂä†ËçØÁâ©", true);
          }

          closeMedModal();
          renderAll(false);
        }

        /* =========================
     ‰∏ÄÈîÆ‰∏éÊô∫ËÉΩË°•ÂΩï
  ========================= */
        function markAllTakenForDay(iso) {
          const plan = buildDayPlan(iso);
          if (plan.length === 0) return;

          snapshotUndo(`‰∏ÄÈîÆÂÖ®Â∑≤ÊúçÔºö${iso}`);

          const isToday = iso === toISODate(new Date());
          for (const dose of plan) {
            // Âè™Â°´Êú™ËÆ∞ÂΩïÁöÑ
            const st = getDoseStatus(iso, dose.doseId).status;
            if (st === "none") {
              setDoseStatus(
                iso,
                dose.doseId,
                "taken",
                isToday ? nowHHMM() : dose.time
              );
            }
          }
          showToast("ÂΩìÂ§©Êú™ËÆ∞ÂΩïÁöÑÂâÇÈáèÂ∑≤ÂÖ®ÈÉ®Ê†áËÆ∞‰∏∫„ÄåÂ∑≤Êúç„Äç", true);
        }

        function markAllMissedForDay(iso) {
          const plan = buildDayPlan(iso);
          if (plan.length === 0) return;

          snapshotUndo(`‰∏ÄÈîÆÂÖ®ÊºèÊúçÔºö${iso}`);
          for (const dose of plan) {
            const st = getDoseStatus(iso, dose.doseId).status;
            if (st === "none") {
              setDoseStatus(iso, dose.doseId, "missed", null);
            }
          }
          showToast("ÂΩìÂ§©Êú™ËÆ∞ÂΩïÁöÑÂâÇÈáèÂ∑≤ÂÖ®ÈÉ®Ê†áËÆ∞‰∏∫„ÄåÊºèÊúç„Äç", true);
        }

        /* =========================
     Á°ÆËÆ§/Êí§ÈîÄ/ÊèêÁ§∫
  ========================= */
        let confirmHandler = null;

        function confirmAction(title, text, onOk) {
          confirmTitle.textContent = title;
          confirmText.textContent = text;
          confirmOverlay.classList.add("show");
          confirmHandler = onOk;
        }

        function closeConfirm() {
          confirmOverlay.classList.remove("show");
          confirmHandler = null;
        }

        function snapshotUndo(label) {
          undoStack = {
            label,
            snapshot: JSON.parse(JSON.stringify(state)),
          };
        }

        function restoreUndo() {
          if (!undoStack) return;
          state = undoStack.snapshot;
          saveState();
          showToast(`Â∑≤Êí§ÈîÄÔºö${undoStack.label}`, false);
          undoStack = null;
          renderAll(false);
        }

        let toastTimer = null;
        function showToast(msg, canUndo = false, isError = false) {
          toastMsg.textContent = msg;
          toast.classList.add("show");
          toastUndo.style.display = canUndo ? "inline-flex" : "none";
          toast.style.borderColor = isError
            ? "rgba(255,77,77,.35)"
            : "color-mix(in oklab, var(--border) 70%, white)";
          if (toastTimer) clearTimeout(toastTimer);
          toastTimer = setTimeout(() => toast.classList.remove("show"), 3600);
        }

        /* =========================
     ÂØºÂÖ•/ÂØºÂá∫/ÈáçÁΩÆ
  ========================= */
        function exportJSON() {
          const blob = new Blob([JSON.stringify(state, null, 2)], {
            type: "application/json",
          });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `katy-med-tracker-backup-${toISODate(new Date())}.json`;
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
          showToast("Â∑≤ÂØºÂá∫ JSON", false);
        }

        function importJSONFile(file) {
          const reader = new FileReader();
          reader.onload = () => {
            try {
              const obj = JSON.parse(reader.result);
              if (
                !obj ||
                !Array.isArray(obj.meds) ||
                typeof obj.records !== "object"
              )
                throw new Error("bad");
              snapshotUndo("ÂØºÂÖ•Êï∞ÊçÆ");
              state = obj;
              saveState();
              renderAll(false);
              showToast("ÂØºÂÖ•ÊàêÂäü", true);
            } catch {
              showToast("ÂØºÂÖ•Â§±Ë¥•ÔºöÊñá‰ª∂Ê†ºÂºè‰∏çÊ≠£Á°Æ„ÄÇ", false, true);
            }
          };
          reader.readAsText(file);
        }

        function resetEmpty() {
          confirmAction(
            "Êñ∞Âª∫Á©∫ÁôΩËçØÁÆ±Ôºü",
            "‰ºöÊ∏ÖÁ©∫ÂΩìÂâçËÆæÂ§á‰∏äÁöÑÂÖ®ÈÉ®ËçØÁÆ±‰∏éÊâìÂç°ËÆ∞ÂΩï„ÄÇ",
            () => {
              snapshotUndo("Êñ∞Âª∫Á©∫ÁôΩËçØÁÆ±");
              state = defaultState();
              saveState();
              renderAll(false);
              showToast("Â∑≤Êñ∞Âª∫Á©∫ÁôΩËçØÁÆ±", true);
            }
          );
        }

        function wipeAll() {
          confirmAction(
            "Á°ÆËÆ§Ê∏ÖÁ©∫ÂÖ®ÈÉ®Êï∞ÊçÆÔºü",
            "Ê≠§Êìç‰Ωú‰ºöÂà†Èô§ËçØÁÆ±‰∏éÊâÄÊúâÂéÜÂè≤ÊâìÂç°ËÆ∞ÂΩï„ÄÇ",
            () => {
              localStorage.removeItem(STORAGE_KEY);
              state = defaultState();
              saveState();
              renderAll(false);
              showToast("Â∑≤Ê∏ÖÁ©∫ÂÖ®ÈÉ®Êï∞ÊçÆ", false);
            }
          );
        }

        /* =========================
     Ê∏≤ÊüìÊÄªÊéß
  ========================= */
        function renderStats() {
          const ms = computeMonthStats(viewDate);
          statRate.textContent = `${ms.rate}%`;
          statTaken.textContent = `${ms.taken}`;
          statMissed.textContent = `${ms.missed}`;
          monthRate.textContent = `üìà Êú¨ÊúàÔºö${ms.rate}%`;
          totalDosesChip.textContent = `üßÆ Êú¨ÊúàÂâÇÈáèÔºö${ms.total}`;

          const st = computeStreak();
          streak.textContent = `üî• ËøûÁª≠Ôºö${st}Â§©`;
        }

        function renderAll(keepToast = true) {
          if (!keepToast) toast.classList.remove("show");
          renderCalendar();
          renderSelectedDay();
          renderMedBox();
          renderStats();
          refreshStorageChip();
        }

        /* =========================
     ‰∫ã‰ª∂ÁªëÂÆö
  ========================= */
        // Theme
        themeSelect.addEventListener("change", () => {
          settings.theme = themeSelect.value;
          applySettings();
          renderAll();
        });

        btnDecor.addEventListener("click", () => {
          settings.decorOn = !settings.decorOn;
          applySettings();
          renderAll();
        });

        btnMotion.addEventListener("click", () => {
          settings.motionOn = !settings.motionOn;
          applySettings();
          renderAll();
        });

        // Calendar nav
        prevMonth.addEventListener("click", () => {
          viewDate = new Date(
            viewDate.getFullYear(),
            viewDate.getMonth() - 1,
            1
          );
          renderAll();
        });
        nextMonth.addEventListener("click", () => {
          viewDate = new Date(
            viewDate.getFullYear(),
            viewDate.getMonth() + 1,
            1
          );
          renderAll();
        });
        todayBtn.addEventListener("click", () => {
          const t = new Date();
          viewDate = new Date(t.getFullYear(), t.getMonth(), 1);
          selectedDate = t;
          renderAll();
        });

        // Add med
        btnAddMed.addEventListener("click", () => openMedModal(null));
        modalClose.addEventListener("click", closeMedModal);
        modalCancel.addEventListener("click", closeMedModal);
        modalOverlay.addEventListener("click", (e) => {
          if (e.target === modalOverlay) closeMedModal();
        });

        modalSave.addEventListener("click", saveMed);

        modalDelete.addEventListener("click", () => {
          if (!editingMedId) return;
          const med = state.meds.find((m) => m.id === editingMedId);
          confirmAction(
            "Á°ÆËÆ§Âà†Èô§Ôºü",
            `Âà†Èô§ËçØÁâ©„Äå${med?.name || ""}„ÄçÂêéÊó†Ê≥ïËá™Âä®ÊÅ¢Â§çÔºàÂèØÁî®Êí§ÈîÄÔºâ„ÄÇ`,
            () => {
              snapshotUndo(`Âà†Èô§ËçØÁâ©Ôºö${med?.name || ""}`);
              state.meds = state.meds.filter((x) => x.id !== editingMedId);
              saveState();
              closeMedModal();
              showToast("Â∑≤Âà†Èô§ËçØÁâ©", true);
              renderAll(false);
            }
          );
        });

        // Mark all
        markAllBtn.addEventListener("click", () => {
          const iso = toISODate(selectedDate);
          if (buildDayPlan(iso).length === 0) {
            showToast("ÂΩìÂ§©Ê≤°ÊúâËÆ°ÂàíÂâÇÈáèÔºàËçØÁÆ±‰∏∫Á©∫ÊàñÊú™ËÆæÁΩÆÊó∂Èó¥Ôºâ", false, true);
            return;
          }
          confirmAction(
            "‰∏ÄÈîÆÂÖ®Â∑≤ÊúçÔºü",
            "‰ºöÊää‚ÄúÊú™ËÆ∞ÂΩï‚ÄùÁöÑÂâÇÈáèÂÖ®ÈÉ®Ê†áËÆ∞‰∏∫Â∑≤ÊúçÔºàÂ∑≤ËÆ∞ÂΩïÁöÑ‰∏çÂä®Ôºâ„ÄÇ",
            () => {
              markAllTakenForDay(iso);
              renderAll(false);
            }
          );
        });

        // Quick missed
        btnQuickMissed.addEventListener("click", () => {
          const iso = toISODate(selectedDate);
          if (buildDayPlan(iso).length === 0) {
            showToast("ÂΩìÂ§©Ê≤°ÊúâËÆ°ÂàíÂâÇÈáè", false, true);
            return;
          }
          confirmAction(
            "‰∏ÄÈîÆÊ†áËÆ∞ÊºèÊúçÔºü",
            "‰ºöÊää‚ÄúÊú™ËÆ∞ÂΩï‚ÄùÁöÑÂâÇÈáèÂÖ®ÈÉ®Ê†áËÆ∞‰∏∫ÊºèÊúçÔºàÂ∑≤ËÆ∞ÂΩïÁöÑ‰∏çÂä®Ôºâ„ÄÇ",
            () => {
              markAllMissedForDay(iso);
              renderAll(false);
            }
          );
        });

        // Clear day
        btnClearDay.addEventListener("click", () => {
          const iso = toISODate(selectedDate);
          confirmAction(
            "Ê∏ÖÁ©∫ÂΩìÂ§©ËÆ∞ÂΩïÔºü",
            `Â∞ÜÊ∏ÖÁ©∫ ${iso} ÁöÑÊâÄÊúâÊâìÂç°Áä∂ÊÄÅÔºàÂè™ÂΩ±ÂìçËøô‰∏ÄÂ§©Ôºâ„ÄÇ`,
            () => {
              snapshotUndo(`Ê∏ÖÁ©∫ÂΩìÂ§©Ôºö${iso}`);
              clearDay(iso);
              showToast("Â∑≤Ê∏ÖÁ©∫ÂΩìÂ§©ËÆ∞ÂΩï", true);
              renderAll(false);
            }
          );
        });

        // Reset empty
        btnReset.addEventListener("click", resetEmpty);

        // Tools
        btnTools.addEventListener("click", () =>
          toolsOverlay.classList.add("show")
        );
        toolsClose.addEventListener("click", () =>
          toolsOverlay.classList.remove("show")
        );
        toolsOk.addEventListener("click", () =>
          toolsOverlay.classList.remove("show")
        );
        toolsOverlay.addEventListener("click", (e) => {
          if (e.target === toolsOverlay) toolsOverlay.classList.remove("show");
        });

        btnExport.addEventListener("click", exportJSON);
        btnImport.addEventListener("click", () => fileImport.click());
        fileImport.addEventListener("change", () => {
          const f = fileImport.files?.[0];
          if (f) importJSONFile(f);
          fileImport.value = "";
        });
        btnWipeAll.addEventListener("click", wipeAll);

        // Confirm
        confirmClose.addEventListener("click", closeConfirm);
        confirmCancel.addEventListener("click", closeConfirm);
        confirmOverlay.addEventListener("click", (e) => {
          if (e.target === confirmOverlay) closeConfirm();
        });
        confirmOk.addEventListener("click", () => {
          const fn = confirmHandler;
          closeConfirm();
          if (fn) fn();
        });

        // Toast
        toastUndo.addEventListener("click", () => {
          restoreUndo();
          toast.classList.remove("show");
        });
        toastClose.addEventListener("click", () =>
          toast.classList.remove("show")
        );

        // ÈîÆÁõòÔºöESC ÂÖ≥Èó≠ÂºπÁ™ó
        window.addEventListener("keydown", (e) => {
          if (e.key === "Escape") {
            modalOverlay.classList.remove("show");
            toolsOverlay.classList.remove("show");
            confirmOverlay.classList.remove("show");
            toast.classList.remove("show");
          }
        });

        /* =========================
     Â∑•ÂÖ∑ÔºöHTML ËΩ¨‰πâ & ÊñáÊú¨Êà™Êñ≠
  ========================= */
        function escapeHTML(str) {
          return String(str)
            .replaceAll("&", "&amp;")
            .replaceAll("<", "&lt;")
            .replaceAll(">", "&gt;")
            .replaceAll('"', "&quot;")
            .replaceAll("'", "&#039;");
        }
        function shorten(str, n) {
          const s = String(str);
          return s.length > n ? s.slice(0, n - 1) + "‚Ä¶" : s;
        }

        /* =========================
     ÂàùÂßãÂåñ
  ========================= */
        function init() {
          applySettings();
          renderDOW();
          viewDate = new Date(
            new Date().getFullYear(),
            new Date().getMonth(),
            1
          );
          selectedDate = new Date();
          renderAll();
        }

        init();
      })();
    </script>

    <
  </body>
</html>

