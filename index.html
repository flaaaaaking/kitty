<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Kitty Med Tracker</title>

<style>
/* =========================
   ä¸»é¢˜ç³»ç»Ÿï¼ˆCSS å˜é‡ï¼‰
   ========================= */
:root{
  --bg1:#fff5fb; --bg2:#ffffff;
  --card:#ffffffcc;
  --stroke:rgba(0,0,0,.06);
  --shadow:rgba(18, 18, 22, .10);
  --text:#23262a;
  --muted:#6b7280;

  --brand:#ff69b4;
  --brand2:#ff4fa6;
  --brandSoft:rgba(255,105,180,.14);

  --good:#20c997;
  --warn:#ff9f1a;
  --bad:#ff3b6b;

  --calHas: rgba(255,105,180,.14);
  --calDone: rgba(32,201,151,.18);
  --calMiss: rgba(255,59,107,.16);

  --focus: rgba(255,105,180,.35);
  --ring: rgba(255,105,180,.25);

  --radius:18px;
  --radius2:14px;

  --font: ui-rounded, system-ui, -apple-system, "PingFang SC", "Microsoft YaHei", "Segoe UI", Arial, sans-serif;
}

/* ===== ä¸»é¢˜ï¼šè“ ===== */
body.theme-blue{
  --bg1:#eff6ff; --bg2:#ffffff;
  --card:#ffffffcc;
  --stroke:rgba(30, 64, 175, .10);
  --shadow:rgba(15, 23, 42, .10);
  --text:#0f172a;
  --muted:#64748b;

  --brand:#4a90e2;
  --brand2:#2563eb;
  --brandSoft:rgba(37,99,235,.14);

  --calHas: rgba(37,99,235,.12);
  --calDone: rgba(16,185,129,.18);
  --calMiss: rgba(244,63,94,.14);

  --focus: rgba(37,99,235,.35);
  --ring: rgba(37,99,235,.22);
}

/* ===== ä¸»é¢˜ï¼šè–„è· ===== */
body.theme-mint{
  --bg1:#effffb; --bg2:#ffffff;
  --card:#ffffffcc;
  --stroke:rgba(16, 185, 129, .10);
  --shadow:rgba(6, 95, 70, .12);
  --text:#064e3b;
  --muted:#3f7667;

  --brand:#2ec4b6;
  --brand2:#0ea5a4;
  --brandSoft:rgba(14,165,164,.14);

  --calHas: rgba(14,165,164,.12);
  --calDone: rgba(34,197,94,.18);
  --calMiss: rgba(244,63,94,.14);

  --focus: rgba(14,165,164,.35);
  --ring: rgba(14,165,164,.22);
}

/* ===== ä¸»é¢˜ï¼šè–°è¡£è‰ ===== */
body.theme-lavender{
  --bg1:#f6f3ff; --bg2:#ffffff;
  --card:#ffffffcc;
  --stroke:rgba(124, 58, 237, .10);
  --shadow:rgba(31, 17, 67, .10);
  --text:#241a3a;
  --muted:#6b5f85;

  --brand:#8e7dff;
  --brand2:#7c3aed;
  --brandSoft:rgba(124,58,237,.14);

  --calHas: rgba(124,58,237,.12);
  --calDone: rgba(16,185,129,.18);
  --calMiss: rgba(244,63,94,.14);

  --focus: rgba(124,58,237,.35);
  --ring: rgba(124,58,237,.22);
}

/* ===== ä¸»é¢˜ï¼šå¤œé—´ ===== */
body.theme-night{
  --bg1:#0b0d12; --bg2:#101420;
  --card:rgba(20, 24, 36, .82);
  --stroke:rgba(255,255,255,.10);
  --shadow:rgba(0,0,0,.45);
  --text:#f3f5ff;
  --muted:#b7bccb;

  --brand:#ff69b4;
  --brand2:#ff4fa6;
  --brandSoft:rgba(255,105,180,.18);

  --calHas: rgba(255,105,180,.14);
  --calDone: rgba(34,197,94,.18);
  --calMiss: rgba(244,63,94,.14);

  --focus: rgba(255,105,180,.40);
  --ring: rgba(255,105,180,.22);
}

/* ===== ä¸»é¢˜ï¼šå•è‰²ï¼ˆæç®€ï¼‰ ===== */
body.theme-mono{
  --bg1:#f7f7f8; --bg2:#ffffff;
  --card:#ffffffcc;
  --stroke:rgba(0,0,0,.08);
  --shadow:rgba(0,0,0,.08);
  --text:#1f2937;
  --muted:#6b7280;

  --brand:#111827;
  --brand2:#111827;
  --brandSoft:rgba(17,24,39,.10);

  --calHas: rgba(17,24,39,.10);
  --calDone: rgba(34,197,94,.18);
  --calMiss: rgba(244,63,94,.14);

  --focus: rgba(17,24,39,.26);
  --ring: rgba(17,24,39,.16);
}

/* =========================
   åŸºç¡€å¸ƒå±€ / è´¨æ„Ÿ
   ========================= */
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:var(--font);
  color:var(--text);
  background:
    radial-gradient(900px 600px at 18% 10%, var(--brandSoft), transparent 55%),
    radial-gradient(900px 600px at 85% 18%, rgba(255,255,255,.45), transparent 55%),
    linear-gradient(180deg, var(--bg1), var(--bg2));
}

.app{
  width:100%;
  max-width:520px;
  margin:0 auto;
  padding:18px 14px 62px;
}

/* é¡¶éƒ¨æ¡ */
.topbar{
  display:flex; align-items:center; justify-content:space-between; gap:12px;
  margin-bottom:12px;
}
.brand{
  display:flex; align-items:center; gap:10px;
}
.logo{
  width:44px; height:44px; border-radius:16px;
  background: linear-gradient(135deg, var(--brand), var(--brand2));
  box-shadow: 0 16px 36px var(--shadow);
  display:grid; place-items:center;
  user-select:none;
}
.brand h1{
  margin:0; font-size:18px; letter-spacing:.2px;
}
.brand .sub{
  margin-top:2px; font-size:12px; color:var(--muted);
}

/* å¡ç‰‡ */
.card{
  background: var(--card);
  backdrop-filter: blur(10px);
  border:1px solid var(--stroke);
  border-radius: var(--radius);
  box-shadow: 0 18px 45px var(--shadow);
  padding:14px;
  margin:12px 0;
  position:relative;
  overflow:hidden;
}
.card::after{
  content:"";
  position:absolute; right:-28px; top:-28px;
  width:120px; height:120px;
  background:
    radial-gradient(circle at 30% 30%, var(--brandSoft), transparent 60%),
    radial-gradient(circle at 70% 70%, rgba(255,255,255,.18), transparent 60%);
  transform: rotate(16deg);
  border-radius: 32px;
  pointer-events:none;
}

/* Tabs */
.tabs{
  display:flex; gap:8px; margin:10px 0 6px;
}
.tab{
  flex:1;
  border:1px solid var(--stroke);
  background: rgba(255,255,255,.55);
  color: var(--text);
  padding:10px 12px;
  border-radius:999px;
  font-weight:800;
  cursor:pointer;
}
.tab.active{
  border:none;
  background: linear-gradient(135deg, var(--brand), var(--brand2));
  color:#fff;
}

/* ä¸»é¢˜é€‰æ‹© */
.themeBox{
  display:flex; align-items:center; gap:8px;
  padding:8px 10px;
  border-radius:999px;
  border:1px solid var(--stroke);
  background: rgba(255,255,255,.65);
}
.themeBox label{
  font-size:12px; color:var(--muted);
}
select{
  border:1px solid var(--stroke);
  background: rgba(255,255,255,.85);
  padding:6px 10px;
  border-radius:999px;
  font-weight:800;
  color:var(--text);
  outline:none;
}
select:focus{box-shadow:0 0 0 4px var(--ring)}

/* é€šç”¨ */
h2{
  margin:0 0 10px 0;
  font-size:15px;
  display:flex; align-items:center; gap:8px;
}
h2::before{content:"ğŸŒ¸"; transform: translateY(-1px)}
.muted{color:var(--muted); font-size:12px; line-height:1.45}
.pill{
  display:inline-flex; align-items:center; gap:6px;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid var(--stroke);
  background: rgba(255,255,255,.65);
  font-size:12px;
  color:var(--muted);
}
.row{display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap}
.mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}

/* æŒ‰é’® */
.btn{
  border:0;
  border-radius:999px;
  padding:11px 14px;
  font-weight:900;
  cursor:pointer;
  background: linear-gradient(135deg, var(--brand), var(--brand2));
  color:#fff;
  box-shadow: 0 12px 24px rgba(0,0,0,.10);
}
.btn.secondary{
  background: rgba(255,255,255,.70);
  color: var(--text);
  border:1px solid var(--stroke);
  box-shadow:none;
}
.btn:active{transform: translateY(1px)}
.btn:focus{outline:none; box-shadow:0 0 0 4px var(--ring)}

/* ä»Šæ—¥æ¡ç›® */
.list{display:flex; flex-direction:column; gap:10px; margin-top:8px}
.item{
  border:1px solid var(--stroke);
  background: rgba(255,255,255,.70);
  border-radius: var(--radius2);
  padding:12px;
}
.itemTop{display:flex; align-items:center; justify-content:space-between; gap:10px}
.name{font-weight:950}
.small{font-size:12px; color:var(--muted); margin-top:6px; line-height:1.45}
.divider{height:1px; background: var(--stroke); margin:10px 0}

/* æ‰“å¡å¼€å…³ */
.checkline{display:flex; align-items:center; justify-content:space-between; gap:12px}
.stateTag{
  font-size:12px; font-weight:900;
}
.ok{color:var(--good)}
.bad{color:var(--bad)}
.warn{color:var(--warn)}
.box{
  width:30px;height:30px;border-radius:12px;
  border:1px solid var(--stroke);
  background: rgba(255,255,255,.85);
  display:grid; place-items:center;
  cursor:pointer; user-select:none;
  box-shadow: 0 12px 18px rgba(0,0,0,.06);
}
.box.on{
  background: var(--brandSoft);
  border-color: var(--focus);
}
.box.on::after{content:"âœ…"; font-size:15px}

/* æ—¥å† */
.calendar{
  display:grid;
  grid-template-columns: repeat(7, 1fr);
  gap:8px;
  margin-top:10px;
}
.day{
  border:1px solid var(--stroke);
  background: rgba(255,255,255,.70);
  border-radius: 14px;
  padding:10px 6px;
  text-align:center;
  cursor:pointer;
  user-select:none;
  font-size:13px;
}
.day:hover{transform: translateY(-1px)}
.day.has{background: var(--calHas)}
.day.done{background: var(--calDone); font-weight:900}
.day.miss{background: var(--calMiss); font-weight:900}
.day.active{outline: 2px solid var(--focus)}

/* è¡¨å• */
input,textarea{
  width:100%;
  padding:10px 12px;
  border-radius: 14px;
  border:1px solid var(--stroke);
  background: rgba(255,255,255,.85);
  outline:none;
  font-size:14px;
  color:var(--text);
}
textarea{min-height:72px; resize:vertical}
label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px}
.grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px}

/* å³ä¸‹è§’ä½œè€… */
.author-fixed{
  position:fixed;
  right:10px;
  bottom:8px;
  font-size:12px;
  color:var(--muted);
  opacity:.85;
  pointer-events:none;
  z-index:5;
}
.hidden{display:none}
</style>
</head>

<body class="theme-pink">
  <div class="app">

    <div class="topbar">
      <div class="brand">
        <div class="logo">ğŸ€</div>
        <div>
          <h1>Kitty Med Tracker</h1>
          <div class="sub">ç‚¹æ—¥å†è¡¥å½• Â· æœ¬åœ°ä¿å­˜ Â· å¤šçš®è‚¤</div>
        </div>
      </div>

      <div class="themeBox">
        <label for="themeSelect">çš®è‚¤</label>
        <select id="themeSelect">
          <option value="theme-pink">Pink ç²‰æ¨±</option>
          <option value="theme-blue">Blue æ¸…çˆ½</option>
          <option value="theme-mint">Mint è–„è·</option>
          <option value="theme-lavender">Lavender è–°è¡£è‰</option>
          <option value="theme-night">Night å¤œçŒ«</option>
          <option value="theme-mono">Mono æç®€</option>
        </select>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" id="tabToday">ä»Šæ—¥æ‰“å¡</button>
      <button class="tab" id="tabMeds">æˆ‘çš„è¯ç®±</button>
      <button class="tab" id="tabStats">æ—¥å†ç»Ÿè®¡</button>
    </div>

    <!-- ä»Šæ—¥ -->
    <section id="viewToday">
      <div class="card">
        <h2>å½“å¤©ç”¨è¯æ‰“å¡</h2>

        <div class="row">
          <div class="pill">æ—¥æœŸï¼š<span class="mono" id="currentKey"></span></div>
          <button class="btn secondary" id="btnBackToday">å›åˆ°ä»Šå¤©</button>
        </div>

        <div class="muted" id="backfillHint" style="margin-top:10px;"></div>

        <div class="list" id="todayList"></div>

        <div class="divider"></div>

        <div class="row">
          <button class="btn" style="flex:1" id="btnMarkAll">ä¸€é”®å…¨éƒ¨æ ‡è®°å·²æœç”¨</button>
        </div>
        <div class="muted" id="todayHint" style="margin-top:10px;"></div>
      </div>
    </section>

    <!-- è¯ç®± -->
    <section id="viewMeds" class="hidden">
      <div class="card">
        <h2>æ·»åŠ æ–°è¯</h2>

        <label>è¯ç‰©åç§°</label>
        <input id="fName" placeholder="ä¾‹å¦‚ï¼šè‰é…¸è‰¾å¸è¥¿é…æ™®å…° / ç¢³é…¸é”‚ç¼“é‡Šç‰‡" />

        <div class="grid2">
          <div>
            <label>è§„æ ¼/å‰‚é‡ï¼ˆå±•ç¤ºç”¨ï¼‰</label>
            <input id="fSpec" placeholder="ä¾‹å¦‚ï¼š10mg/ç‰‡" />
          </div>
          <div>
            <label>å•æ¬¡ç”¨é‡</label>
            <input id="fDose" placeholder="ä¾‹å¦‚ï¼š1ç‰‡ / 1ç²’ / 10ml" />
          </div>
        </div>

        <div class="grid2">
          <div>
            <label>æ¯å¤©æ¬¡æ•°</label>
            <select id="fTimes" style="width:100%; border-radius:14px; padding:10px 12px;">
              <option value="1">1 æ¬¡</option>
              <option value="2" selected>2 æ¬¡</option>
              <option value="3">3 æ¬¡</option>
              <option value="4">4 æ¬¡</option>
            </select>
          </div>
          <div>
            <label>æœç”¨æ—¶é—´ï¼ˆé€—å·åˆ†éš”ï¼‰</label>
            <input id="fSchedule" placeholder="08:00,20:00" />
          </div>
        </div>

        <div class="grid2">
          <div>
            <label>æ€»æ•°é‡ï¼ˆåº“å­˜ï¼‰</label>
            <input id="fStock" type="number" min="0" placeholder="ä¾‹å¦‚ï¼š30" />
          </div>
          <div>
            <label>ä½åº“å­˜æé†’ï¼ˆâ‰¤ï¼‰</label>
            <input id="fLow" type="number" min="0" placeholder="ä¾‹å¦‚ï¼š7" />
          </div>
        </div>

        <label>å¤‡æ³¨</label>
        <textarea id="fNote" placeholder="ä¾‹å¦‚ï¼šé¥­åæœç”¨ / å¯èƒ½å—œç¡ / ä¸è¦å–é…’"></textarea>

        <div class="row" style="margin-top:10px;">
          <button class="btn" style="flex:1" id="btnAdd">æ·»åŠ åˆ°è¯ç®±</button>
          <button class="btn secondary" id="btnSeed">å¡«å……ç¤ºä¾‹</button>
        </div>

        <div class="muted" style="margin-top:10px;">
          è§„åˆ™ï¼šåªæœ‰â€œä»Šå¤©â€æ‰“å¡ä¼šæ‰£åº“å­˜ï¼›è¡¥å½•é»˜è®¤ä¸æ‰£åº“å­˜ï¼ˆé¿å…åº“å­˜è¢«æ‰£ä¹±ï¼‰ã€‚
        </div>
      </div>

      <div class="card">
        <h2>æˆ‘çš„è¯ç®±</h2>
        <div class="list" id="medList"></div>
      </div>

      <div class="card">
        <h2>å¤‡ä»½ä¸è¿ç§»</h2>
        <div class="row" style="gap:8px;">
          <button class="btn secondary" id="btnExport">å¯¼å‡º JSON</button>
          <button class="btn secondary" id="btnImport">å¯¼å…¥ JSON</button>
          <button class="btn secondary" id="btnReset">æ¸…ç©ºæ•°æ®</button>
        </div>
        <textarea class="mono" id="backupBox" placeholder="å¯¼å‡ºä¼šå‡ºç°åœ¨è¿™é‡Œï¼›å¯¼å…¥è¯·æŠŠ JSON ç²˜è´´åˆ°è¿™é‡Œ" style="margin-top:10px;"></textarea>
        <div class="muted" style="margin-top:10px;">å¯¼å…¥ä¼šè¦†ç›–æœ¬åœ°æ•°æ®ï¼Œå»ºè®®å…ˆå¯¼å‡ºä¸€ä»½ç•™å­˜ã€‚</div>
      </div>
    </section>

    <!-- æ—¥å†ç»Ÿè®¡ -->
    <section id="viewStats" class="hidden">
      <div class="card">
        <h2>æœ¬æœˆæ—¥å†ï¼ˆç‚¹æ—¥æœŸè¡¥å½•ï¼‰</h2>
        <div class="row">
          <div class="pill">âœ… å®Œæˆ</div>
          <div class="pill">âš ï¸ éƒ¨åˆ†å®Œæˆ</div>
          <div class="pill">ç©ºç™½ = æ— è®°å½•</div>
        </div>

        <div class="calendar" id="calendar"></div>
        <div class="muted" id="statHint" style="margin-top:10px;"></div>
      </div>

      <div class="card">
        <h2>æ¦‚è§ˆ</h2>
        <div class="list" id="overview"></div>
      </div>
    </section>

  </div>

  <div class="author-fixed">by FLAAAAKING</div>

<script>
/* =========================
   å­˜å‚¨ä¸çŠ¶æ€
   ========================= */
const STORE_KEY = "kitty-med-single-v1";
const THEME_KEY = "kitty-med-theme-v1";

function isoDateKey(d){
  const local = new Date(d.getTime() - d.getTimezoneOffset()*60000);
  return local.toISOString().slice(0,10);
}
const todayKey = isoDateKey(new Date());
let currentDateKey = todayKey;

function uid(){ return "id_" + Math.random().toString(16).slice(2) + Date.now().toString(16); }
function hhmm(d){ return String(d.getHours()).padStart(2,"0")+":"+String(d.getMinutes()).padStart(2,"0"); }

function loadState(){
  try{
    const raw = localStorage.getItem(STORE_KEY);
    if(!raw) return null;
    return JSON.parse(raw);
  }catch{ return null; }
}
function saveState(){
  localStorage.setItem(STORE_KEY, JSON.stringify(state));
}

/* é»˜è®¤ç¤ºä¾‹ï¼ˆæ‚¨ä¹Ÿå¯ä»¥åˆ æ‰ï¼‰ */
const defaultState = {
  meds: [
    { id: uid(), name:"ç¢³é…¸é”‚ç¼“é‡Šç‰‡", spec:"â€”", dose:"1ç‰‡", timesPerDay:2, schedule:"08:00,20:00", stock:30, lowStock:7, note:"é¥­åæœç”¨" },
    { id: uid(), name:"è‰é…¸è‰¾å¸è¥¿é…æ™®å…°", spec:"â€”", dose:"1ç‰‡", timesPerDay:1, schedule:"22:00", stock:30, lowStock:7, note:"éµåŒ»å˜±" },
  ],
  records: {}
};

const state = loadState() || structuredClone(defaultState);

/* =========================
   ä¸»é¢˜åˆ‡æ¢
   ========================= */
const themeSelect = document.getElementById("themeSelect");
const savedTheme = localStorage.getItem(THEME_KEY) || "theme-pink";
document.body.className = savedTheme;
themeSelect.value = savedTheme;

themeSelect.onchange = ()=>{
  document.body.className = themeSelect.value;
  localStorage.setItem(THEME_KEY, themeSelect.value);
};

/* =========================
   Tabs
   ========================= */
const tabToday = document.getElementById("tabToday");
const tabMeds  = document.getElementById("tabMeds");
const tabStats = document.getElementById("tabStats");
const viewToday = document.getElementById("viewToday");
const viewMeds  = document.getElementById("viewMeds");
const viewStats = document.getElementById("viewStats");

function setTab(which){
  tabToday.classList.toggle("active", which==="today");
  tabMeds.classList.toggle("active", which==="meds");
  tabStats.classList.toggle("active", which==="stats");
  viewToday.classList.toggle("hidden", which!=="today");
  viewMeds.classList.toggle("hidden", which!=="meds");
  viewStats.classList.toggle("hidden", which!=="stats");
}
tabToday.onclick = ()=>setTab("today");
tabMeds.onclick  = ()=>setTab("meds");
tabStats.onclick = ()=>setTab("stats");

/* =========================
   è®¡åˆ’ç”Ÿæˆ / è¡¥å½•ç­–ç•¥
   ========================= */
function parseSchedule(str, times){
  const arr = (str||"").split(",").map(s=>s.trim()).filter(Boolean);
  const defaults = ["08:00","12:00","18:00","22:00"];
  while(arr.length < times) arr.push(defaults[arr.length] || "");
  return arr.slice(0, times);
}
function getMed(id){ return state.meds.find(m=>m.id===id); }

function buildPlanForDate(dateKey){
  if(state.records[dateKey]) return;

  const entries = [];
  for(const med of state.meds){
    const times = Math.max(1, parseInt(med.timesPerDay||1,10));
    const schedule = parseSchedule(med.schedule, times);
    for(let i=0;i<times;i++){
      entries.push({
        id: uid(),
        medId: med.id,
        name: med.name,
        dose: med.dose || "",
        scheduledTime: schedule[i] || "",
        taken: false,
        takenTime: "",
        backfilled: dateKey !== todayKey
      });
    }
  }
  state.records[dateKey] = { entries, summary:{ allTaken:false, miss:false } };
  saveState();
}

function recomputeSummary(dateKey){
  const rec = state.records[dateKey];
  if(!rec) return;
  const entries = rec.entries || [];
  const total = entries.length;
  const done = entries.filter(e=>e.taken).length;
  rec.summary = {
    allTaken: total>0 && done===total,
    miss: total>0 && done<total && done>0
  };
  saveState();
}

function shouldAffectStock(){
  // åªæœ‰â€œä»Šå¤©â€æ‰“å¡å½±å“åº“å­˜ï¼›è¡¥å½•ä¸æ‰£åº“å­˜ï¼ˆé¿å…å†å²è¡¥å½•æŠŠåº“å­˜æ‰£ä¹±ï¼‰
  return currentDateKey === todayKey;
}

/* =========================
   ä»Šæ—¥è§†å›¾æ¸²æŸ“
   ========================= */
const currentKeyEl = document.getElementById("currentKey");
const backfillHint = document.getElementById("backfillHint");
const todayList = document.getElementById("todayList");
const todayHint = document.getElementById("todayHint");
const btnBackToday = document.getElementById("btnBackToday");
const btnMarkAll = document.getElementById("btnMarkAll");

btnBackToday.onclick = ()=>{
  currentDateKey = todayKey;
  setTab("today");
  renderAll();
};

btnMarkAll.onclick = ()=>{
  buildPlanForDate(currentDateKey);
  const rec = state.records[currentDateKey];
  const nowStr = hhmm(new Date());

  for(const e of rec.entries){
    if(!e.taken){
      e.taken = true;
      e.takenTime = nowStr;
      if(shouldAffectStock()){
        const med = getMed(e.medId);
        if(med){
          const stock = Number(med.stock||0);
          med.stock = Math.max(0, stock - 1);
        }
      }
    }
  }
  recomputeSummary(currentDateKey);
  renderAll();
};

function renderToday(){
  currentKeyEl.textContent = currentDateKey;

  const isBackfill = currentDateKey !== todayKey;
  backfillHint.textContent = isBackfill
    ? `æ‚¨æ­£åœ¨è¡¥å½•ï¼š${currentDateKey}ï¼ˆè¡¥å½•é»˜è®¤ä¸æ‰£åº“å­˜ï¼‰`
    : `ä»Šå¤©ï¼šæŒ‰æ—¶æ‰“å¡ä¼šæ‰£åº“å­˜`;

  buildPlanForDate(currentDateKey);

  const rec = state.records[currentDateKey];
  const entries = rec.entries || [];

  if(state.meds.length===0){
    todayList.innerHTML = `<div class="muted">è¯ç®±ä¸ºç©ºã€‚å…ˆå»ã€Œæˆ‘çš„è¯ç®±ã€æ·»åŠ è¯ç‰©ã€‚</div>`;
    todayHint.textContent = "";
    btnMarkAll.disabled = true;
    return;
  }

  btnMarkAll.disabled = entries.length===0;

  todayList.innerHTML = "";
  entries.forEach(e=>{
    const med = getMed(e.medId);
    const stock = med ? Number(med.stock??0) : 0;
    const low = med ? Number(med.lowStock??0) : 0;
    const lowTag = (med && stock<=low) ? ` <span class="stateTag warn">ä½åº“å­˜</span>` : "";
    const bfTag = e.backfilled ? ` <span class="stateTag warn">è¡¥å½•</span>` : "";

    const box = document.createElement("div");
    box.className = "item";
    box.innerHTML = `
      <div class="itemTop">
        <div class="name">${(med?med.name:e.name)}${bfTag}</div>
        <div class="pill">ğŸ•’ ${e.scheduledTime || "æœªè®¾ç½®"}</div>
      </div>
      <div class="small">
        ğŸ’Š ç”¨é‡ï¼š${e.dose || (med?med.dose:"â€”")}ã€€ğŸ“¦ åº“å­˜ï¼š${med?stock:"â€”"}${lowTag}<br/>
        ğŸ“ å¤‡æ³¨ï¼š${(med && med.note) ? med.note : "â€”"}
      </div>
      <div class="divider"></div>
      <div class="checkline">
        <div>
          ${e.taken
            ? `<div class="stateTag ok">å·²æœç”¨</div><div class="small">è®°å½•æ—¶é—´ï¼š${e.takenTime}</div>`
            : `<div class="stateTag bad">æœªæœç”¨</div><div class="small">ç‚¹å‡»å³ä¾§æ‰“å¡</div>`
          }
        </div>
        <div class="box ${e.taken ? "on":""}" data-id="${e.id}"></div>
      </div>
    `;
    todayList.appendChild(box);
  });

  todayList.querySelectorAll(".box").forEach(node=>{
    node.onclick = ()=>{
      const id = node.getAttribute("data-id");
      const rec = state.records[currentDateKey];
      const entry = rec.entries.find(x=>x.id===id);
      if(!entry) return;

      entry.taken = !entry.taken;
      entry.takenTime = entry.taken ? hhmm(new Date()) : "";

      if(shouldAffectStock()){
        const med = getMed(entry.medId);
        if(med){
          const stock = Number(med.stock||0);
          if(entry.taken) med.stock = Math.max(0, stock - 1);
          else med.stock = stock + 1;
        }
      }

      recomputeSummary(currentDateKey);
      renderAll();
    };
  });

  recomputeSummary(currentDateKey);
  const total = entries.length;
  const done = entries.filter(x=>x.taken).length;
  const pct = total? Math.round(done/total*100) : 0;
  todayHint.textContent = `å½“å¤©è¿›åº¦ï¼š${done}/${total}ï¼ˆ${pct}%ï¼‰`;
}

/* =========================
   è¯ç®±ï¼šCRUDï¼ˆæœ€å°å¯ç”¨ï¼‰
   ========================= */
const fName = document.getElementById("fName");
const fSpec = document.getElementById("fSpec");
const fDose = document.getElementById("fDose");
const fTimes = document.getElementById("fTimes");
const fSchedule = document.getElementById("fSchedule");
const fStock = document.getElementById("fStock");
const fLow = document.getElementById("fLow");
const fNote = document.getElementById("fNote");
const btnAdd = document.getElementById("btnAdd");
const btnSeed = document.getElementById("btnSeed");
const medList = document.getElementById("medList");

btnSeed.onclick = ()=>{
  fName.value = "ç›é…¸å“Œå”‘ç½—æ±€";
  fSpec.value = "â€”";
  fDose.value = "1ç‰‡";
  fTimes.value = "1";
  fSchedule.value = "22:30";
  fStock.value = "30";
  fLow.value = "7";
  fNote.value = "éµåŒ»å˜±";
};

btnAdd.onclick = ()=>{
  const name = fName.value.trim();
  if(!name) return;

  state.meds.push({
    id: uid(),
    name,
    spec: fSpec.value.trim(),
    dose: fDose.value.trim(),
    timesPerDay: parseInt(fTimes.value,10) || 1,
    schedule: fSchedule.value.trim(),
    stock: Number(fStock.value||0),
    lowStock: Number(fLow.value||0),
    note: fNote.value.trim()
  });

  // æ–°è¯åŠ å…¥åï¼šä¸è‡ªåŠ¨é‡ç®—å†å²è®°å½•ï¼Œé¿å…æ±¡æŸ“ï¼›ä½†ä¼šå½±å“â€œæœªæ¥æ–°å»ºæ—¥æœŸè®¡åˆ’â€
  saveState();

  // æ¸…ç©ºè¡¨å•
  fName.value=""; fSpec.value=""; fDose.value="";
  fSchedule.value=""; fStock.value=""; fLow.value=""; fNote.value="";
  fTimes.value="2";

  renderAll();
};

function renderMeds(){
  medList.innerHTML = "";
  if(state.meds.length===0){
    medList.innerHTML = `<div class="muted">è¯ç®±ä¸ºç©ºã€‚</div>`;
    return;
  }

  state.meds.forEach(m=>{
    const stock = Number(m.stock||0);
    const low = Number(m.lowStock||0);
    const lowTag = stock<=low ? ` <span class="stateTag warn">ä½åº“å­˜</span>` : "";
    const el = document.createElement("div");
    el.className = "item";
    el.innerHTML = `
      <div class="itemTop">
        <div class="name">${m.name}${lowTag}</div>
        <button class="btn secondary" data-id="${m.id}" style="padding:8px 12px;">åˆ é™¤</button>
      </div>
      <div class="small">
        è§„æ ¼ï¼š${m.spec||"â€”"}ã€€ç”¨é‡ï¼š${m.dose||"â€”"}ã€€æ¬¡æ•°ï¼š${m.timesPerDay||1}/å¤©<br/>
        æ—¶é—´ï¼š${m.schedule||"â€”"}ã€€åº“å­˜ï¼š${stock}ï¼ˆæé†’â‰¤${low}ï¼‰<br/>
        å¤‡æ³¨ï¼š${m.note||"â€”"}
      </div>
    `;
    medList.appendChild(el);
  });

  medList.querySelectorAll("button[data-id]").forEach(btn=>{
    btn.onclick = ()=>{
      const id = btn.getAttribute("data-id");
      state.meds = state.meds.filter(x=>x.id!==id);
      saveState();
      renderAll();
    };
  });
}

/* =========================
   å¤‡ä»½
   ========================= */
const btnExport = document.getElementById("btnExport");
const btnImport = document.getElementById("btnImport");
const btnReset  = document.getElementById("btnReset");
const backupBox = document.getElementById("backupBox");

btnExport.onclick = ()=>{
  backupBox.value = JSON.stringify(state, null, 2);
};
btnImport.onclick = ()=>{
  try{
    const obj = JSON.parse(backupBox.value);
    if(!obj || typeof obj !== "object") return;
    if(!obj.meds || !obj.records) return;
    localStorage.setItem(STORE_KEY, JSON.stringify(obj));
    location.reload();
  }catch{}
};
btnReset.onclick = ()=>{
  localStorage.removeItem(STORE_KEY);
  location.reload();
};

/* =========================
   æ—¥å†ï¼šç‚¹æ—¥æœŸè¡¥å½•ï¼ˆå·æ‡’æ–¹æ¡ˆï¼‰
   ========================= */
const calendarEl = document.getElementById("calendar");
const statHint = document.getElementById("statHint");
const overview = document.getElementById("overview");

function renderCalendar(){
  calendarEl.innerHTML = "";

  const now = new Date();
  const year = now.getFullYear();
  const month = now.getMonth(); // 0-based
  const first = new Date(year, month, 1);
  const last = new Date(year, month+1, 0);
  const daysInMonth = last.getDate();

  // å‘¨èµ·å§‹ç©ºæ ¼
  const startDow = first.getDay(); // 0 Sun - 6 Sat
  for(let i=0;i<startDow;i++){
    const pad = document.createElement("div");
    pad.className="day";
    pad.style.opacity=".25";
    pad.textContent="";
    calendarEl.appendChild(pad);
  }

  for(let d=1; d<=daysInMonth; d++){
    const date = new Date(year, month, d);
    const key = isoDateKey(date);

    const rec = state.records[key];
    let cls = "day";
    if(rec){
      const sum = rec.summary || {};
      if(sum.allTaken) cls += " done";
      else if(sum.miss) cls += " miss";
      else cls += " has";
    }
    if(key===currentDateKey) cls += " active";

    const cell = document.createElement("div");
    cell.className = cls;
    cell.textContent = d;

    cell.onclick = ()=>{
      currentDateKey = key;
      buildPlanForDate(key);
      setTab("today");       // å…³é”®ï¼šç‚¹æ—¥å†ç›´æ¥è·³åˆ°ä»Šæ—¥é¡µé¢ï¼ˆå·æ‡’æ–¹æ¡ˆï¼‰
      renderAll();
    };

    calendarEl.appendChild(cell);
  }

  statHint.textContent = `æœ¬æœˆï¼š${year}-${String(month+1).padStart(2,"0")}ï¼ˆç‚¹ä»»æ„æ—¥æœŸå¯è¡¥å½•ï¼‰`;
}

function renderOverview(){
  // ç»Ÿè®¡æœ¬æœˆå®Œæˆ/éƒ¨åˆ†/æ— è®°å½•
  const now = new Date();
  const year = now.getFullYear();
  const month = now.getMonth();
  const last = new Date(year, month+1, 0);
  const daysInMonth = last.getDate();

  let has=0, done=0, miss=0;
  for(let d=1; d<=daysInMonth; d++){
    const key = isoDateKey(new Date(year, month, d));
    const rec = state.records[key];
    if(!rec) continue;
    has++;
    const sum = rec.summary || {};
    if(sum.allTaken) done++;
    else if(sum.miss) miss++;
  }

  overview.innerHTML = `
    <div class="item">
      <div class="itemTop">
        <div class="name">æœ¬æœˆè®°å½•æ¦‚è§ˆ</div>
        <div class="pill">ğŸ“Š</div>
      </div>
      <div class="small">
        æœ‰è®°å½•ï¼š${has} å¤©<br/>
        âœ… å®Œæˆï¼š${done} å¤©<br/>
        âš ï¸ éƒ¨åˆ†å®Œæˆï¼š${miss} å¤©<br/>
        ç©ºç™½ï¼š${daysInMonth - has} å¤©
      </div>
    </div>
    <div class="item">
      <div class="itemTop">
        <div class="name">è¡¥å½•è¯´æ˜</div>
        <div class="pill">ğŸ“</div>
      </div>
      <div class="small">
        ç‚¹å‡»æ—¥å†æ—¥æœŸä¼šç›´æ¥è·³è½¬åˆ°å½“å¤©æ‰“å¡ã€‚è¡¥å½•é»˜è®¤ä¸æ‰£åº“å­˜ï¼›åªæœ‰â€œä»Šå¤©â€çš„æ‰“å¡ä¼šæ‰£åº“å­˜ã€‚
      </div>
    </div>
  `;
}

/* =========================
   æ€»æ¸²æŸ“
   ========================= */
function renderAll(){
  renderToday();
  renderMeds();
  renderCalendar();
  renderOverview();
}
renderAll();
</script>
</body>
</html>

