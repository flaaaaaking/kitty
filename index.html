<!DOCTYPE html>
<html lang="zh-CN" data-theme="katy-pink" data-decor="on" data-motion="on">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ç”¨è¯è®°å½•å™¨</title>
    <style>
      :root {
        --bg: #fff5fb;
        --bg2: #ffe8f4;
        --panel: #fff;
        --panel2: #ffffffcc;
        --text: #1f2937;
        --muted: #6b7280;
        --border: rgba(0, 0, 0, 0.1);
        --shadow: 0 18px 44px rgba(0, 0, 0, 0.1);
        --shadow2: 0 10px 24px rgba(0, 0, 0, 0.08);

        --accent: #ff4fa3;
        --accent2: #ff8cc7;
        --accent3: #ffd1e6;

        --ok: #16a34a;
        --warn: #f59e0b;
        --bad: #ef4444;

        --radius: 18px;
        --radius2: 14px;
        --font: ui-rounded, "SF Pro Rounded", "PingFang SC", "Microsoft YaHei",
          system-ui, -apple-system, "Segoe UI", Arial, sans-serif;
        --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", monospace;

        --gridGap: 10px;

        --animFast: 180ms;
        --anim: 260ms;
        --animSlow: 520ms;
      }

      /* 12 themes */
      html[data-theme="katy-pink"] {
        --bg: #fff5fb;
        --bg2: #ffe8f4;
        --panel: #fff;
        --text: #1f2937;
        --muted: #6b7280;
        --accent: #ff4fa3;
        --accent2: #ff8cc7;
        --accent3: #ffd1e6;
        --border: rgba(0, 0, 0, 0.1);
      }
      html[data-theme="milk-tea"] {
        --bg: #fff7ee;
        --bg2: #fbe9d6;
        --panel: #fff;
        --text: #2b2b2b;
        --muted: #7c6f64;
        --accent: #c97a3d;
        --accent2: #f3b27f;
        --accent3: #ffe1c8;
        --border: rgba(43, 43, 43, 0.12);
      }
      html[data-theme="peach"] {
        --bg: #fff1ef;
        --bg2: #ffe0dc;
        --panel: #fff;
        --text: #1f2937;
        --muted: #7a6f7b;
        --accent: #ff5b4d;
        --accent2: #ffb199;
        --accent3: #ffd6cb;
        --border: rgba(0, 0, 0, 0.1);
      }
      html[data-theme="mint"] {
        --bg: #eefcf6;
        --bg2: #daf6e7;
        --panel: #fff;
        --text: #0f172a;
        --muted: #57706a;
        --accent: #10b981;
        --accent2: #86efac;
        --accent3: #c8f8dc;
        --border: rgba(15, 23, 42, 0.12);
      }
      html[data-theme="blue-calm"] {
        --bg: #eff7ff;
        --bg2: #dbeeff;
        --panel: #fff;
        --text: #0f172a;
        --muted: #556277;
        --accent: #3b82f6;
        --accent2: #93c5fd;
        --accent3: #dbeafe;
        --border: rgba(15, 23, 42, 0.12);
      }
      html[data-theme="sky-glass"] {
        --bg: #f2fbff;
        --bg2: #dff2ff;
        --panel: #ffffffd9;
        --panel2: #ffffffb3;
        --text: #0f172a;
        --muted: #4f6476;
        --accent: #06b6d4;
        --accent2: #67e8f9;
        --accent3: #cffafe;
        --border: rgba(15, 23, 42, 0.12);
      }
      html[data-theme="moonlight"] {
        --bg: #f6f2ff;
        --bg2: #e8ddff;
        --panel: #fff;
        --text: #0f172a;
        --muted: #5f5b78;
        --accent: #8b5cf6;
        --accent2: #c4b5fd;
        --accent3: #ede9fe;
        --border: rgba(15, 23, 42, 0.12);
      }
      html[data-theme="night-cat"] {
        --bg: #0b1020;
        --bg2: #0a1636;
        --panel: #0f172a;
        --panel2: #0f172ad9;
        --text: #e5e7eb;
        --muted: #9aa7bd;
        --accent: #a78bfa;
        --accent2: #60a5fa;
        --accent3: #22d3ee;
        --border: rgba(229, 231, 235, 0.14);
        --shadow: 0 18px 44px rgba(0, 0, 0, 0.45);
        --shadow2: 0 10px 24px rgba(0, 0, 0, 0.35);
      }
      html[data-theme="ink-black"] {
        --bg: #0b0b0d;
        --bg2: #111114;
        --panel: #15151a;
        --panel2: #15151ad9;
        --text: #f3f4f6;
        --muted: #9ca3af;
        --accent: #f472b6;
        --accent2: #fda4af;
        --accent3: #a78bfa;
        --border: rgba(243, 244, 246, 0.12);
        --shadow: 0 18px 44px rgba(0, 0, 0, 0.55);
        --shadow2: 0 10px 24px rgba(0, 0, 0, 0.4);
      }
      html[data-theme="minimal-paper"] {
        --bg: #fbfbfb;
        --bg2: #f2f2f2;
        --panel: #fff;
        --text: #111827;
        --muted: #6b7280;
        --accent: #111827;
        --accent2: #6b7280;
        --accent3: #d1d5db;
        --border: rgba(17, 24, 39, 0.12);
        --shadow: 0 18px 44px rgba(17, 24, 39, 0.08);
        --shadow2: 0 10px 24px rgba(17, 24, 39, 0.06);
      }
      html[data-theme="mono-grey"] {
        --bg: #f3f4f6;
        --bg2: #e5e7eb;
        --panel: #fff;
        --text: #111827;
        --muted: #6b7280;
        --accent: #374151;
        --accent2: #9ca3af;
        --accent3: #e5e7eb;
        --border: rgba(17, 24, 39, 0.12);
      }
      html[data-theme="clinic-white"] {
        --bg: #f7fbff;
        --bg2: #e8f3ff;
        --panel: #fff;
        --text: #0f172a;
        --muted: #4b5563;
        --accent: #2563eb;
        --accent2: #60a5fa;
        --accent3: #dbeafe;
        --border: rgba(15, 23, 42, 0.1);
      }

      html[data-motion="off"] * {
        transition: none !important;
        animation: none !important;
        scroll-behavior: auto !important;
      }

      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: var(--font);
        color: var(--text);
        min-height: 100vh;
        background: radial-gradient(
            1200px 800px at 20% 20%,
            var(--bg2),
            transparent 55%
          ),
          radial-gradient(
            1200px 800px at 80% 70%,
            rgba(255, 255, 255, 0.35),
            transparent 55%
          ),
          linear-gradient(180deg, var(--bg), var(--bg));
      }

      .app {
        max-width: 1100px;
        margin: 32px auto 86px;
        padding: 0 18px;
        position: relative;
      }

      .decorLayer {
        position: absolute;
        inset: -40px -10px 0 -10px;
        pointer-events: none;
        opacity: 0.85;
      }
      html[data-decor="off"] .decorLayer {
        display: none;
      }

      .floatSticker {
        position: absolute;
        filter: drop-shadow(0 10px 18px rgba(0, 0, 0, 0.14));
        opacity: 0.95;
        transform: translateZ(0);
        animation: floaty var(--animSlow) ease-in-out infinite alternate;
      }
      .floatSticker.s1 {
        left: 14px;
        top: 14px;
        animation-duration: 1800ms;
      }
      .floatSticker.s2 {
        right: 24px;
        top: 56px;
        animation-duration: 2200ms;
      }
      .floatSticker.s3 {
        left: 34px;
        bottom: 120px;
        animation-duration: 2400ms;
      }
      .floatSticker.s4 {
        right: 18px;
        bottom: 80px;
        animation-duration: 2000ms;
      }
      @keyframes floaty {
        from {
          transform: translateY(0) rotate(-1deg);
        }
        to {
          transform: translateY(-10px) rotate(1deg);
        }
      }
      .svgToken {
        width: 80px;
        height: 80px;
      }
      .svgToken.small {
        width: 64px;
        height: 64px;
      }
      .svgToken.tiny {
        width: 48px;
        height: 48px;
      }

      .topBar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 14px;
        margin-bottom: 14px;
      }
      .brand {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .logo {
        width: 44px;
        height: 44px;
        border-radius: 14px;
        background: linear-gradient(135deg, var(--accent), var(--accent2));
        box-shadow: var(--shadow2);
        display: grid;
        place-items: center;
        position: relative;
        overflow: hidden;
      }
      .logo:before {
        content: "";
        position: absolute;
        inset: -2px;
        background: radial-gradient(
            circle at 30% 30%,
            rgba(255, 255, 255, 0.6),
            transparent 50%
          ),
          radial-gradient(
            circle at 70% 80%,
            rgba(255, 255, 255, 0.3),
            transparent 60%
          );
        opacity: 0.8;
      }
      .logo span {
        position: relative;
        font-size: 20px;
        filter: drop-shadow(0 6px 10px rgba(0, 0, 0, 0.18));
      }
      .titleBlock .title {
        font-size: 18px;
        font-weight: 900;
        letter-spacing: 0.3px;
        margin: 0;
      }
      .titleBlock .sub {
        margin: 2px 0 0;
        color: var(--muted);
        font-size: 12px;
      }

      .actions {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: flex-end;
      }

      .panel {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 16px;
        backdrop-filter: blur(10px);
      }
      html[data-theme="night-cat"] .panel,
      html[data-theme="ink-black"] .panel {
        backdrop-filter: none;
      }

      .grid2 {
        display: grid;
        grid-template-columns: 1.2fr 0.8fr;
        gap: 10px;
      }
      @media (max-width: 980px) {
        .grid2 {
          grid-template-columns: 1fr;
        }
      }
      .sectionTitle {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        margin-bottom: 10px;
      }
      .sectionTitle h2 {
        margin: 0;
        font-size: 14px;
        letter-spacing: 0.2px;
      }
      .sectionTitle .hint {
        font-size: 12px;
        color: var(--muted);
      }

      .btn {
        border: 1px solid transparent;
        border-radius: 14px;
        padding: 10px 12px;
        cursor: pointer;
        font-weight: 800;
        user-select: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: transform var(--animFast), filter var(--animFast),
          background var(--animFast), border var(--animFast);
        box-shadow: 0 10px 22px rgba(0, 0, 0, 0.08);
        background: linear-gradient(135deg, var(--accent), var(--accent2));
        color: #fff;
      }
      .btn:hover {
        filter: brightness(1.03);
        transform: translateY(-1px);
      }
      .btn:active {
        transform: translateY(0) scale(0.99);
      }
      .btn.secondary {
        background: transparent;
        color: var(--text);
        border-color: var(--border);
        box-shadow: none;
      }
      .btn.ghost {
        background: transparent;
        color: var(--text);
        border-color: transparent;
        box-shadow: none;
        padding: 8px 10px;
      }
      .btn.danger {
        background: linear-gradient(135deg, #ef4444, #fb7185);
      }
      .btn.ok {
        background: linear-gradient(135deg, #16a34a, #4ade80);
      }
      .btn.small {
        padding: 8px 10px;
        border-radius: 12px;
        font-weight: 800;
        box-shadow: none;
      }

      .toggle {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 10px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.32);
        cursor: pointer;
        user-select: none;
        transition: transform var(--animFast), background var(--animFast);
      }
      .toggle:hover {
        transform: translateY(-1px);
      }
      .toggle .dot {
        width: 16px;
        height: 16px;
        border-radius: 999px;
        background: rgba(107, 114, 128, 0.3);
        transition: background var(--animFast);
      }
      .toggle.on .dot {
        background: linear-gradient(135deg, var(--accent), var(--accent2));
      }
      .toggle span {
        font-size: 12px;
        color: var(--muted);
        font-weight: 800;
      }

      .select,
      .input,
      .textarea {
        width: 100%;
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 10px 12px;
        background: rgba(255, 255, 255, 0.7);
        color: var(--text);
        outline: none;
        transition: border var(--animFast), transform var(--animFast),
          background var(--animFast);
      }
      html[data-theme="night-cat"] .select,
      html[data-theme="night-cat"] .input,
      html[data-theme="night-cat"] .textarea,
      html[data-theme="ink-black"] .select,
      html[data-theme="ink-black"] .input,
      html[data-theme="ink-black"] .textarea {
        background: rgba(255, 255, 255, 0.06);
        color: var(--text);
      }
      .input:focus,
      .select:focus,
      .textarea:focus {
        border-color: rgba(255, 79, 163, 0.45);
        transform: translateY(-1px);
      }
      .textarea {
        min-height: 84px;
        resize: vertical;
      }

      .row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      .row3 {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 10px;
      }
      @media (max-width: 720px) {
        .row,
        .row3 {
          grid-template-columns: 1fr;
        }
      }

      .calHead {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        margin-bottom: 10px;
      }
      .calHead .month {
        font-weight: 900;
        letter-spacing: 0.2px;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .calHead .month .tag {
        font-size: 12px;
        color: var(--muted);
        padding: 6px 10px;
        border: 1px solid var(--border);
        border-radius: 999px;
      }
      .calGrid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 8px;
      }
      .dow {
        font-size: 12px;
        color: var(--muted);
        text-align: center;
        padding: 6px 0;
        font-weight: 900;
      }
      .dayCell {
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 10px 10px 8px;
        min-height: 76px;
        background: rgba(255, 255, 255, 0.55);
        position: relative;
        cursor: pointer;
        overflow: hidden;
        transition: transform var(--animFast), background var(--animFast),
          border var(--animFast);
      }
      html[data-theme="night-cat"] .dayCell,
      html[data-theme="ink-black"] .dayCell {
        background: rgba(255, 255, 255, 0.05);
      }
      .dayCell:hover {
        transform: translateY(-2px);
      }
      .dayCell.muted {
        opacity: 0.48;
      }
      .dayCell.today {
        border-color: rgba(255, 79, 163, 0.45);
        box-shadow: 0 12px 26px rgba(255, 79, 163, 0.14);
        background: radial-gradient(
            circle at 30% 20%,
            rgba(255, 255, 255, 0.6),
            transparent 55%
          ),
          rgba(255, 255, 255, 0.55);
      }
      html[data-theme="night-cat"] .dayCell.today,
      html[data-theme="ink-black"] .dayCell.today {
        background: radial-gradient(
            circle at 30% 20%,
            rgba(255, 255, 255, 0.18),
            transparent 55%
          ),
          rgba(255, 255, 255, 0.06);
      }
      .dayNum {
        font-weight: 900;
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .badge {
        font-size: 12px;
        font-weight: 900;
        padding: 4px 8px;
        border-radius: 999px;
        border: 1px solid var(--border);
        color: var(--muted);
        background: rgba(255, 255, 255, 0.45);
      }
      html[data-theme="night-cat"] .badge,
      html[data-theme="ink-black"] .badge {
        background: rgba(255, 255, 255, 0.06);
      }
      .badge.ok {
        color: #0b7a34;
        border-color: rgba(22, 163, 74, 0.35);
      }
      .badge.warn {
        color: #a16207;
        border-color: rgba(245, 158, 11, 0.35);
      }
      .badge.bad {
        color: #991b1b;
        border-color: rgba(239, 68, 68, 0.35);
      }
      html[data-theme="night-cat"] .badge.ok,
      html[data-theme="ink-black"] .badge.ok {
        color: #86efac;
      }
      html[data-theme="night-cat"] .badge.warn,
      html[data-theme="ink-black"] .badge.warn {
        color: #fde68a;
      }
      html[data-theme="night-cat"] .badge.bad,
      html[data-theme="ink-black"] .badge.bad {
        color: #fecaca;
      }

      .miniInfo {
        margin-top: 10px;
        font-size: 12px;
        color: var(--muted);
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }
      .miniChip {
        padding: 4px 8px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.35);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100%;
      }
      html[data-theme="night-cat"] .miniChip,
      html[data-theme="ink-black"] .miniChip {
        background: rgba(255, 255, 255, 0.06);
      }

      .list {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .item {
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 12px;
        background: rgba(255, 255, 255, 0.58);
        transition: transform var(--animFast), background var(--animFast);
      }
      html[data-theme="night-cat"] .item,
      html[data-theme="ink-black"] .item {
        background: rgba(255, 255, 255, 0.05);
      }
      .item:hover {
        transform: translateY(-1px);
      }
      .itemTop {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 10px;
      }
      .itemName {
        font-weight: 900;
        letter-spacing: 0.2px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .tagLite {
        font-size: 12px;
        padding: 4px 8px;
        border-radius: 999px;
        border: 1px solid var(--border);
        color: var(--muted);
        background: rgba(255, 255, 255, 0.3);
      }
      html[data-theme="night-cat"] .tagLite,
      html[data-theme="ink-black"] .tagLite {
        background: rgba(255, 255, 255, 0.06);
      }
      .itemMeta {
        margin-top: 8px;
        color: var(--muted);
        font-size: 12px;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }
      .itemMeta b {
        color: var(--text);
      }
      .itemBtns {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        justify-content: flex-end;
      }

      .doseRow {
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 12px;
        background: rgba(255, 255, 255, 0.58);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }
      html[data-theme="night-cat"] .doseRow,
      html[data-theme="ink-black"] .doseRow {
        background: rgba(255, 255, 255, 0.05);
      }
      .doseLeft {
        display: flex;
        flex-direction: column;
        gap: 4px;
        min-width: 0;
      }
      .doseLeft .line1 {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 900;
        min-width: 0;
      }
      .doseLeft .line1 .mname {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 360px;
      }
      @media (max-width: 720px) {
        .doseLeft .line1 .mname {
          max-width: 200px;
        }
      }
      .doseLeft .line2 {
        font-size: 12px;
        color: var(--muted);
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
      .doseRight {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: flex-end;
      }
      .statusPill {
        padding: 6px 10px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 900;
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.4);
        color: var(--muted);
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }
      html[data-theme="night-cat"] .statusPill,
      html[data-theme="ink-black"] .statusPill {
        background: rgba(255, 255, 255, 0.06);
      }
      .statusPill.ok {
        color: #0b7a34;
        border-color: rgba(22, 163, 74, 0.35);
      }
      .statusPill.warn {
        color: #a16207;
        border-color: rgba(245, 158, 11, 0.35);
      }
      .statusPill.bad {
        color: #991b1b;
        border-color: rgba(239, 68, 68, 0.35);
      }
      html[data-theme="night-cat"] .statusPill.ok,
      html[data-theme="ink-black"] .statusPill.ok {
        color: #86efac;
      }
      html[data-theme="night-cat"] .statusPill.warn,
      html[data-theme="ink-black"] .statusPill.warn {
        color: #fde68a;
      }
      html[data-theme="night-cat"] .statusPill.bad,
      html[data-theme="ink-black"] .statusPill.bad {
        color: #fecaca;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 10px;
        border-radius: 999px;
        border: 1px solid var(--border);
        color: var(--muted);
        background: rgba(255, 255, 255, 0.35);
        backdrop-filter: blur(10px);
      }
      html[data-theme="night-cat"] .pill,
      html[data-theme="ink-black"] .pill {
        background: rgba(255, 255, 255, 0.06);
        backdrop-filter: none;
      }

      .modalMask {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.32);
        display: none;
        align-items: center;
        justify-content: center;
        padding: 18px;
        z-index: 999;
      }
      .modalMask.show {
        display: flex;
      }
      .modal {
        width: min(920px, 100%);
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 22px;
        box-shadow: var(--shadow);
        overflow: hidden;
      }
      .modalHead {
        padding: 14px 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        border-bottom: 1px solid var(--border);
        background: radial-gradient(
            circle at 20% 10%,
            rgba(255, 255, 255, 0.6),
            transparent 60%
          ),
          rgba(255, 255, 255, 0.35);
      }
      html[data-theme="night-cat"] .modalHead,
      html[data-theme="ink-black"] .modalHead {
        background: radial-gradient(
            circle at 20% 10%,
            rgba(255, 255, 255, 0.12),
            transparent 60%
          ),
          rgba(255, 255, 255, 0.06);
      }
      .modalHead h3 {
        margin: 0;
        font-size: 14px;
        font-weight: 900;
        letter-spacing: 0.2px;
      }
      .modalBody {
        padding: 16px;
      }
      .modalFoot {
        padding: 14px 16px;
        border-top: 1px solid var(--border);
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        flex-wrap: wrap;
        background: rgba(255, 255, 255, 0.3);
      }
      html[data-theme="night-cat"] .modalFoot,
      html[data-theme="ink-black"] .modalFoot {
        background: rgba(255, 255, 255, 0.06);
      }

      .toastWrap {
        position: fixed;
        left: 50%;
        bottom: 18px;
        transform: translateX(-50%);
        display: flex;
        flex-direction: column;
        gap: 10px;
        z-index: 1000;
        pointer-events: none;
      }
      .toast {
        pointer-events: auto;
        border: 1px solid var(--border);
        border-radius: 999px;
        padding: 10px 14px;
        background: rgba(255, 255, 255, 0.78);
        box-shadow: var(--shadow2);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        min-width: min(540px, 92vw);
        animation: toastIn var(--anim) ease both;
      }
      html[data-theme="night-cat"] .toast,
      html[data-theme="ink-black"] .toast {
        background: rgba(15, 23, 42, 0.85);
        border-color: rgba(229, 231, 235, 0.14);
      }
      @keyframes toastIn {
        from {
          opacity: 0;
          transform: translateY(8px) scale(0.98);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }
      .toast .msg {
        font-size: 13px;
        font-weight: 900;
        color: var(--text);
      }
      .toast .miniBtn {
        border: 1px solid var(--border);
        background: transparent;
        color: var(--text);
        border-radius: 999px;
        padding: 7px 10px;
        font-weight: 900;
        cursor: pointer;
      }
      html[data-theme="night-cat"] .toast .miniBtn,
      html[data-theme="ink-black"] .toast .miniBtn {
        border-color: rgba(229, 231, 235, 0.14);
        color: var(--text);
      }

      .author {
        position: fixed;
        right: 14px;
        bottom: 10px;
        font-size: 12px;
        color: var(--muted);
        user-select: none;
        z-index: 2;
      }
      .author code {
        font-family: var(--mono);
        font-weight: 900;
      }
    </style>
  </head>

  <body>
    <div class="app">
      <div class="decorLayer" aria-hidden="true">
        <div class="floatSticker s1">
          <svg class="svgToken small" viewBox="0 0 120 120">
            <defs>
              <linearGradient id="gBow1" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0" stop-color="var(--accent)" />
                <stop offset="1" stop-color="var(--accent2)" />
              </linearGradient>
            </defs>
            <circle
              cx="60"
              cy="60"
              r="54"
              fill="rgba(255,255,255,.24)"
              stroke="rgba(255,255,255,.35)"
              stroke-width="2"
            />
            <path
              d="M60 30c-6 0-10 4-10 10 0 3 1 6 3 8-9-6-25-10-33-4-11 9 3 29 26 30 6 0 11-1 14-3 3 2 8 3 14 3 23-1 37-21 26-30-8-6-24-2-33 4 2-2 3-5 3-8 0-6-4-10-10-10z"
              fill="url(#gBow1)"
              opacity=".95"
            />
            <circle cx="60" cy="60" r="10" fill="rgba(255,255,255,.85)" />
            <circle cx="60" cy="60" r="7" fill="rgba(0,0,0,.08)" />
          </svg>
        </div>
        <div class="floatSticker s2">
          <svg class="svgToken" viewBox="0 0 120 120">
            <defs>
              <linearGradient id="gPill" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0" stop-color="var(--accent2)" />
                <stop offset="1" stop-color="var(--accent3)" />
              </linearGradient>
            </defs>
            <circle
              cx="60"
              cy="60"
              r="54"
              fill="rgba(255,255,255,.18)"
              stroke="rgba(255,255,255,.30)"
              stroke-width="2"
            />
            <g transform="translate(18 28) rotate(-18 42 32)">
              <rect
                x="10"
                y="18"
                width="74"
                height="36"
                rx="18"
                fill="rgba(255,255,255,.90)"
              />
              <path d="M47 18h19a18 18 0 0 1 0 36H47z" fill="url(#gPill)" />
              <path d="M47 18v36" stroke="rgba(0,0,0,.08)" stroke-width="2" />
              <circle cx="33" cy="36" r="4" fill="rgba(0,0,0,.06)" />
              <circle cx="25" cy="36" r="3" fill="rgba(0,0,0,.05)" />
            </g>
          </svg>
        </div>
        <div class="floatSticker s3">
          <svg class="svgToken tiny" viewBox="0 0 120 120">
            <defs>
              <linearGradient id="gHeart" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0" stop-color="var(--accent)" />
                <stop offset="1" stop-color="var(--accent2)" />
              </linearGradient>
            </defs>
            <path
              d="M60 98s-34-20-44-42c-7-16 3-34 21-34 10 0 18 5 23 12 5-7 13-12 23-12 18 0 28 18 21 34-10 22-44 42-44 42z"
              fill="url(#gHeart)"
              opacity=".92"
            />
          </svg>
        </div>
        <div class="floatSticker s4">
          <svg class="svgToken tiny" viewBox="0 0 120 120">
            <defs>
              <linearGradient id="gStar" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0" stop-color="var(--accent2)" />
                <stop offset="1" stop-color="var(--accent3)" />
              </linearGradient>
            </defs>
            <path
              d="M60 18l10 26 28 2-22 17 7 27-23-14-23 14 7-27-22-17 28-2z"
              fill="url(#gStar)"
              opacity=".9"
            />
          </svg>
        </div>
      </div>

      <div class="topBar">
        <div class="brand">
          <div class="logo" title="Katy"><span>ğŸ€</span></div>
          <div class="titleBlock">
            <p class="title">ç”¨è¯è®°å½•å™¨</p>
            <p class="sub" id="modeLabel">å…¬å…±ç©ºç™½æ¨¡å¼</p>
          </div>
        </div>

        <div class="actions">
          <div class="toggle" id="toggleDecor" onclick="uiToggleDecor()">
            <div class="dot"></div>
            <span>è£…é¥°</span>
          </div>
          <div class="toggle" id="toggleMotion" onclick="uiToggleMotion()">
            <div class="dot"></div>
            <span>åŠ¨æ•ˆ</span>
          </div>

          <select
            class="select"
            id="themeSelect"
            style="max-width: 240px"
            onchange="setTheme(this.value)"
          >
            <option value="katy-pink">ğŸ€ Katy Pink</option>
            <option value="milk-tea">ğŸ§‹ å¥¶èŒ¶ Milk Tea</option>
            <option value="peach">ğŸ‘ èœœæ¡ƒ Peach</option>
            <option value="mint">ğŸƒ è–„è· Mint</option>
            <option value="blue-calm">ğŸ’  é™è“ Blue</option>
            <option value="sky-glass">ğŸ«§ å¤©ç©ºç»ç’ƒ Sky</option>
            <option value="moonlight">ğŸŒ™ æœˆå…‰ Moonlight</option>
            <option value="night-cat">ğŸ¾ å¤œçŒ« Night Cat</option>
            <option value="ink-black">ğŸ–¤ å¢¨é»‘ Ink</option>
            <option value="minimal-paper">ğŸ“„ æç®€ Paper</option>
            <option value="mono-grey">ğŸ©¶ å•è‰² Grey</option>
            <option value="clinic-white">ğŸ©º åŒ»ç–—ç™½ Clinic</option>
          </select>

          <button class="btn secondary" type="button" onclick="openPrivacy()">
            ğŸ”‘ éšç§
          </button>
          <button class="btn secondary" type="button" onclick="openDataTools()">
            ğŸ“¦ æ•°æ®
          </button>
        </div>
      </div>

      <div class="grid2">
        <div class="panel">
          <div class="sectionTitle">
            <h2>ğŸ“… æœˆå†</h2>
            <div class="hint">ç‚¹å‡»ä»»æ„æ—¥æœŸï¼šæŸ¥çœ‹/è¡¥å½•</div>
          </div>
          <div class="calHead">
            <div class="month">
              <button class="btn ghost" type="button" onclick="calPrev()">
                â—€
              </button>
              <span id="calMonthText">â€”</span>
              <button class="btn ghost" type="button" onclick="calNext()">
                â–¶
              </button>
              <span class="tag" id="calStatsTag">â€”</span>
            </div>
            <button
              class="btn small secondary"
              type="button"
              onclick="goToday()"
            >
              å›åˆ°ä»Šå¤©
            </button>
          </div>
          <div class="calGrid" id="calGrid"></div>
        </div>

        <div class="panel">
          <div class="sectionTitle">
            <h2>ğŸ§¾ ä»Šæ—¥ç”¨è¯</h2>
            <div class="hint" id="todayHint">â€”</div>
          </div>
          <div id="todayList" class="list"></div>

          <div style="height: 12px"></div>

          <div class="sectionTitle">
            <h2>ğŸ’ æˆ‘çš„è¯ç®±</h2>
            <div class="hint">æ·»åŠ /ç¼–è¾‘/åˆ é™¤</div>
          </div>
          <div class="row">
            <input
              class="input"
              id="inMedName"
              placeholder="è¯ç‰©åç§°ï¼ˆä¾‹ï¼šç¢³é…¸é”‚ç¼“é‡Šç‰‡ï¼‰"
            />
            <input
              class="input"
              id="inMedDose"
              placeholder="å‰‚é‡/å¤‡æ³¨ï¼ˆä¾‹ï¼š300mgï¼Œæ™šé¥­åï¼‰"
            />
          </div>
          <div style="height: 10px"></div>
          <div class="row3">
            <input
              class="input"
              id="inMedTimes"
              placeholder="æ¯æ—¥æ¬¡æ•°ï¼ˆä¾‹ï¼š2ï¼‰"
              inputmode="numeric"
            />
            <input
              class="input"
              id="inMedSchedule"
              placeholder="æ—¶é—´ï¼ˆä¾‹ï¼š08:00,20:00ï¼‰"
            />
            <input
              class="input"
              id="inMedUnit"
              placeholder="å•æ¬¡å‰‚é‡ï¼ˆä¾‹ï¼š1ç‰‡/1ç²’ï¼‰"
            />
          </div>
          <div style="height: 10px"></div>
          <textarea
            class="textarea"
            id="inMedNote"
            placeholder="å¤‡æ³¨ï¼ˆå¯é€‰ï¼šé¥­å‰/é¥­å/å¿Œå£/ååº”ç­‰ï¼‰"
          ></textarea>
          <div style="height: 10px"></div>
          <button class="btn" type="button" onclick="addMed()">
            â• æ·»åŠ åˆ°è¯ç®±
          </button>

          <div style="height: 14px"></div>
          <div id="medList" class="list"></div>
        </div>
      </div>

      <!-- Day detail modal -->
      <div
        class="modalMask"
        id="dayModalMask"
        onclick="maskClose(event,'dayModalMask')"
      >
        <div class="modal" onclick="event.stopPropagation()">
          <div class="modalHead">
            <h3 id="dayModalTitle">â€”</h3>
            <button
              class="btn ghost"
              type="button"
              onclick="closeModal('dayModalMask')"
            >
              âœ•
            </button>
          </div>
          <div class="modalBody">
            <div
              style="
                display: flex;
                align-items: center;
                justify-content: space-between;
                gap: 10px;
                margin-bottom: 10px;
                flex-wrap: wrap;
              "
            >
              <div
                style="
                  display: flex;
                  align-items: center;
                  gap: 10px;
                  flex-wrap: wrap;
                "
              >
                <span class="pill" id="dayModalBadge">â€”</span>
                <span class="pill" id="dayModalSummary">â€”</span>
              </div>
              <div>
                <input
                  class="input"
                  type="date"
                  id="jumpDate"
                  style="max-width: 210px"
                  onchange="jumpToDate(this.value)"
                />
              </div>
            </div>
            <div id="dayDoseList" class="list"></div>
          </div>
          <div class="modalFoot">
            <button
              class="btn secondary"
              type="button"
              onclick="closeModal('dayModalMask')"
            >
              å…³é—­
            </button>
          </div>
        </div>
      </div>

      <!-- Confirm modal: used for "take" and "danger" actions -->
      <div
        class="modalMask"
        id="confirmMask"
        onclick="maskClose(event,'confirmMask')"
      >
        <div class="modal" onclick="event.stopPropagation()">
          <div class="modalHead">
            <h3 id="confirmTitle">ç¡®è®¤</h3>
            <button
              class="btn ghost"
              type="button"
              onclick="closeModal('confirmMask')"
            >
              âœ•
            </button>
          </div>
          <div class="modalBody">
            <div id="confirmMain" class="row">
              <div>
                <div
                  style="font-weight: 900; margin-bottom: 6px"
                  id="confirmLine1"
                >
                  â€”
                </div>
                <div
                  style="color: var(--muted); font-size: 12px; line-height: 1.5"
                  id="confirmLine2"
                >
                  â€”
                </div>
              </div>
              <div id="confirmRight">
                <label
                  style="font-size: 12px; color: var(--muted); font-weight: 900"
                  >è®°å½•æ—¶é—´</label
                >
                <input class="input" type="time" id="confirmTime" />
                <div style="height: 8px"></div>
                <label
                  style="font-size: 12px; color: var(--muted); font-weight: 900"
                  >å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</label
                >
                <input
                  class="input"
                  id="confirmNote"
                  placeholder="ä¾‹ï¼šé¥­å/æœ‰ç‚¹åé…¸/å¿˜è®°å¸¦æ°´â€¦"
                />
              </div>
            </div>

            <div style="height: 10px"></div>

            <div
              class="pill"
              id="confirmQuick"
              style="
                display: flex;
                justify-content: space-between;
                gap: 10px;
                flex-wrap: wrap;
              "
            >
              <span style="font-weight: 900">å¿«é€Ÿé€‰æ‹©</span>
              <div style="display: flex; gap: 8px; flex-wrap: wrap">
                <button
                  class="btn small secondary"
                  type="button"
                  onclick="confirmSetNow()"
                >
                  ç°åœ¨
                </button>
                <button
                  class="btn small secondary"
                  type="button"
                  id="btnSetSchedule"
                  onclick="confirmSetSchedule()"
                >
                  æŒ‰è®¡åˆ’
                </button>
                <button
                  class="btn small secondary"
                  type="button"
                  onclick="confirmClearNote()"
                >
                  æ¸…ç©ºå¤‡æ³¨
                </button>
              </div>
            </div>

            <div
              class="pill"
              id="confirmDangerHint"
              style="
                display: none;
                margin-top: 10px;
                gap: 10px;
                justify-content: space-between;
                flex-wrap: wrap;
              "
            >
              <span style="font-weight: 900">âš ï¸ é£é™©æ“ä½œ</span>
              <span style="font-size: 12px; color: var(--muted)"
                >ç¡®è®¤åç«‹å³ç”Ÿæ•ˆï¼ˆå¯åœ¨æç¤ºæ¡é‡Œæ’¤å›ï¼‰</span
              >
            </div>
          </div>
          <div class="modalFoot">
            <button
              class="btn secondary"
              type="button"
              onclick="closeModal('confirmMask')"
            >
              å–æ¶ˆ
            </button>
            <button
              class="btn ok"
              type="button"
              id="confirmOkBtn"
              onclick="confirmCommit()"
            >
              âœ… ç¡®è®¤
            </button>
          </div>
        </div>
      </div>

      <!-- Edit med modal -->
      <div
        class="modalMask"
        id="editMask"
        onclick="maskClose(event,'editMask')"
      >
        <div class="modal" onclick="event.stopPropagation()">
          <div class="modalHead">
            <h3>ç¼–è¾‘è¯ç‰©</h3>
            <button
              class="btn ghost"
              type="button"
              onclick="closeModal('editMask')"
            >
              âœ•
            </button>
          </div>
          <div class="modalBody">
            <input type="hidden" id="editId" />
            <div class="row">
              <input class="input" id="editName" placeholder="è¯ç‰©åç§°" />
              <input class="input" id="editDose" placeholder="å‰‚é‡/å¤‡æ³¨" />
            </div>
            <div style="height: 10px"></div>
            <div class="row3">
              <input
                class="input"
                id="editTimes"
                placeholder="æ¯æ—¥æ¬¡æ•°"
                inputmode="numeric"
              />
              <input
                class="input"
                id="editSchedule"
                placeholder="æ—¶é—´ï¼ˆ08:00,20:00ï¼‰"
              />
              <input
                class="input"
                id="editUnit"
                placeholder="å•æ¬¡å‰‚é‡ï¼ˆ1ç‰‡/1ç²’ï¼‰"
              />
            </div>
            <div style="height: 10px"></div>
            <textarea
              class="textarea"
              id="editNote"
              placeholder="å¤‡æ³¨"
            ></textarea>
          </div>
          <div class="modalFoot">
            <button class="btn danger" type="button" onclick="askDeleteMed()">
              ğŸ—‘ åˆ é™¤
            </button>
            <button
              class="btn secondary"
              type="button"
              onclick="closeModal('editMask')"
            >
              å–æ¶ˆ
            </button>
            <button class="btn ok" type="button" onclick="saveEdit()">
              ä¿å­˜
            </button>
          </div>
        </div>
      </div>

      <!-- Privacy modal -->
      <div
        class="modalMask"
        id="privacyMask"
        onclick="maskClose(event,'privacyMask')"
      >
        <div class="modal" onclick="event.stopPropagation()">
          <div class="modalHead">
            <h3>éšç§ä¸ç©ºé—´</h3>
            <button
              class="btn ghost"
              type="button"
              onclick="closeModal('privacyMask')"
            >
              âœ•
            </button>
          </div>
          <div class="modalBody">
            <div
              class="pill"
              style="
                display: flex;
                justify-content: space-between;
                gap: 12px;
                flex-wrap: wrap;
              "
            >
              <div>
                <div style="font-weight: 900">å½“å‰ç©ºé—´</div>
                <div
                  style="font-size: 12px; color: var(--muted)"
                  id="spaceDesc"
                >
                  â€”
                </div>
              </div>
              <div
                style="
                  display: flex;
                  gap: 8px;
                  flex-wrap: wrap;
                  align-items: center;
                "
              >
                <button
                  class="btn secondary small"
                  type="button"
                  onclick="copySelfLink()"
                >
                  å¤åˆ¶æˆ‘çš„ç§äººé“¾æ¥
                </button>
                <button
                  class="btn secondary small"
                  type="button"
                  onclick="copyPublicLink()"
                >
                  å¤åˆ¶å…¬å…±ç©ºç™½é“¾æ¥
                </button>
              </div>
            </div>

            <div style="height: 14px"></div>

            <div
              class="panel"
              style="box-shadow: none; background: rgba(255, 255, 255, 0.18)"
            >
              <div style="font-weight: 900; margin-bottom: 8px">
                åˆ‡æ¢åˆ°ç§äººç©ºé—´ï¼ˆç²˜è´´ä½ çš„ kï¼‰
              </div>
              <div class="row">
                <input
                  class="input"
                  id="inKey"
                  placeholder="è¾“å…¥ kï¼ˆä¾‹ï¼šk_ab12cd34ï¼‰"
                />
                <button class="btn ok" type="button" onclick="goWithKey()">
                  è¿›å…¥ç§äººç©ºé—´
                </button>
              </div>
              <div style="height: 10px"></div>
              <div style="display: flex; gap: 10px; flex-wrap: wrap">
                <button class="btn" type="button" onclick="createPrivateKey()">
                  ç”Ÿæˆæ–°çš„ç§äººç©ºé—´
                </button>
                <button
                  class="btn secondary"
                  type="button"
                  onclick="switchToPublic()"
                >
                  å›åˆ°å…¬å…±ç©ºç™½
                </button>
              </div>
              <div
                style="
                  margin-top: 10px;
                  color: var(--muted);
                  font-size: 12px;
                  line-height: 1.5;
                "
              >
                è§„åˆ™ï¼šå…¬å…±é“¾æ¥æ°¸è¿œæ˜¯ç©ºç™½èµ·å§‹ï¼›ç§äººç©ºé—´åªåœ¨ URL å¸¦
                <code style="font-family: var(--mono); font-weight: 900"
                  >?k=</code
                >
                æ—¶ç”Ÿæ•ˆã€‚
              </div>
            </div>
          </div>
          <div class="modalFoot">
            <button
              class="btn secondary"
              type="button"
              onclick="closeModal('privacyMask')"
            >
              å…³é—­
            </button>
          </div>
        </div>
      </div>

      <!-- Data tools modal -->
      <div
        class="modalMask"
        id="dataMask"
        onclick="maskClose(event,'dataMask')"
      >
        <div class="modal" onclick="event.stopPropagation()">
          <div class="modalHead">
            <h3>æ•°æ®å·¥å…·</h3>
            <button
              class="btn ghost"
              type="button"
              onclick="closeModal('dataMask')"
            >
              âœ•
            </button>
          </div>
          <div class="modalBody">
            <div class="row">
              <button
                class="btn secondary"
                type="button"
                onclick="exportJSON()"
              >
                å¯¼å‡º JSON
              </button>
              <button class="btn secondary" type="button" onclick="exportCSV()">
                å¯¼å‡º CSVï¼ˆæ‰“å¡æ˜ç»†ï¼‰
              </button>
            </div>

            <div style="height: 10px"></div>

            <div
              class="panel"
              style="box-shadow: none; background: rgba(255, 255, 255, 0.18)"
            >
              <div style="font-weight: 900; margin-bottom: 8px">
                å¯¼å…¥ JSONï¼ˆè¦†ç›–å½“å‰ç©ºé—´ï¼‰
              </div>
              <textarea
                class="textarea"
                id="importText"
                placeholder="ç²˜è´´ JSON"
              ></textarea>
              <div style="height: 10px"></div>
              <button class="btn ok" type="button" onclick="importJSON()">
                å¯¼å…¥å¹¶è¦†ç›–
              </button>
              <div
                style="
                  margin-top: 10px;
                  color: var(--muted);
                  font-size: 12px;
                  line-height: 1.5;
                "
              >
                å¯¼å…¥ä¼šè¦†ç›–å½“å‰ç©ºé—´å…¨éƒ¨å†…å®¹ï¼ˆè¯ç®± + æ‰“å¡è®°å½•ï¼‰ã€‚
              </div>
            </div>

            <div style="height: 12px"></div>

            <div
              class="panel"
              style="box-shadow: none; background: rgba(255, 255, 255, 0.18)"
            >
              <div style="font-weight: 900; margin-bottom: 8px">
                æ¸…ç©ºå½“å‰ç©ºé—´
              </div>
              <button class="btn danger" type="button" onclick="askWipeSpace()">
                âš ï¸ æ¸…ç©ºè¯ç®±ä¸è®°å½•
              </button>
            </div>
          </div>
          <div class="modalFoot">
            <button
              class="btn secondary"
              type="button"
              onclick="closeModal('dataMask')"
            >
              å…³é—­
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="toastWrap" id="toastWrap"></div>
    <div class="author">by <code>FLAAAAKING</code></div>

    <script>
      /* =========================
   Storage / Space
   ========================= */
      const VERSION = "v1";
      const KEY_PARAM = "k";
      const PUBLIC_SPACE = "public";
      const LS_PREFIX = `katyMedTracker:${VERSION}:`;
      const UI_KEY = `katyMedTracker:${VERSION}:ui`;

      function qs() {
        return new URLSearchParams(location.search);
      }
      function getKeyFromUrl() {
        const k = qs().get(KEY_PARAM) || "";
        if (!k) return "";
        if (!/^k_[a-zA-Z0-9_-]{6,64}$/.test(k)) return "";
        return k;
      }
      function spaceId() {
        return getKeyFromUrl() || PUBLIC_SPACE;
      }
      function storageKey() {
        return LS_PREFIX + spaceId();
      }
      function isPrivate() {
        return spaceId() !== PUBLIC_SPACE;
      }

      function nowISODate(d = new Date()) {
        const z = new Date(d.getTime() - d.getTimezoneOffset() * 60000);
        return z.toISOString().slice(0, 10);
      }
      function nowTimeHHMM(d = new Date()) {
        const hh = String(d.getHours()).padStart(2, "0");
        const mm = String(d.getMinutes()).padStart(2, "0");
        return `${hh}:${mm}`;
      }
      function ymdToDate(ymd) {
        const [y, m, dd] = ymd.split("-").map(Number);
        return new Date(y, m - 1, dd);
      }
      function fmtCN(ymd) {
        const d = ymdToDate(ymd);
        return `${d.getFullYear()}å¹´${d.getMonth() + 1}æœˆ${d.getDate()}æ—¥`;
      }
      function clamp(n, a, b) {
        return Math.max(a, Math.min(b, n));
      }
      function uid() {
        return (
          "m_" +
          Math.random().toString(36).slice(2, 10) +
          Math.random().toString(36).slice(2, 6)
        );
      }
      function clone(x) {
        return JSON.parse(JSON.stringify(x));
      } // avoid structuredClone compatibility issues

      /* =========================
   State
   ========================= */
      const defaultState = { meds: [], records: {} };
      let state = loadState();
      let calCursor = new Date();
      let selectedDay = nowISODate();

      /* =========================
   Load/Save
   ========================= */
      function normalizeMed(m) {
        if (!m || typeof m !== "object") return null;
        const name = String(m.name || "").trim();
        if (!name) return null;
        const timesPerDay = clamp(parseInt(m.timesPerDay ?? 1, 10) || 1, 1, 6);
        const schedule = Array.isArray(m.schedule)
          ? m.schedule
          : String(m.schedule || "")
              .split(",")
              .map((s) => s.trim())
              .filter(Boolean);
        const sched = schedule
          .map((x) => x.trim())
          .filter((x) => /^\d{2}:\d{2}$/.test(x))
          .slice(0, 6);
        const defaults = ["08:00", "12:00", "20:00", "22:00", "06:00", "16:00"];
        const finalSchedule = (
          sched.length ? sched : defaults.slice(0, timesPerDay)
        ).slice(0, timesPerDay);

        return {
          id: String(m.id || uid()),
          name,
          dose: String(m.dose || "").trim(),
          unit: String(m.unit || "").trim(),
          timesPerDay,
          schedule: finalSchedule,
          note: String(m.note || "").trim(),
          createdAt: m.createdAt || Date.now(),
        };
      }
      function normalizeState(s) {
        const out = clone(defaultState);
        if (s && typeof s === "object") {
          if (Array.isArray(s.meds))
            out.meds = s.meds.map(normalizeMed).filter(Boolean);
          if (s.records && typeof s.records === "object")
            out.records = s.records;
        }
        const seen = new Set();
        out.meds = out.meds.map((m) => {
          if (!m.id || seen.has(m.id)) m.id = uid();
          seen.add(m.id);
          return m;
        });
        return out;
      }
      function loadState() {
        try {
          const raw = localStorage.getItem(storageKey());
          if (!raw) return clone(defaultState);
          return normalizeState(JSON.parse(raw));
        } catch (e) {
          return clone(defaultState);
        }
      }
      function saveState() {
        localStorage.setItem(storageKey(), JSON.stringify(state));
      }

      /* =========================
   UI settings
   ========================= */
      function loadUI() {
        let ui = { theme: "katy-pink", decor: "on", motion: "on" };
        try {
          const raw = localStorage.getItem(UI_KEY);
          if (raw) {
            const p = JSON.parse(raw);
            ui.theme = p.theme || ui.theme;
            ui.decor = p.decor || ui.decor;
            ui.motion = p.motion || ui.motion;
          }
        } catch {}
        return ui;
      }
      function saveUI(ui) {
        localStorage.setItem(UI_KEY, JSON.stringify(ui));
      }
      let ui = loadUI();

      function applyUI() {
        document.documentElement.setAttribute("data-theme", ui.theme);
        document.documentElement.setAttribute("data-decor", ui.decor);
        document.documentElement.setAttribute("data-motion", ui.motion);

        const themeSel = document.getElementById("themeSelect");
        if (themeSel) themeSel.value = ui.theme;

        const decorBtn = document.getElementById("toggleDecor");
        const motionBtn = document.getElementById("toggleMotion");
        if (decorBtn) decorBtn.classList.toggle("on", ui.decor === "on");
        if (motionBtn) motionBtn.classList.toggle("on", ui.motion === "on");
      }
      function uiToggleDecor() {
        ui.decor = ui.decor === "on" ? "off" : "on";
        saveUI(ui);
        applyUI();
      }
      function uiToggleMotion() {
        ui.motion = ui.motion === "on" ? "off" : "on";
        saveUI(ui);
        applyUI();
      }
      function setTheme(theme) {
        ui.theme = theme;
        saveUI(ui);
        applyUI();
        toast("çš®è‚¤å·²åˆ‡æ¢ âœ¨");
      }

      /* =========================
   Toast
   ========================= */
      function toast(message, actions = []) {
        const wrap = document.getElementById("toastWrap");
        const t = document.createElement("div");
        t.className = "toast";
        const msg = document.createElement("div");
        msg.className = "msg";
        msg.textContent = message;
        t.appendChild(msg);

        const right = document.createElement("div");
        right.style.display = "flex";
        right.style.gap = "8px";
        actions.forEach((a) => {
          const b = document.createElement("button");
          b.className = "miniBtn";
          b.type = "button";
          b.textContent = a.label;
          b.onclick = () => {
            try {
              a.onClick?.();
            } finally {
              t.remove();
            }
          };
          right.appendChild(b);
        });
        t.appendChild(right);
        wrap.appendChild(t);

        setTimeout(() => {
          if (t.isConnected) t.remove();
        }, 4200);
      }

      /* =========================
   Modals
   ========================= */
      function openModal(id) {
        document.getElementById(id).classList.add("show");
      }
      function closeModal(id) {
        document.getElementById(id).classList.remove("show");
      }
      function maskClose(e, id) {
        if (e.target && e.target.id === id) closeModal(id);
      }

      /* =========================
   Privacy / links
   ========================= */
      function baseUrl() {
        return location.origin + location.pathname;
      }
      function selfLink() {
        const k = getKeyFromUrl();
        if (!k) return "";
        return baseUrl() + `?${KEY_PARAM}=` + encodeURIComponent(k);
      }
      function publicLink() {
        return baseUrl();
      }

      async function copyText(text) {
        try {
          await navigator.clipboard.writeText(text);
          toast("å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ âœ…");
        } catch {
          prompt("å¤åˆ¶ä¸‹é¢é“¾æ¥ï¼š", text);
        }
      }
      function createPrivateKey() {
        const k =
          "k_" +
          Math.random().toString(36).slice(2, 10) +
          Math.random().toString(36).slice(2, 6);
        const url = new URL(baseUrl());
        url.searchParams.set(KEY_PARAM, k);
        location.href = url.toString();
      }
      function goWithKey() {
        const raw = document.getElementById("inKey").value.trim();
        if (!/^k_[a-zA-Z0-9_-]{6,64}$/.test(raw)) {
          toast("k æ ¼å¼ä¸å¯¹ï¼ˆç¤ºä¾‹ï¼šk_ab12cd34ï¼‰");
          return;
        }
        const url = new URL(baseUrl());
        url.searchParams.set(KEY_PARAM, raw);
        location.href = url.toString();
      }
      function switchToPublic() {
        location.href = baseUrl();
      }
      function copySelfLink() {
        const link = selfLink();
        if (!link) {
          toast("å½“å‰ä¸æ˜¯ç§äººç©ºé—´ï¼Œå…ˆç”Ÿæˆ/è¿›å…¥ç§äººç©ºé—´");
          return;
        }
        copyText(link);
      }
      function copyPublicLink() {
        copyText(publicLink());
      }
      function openPrivacy() {
        const desc = document.getElementById("spaceDesc");
        desc.textContent = isPrivate()
          ? `ç§äººç©ºé—´ï¼ˆ${spaceId()}ï¼‰`
          : `å…¬å…±ç©ºç™½æ¨¡å¼ï¼ˆåˆ†äº«ç»™åˆ«äººé»˜è®¤æ˜¯ç©ºç™½ï¼‰`;
        openModal("privacyMask");
      }

      /* =========================
   Data tools
   ========================= */
      function openDataTools() {
        openModal("dataMask");
      }
      function downloadFile(filename, content, mime) {
        const blob = new Blob([content], { type: mime });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }
      function exportJSON() {
        const payload = { exportedAt: Date.now(), space: spaceId(), state };
        downloadFile(
          `katy-med-${spaceId()}-${nowISODate()}.json`,
          JSON.stringify(payload, null, 2),
          "application/json"
        );
        toast("å·²å¯¼å‡º JSON ğŸ“¦");
      }
      function exportCSV() {
        const rows = [
          ["date", "medName", "scheduleTime", "taken", "takenTime", "note"],
        ];
        const medMap = new Map(state.meds.map((m) => [m.id, m]));
        const dates = Object.keys(state.records).sort();
        for (const d of dates) {
          const doses = state.records[d]?.doses || {};
          for (const key of Object.keys(doses)) {
            const entry = doses[key];
            const [medId, sch] = key.split("@");
            const med = medMap.get(medId);
            rows.push([
              d,
              med?.name || medId,
              sch || "",
              entry?.taken ? "1" : "0",
              entry?.takenTime || "",
              (entry?.note || "").replace(/\n/g, " "),
            ]);
          }
        }
        const csv = rows
          .map((r) =>
            r
              .map((cell) => {
                const s = String(cell ?? "");
                return /[",\n]/.test(s) ? `"${s.replace(/"/g, '""')}"` : s;
              })
              .join(",")
          )
          .join("\n");
        downloadFile(
          `katy-med-records-${spaceId()}-${nowISODate()}.csv`,
          csv,
          "text/csv"
        );
        toast("å·²å¯¼å‡º CSV ğŸ“„");
      }
      function importJSON() {
        const text = document.getElementById("importText").value.trim();
        if (!text) {
          toast("æ²¡æœ‰å†…å®¹");
          return;
        }
        try {
          const p = JSON.parse(text);
          const incoming = p.state ? p.state : p;
          state = normalizeState(incoming);
          saveState();
          renderAll();
          toast("å¯¼å…¥å®Œæˆï¼ˆå·²è¦†ç›–ï¼‰âœ…");
        } catch {
          toast("JSON è§£æå¤±è´¥");
        }
      }

      /* ä¸å†ç”¨ confirm()ï¼Œæ”¹ç”¨ç«™å†…ç¡®è®¤ */
      function askWipeSpace() {
        openConfirmDanger({
          title: "ç¡®è®¤æ¸…ç©ºå½“å‰ç©ºé—´",
          line1: `æ¸…ç©ºç©ºé—´ï¼š${spaceId()}`,
          line2: "å°†åˆ é™¤ï¼šè¯ç®± + æ‰€æœ‰æ‰“å¡è®°å½•ã€‚ç¡®è®¤åç«‹å³ç”Ÿæ•ˆã€‚",
          okText: "âš ï¸ ç«‹å³æ¸…ç©º",
          onOk: () => {
            state = clone(defaultState);
            saveState();
            renderAll();
            toast("å·²æ¸…ç©ºå½“å‰ç©ºé—´", []);
          },
        });
      }

      /* =========================
   Plan / Records
   ========================= */
      function plannedKeysForDate(ymd) {
        const out = [];
        for (const m of state.meds) {
          const sched = (m.schedule || []).slice(0, m.timesPerDay || 1);
          for (const t of sched) {
            out.push({ med: m, time: t, key: `${m.id}@${t}` });
          }
        }
        out.sort((a, b) =>
          a.time !== b.time
            ? a.time.localeCompare(b.time)
            : a.med.name.localeCompare(b.med.name)
        );
        return out;
      }
      function getDayRecord(ymd) {
        if (!state.records[ymd]) state.records[ymd] = { doses: {} };
        if (!state.records[ymd].doses) state.records[ymd].doses = {};
        return state.records[ymd];
      }
      function getDoseEntry(ymd, doseKey) {
        const rec = getDayRecord(ymd);
        if (!rec.doses[doseKey])
          rec.doses[doseKey] = {
            taken: false,
            takenTime: "",
            note: "",
            updatedAt: Date.now(),
          };
        return rec.doses[doseKey];
      }

      /* =========================
   Smart Confirm (Take) + Danger Confirm
   ========================= */
      let pendingConfirm = null; // {type:"take"|"danger", ...}

      function openConfirmTake({ ymd, doseKey, medName, scheduleTime }) {
        pendingConfirm = { type: "take", ymd, doseKey, medName, scheduleTime };

        document.getElementById("confirmTitle").textContent = "ç¡®è®¤è®°å½•å·²æœç”¨";
        document.getElementById("confirmLine1").textContent = medName;
        document.getElementById("confirmLine2").textContent = `${fmtCN(
          ymd
        )} Â· è®¡åˆ’æ—¶é—´ ${scheduleTime}`;
        document.getElementById("confirmTime").value =
          scheduleTime || nowTimeHHMM();
        document.getElementById("confirmNote").value = "";

        document.getElementById("confirmRight").style.display = "";
        document.getElementById("confirmQuick").style.display = "flex";
        document.getElementById("confirmDangerHint").style.display = "none";

        const btn = document.getElementById("btnSetSchedule");
        btn.textContent = "æŒ‰è®¡åˆ’";
        btn.disabled = !scheduleTime;

        const okBtn = document.getElementById("confirmOkBtn");
        okBtn.className = "btn ok";
        okBtn.textContent = "âœ… ç¡®è®¤è®°å½•";

        openModal("confirmMask");
      }

      /* é£é™©åŠ¨ä½œç¡®è®¤ï¼ˆåˆ é™¤/æ¸…ç©ºç­‰ï¼‰ */
      function openConfirmDanger({ title, line1, line2, okText, onOk }) {
        pendingConfirm = { type: "danger", onOk };

        document.getElementById("confirmTitle").textContent = title;
        document.getElementById("confirmLine1").textContent = line1;
        document.getElementById("confirmLine2").textContent = line2;

        document.getElementById("confirmRight").style.display = "none";
        document.getElementById("confirmQuick").style.display = "none";
        document.getElementById("confirmDangerHint").style.display = "flex";

        const okBtn = document.getElementById("confirmOkBtn");
        okBtn.className = "btn danger";
        okBtn.textContent = okText || "ç¡®è®¤";

        openModal("confirmMask");
      }

      function confirmSetNow() {
        document.getElementById("confirmTime").value = nowTimeHHMM();
      }
      function confirmSetSchedule() {
        if (pendingConfirm?.type !== "take") return;
        if (!pendingConfirm.scheduleTime) return;
        document.getElementById("confirmTime").value =
          pendingConfirm.scheduleTime;
      }
      function confirmClearNote() {
        document.getElementById("confirmNote").value = "";
      }

      function confirmCommit() {
        if (!pendingConfirm) return;

        if (pendingConfirm.type === "take") {
          const { ymd, doseKey, scheduleTime } = pendingConfirm;
          const rec = getDayRecord(ymd);
          const t =
            document.getElementById("confirmTime").value.trim() ||
            scheduleTime ||
            nowTimeHHMM();
          const note = document.getElementById("confirmNote").value.trim();
          rec.doses[doseKey] = {
            taken: true,
            takenTime: t,
            note,
            updatedAt: Date.now(),
          };
          saveState();
          closeModal("confirmMask");
          renderAll();
          toast("å·²ç¡®è®¤è®°å½• âœ…", [
            {
              label: "æ’¤é”€",
              onClick: () => undoDose(ymd, doseKey),
            },
          ]);
        } else {
          // danger
          const onOk = pendingConfirm.onOk;
          closeModal("confirmMask");
          pendingConfirm = null;
          onOk?.();
        }
        pendingConfirm = null;
      }

      /* =========================
   One-click undo (fix your issue)
   ========================= */
      function undoDose(ymd, doseKey) {
        const rec = getDayRecord(ymd);
        const prev = rec.doses[doseKey] ? clone(rec.doses[doseKey]) : null;

        rec.doses[doseKey] = {
          taken: false,
          takenTime: "",
          note: "",
          updatedAt: Date.now(),
        };
        saveState();
        renderAll();

        toast("å·²æ’¤é”€ âœ…", [
          {
            label: "æ¢å¤",
            onClick: () => {
              if (prev) {
                rec.doses[doseKey] = prev;
              } else {
                delete rec.doses[doseKey];
              }
              saveState();
              renderAll();
              toast("å·²æ¢å¤");
            },
          },
        ]);
      }

      /* =========================
   Calendar status
   ========================= */
      function dayStatus(ymd) {
        const plan = plannedKeysForDate(ymd);
        if (plan.length === 0) return { kind: "bad", label: "æ— è¯", chips: [] };

        const rec = state.records[ymd]?.doses || {};
        let taken = 0,
          hasAny = false;
        const chips = [];

        for (const p of plan) {
          const e = rec[p.key];
          if (e) {
            hasAny = true;
            if (e.taken) taken++;
          }
        }

        const today = nowISODate();
        const isPast = ymd < today;
        const isFuture = ymd > today;

        if (taken === plan.length && plan.length > 0) {
          chips.push(`å…¨éƒ¨å·²æœç”¨ ${taken}/${plan.length}`);
          return { kind: "ok", label: "âœ…", chips };
        }
        if (!hasAny && isFuture) {
          chips.push(`è®¡åˆ’ ${plan.length} æ¬¡`);
          return { kind: "bad", label: "â€¢", chips };
        }
        if (isPast) {
          chips.push(`å·²è®°å½• ${taken}/${plan.length}`);
          if (taken === 0) return { kind: "bad", label: "â›”", chips };
          return { kind: "warn", label: "âš ï¸", chips };
        }
        chips.push(`è¿›åº¦ ${taken}/${plan.length}`);
        return { kind: "warn", label: "â³", chips };
      }

      function monthStats(startDate, endDate) {
        let ok = 0,
          warn = 0,
          none = 0;
        for (
          let d = new Date(startDate);
          d <= endDate;
          d.setDate(d.getDate() + 1)
        ) {
          const ymd = nowISODate(d);
          const st = dayStatus(ymd);
          if (st.label === "âœ…") ok++;
          else if (st.label === "âš ï¸" || st.label === "â³") warn++;
          else none++;
        }
        return { ok, warn, none };
      }

      /* =========================
   Calendar render
   ========================= */
      function monthLabel(d) {
        return `${d.getFullYear()}å¹´${d.getMonth() + 1}æœˆ`;
      }
      function calPrev() {
        calCursor = new Date(
          calCursor.getFullYear(),
          calCursor.getMonth() - 1,
          1
        );
        renderCalendar();
      }
      function calNext() {
        calCursor = new Date(
          calCursor.getFullYear(),
          calCursor.getMonth() + 1,
          1
        );
        renderCalendar();
      }
      function goToday() {
        selectedDay = nowISODate();
        calCursor = new Date();
        renderAll();
        openDay(selectedDay);
      }

      function makeDayCell(date, muted, todayYmd) {
        const ymd = nowISODate(date);
        const cell = document.createElement("div");
        cell.className =
          "dayCell" +
          (muted ? " muted" : "") +
          (ymd === todayYmd ? " today" : "");
        cell.onclick = () => openDay(ymd);

        const top = document.createElement("div");
        top.className = "dayNum";
        const left = document.createElement("span");
        left.textContent = String(date.getDate());
        const badge = document.createElement("span");
        badge.className = "badge";

        const st = dayStatus(ymd);
        badge.textContent = st.label;
        badge.classList.toggle("ok", st.kind === "ok");
        badge.classList.toggle("warn", st.kind === "warn");
        badge.classList.toggle("bad", st.kind === "bad");
        top.appendChild(left);
        top.appendChild(badge);
        cell.appendChild(top);

        const mini = document.createElement("div");
        mini.className = "miniInfo";
        const chips = st.chips.slice(0, 3);
        if (chips.length === 0) {
          const chip = document.createElement("span");
          chip.className = "miniChip";
          chip.textContent = "â€”";
          mini.appendChild(chip);
        } else {
          for (const c of chips) {
            const chip = document.createElement("span");
            chip.className = "miniChip";
            chip.textContent = c;
            mini.appendChild(chip);
          }
        }
        cell.appendChild(mini);
        return cell;
      }

      function renderCalendar() {
        const grid = document.getElementById("calGrid");
        grid.innerHTML = "";

        const dows = ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"];
        for (const w of dows) {
          const el = document.createElement("div");
          el.className = "dow";
          el.textContent = w;
          grid.appendChild(el);
        }

        const y = calCursor.getFullYear();
        const m = calCursor.getMonth();
        document.getElementById("calMonthText").textContent =
          monthLabel(calCursor);

        const first = new Date(y, m, 1);
        const startDow = first.getDay();
        const daysInMonth = new Date(y, m + 1, 0).getDate();

        const prevDays = startDow;
        const prevLast = new Date(y, m, 0).getDate();
        const today = nowISODate();

        const stats = monthStats(new Date(y, m, 1), new Date(y, m + 1, 0));
        document.getElementById(
          "calStatsTag"
        ).textContent = `âœ…${stats.ok} âš ï¸${stats.warn} â€¢${stats.none}`;

        for (let i = prevDays; i > 0; i--) {
          const dayNum = prevLast - i + 1;
          grid.appendChild(
            makeDayCell(new Date(y, m - 1, dayNum), true, today)
          );
        }
        for (let day = 1; day <= daysInMonth; day++) {
          grid.appendChild(makeDayCell(new Date(y, m, day), false, today));
        }
        const totalCells = prevDays + daysInMonth;
        const extra = (7 - (totalCells % 7)) % 7;
        for (let i = 1; i <= extra; i++) {
          grid.appendChild(makeDayCell(new Date(y, m + 1, i), true, today));
        }
      }

      /* =========================
   Day modal
   ========================= */
      function openDay(ymd) {
        selectedDay = ymd;
        document.getElementById("jumpDate").value = ymd;

        const plan = plannedKeysForDate(ymd);
        const rec = getDayRecord(ymd).doses;

        document.getElementById("dayModalTitle").textContent = `ğŸ“Œ ${fmtCN(
          ymd
        )} ç”¨è¯æ˜ç»†`;
        const st = dayStatus(ymd);
        document.getElementById(
          "dayModalBadge"
        ).textContent = `çŠ¶æ€ï¼š${st.label}`;
        const taken = plan.filter((p) => rec[p.key]?.taken).length;
        document.getElementById(
          "dayModalSummary"
        ).textContent = `è¿›åº¦ï¼š${taken}/${plan.length}`;

        const list = document.getElementById("dayDoseList");
        list.innerHTML = "";

        if (plan.length === 0) {
          const empty = document.createElement("div");
          empty.className = "item";
          empty.innerHTML = `<div style="font-weight:900">å½“å‰è¯ç®±ä¸ºç©º</div><div style="margin-top:6px;color:var(--muted);font-size:12px">å…ˆåœ¨å³ä¾§æ·»åŠ è¯ç‰©ï¼Œå†å›æ¥æ‰“å¡ã€‚</div>`;
          list.appendChild(empty);
        } else {
          for (const p of plan) {
            const entry = rec[p.key] || {
              taken: false,
              takenTime: "",
              note: "",
            };

            const row = document.createElement("div");
            row.className = "doseRow";

            const left = document.createElement("div");
            left.className = "doseLeft";

            const l1 = document.createElement("div");
            l1.className = "line1";
            const name = document.createElement("span");
            name.className = "mname";
            name.textContent = p.med.name;
            const tag = document.createElement("span");
            tag.className = "tagLite";
            tag.textContent = `è®¡åˆ’ ${p.time}`;
            l1.appendChild(name);
            l1.appendChild(tag);

            const l2 = document.createElement("div");
            l2.className = "line2";
            const doseTxt = [p.med.unit, p.med.dose]
              .filter(Boolean)
              .join(" Â· ");
            l2.innerHTML = `<span>å‰‚é‡ï¼š<b>${
              doseTxt || "æœªæ³¨æ˜"
            }</b></span><span>å¤‡æ³¨ï¼š<b>${p.med.note || "â€”"}</b></span>`;

            left.appendChild(l1);
            left.appendChild(l2);

            const right = document.createElement("div");
            right.className = "doseRight";

            const stp = document.createElement("span");
            stp.className =
              "statusPill " +
              (entry.taken ? "ok" : ymd < nowISODate() ? "bad" : "warn");
            stp.textContent = entry.taken
              ? `âœ… å·²æœç”¨ ${entry.takenTime || ""}`
              : ymd < nowISODate()
              ? "â›” æœªè®°å½•"
              : "â³ å¾…æœç”¨";

            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = "btn small " + (entry.taken ? "secondary" : "ok");
            btn.textContent = entry.taken ? "ä¸€é”®æ’¤é”€" : "æ ‡è®°å·²æœç”¨";
            btn.onclick = () => {
              if (entry.taken) {
                undoDose(ymd, p.key);
              } else {
                openConfirmTake({
                  ymd,
                  doseKey: p.key,
                  medName: p.med.name,
                  scheduleTime: p.time,
                });
              }
            };

            right.appendChild(stp);
            right.appendChild(btn);

            row.appendChild(left);
            row.appendChild(right);
            list.appendChild(row);
          }
        }

        openModal("dayModalMask");
      }
      function jumpToDate(value) {
        if (!value) return;
        openDay(value);
        const d = ymdToDate(value);
        calCursor = new Date(d.getFullYear(), d.getMonth(), 1);
        renderCalendar();
      }

      /* =========================
   Today render (æ’¤é”€ä¸€é”®)
   ========================= */
      function renderToday() {
        const ymd = nowISODate();
        const plan = plannedKeysForDate(ymd);
        const list = document.getElementById("todayList");
        list.innerHTML = "";

        document.getElementById("todayHint").textContent = plan.length
          ? `ä»Šå¤©è®¡åˆ’ ${plan.length} æ¬¡`
          : "è¯ç®±ä¸ºç©º";

        const modeLabel = document.getElementById("modeLabel");
        modeLabel.textContent = isPrivate()
          ? `ç§äººç©ºé—´ï¼ˆ${spaceId()}ï¼‰`
          : `å…¬å…±ç©ºç™½æ¨¡å¼`;

        if (plan.length === 0) {
          const empty = document.createElement("div");
          empty.className = "item";
          empty.innerHTML = `<div style="font-weight:900">ä»Šå¤©æ²¡æœ‰è®¡åˆ’</div><div style="margin-top:6px;color:var(--muted);font-size:12px">æ·»åŠ è¯ç‰©åï¼Œè¿™é‡Œä¼šè‡ªåŠ¨ç”Ÿæˆè®¡åˆ’ã€‚</div>`;
          list.appendChild(empty);
          return;
        }

        const rec = getDayRecord(ymd).doses;
        let done = 0;

        for (const p of plan) {
          const entry = rec[p.key] || { taken: false, takenTime: "", note: "" };
          if (entry.taken) done++;

          const it = document.createElement("div");
          it.className = "item";

          const top = document.createElement("div");
          top.className = "itemTop";

          const left = document.createElement("div");
          left.style.minWidth = "0";

          const name = document.createElement("div");
          name.className = "itemName";
          name.innerHTML = `<span>${
            entry.taken ? "âœ…" : "â³"
          }</span><span style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:360px">${
            p.med.name
          }</span>`;
          const tag = document.createElement("span");
          tag.className = "tagLite";
          tag.textContent = `è®¡åˆ’ ${p.time}`;
          name.appendChild(tag);

          const meta = document.createElement("div");
          meta.className = "itemMeta";
          const doseTxt = [p.med.unit, p.med.dose].filter(Boolean).join(" Â· ");
          meta.innerHTML = `<span>å‰‚é‡ï¼š<b>${
            doseTxt || "æœªæ³¨æ˜"
          }</b></span><span>è®°å½•ï¼š<b>${
            entry.taken ? entry.takenTime || "å·²ç¡®è®¤" : "â€”"
          }</b></span>`;

          left.appendChild(name);
          left.appendChild(meta);

          const btns = document.createElement("div");
          btns.className = "itemBtns";

          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "btn small " + (entry.taken ? "secondary" : "ok");
          btn.textContent = entry.taken ? "ä¸€é”®æ’¤é”€" : "ç¡®è®¤å·²æœç”¨";
          btn.onclick = () => {
            if (entry.taken) {
              undoDose(ymd, p.key);
            } else {
              openConfirmTake({
                ymd,
                doseKey: p.key,
                medName: p.med.name,
                scheduleTime: p.time,
              });
            }
          };

          const btnDetail = document.createElement("button");
          btnDetail.type = "button";
          btnDetail.className = "btn small secondary";
          btnDetail.textContent = "è¯¦æƒ…/è¡¥å½•";
          btnDetail.onclick = () => openDay(ymd);

          btns.appendChild(btn);
          btns.appendChild(btnDetail);

          top.appendChild(left);
          top.appendChild(btns);

          it.appendChild(top);
          list.appendChild(it);
        }

        // show progress in subtitle
        const sub = isPrivate()
          ? `ç§äººç©ºé—´ Â· ä»Šæ—¥ ${done}/${plan.length}`
          : `å…¬å…±ç©ºç™½æ¨¡å¼ Â· ä»Šæ—¥ ${done}/${plan.length}`;
        document.getElementById("modeLabel").textContent = sub;
      }

      /* =========================
   Med CRUD (åˆ é™¤æ”¹ä¸ºç«™å†…ç¡®è®¤)
   ========================= */
      function addMed() {
        const name = document.getElementById("inMedName").value.trim();
        if (!name) {
          toast("è¯ç‰©åç§°ä¸èƒ½ä¸ºç©º");
          return;
        }
        const dose = document.getElementById("inMedDose").value.trim();
        const unit = document.getElementById("inMedUnit").value.trim();
        const timesPerDay = clamp(
          parseInt(
            document.getElementById("inMedTimes").value.trim() || "1",
            10
          ) || 1,
          1,
          6
        );
        const scheduleRaw = document
          .getElementById("inMedSchedule")
          .value.trim();
        const schedule = scheduleRaw
          ? scheduleRaw
              .split(",")
              .map((s) => s.trim())
              .filter(Boolean)
              .filter((s) => /^\d{2}:\d{2}$/.test(s))
          : [];
        const note = document.getElementById("inMedNote").value.trim();

        const med = normalizeMed({
          id: uid(),
          name,
          dose,
          unit,
          timesPerDay,
          schedule: schedule.length ? schedule : undefined,
          note,
        });
        state.meds.unshift(med);
        saveState();

        document.getElementById("inMedName").value = "";
        document.getElementById("inMedDose").value = "";
        document.getElementById("inMedUnit").value = "";
        document.getElementById("inMedTimes").value = "";
        document.getElementById("inMedSchedule").value = "";
        document.getElementById("inMedNote").value = "";

        renderAll();
        toast("å·²æ·»åŠ åˆ°è¯ç®± âœ…");
      }

      function openEdit(medId) {
        const m = state.meds.find((x) => x.id === medId);
        if (!m) return;
        document.getElementById("editId").value = m.id;
        document.getElementById("editName").value = m.name;
        document.getElementById("editDose").value = m.dose || "";
        document.getElementById("editUnit").value = m.unit || "";
        document.getElementById("editTimes").value = String(m.timesPerDay || 1);
        document.getElementById("editSchedule").value = (m.schedule || []).join(
          ","
        );
        document.getElementById("editNote").value = m.note || "";
        openModal("editMask");
      }
      function saveEdit() {
        const id = document.getElementById("editId").value;
        const idx = state.meds.findIndex((x) => x.id === id);
        if (idx < 0) return;

        const updated = normalizeMed({
          id,
          name: document.getElementById("editName").value.trim(),
          dose: document.getElementById("editDose").value.trim(),
          unit: document.getElementById("editUnit").value.trim(),
          timesPerDay:
            parseInt(
              document.getElementById("editTimes").value.trim() || "1",
              10
            ) || 1,
          schedule: document.getElementById("editSchedule").value.trim(),
          note: document.getElementById("editNote").value.trim(),
          createdAt: state.meds[idx].createdAt,
        });
        if (!updated) {
          toast("è¯ç‰©åç§°ä¸èƒ½ä¸ºç©º");
          return;
        }

        state.meds[idx] = updated;
        saveState();
        closeModal("editMask");
        renderAll();
        toast("è¯ç‰©å·²æ›´æ–° âœ…");
      }

      /* åˆ é™¤ï¼šä¸ç”¨ confirm()ï¼Œç”¨ confirmMask */
      function askDeleteMed() {
        const id = document.getElementById("editId").value;
        const m = state.meds.find((x) => x.id === id);
        if (!m) {
          toast("æ‰¾ä¸åˆ°è¯¥è¯ç‰©");
          return;
        }

        openConfirmDanger({
          title: "ç¡®è®¤åˆ é™¤è¯ç‰©",
          line1: `åˆ é™¤ï¼š${m.name}`,
          line2: "å°†åŒæ—¶ç§»é™¤æ‰€æœ‰å†å²è®°å½•é‡Œä¸è¯¥è¯ç›¸å…³çš„æ¡ç›®ã€‚",
          okText: "ğŸ—‘ ç«‹å³åˆ é™¤",
          onOk: () => {
            deleteMedHard(id);
          },
        });
      }
      function deleteMedHard(id) {
        const m = state.meds.find((x) => x.id === id);
        // backup for undo
        const backup = m ? clone(m) : null;
        const removedRecordKeys = []; // [{date, key, value}]
        for (const d of Object.keys(state.records)) {
          const doses = state.records[d]?.doses;
          if (!doses) continue;
          for (const k of Object.keys(doses)) {
            if (k.startsWith(id + "@")) {
              removedRecordKeys.push({
                date: d,
                key: k,
                value: clone(doses[k]),
              });
              delete doses[k];
            }
          }
        }
        state.meds = state.meds.filter((x) => x.id !== id);
        saveState();
        closeModal("editMask");
        renderAll();

        toast("å·²åˆ é™¤ âœ…", [
          {
            label: "æ’¤å›",
            onClick: () => {
              if (backup) state.meds.unshift(backup);
              for (const it of removedRecordKeys) {
                if (!state.records[it.date])
                  state.records[it.date] = { doses: {} };
                if (!state.records[it.date].doses)
                  state.records[it.date].doses = {};
                state.records[it.date].doses[it.key] = it.value;
              }
              saveState();
              renderAll();
              toast("å·²æ’¤å›åˆ é™¤");
            },
          },
        ]);
      }

      /* =========================
   Med list render
   ========================= */
      function renderMedList() {
        const list = document.getElementById("medList");
        list.innerHTML = "";

        if (state.meds.length === 0) {
          const empty = document.createElement("div");
          empty.className = "item";
          empty.innerHTML = `<div style="font-weight:900">è¯ç®±è¿˜æ˜¯ç©ºçš„</div><div style="margin-top:6px;color:var(--muted);font-size:12px">æ·»åŠ è¯ç‰©åï¼Œæœˆå†ä¸ä»Šæ—¥è®¡åˆ’ä¼šè‡ªåŠ¨ç”Ÿæˆã€‚</div>`;
          list.appendChild(empty);
          return;
        }

        for (const m of state.meds) {
          const it = document.createElement("div");
          it.className = "item";

          const top = document.createElement("div");
          top.className = "itemTop";

          const left = document.createElement("div");
          left.style.minWidth = "0";

          const nm = document.createElement("div");
          nm.className = "itemName";
          nm.innerHTML = `<span>ğŸ’Š</span><span style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:420px">${m.name}</span>`;

          const meta = document.createElement("div");
          meta.className = "itemMeta";
          const doseTxt = [m.unit, m.dose].filter(Boolean).join(" Â· ");
          meta.innerHTML =
            `<span>æ¬¡æ•°ï¼š<b>${m.timesPerDay} / å¤©</b></span>` +
            `<span>æ—¶é—´ï¼š<b>${
              (m.schedule || []).join(", ") || "â€”"
            }</b></span>` +
            `<span>å‰‚é‡ï¼š<b>${doseTxt || "æœªæ³¨æ˜"}</b></span>` +
            `<span>å¤‡æ³¨ï¼š<b>${m.note || "â€”"}</b></span>`;

          left.appendChild(nm);
          left.appendChild(meta);

          const btns = document.createElement("div");
          btns.className = "itemBtns";

          const b1 = document.createElement("button");
          b1.type = "button";
          b1.className = "btn small secondary";
          b1.textContent = "ç¼–è¾‘";
          b1.onclick = () => openEdit(m.id);

          const b2 = document.createElement("button");
          b2.type = "button";
          b2.className = "btn small secondary";
          b2.textContent = "å»ä»Šå¤©æ‰“å¡";
          b2.onclick = () => openDay(nowISODate());

          btns.appendChild(b1);
          btns.appendChild(b2);

          top.appendChild(left);
          top.appendChild(btns);
          it.appendChild(top);
          list.appendChild(it);
        }
      }

      /* =========================
   Render all
   ========================= */
      function renderAll() {
        renderCalendar();
        renderToday();
        renderMedList();
      }

      /* =========================
   Init
   ========================= */
      function init() {
        applyUI();
        document.getElementById("themeSelect").value = ui.theme;

        const t = ymdToDate(nowISODate());
        calCursor = new Date(t.getFullYear(), t.getMonth(), 1);

        renderAll();
        toast(
          isPrivate()
            ? "å·²è¿›å…¥ç§äººç©ºé—´ âœ…"
            : "å…¬å…±ç©ºç™½æ¨¡å¼ï¼šåˆ†äº«ç»™åˆ«äººé»˜è®¤ç©ºç™½ âœ…"
        );
      }
      init();
    </script>
  </body>
</html>
