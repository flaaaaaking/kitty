<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Kitty Med Tracker</title>

<style>
:root{
  --bg1:#fff5fb; --bg2:#ffffff;
  --card:rgba(255,255,255,.78);
  --stroke:rgba(0,0,0,.07);
  --shadow:rgba(18,18,22,.12);
  --text:#23262a;
  --muted:#6b7280;

  --brand:#ff69b4;
  --brand2:#ff4fa6;
  --brandSoft:rgba(255,105,180,.14);

  --good:#22c55e;
  --warn:#ff9f1a;
  --bad:#f43f5e;

  --calHas: rgba(255,105,180,.14);
  --calDone: rgba(34,197,94,.16);
  --calMiss: rgba(244,63,94,.14);

  --focus: rgba(255,105,180,.36);
  --ring: rgba(255,105,180,.22);

  --radius:22px;
  --radius2:16px;

  --font: ui-rounded, system-ui, -apple-system, "PingFang SC", "Microsoft YaHei", "Segoe UI", Arial, sans-serif;

  --decoOpacity:.65;
  --decoScale:1;
  --grainOpacity:.09;
  --shineOpacity:.38;

  --wallAlpha:.55;
  --wallBlur:0px;
}

/* ===== Theme: Blue (Wallpaper-like) ===== */
body.theme-blue{
  --bg1:#eaf3ff; --bg2:#ffffff;
  --stroke:rgba(30,64,175,.11);
  --shadow:rgba(15,23,42,.12);
  --text:#0f172a;
  --muted:#64748b;

  --brand:#4a90e2;
  --brand2:#2563eb;
  --brandSoft:rgba(37,99,235,.14);

  --calHas: rgba(37,99,235,.12);
  --calDone: rgba(16,185,129,.16);
  --calMiss: rgba(244,63,94,.14);

  --focus: rgba(37,99,235,.36);
  --ring: rgba(37,99,235,.20);

  --wallAlpha:.65;
  --shineOpacity:.32;
}

/* ===== Theme: Mint ===== */
body.theme-mint{
  --bg1:#eafff8; --bg2:#ffffff;
  --stroke:rgba(16,185,129,.11);
  --shadow:rgba(6,95,70,.14);
  --text:#064e3b;
  --muted:#3f7667;

  --brand:#2ec4b6;
  --brand2:#0ea5a4;
  --brandSoft:rgba(14,165,164,.14);

  --calHas: rgba(14,165,164,.12);
  --calDone: rgba(34,197,94,.16);
  --calMiss: rgba(244,63,94,.14);

  --focus: rgba(14,165,164,.36);
  --ring: rgba(14,165,164,.20);

  --wallAlpha:.62;
}

/* ===== Theme: Lavender ===== */
body.theme-lavender{
  --bg1:#f6f3ff; --bg2:#ffffff;
  --stroke:rgba(124,58,237,.11);
  --shadow:rgba(31,17,67,.12);
  --text:#241a3a;
  --muted:#6b5f85;

  --brand:#8e7dff;
  --brand2:#7c3aed;
  --brandSoft:rgba(124,58,237,.14);

  --calHas: rgba(124,58,237,.12);
  --calDone: rgba(16,185,129,.16);
  --calMiss: rgba(244,63,94,.14);

  --focus: rgba(124,58,237,.36);
  --ring: rgba(124,58,237,.20);

  --wallAlpha:.66;
}

/* ===== Theme: Peach ===== */
body.theme-peach{
  --bg1:#fff3ea; --bg2:#ffffff;
  --stroke:rgba(251,113,133,.12);
  --shadow:rgba(88,28,135,.10);
  --text:#2a1d1d;
  --muted:#7a5a5a;

  --brand:#ff7a90;
  --brand2:#ff5e7a;
  --brandSoft:rgba(255,122,144,.14);

  --calHas: rgba(255,122,144,.12);
  --calDone: rgba(34,197,94,.16);
  --calMiss: rgba(244,63,94,.14);

  --focus: rgba(255,94,122,.36);
  --ring: rgba(255,94,122,.20);

  --wallAlpha:.64;
}

/* ===== Theme: Cocoa ===== */
body.theme-cocoa{
  --bg1:#f7efe7; --bg2:#ffffff;
  --stroke:rgba(120,53,15,.12);
  --shadow:rgba(120,53,15,.14);
  --text:#2b1d12;
  --muted:#7a5a43;

  --brand:#b46a3c;
  --brand2:#8b5a3c;
  --brandSoft:rgba(180,106,60,.14);

  --calHas: rgba(180,106,60,.10);
  --calDone: rgba(34,197,94,.16);
  --calMiss: rgba(244,63,94,.14);

  --focus: rgba(180,106,60,.34);
  --ring: rgba(180,106,60,.18);

  --wallAlpha:.60;
}

/* ===== Theme: Night (readable) ===== */
body.theme-night{
  --bg1:#0b0d12; --bg2:#101420;
  --card:rgba(14,18,28,.86);

  --stroke:rgba(255,255,255,.12);
  --shadow:rgba(0,0,0,.55);

  --text:#f3f5ff;
  --muted:#b7bccb;

  --brand:#ff69b4;
  --brand2:#ff4fa6;
  --brandSoft:rgba(255,105,180,.18);

  --calHas: rgba(255,105,180,.14);
  --calDone: rgba(34,197,94,.18);
  --calMiss: rgba(244,63,94,.16);

  --focus: rgba(255,105,180,.44);
  --ring: rgba(255,105,180,.22);

  --grainOpacity:.12;
  --shineOpacity:.18;

  --wallAlpha:.42;
  --wallBlur:6px;
}
body.theme-night .pill,
body.theme-night .item,
body.theme-night .day,
body.theme-night select,
body.theme-night input,
body.theme-night textarea{
  background: rgba(18,22,34,.88) !important;
  color: var(--text) !important;
  border-color: rgba(255,255,255,.14) !important;
}
body.theme-night input::placeholder,
body.theme-night textarea::placeholder{
  color: rgba(243,245,255,.55) !important;
}
body.theme-night .btn.secondary{
  background: rgba(18,22,34,.88) !important;
  color: var(--text) !important;
  border-color: rgba(255,255,255,.14) !important;
}
body.theme-night .day.active{
  outline: 2px solid var(--focus) !important;
}

/* ===== Theme: Mono ===== */
body.theme-mono{
  --bg1:#f7f7f8; --bg2:#ffffff;
  --stroke:rgba(0,0,0,.09);
  --shadow:rgba(0,0,0,.09);
  --text:#111827;
  --muted:#6b7280;

  --brand:#111827;
  --brand2:#111827;
  --brandSoft:rgba(17,24,39,.10);

  --calHas: rgba(17,24,39,.10);
  --calDone: rgba(34,197,94,.16);
  --calMiss: rgba(244,63,94,.14);

  --focus: rgba(17,24,39,.28);
  --ring: rgba(17,24,39,.16);

  --decoOpacity:.28;
  --shineOpacity:.18;

  --wallAlpha:.35;
}

/* ===== Base ===== */
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:var(--font);
  color:var(--text);
  background:
    radial-gradient(1200px 800px at 18% 10%, var(--brandSoft), transparent 58%),
    radial-gradient(1000px 700px at 82% 14%, rgba(255,255,255,.55), transparent 55%),
    linear-gradient(180deg, var(--bg1), var(--bg2));
  overflow-x:hidden;
}

/* Wallpaper layer (very pretty, subtle) */
.wallpaper{
  position:fixed; inset:-40px;
  z-index:-3;
  opacity: var(--wallAlpha);
  filter: blur(var(--wallBlur));
  transform: scale(1.06);
  pointer-events:none;
  background:
    radial-gradient(900px 520px at 18% 18%, rgba(255,255,255,.70), transparent 60%),
    radial-gradient(860px 560px at 78% 22%, rgba(255,255,255,.55), transparent 62%),
    radial-gradient(700px 520px at 40% 86%, rgba(255,255,255,.42), transparent 65%),
    radial-gradient(circle at 16% 30%, rgba(255,255,255,.55) 0 10px, transparent 11px),
    radial-gradient(circle at 25% 18%, rgba(255,255,255,.35) 0 8px, transparent 9px),
    radial-gradient(circle at 84% 32%, rgba(255,255,255,.45) 0 9px, transparent 10px),
    radial-gradient(circle at 70% 70%, rgba(255,255,255,.30) 0 10px, transparent 11px),
    linear-gradient(135deg, rgba(255,255,255,.35), transparent 45%),
    radial-gradient(900px 760px at 30% 10%, var(--brandSoft), transparent 65%),
    radial-gradient(900px 760px at 85% 20%, rgba(255,255,255,.20), transparent 68%);
  mix-blend-mode: screen;
}

body::before{
  content:"";
  position:fixed; inset:0;
  opacity:var(--decoOpacity);
  transform: scale(var(--decoScale));
  pointer-events:none;
  background:
    radial-gradient(circle at 10% 20%, rgba(255,255,255,.45), transparent 45%),
    radial-gradient(circle at 85% 22%, rgba(255,255,255,.28), transparent 46%),
    radial-gradient(circle at 30% 80%, rgba(255,255,255,.22), transparent 50%),
    radial-gradient(circle at 92% 78%, rgba(255,255,255,.18), transparent 50%),
    radial-gradient(circle, rgba(255,255,255,.36) 12%, transparent 13%) 0 0/22px 22px,
    radial-gradient(circle, rgba(255,255,255,.20) 10%, transparent 11%) 11px 11px/22px 22px;
  mix-blend-mode: overlay;
}
body::after{
  content:"";
  position:fixed; inset:0;
  pointer-events:none;
  background:
    radial-gradient(900px 560px at 30% 0%, rgba(255,255,255,var(--shineOpacity)), transparent 60%),
    radial-gradient(980px 640px at 85% 10%, rgba(255,255,255,calc(var(--shineOpacity) * .7)), transparent 60%);
  mix-blend-mode: screen;
}
.grain{
  position:fixed; inset:0;
  pointer-events:none;
  opacity:var(--grainOpacity);
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='180' height='180' filter='url(%23n)' opacity='.35'/%3E%3C/svg%3E");
  mix-blend-mode: multiply;
}

.app{
  width:100%;
  max-width:600px;
  margin:0 auto;
  padding:20px 14px 96px;
  position:relative;
}

.topbar{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px;}
.brand{display:flex; align-items:center; gap:10px;}
.logo{
  width:48px; height:48px; border-radius:18px;
  background: linear-gradient(135deg, var(--brand), var(--brand2));
  box-shadow: 0 18px 45px var(--shadow);
  display:grid; place-items:center;
  user-select:none;
}
.brand h1{margin:0; font-size:18px; letter-spacing:.2px;}
.brand .sub{margin-top:2px; font-size:12px; color:var(--muted);}

.ctrls{display:flex; flex-direction:column; gap:8px; align-items:flex-end;}
.pillbar{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;}
.pill{
  display:inline-flex; align-items:center; gap:8px;
  padding:8px 10px;
  border-radius:999px;
  border:1px solid var(--stroke);
  background: rgba(255,255,255,.68);
  font-size:12px;
  color:var(--muted);
}
select,button, input, textarea{font-family:var(--font);}
select{
  border:1px solid var(--stroke);
  background: rgba(255,255,255,.90);
  padding:6px 10px;
  border-radius:999px;
  font-weight:900;
  color:var(--text);
  outline:none;
}
select:focus{box-shadow:0 0 0 4px var(--ring)}
.toggle{
  width:44px; height:24px;
  border-radius:999px;
  border:1px solid var(--stroke);
  background: rgba(255,255,255,.72);
  position:relative;
  cursor:pointer;
}
.toggle::after{
  content:"";
  position:absolute; top:2px; left:2px;
  width:18px; height:18px; border-radius:999px;
  background: linear-gradient(135deg, var(--brand), var(--brand2));
  box-shadow: 0 10px 16px rgba(0,0,0,.12);
  transition: transform .22s ease;
}
.toggle.on::after{ transform: translateX(20px); }

.tabs{display:flex; gap:8px; margin:10px 0 6px;}
.tab{
  flex:1;
  border:1px solid var(--stroke);
  background: rgba(255,255,255,.60);
  color: var(--text);
  padding:12px 12px;
  border-radius:999px;
  font-weight:950;
  cursor:pointer;
  transition: transform .18s ease, box-shadow .18s ease;
}
.tab:hover{ transform: translateY(-1px); }
.tab.active{
  border:none;
  background: linear-gradient(135deg, var(--brand), var(--brand2));
  color:#fff;
  box-shadow: 0 18px 40px rgba(0,0,0,.10);
}

.card{
  background: var(--card);
  backdrop-filter: blur(12px);
  border:1px solid var(--stroke);
  border-radius: var(--radius);
  box-shadow: 0 18px 55px var(--shadow);
  padding:14px;
  margin:12px 0;
  position:relative;
  overflow:hidden;
}
.card::after{
  content:"";
  position:absolute; right:-36px; top:-36px;
  width:150px; height:150px;
  background:
    radial-gradient(circle at 30% 30%, var(--brandSoft), transparent 62%),
    radial-gradient(circle at 70% 70%, rgba(255,255,255,.18), transparent 62%);
  transform: rotate(18deg);
  border-radius: 40px;
  pointer-events:none;
}

h2{margin:0 0 10px 0; font-size:15px; display:flex; align-items:center; gap:8px;}
h2 .sticker{ font-size:16px; }
.muted{color:var(--muted); font-size:12px; line-height:1.6}
.row{display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap}
.mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}

.btn{
  border:0;
  border-radius:999px;
  padding:11px 14px;
  font-weight:950;
  cursor:pointer;
  background: linear-gradient(135deg, var(--brand), var(--brand2));
  color:#fff;
  box-shadow: 0 14px 28px rgba(0,0,0,.10);
  transition: transform .18s ease, box-shadow .18s ease, filter .18s ease;
}
.btn:hover{ transform: translateY(-1px); filter: brightness(1.02); }
.btn:active{ transform: translateY(1px); }
.btn.secondary{
  background: rgba(255,255,255,.75);
  color: var(--text);
  border:1px solid var(--stroke);
  box-shadow:none;
}
.btn.danger{
  background: linear-gradient(135deg, #fb7185, #f43f5e);
}
.btn:focus{outline:none; box-shadow:0 0 0 4px var(--ring)}

.list{display:flex; flex-direction:column; gap:10px; margin-top:8px}
.item{
  border:1px solid var(--stroke);
  background: rgba(255,255,255,.74);
  border-radius: var(--radius2);
  padding:12px;
  transition: transform .18s ease, box-shadow .18s ease;
}
.item:hover{ transform: translateY(-1px); box-shadow: 0 16px 30px rgba(0,0,0,.07); }
.itemTop{display:flex; align-items:center; justify-content:space-between; gap:10px}
.name{font-weight:1000}
.small{font-size:12px; color:var(--muted); margin-top:6px; line-height:1.6}
.divider{height:1px; background: var(--stroke); margin:10px 0}

.checkline{display:flex; align-items:center; justify-content:space-between; gap:12px}
.stateTag{font-size:12px; font-weight:1000}
.ok{color:var(--good)}
.bad{color:var(--bad)}
.warn{color:var(--warn)}
.box{
  width:32px;height:32px;border-radius:12px;
  border:1px solid var(--stroke);
  background: rgba(255,255,255,.88);
  display:grid; place-items:center;
  cursor:pointer; user-select:none;
  box-shadow: 0 12px 18px rgba(0,0,0,.06);
  transition: transform .14s ease, box-shadow .14s ease;
}
.box:hover{ transform: scale(1.03); }
.box.on{ background: var(--brandSoft); border-color: var(--focus); }
.box.on::after{content:"âœ…"; font-size:15px}

.calTop{display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;}
.calendar{display:grid; grid-template-columns: repeat(7, 1fr); gap:8px; margin-top:10px;}
.dow{text-align:center; font-size:11px; color:var(--muted); opacity:.85; padding:6px 0;}
.day{
  border:1px solid var(--stroke);
  background: rgba(255,255,255,.74);
  border-radius: 14px;
  padding:10px 6px;
  text-align:center;
  cursor:pointer;
  user-select:none;
  font-size:13px;
  position:relative;
  transition: transform .18s ease, box-shadow .18s ease;
}
.day:hover{transform: translateY(-1px)}
.day.has{background: var(--calHas)}
.day.done{background: var(--calDone); font-weight:1000}
.day.miss{background: var(--calMiss); font-weight:1000}
.day.active{outline: 2px solid var(--focus)}
.day.today::after{
  content:"";
  position:absolute;
  left:50%; bottom:6px;
  width:6px; height:6px;
  background: linear-gradient(135deg, var(--brand), var(--brand2));
  border-radius:999px;
  transform: translateX(-50%);
  opacity:.88;
}

input,textarea{
  width:100%;
  padding:10px 12px;
  border-radius: 14px;
  border:1px solid var(--stroke);
  background: rgba(255,255,255,.92);
  outline:none;
  font-size:14px;
  color:var(--text);
}
textarea{min-height:72px; resize:vertical}
label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px}
.grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
.hidden{display:none}

.author-fixed{
  position:fixed;
  right:10px;
  bottom:8px;
  font-size:12px;
  color:var(--muted);
  opacity:.85;
  pointer-events:none;
  z-index:6;
}

body.motion-off *{ transition:none !important; animation:none !important; }

/* ===== Modal ===== */
.modalWrap{
  position:fixed; inset:0;
  display:none;
  align-items:flex-end;
  justify-content:center;
  background: rgba(0,0,0,.36);
  backdrop-filter: blur(6px);
  z-index:50;
}
.modalWrap.show{display:flex;}
.modal{
  width:min(600px, 100%);
  border-radius: 22px 22px 0 0;
  background: var(--card);
  border:1px solid var(--stroke);
  box-shadow: 0 30px 90px rgba(0,0,0,.35);
  padding:14px;
}
.modalHead{display:flex; align-items:center; justify-content:space-between; gap:10px;}
.modalTitle{font-weight:1000; display:flex; gap:8px; align-items:center;}
.modalClose{
  width:38px; height:38px; border-radius:14px;
  border:1px solid var(--stroke);
  background: rgba(255,255,255,.72);
  cursor:pointer;
  display:grid; place-items:center;
}
.chips{display:flex; flex-wrap:wrap; gap:8px; margin-top:10px;}
.chip{
  padding:8px 10px;
  border-radius:999px;
  border:1px solid var(--stroke);
  background: rgba(255,255,255,.72);
  cursor:pointer;
  font-size:12px;
  font-weight:900;
  color: var(--text);
}
.chip.on{border-color: var(--focus); background: var(--brandSoft);}
hr.sep{border:none; height:1px; background: var(--stroke); margin:12px 0;}
</style>
</head>

<body class="theme-pink">
<div class="wallpaper"></div>
<div class="grain"></div>

<div class="app">
  <div class="topbar">
    <div class="brand">
      <div class="logo" id="logoEmoji">ğŸ€</div>
      <div>
        <h1>Kitty Med Tracker</h1>
        <div class="sub" id="subLine">ç‚¹æ—¥å†è¡¥å½• Â· ç¼–è¾‘è¯ç‰© Â· è¡¥å½•ç¡®è®¤æ›´å®‰å¿ƒ</div>
      </div>
    </div>

    <div class="ctrls">
      <div class="pillbar">
        <div class="pill">çš®è‚¤
          <select id="themeSelect">
            <option value="theme-pink">Pink ç²‰æ¨±</option>
            <option value="theme-blue">Blue æ¡Œé¢è“</option>
            <option value="theme-mint">Mint è–„è·</option>
            <option value="theme-lavender">Lavender è–°è¡£è‰</option>
            <option value="theme-peach">Peach èœœæ¡ƒ</option>
            <option value="theme-cocoa">Cocoa å¯å¯</option>
            <option value="theme-night">Night å¤œçŒ«</option>
            <option value="theme-mono">Mono æç®€</option>
          </select>
        </div>

        <div class="pill">è£…é¥°
          <div class="toggle on" id="decoToggle" title="èƒŒæ™¯è£…é¥°å¼€å…³"></div>
        </div>

        <div class="pill">åŠ¨æ•ˆ
          <div class="toggle on" id="motionToggle" title="åŠ¨æ•ˆå¼€å…³"></div>
        </div>
      </div>
      <div class="muted mono" id="hintBar"></div>
    </div>
  </div>

  <div class="tabs">
    <button class="tab active" id="tabToday">ä»Šæ—¥/è¡¥å½•</button>
    <button class="tab" id="tabMeds">æˆ‘çš„è¯ç®±</button>
    <button class="tab" id="tabStats">æ—¥å†ç»Ÿè®¡</button>
  </div>

  <section id="viewToday">
    <div class="card">
      <h2><span class="sticker" id="todaySticker">ğŸŒ¸</span> å½“å¤©ç”¨è¯æ‰“å¡</h2>

      <div class="row">
        <div class="pill">æ—¥æœŸï¼š<span class="mono" id="currentKey"></span></div>
        <div class="row" style="gap:8px;">
          <button class="btn secondary" id="btnPickDate">é€‰æ‹©æ—¥æœŸ</button>
          <button class="btn secondary" id="btnBackToday">å›åˆ°ä»Šå¤©</button>
        </div>
      </div>

      <div class="muted" id="backfillHint" style="margin-top:10px;"></div>
      <div class="list" id="todayList"></div>

      <div class="divider"></div>
      <div class="row">
        <button class="btn" style="flex:1" id="btnMarkAll">ä¸€é”®å…¨éƒ¨æ ‡è®°å·²æœç”¨</button>
      </div>
      <div class="muted" id="todayHint" style="margin-top:10px;"></div>
    </div>
  </section>

  <section id="viewMeds" class="hidden">
    <div class="card">
      <h2><span class="sticker">ğŸ§º</span> æ·»åŠ æ–°è¯</h2>

      <label>è¯ç‰©åç§°</label>
      <input id="fName" placeholder="ä¾‹å¦‚ï¼šç¢³é…¸é”‚ç¼“é‡Šç‰‡ / è‰é…¸è‰¾å¸è¥¿é…æ™®å…°" />

      <div class="grid2">
        <div>
          <label>è§„æ ¼/å‰‚é‡ï¼ˆå±•ç¤ºç”¨ï¼‰</label>
          <input id="fSpec" placeholder="ä¾‹å¦‚ï¼š300mg/ç‰‡" />
        </div>
        <div>
          <label>å•æ¬¡ç”¨é‡</label>
          <input id="fDose" placeholder="ä¾‹å¦‚ï¼š1ç‰‡ / 1ç²’ / 10ml" />
        </div>
      </div>

      <div class="grid2">
        <div>
          <label>æ¯å¤©æ¬¡æ•°</label>
          <select id="fTimes" style="width:100%; border-radius:14px; padding:10px 12px;">
            <option value="1">1 æ¬¡</option>
            <option value="2" selected>2 æ¬¡</option>
            <option value="3">3 æ¬¡</option>
            <option value="4">4 æ¬¡</option>
          </select>
        </div>
        <div>
          <label>æœç”¨æ—¶é—´ï¼ˆé€—å·åˆ†éš”ï¼‰</label>
          <input id="fSchedule" placeholder="08:00,20:00" />
        </div>
      </div>

      <div class="grid2">
        <div>
          <label>æ€»æ•°é‡ï¼ˆåº“å­˜ï¼‰</label>
          <input id="fStock" type="number" min="0" placeholder="ä¾‹å¦‚ï¼š30" />
        </div>
        <div>
          <label>ä½åº“å­˜æé†’ï¼ˆâ‰¤ï¼‰</label>
          <input id="fLow" type="number" min="0" placeholder="ä¾‹å¦‚ï¼š7" />
        </div>
      </div>

      <label>å¤‡æ³¨</label>
      <textarea id="fNote" placeholder="ä¾‹å¦‚ï¼šé¥­åæœç”¨ / å¯èƒ½å—œç¡ / éµåŒ»å˜±"></textarea>

      <div class="row" style="margin-top:10px;">
        <button class="btn" style="flex:1" id="btnAdd">æ·»åŠ åˆ°è¯ç®±</button>
        <button class="btn secondary" id="btnSeed">å¡«å……ç¤ºä¾‹</button>
      </div>

      <div class="muted" style="margin-top:10px;">
        è¡¥å½•é»˜è®¤ä¸æ‰£åº“å­˜ï¼›ä½†æ‚¨åœ¨è¡¥å½•ç¡®è®¤å¼¹çª—é‡Œå¯ä»¥æ‰‹åŠ¨é€‰æ‹©â€œè¡¥å½•ä¹Ÿæ‰£åº“å­˜â€ã€‚
      </div>
    </div>

    <div class="card">
      <h2><span class="sticker">ğŸ’</span> æˆ‘çš„è¯ç®±ï¼ˆå¯ç¼–è¾‘ï¼‰</h2>
      <div class="list" id="medList"></div>
    </div>

    <div class="card">
      <h2><span class="sticker">ğŸ§·</span> å¤‡ä»½ä¸è¿ç§»</h2>
      <div class="row" style="gap:8px;">
        <button class="btn secondary" id="btnExport">å¯¼å‡º JSON</button>
        <button class="btn secondary" id="btnImport">å¯¼å…¥ JSON</button>
        <button class="btn secondary" id="btnReset">æ¸…ç©ºæ•°æ®</button>
      </div>
      <textarea class="mono" id="backupBox" placeholder="å¯¼å‡ºä¼šå‡ºç°åœ¨è¿™é‡Œï¼›å¯¼å…¥è¯·æŠŠ JSON ç²˜è´´åˆ°è¿™é‡Œ" style="margin-top:10px;"></textarea>
      <div class="muted" style="margin-top:10px;">å¯¼å…¥ä¼šè¦†ç›–æœ¬åœ°æ•°æ®ï¼Œå»ºè®®å…ˆå¯¼å‡ºä¸€ä»½ç•™å­˜ã€‚</div>
    </div>
  </section>

  <section id="viewStats" class="hidden">
    <div class="card">
      <div class="calTop">
        <h2><span class="sticker">ğŸ—“ï¸</span> æœˆå†ï¼ˆç‚¹æ—¥æœŸè¡¥å½•ï¼‰</h2>
        <div class="row" style="gap:8px;">
          <button class="btn secondary" id="prevMonth">ä¸Šæœˆ</button>
          <div class="pill">å½“å‰ï¼š<span class="mono" id="monthLabel"></span></div>
          <button class="btn secondary" id="nextMonth">ä¸‹æœˆ</button>
        </div>
      </div>

      <div class="row" style="margin-top:8px;">
        <div class="pill">âœ… å®Œæˆ</div>
        <div class="pill">âš ï¸ éƒ¨åˆ†å®Œæˆ</div>
        <div class="pill">ç©ºç™½ = æ— è®°å½•</div>
      </div>

      <div class="calendar" id="dowRow"></div>
      <div class="calendar" id="calendar"></div>
      <div class="muted" id="statHint" style="margin-top:10px;"></div>
    </div>

    <div class="card">
      <h2><span class="sticker">ğŸ“Œ</span> æ¦‚è§ˆ</h2>
      <div class="list" id="overview"></div>
    </div>
  </section>

  <input id="datePickerHidden" type="date" class="hidden"/>
</div>

<div class="author-fixed">by FLAAAAKING</div>

<!-- ===== è¡¥å½•ç¡®è®¤ Modal ===== -->
<div class="modalWrap" id="backfillModalWrap">
  <div class="modal">
    <div class="modalHead">
      <div class="modalTitle"><span>ğŸ§¾</span><span>è¡¥å½•ç¡®è®¤</span></div>
      <button class="modalClose" id="backfillClose">âœ•</button>
    </div>

    <div class="muted" id="backfillSummary" style="margin-top:8px;"></div>

    <hr class="sep"/>

    <div class="row">
      <div class="pill">è¡¥å½•æ‰£åº“å­˜</div>
      <div class="toggle" id="backfillStockToggle" title="è¡¥å½•æ˜¯å¦æ‰£åº“å­˜"></div>
    </div>
    <div class="muted" style="margin-top:8px;">é»˜è®¤ä¸æ‰£åº“å­˜ï¼›å¦‚æœæ‚¨ç¡®å®è¡¥åƒäº†å¹¶æƒ³åº“å­˜åŒæ­¥ï¼Œæ‰“å¼€å®ƒã€‚</div>

    <hr class="sep"/>

    <div class="muted">è¡¥å½•åŸå› ï¼ˆå¯é€‰ï¼‰</div>
    <div class="chips" id="reasonChips"></div>
    <textarea id="reasonText" placeholder="ä¹Ÿå¯ä»¥å†™ä¸€å¥ï¼šä¾‹å¦‚â€œæ˜¨å¤©å¤ªç´¯ç¡è¿‡å»äº† / å¤–å‡ºå¿˜å¸¦è¯ / èƒƒä¸èˆ’æœæ‰€ä»¥å»¶åâ€" style="margin-top:10px;"></textarea>

    <hr class="sep"/>

    <div class="row" style="gap:8px;">
      <button class="btn secondary" id="backfillCancel">å–æ¶ˆ</button>
      <button class="btn" id="backfillConfirm">ç¡®è®¤è¡¥å½•å¹¶æ‰“å¡</button>
    </div>
    <div class="muted" style="margin-top:10px;">ç¡®è®¤åä¼šå†™å…¥ï¼šè¡¥å½•æ ‡è®° + åŸå› ï¼›å¦‚æœå‹¾é€‰æ‰£åº“å­˜ï¼Œä¼šåŒæ­¥æ‰£åº“å­˜ã€‚</div>
  </div>
</div>

<!-- ===== ç¼–è¾‘è¯ç‰© Modal ===== -->
<div class="modalWrap" id="editMedModalWrap">
  <div class="modal">
    <div class="modalHead">
      <div class="modalTitle"><span>ğŸ› ï¸</span><span>ç¼–è¾‘è¯ç‰©</span></div>
      <button class="modalClose" id="editMedClose">âœ•</button>
    </div>

    <div class="muted" id="editMedHint" style="margin-top:8px;"></div>

    <label>è¯ç‰©åç§°</label>
    <input id="eName" />

    <div class="grid2">
      <div>
        <label>è§„æ ¼/å‰‚é‡</label>
        <input id="eSpec"/>
      </div>
      <div>
        <label>å•æ¬¡ç”¨é‡</label>
        <input id="eDose"/>
      </div>
    </div>

    <div class="grid2">
      <div>
        <label>æ¯å¤©æ¬¡æ•°</label>
        <select id="eTimes" style="width:100%; border-radius:14px; padding:10px 12px;">
          <option value="1">1 æ¬¡</option>
          <option value="2">2 æ¬¡</option>
          <option value="3">3 æ¬¡</option>
          <option value="4">4 æ¬¡</option>
        </select>
      </div>
      <div>
        <label>æœç”¨æ—¶é—´ï¼ˆé€—å·åˆ†éš”ï¼‰</label>
        <input id="eSchedule"/>
      </div>
    </div>

    <div class="grid2">
      <div>
        <label>åº“å­˜</label>
        <input id="eStock" type="number" min="0"/>
      </div>
      <div>
        <label>ä½åº“å­˜æé†’ï¼ˆâ‰¤ï¼‰</label>
        <input id="eLow" type="number" min="0"/>
      </div>
    </div>

    <label>å¤‡æ³¨</label>
    <textarea id="eNote"></textarea>

    <hr class="sep"/>

    <div class="row" style="gap:8px;">
      <button class="btn secondary" id="editMedCancel">å–æ¶ˆ</button>
      <button class="btn danger" id="editMedDelete">åˆ é™¤æ­¤è¯</button>
      <button class="btn" id="editMedSave">ä¿å­˜ä¿®æ”¹</button>
    </div>

    <div class="muted" style="margin-top:10px;">
      ä¿å­˜åï¼šæœªæ¥æ–°å»ºçš„â€œå½“å¤©è®¡åˆ’â€ä¼šä½¿ç”¨æ–°è§„åˆ™ï¼›å·²å­˜åœ¨çš„å†å²è®°å½•ä¸ä¼šå¼ºè¡Œæ”¹åŠ¨ï¼ˆé¿å…å†å²è¢«é‡å†™ï¼‰ã€‚
    </div>
  </div>
</div>

<script>
/* =========================
   Storage Keys
   ========================= */
const STORE_KEY = "kitty-med-single-v3";
const THEME_KEY = "kitty-med-theme-v3";
const DECO_KEY  = "kitty-med-deco-v3";
const MOTION_KEY= "kitty-med-motion-v3";

/* =========================
   Utils
   ========================= */
function isoDateKey(d){
  const local = new Date(d.getTime() - d.getTimezoneOffset()*60000);
  return local.toISOString().slice(0,10);
}
const todayKey = isoDateKey(new Date());
let currentDateKey = todayKey;

function uid(){ return "id_" + Math.random().toString(16).slice(2) + Date.now().toString(16); }
function hhmm(d){ return String(d.getHours()).padStart(2,"0")+":"+String(d.getMinutes()).padStart(2,"0"); }

function loadState(){
  try{
    const raw = localStorage.getItem(STORE_KEY);
    if(!raw) return null;
    return JSON.parse(raw);
  }catch{ return null; }
}
function saveState(){
  localStorage.setItem(STORE_KEY, JSON.stringify(state));
}

/* =========================
   Default State
   ========================= */
const defaultState = {
  meds: [
    { id: uid(), name:"ç¢³é…¸é”‚ç¼“é‡Šç‰‡", spec:"â€”", dose:"1ç‰‡", timesPerDay:2, schedule:"08:00,20:00", stock:30, lowStock:7, note:"é¥­åæœç”¨" },
    { id: uid(), name:"è‰é…¸è‰¾å¸è¥¿é…æ™®å…°", spec:"â€”", dose:"1ç‰‡", timesPerDay:1, schedule:"22:00", stock:30, lowStock:7, note:"éµåŒ»å˜±" }
  ],
  records: {}
};
const state = loadState() || structuredClone(defaultState);

/* =========================
   Theme / Deco / Motion
   ========================= */
const themeSelect = document.getElementById("themeSelect");
const decoToggle = document.getElementById("decoToggle");
const motionToggle = document.getElementById("motionToggle");
const hintBar = document.getElementById("hintBar");
const logoEmoji = document.getElementById("logoEmoji");
const todaySticker = document.getElementById("todaySticker");

const savedTheme = localStorage.getItem(THEME_KEY) || "theme-pink";
document.body.className = savedTheme;
themeSelect.value = savedTheme;

const savedDeco = localStorage.getItem(DECO_KEY);
const decoOn = (savedDeco === null) ? true : (savedDeco === "1");
decoToggle.classList.toggle("on", decoOn);
setDeco(decoOn);

const savedMotion = localStorage.getItem(MOTION_KEY);
const motionOn = (savedMotion === null) ? true : (savedMotion === "1");
motionToggle.classList.toggle("on", motionOn);
setMotion(motionOn);

themeSelect.onchange = ()=>{
  const v = themeSelect.value;
  const isMotionOff = document.body.classList.contains("motion-off");
  document.body.className = v + (isMotionOff ? " motion-off" : "");
  localStorage.setItem(THEME_KEY, v);
  syncThemeSticker();
  renderAll();
};

decoToggle.onclick = ()=>{
  const on = !decoToggle.classList.contains("on");
  decoToggle.classList.toggle("on", on);
  setDeco(on);
  localStorage.setItem(DECO_KEY, on ? "1" : "0");
};

motionToggle.onclick = ()=>{
  const on = !motionToggle.classList.contains("on");
  motionToggle.classList.toggle("on", on);
  setMotion(on);
  localStorage.setItem(MOTION_KEY, on ? "1" : "0");
};

function setDeco(on){
  document.documentElement.style.setProperty("--decoOpacity", on ? getComputedStyle(document.documentElement).getPropertyValue("--decoOpacity") : "0");
  document.documentElement.style.setProperty("--grainOpacity", on ? (document.body.classList.contains("theme-night") ? ".12" : ".09") : "0");
}
function setMotion(on){
  document.body.classList.toggle("motion-off", !on);
}
function syncThemeSticker(){
  const c = document.body.className;
  if(c.includes("theme-blue")) { logoEmoji.textContent="ğŸ’™"; todaySticker.textContent="ğŸ«§"; hintBar.textContent="Blueï¼šæ¡Œé¢å£çº¸è´¨æ„Ÿï¼Œæ¸…çˆ½è€çœ‹ã€‚"; }
  else if(c.includes("theme-mint")) { logoEmoji.textContent="ğŸ«§"; todaySticker.textContent="ğŸƒ"; hintBar.textContent="Mintï¼šè–„è·å‘¼å¸æ„Ÿï¼Œè½»ç›ˆæ²»æ„ˆã€‚"; }
  else if(c.includes("theme-lavender")) { logoEmoji.textContent="ğŸ’œ"; todaySticker.textContent="â­"; hintBar.textContent="Lavenderï¼šæŸ”è½¯å®‰é™ï¼Œåƒå¤œæ™šçš„é¦™æ°”ã€‚"; }
  else if(c.includes("theme-peach")) { logoEmoji.textContent="ğŸ‘"; todaySticker.textContent="ğŸŒ¼"; hintBar.textContent="Peachï¼šæš–ç”œæ˜äº®ï¼Œå¿ƒæƒ…å‹å¥½ã€‚"; }
  else if(c.includes("theme-cocoa")) { logoEmoji.textContent="ğŸ«"; todaySticker.textContent="ğŸ§¸"; hintBar.textContent="Cocoaï¼šå¤å¤æ¸©åšï¼Œè€çœ‹ä¸è…»ã€‚"; }
  else if(c.includes("theme-night")) { logoEmoji.textContent="ğŸŒ™"; todaySticker.textContent="âœ¨"; hintBar.textContent="Nightï¼šæ·±è‰²æŠ¤çœ¼ï¼Œæ–‡å­—æ¸…æ™°å¯è¯»ã€‚"; }
  else if(c.includes("theme-mono")) { logoEmoji.textContent="â¬›"; todaySticker.textContent="ğŸ“"; hintBar.textContent="Monoï¼šæç®€å…‹åˆ¶ï¼Œå·¥å…·æ„Ÿæ›´å¼ºã€‚"; }
  else { logoEmoji.textContent="ğŸ€"; todaySticker.textContent="ğŸŒ¸"; hintBar.textContent="Pinkï¼šè½¯èŒä½†ä¸å¹¼ç¨šï¼Œé»˜è®¤æ¨èã€‚"; }
  const on = decoToggle.classList.contains("on");
  setDeco(on);
}
syncThemeSticker();

/* =========================
   Tabs
   ========================= */
const tabToday = document.getElementById("tabToday");
const tabMeds  = document.getElementById("tabMeds");
const tabStats = document.getElementById("tabStats");
const viewToday = document.getElementById("viewToday");
const viewMeds  = document.getElementById("viewMeds");
const viewStats = document.getElementById("viewStats");
function setTab(which){
  tabToday.classList.toggle("active", which==="today");
  tabMeds.classList.toggle("active", which==="meds");
  tabStats.classList.toggle("active", which==="stats");
  viewToday.classList.toggle("hidden", which!=="today");
  viewMeds.classList.toggle("hidden", which!=="meds");
  viewStats.classList.toggle("hidden", which!=="stats");
}
tabToday.onclick = ()=>setTab("today");
tabMeds.onclick  = ()=>setTab("meds");
tabStats.onclick = ()=>setTab("stats");

/* =========================
   Plan/Record Logic
   ========================= */
function parseSchedule(str, times){
  const arr = (str||"").split(",").map(s=>s.trim()).filter(Boolean);
  const defaults = ["08:00","12:00","18:00","22:00"];
  while(arr.length < times) arr.push(defaults[arr.length] || "");
  return arr.slice(0, times);
}
function getMed(id){ return state.meds.find(m=>m.id===id); }

function buildPlanForDate(dateKey){
  if(state.records[dateKey]) return;
  const entries = [];
  for(const med of state.meds){
    const times = Math.max(1, parseInt(med.timesPerDay||1,10));
    const schedule = parseSchedule(med.schedule, times);
    for(let i=0;i<times;i++){
      entries.push({
        id: uid(),
        medId: med.id,
        name: med.name,
        dose: med.dose || "",
        scheduledTime: schedule[i] || "",
        taken: false,
        takenTime: "",
        backfilled: dateKey !== todayKey,
        backfillMeta: null
      });
    }
  }
  state.records[dateKey] = { entries, summary:{ allTaken:false, miss:false } };
  saveState();
}

function recomputeSummary(dateKey){
  const rec = state.records[dateKey];
  if(!rec) return;
  const entries = rec.entries || [];
  const total = entries.length;
  const done = entries.filter(e=>e.taken).length;
  rec.summary = {
    allTaken: total>0 && done===total,
    miss: total>0 && done<total && done>0
  };
  saveState();
}

function isBackfillDate(){ return currentDateKey !== todayKey; }
function shouldAffectStock(isBackfill, backfillDeductStock){
  if(!isBackfill) return true;
  return !!backfillDeductStock;
}

/* =========================
   Backfill Confirm Modal
   ========================= */
const backfillModalWrap = document.getElementById("backfillModalWrap");
const backfillClose = document.getElementById("backfillClose");
const backfillCancel = document.getElementById("backfillCancel");
const backfillConfirm = document.getElementById("backfillConfirm");
const backfillSummary = document.getElementById("backfillSummary");
const backfillStockToggle = document.getElementById("backfillStockToggle");
const reasonChips = document.getElementById("reasonChips");
const reasonText = document.getElementById("reasonText");

const REASONS = ["å¿˜è®°äº†","å¤ªç´¯ç¡è¿‡å»","å¤–å‡ºä¸æ–¹ä¾¿","æƒ…ç»ªä½è½","ä¸é€‚/æ¶å¿ƒ","åŒ»ç”Ÿè°ƒæ•´/åœè¯","ä¸´æ—¶æ”¹æ—¶é—´","å…¶ä»–"];
let pendingBackfillAction = null; // { type, entryId } | { type:"all" }
let chosenReason = "";
let backfillDeductStock = false;

function openBackfillModal(summaryText){
  backfillSummary.textContent = summaryText;
  backfillModalWrap.classList.add("show");
}
function closeBackfillModal(){
  backfillModalWrap.classList.remove("show");
  pendingBackfillAction = null;
  chosenReason = "";
  backfillDeductStock = false;
  backfillStockToggle.classList.remove("on");
  reasonText.value = "";
  renderReasonChips();
}
backfillClose.onclick = closeBackfillModal;
backfillCancel.onclick = closeBackfillModal;
backfillModalWrap.onclick = (e)=>{ if(e.target === backfillModalWrap) closeBackfillModal(); };

backfillStockToggle.onclick = ()=>{
  backfillDeductStock = !backfillStockToggle.classList.contains("on");
  backfillStockToggle.classList.toggle("on", backfillDeductStock);
};

function renderReasonChips(){
  reasonChips.innerHTML = "";
  REASONS.forEach(r=>{
    const b = document.createElement("button");
    b.className = "chip" + (chosenReason===r ? " on":"");
    b.textContent = r;
    b.onclick = ()=>{
      chosenReason = (chosenReason===r) ? "" : r;
      renderReasonChips();
    };
    reasonChips.appendChild(b);
  });
}
renderReasonChips();

backfillConfirm.onclick = ()=>{
  if(!pendingBackfillAction) return;

  const meta = {
    confirmedAt: isoDateKey(new Date()) + " " + hhmm(new Date()),
    deductStock: backfillDeductStock,
    reasonTag: chosenReason || "",
    reasonText: (reasonText.value||"").trim()
  };

  if(pendingBackfillAction.type === "single"){
    applyToggleEntry(pendingBackfillAction.entryId, meta, true);
  }else if(pendingBackfillAction.type === "all"){
    applyMarkAll(meta, true);
  }
  closeBackfillModal();
  renderAll();
};

/* =========================
   Today View
   ========================= */
const currentKeyEl = document.getElementById("currentKey");
const backfillHint = document.getElementById("backfillHint");
const todayList = document.getElementById("todayList");
const todayHint = document.getElementById("todayHint");
const btnBackToday = document.getElementById("btnBackToday");
const btnMarkAll = document.getElementById("btnMarkAll");
const btnPickDate = document.getElementById("btnPickDate");
const datePickerHidden = document.getElementById("datePickerHidden");

btnBackToday.onclick = ()=>{
  currentDateKey = todayKey;
  setTab("today");
  renderAll();
};

btnPickDate.onclick = ()=>{
  datePickerHidden.value = currentDateKey;
  datePickerHidden.onchange = ()=>{
    if(datePickerHidden.value){
      currentDateKey = datePickerHidden.value;
      buildPlanForDate(currentDateKey);
      setTab("today");
      renderAll();
    }
  };
  datePickerHidden.click();
};

btnMarkAll.onclick = ()=>{
  buildPlanForDate(currentDateKey);
  const isBackfill = isBackfillDate();
  if(isBackfill){
    pendingBackfillAction = { type:"all" };
    openBackfillModal(`æ‚¨å°†è¡¥å½• ${currentDateKey}ï¼šæŠŠâ€œæ‰€æœ‰é¡¹ç›®â€æ ‡è®°ä¸ºå·²æœç”¨ã€‚è¯·ç¡®è®¤æ˜¯å¦æ‰£åº“å­˜ï¼Œå¹¶è®°å½•åŸå› ï¼ˆå¯é€‰ï¼‰ã€‚`);
    return;
  }
  applyMarkAll(null, false);
  renderAll();
};

function applyMarkAll(meta, forcedBackfill){
  buildPlanForDate(currentDateKey);
  const rec = state.records[currentDateKey];
  const nowStr = hhmm(new Date());
  const isBackfill = forcedBackfill ? true : isBackfillDate();
  const deduct = shouldAffectStock(isBackfill, meta?.deductStock);

  for(const e of rec.entries){
    if(!e.taken){
      e.taken = true;
      e.takenTime = nowStr;
      if(isBackfill){
        e.backfilled = true;
        e.backfillMeta = meta;
      }
      if(deduct){
        const med = getMed(e.medId);
        if(med){
          const stock = Number(med.stock||0);
          med.stock = Math.max(0, stock - 1);
        }
      }
    }
  }
  recomputeSummary(currentDateKey);
  saveState();
}

function applyToggleEntry(entryId, meta, forcedBackfill){
  buildPlanForDate(currentDateKey);
  const rec = state.records[currentDateKey];
  const entry = rec.entries.find(x=>x.id===entryId);
  if(!entry) return;

  const nowStr = hhmm(new Date());
  const isBackfill = forcedBackfill ? true : isBackfillDate();

  const next = !entry.taken;
  entry.taken = next;
  entry.takenTime = next ? nowStr : "";

  if(isBackfill && next){
    entry.backfilled = true;
    entry.backfillMeta = meta;
  }
  if(isBackfill && !next){
    entry.backfillMeta = null;
  }

  const deduct = shouldAffectStock(isBackfill, meta?.deductStock);

  const med = getMed(entry.medId);
  if(med){
    const stock = Number(med.stock||0);
    if(next){
      if(deduct) med.stock = Math.max(0, stock - 1);
    }else{
      if(!isBackfill) med.stock = stock + 1;
      else{
        if(entry.backfillMeta?.deductStock) med.stock = stock + 1;
      }
    }
  }

  recomputeSummary(currentDateKey);
  saveState();
}

function renderToday(){
  currentKeyEl.textContent = currentDateKey;
  const isBackfill = isBackfillDate();
  backfillHint.textContent = isBackfill
    ? `è¡¥å½•æ¨¡å¼ï¼š${currentDateKey}ï¼ˆæ‰“å¡ä¼šå¼¹â€œè¡¥å½•ç¡®è®¤â€ï¼Œæ˜ç¡®æ˜¯å¦æ‰£åº“å­˜ + è®°å½•åŸå› ï¼‰`
    : `ä»Šå¤©æ¨¡å¼ï¼šæ‰“å¡ä¼šæ‰£åº“å­˜ï¼ˆæ›´è´´è¿‘çœŸå®æ¶ˆè€—ï¼‰`;

  buildPlanForDate(currentDateKey);
  const rec = state.records[currentDateKey];
  const entries = rec.entries || [];

  if(state.meds.length===0){
    todayList.innerHTML = `<div class="muted">è¯ç®±ä¸ºç©ºã€‚å…ˆå»ã€Œæˆ‘çš„è¯ç®±ã€æ·»åŠ è¯ç‰©ã€‚</div>`;
    todayHint.textContent = "";
    btnMarkAll.disabled = true;
    return;
  }
  btnMarkAll.disabled = entries.length===0;

  todayList.innerHTML = "";
  entries.forEach(e=>{
    const med = getMed(e.medId);
    const stock = med ? Number(med.stock??0) : 0;
    const low = med ? Number(med.lowStock??0) : 0;
    const lowTag = (med && stock<=low) ? ` <span class="stateTag warn">ä½åº“å­˜</span>` : "";
    const bfTag = e.backfilled ? ` <span class="stateTag warn">è¡¥å½•</span>` : "";

    let metaLine = "";
    if(e.backfillMeta){
      const r = e.backfillMeta.reasonTag || "";
      const t = e.backfillMeta.reasonText || "";
      const s = e.backfillMeta.deductStock ? "æ‰£åº“å­˜" : "ä¸æ‰£åº“å­˜";
      metaLine = `<div class="small">ğŸ§¾ è¡¥å½•ç¡®è®¤ï¼š${s}${r?` Â· ${r}`:""}${t?` Â· ${t}`:""}</div>`;
    }

    const el = document.createElement("div");
    el.className = "item";
    el.innerHTML = `
      <div class="itemTop">
        <div class="name">${(med?med.name:e.name)}${bfTag}</div>
        <div class="pill">ğŸ•’ ${e.scheduledTime || "æœªè®¾ç½®"}</div>
      </div>
      <div class="small">
        ğŸ’Š ç”¨é‡ï¼š${e.dose || (med?med.dose:"â€”")}ã€€ğŸ“¦ åº“å­˜ï¼š${med?stock:"â€”"}${lowTag}<br/>
        ğŸ“ å¤‡æ³¨ï¼š${(med && med.note) ? med.note : "â€”"}
      </div>
      ${metaLine}
      <div class="divider"></div>
      <div class="checkline">
        <div>
          ${e.taken
            ? `<div class="stateTag ok">å·²æœç”¨</div><div class="small">è®°å½•æ—¶é—´ï¼š${e.takenTime}</div>`
            : `<div class="stateTag bad">æœªæœç”¨</div><div class="small">${isBackfill ? "ç‚¹å‡»å³ä¾§ä¼šè¿›å…¥è¡¥å½•ç¡®è®¤" : "ç‚¹å‡»å³ä¾§æ‰“å¡"}</div>`
          }
        </div>
        <div class="box ${e.taken ? "on":""}" data-id="${e.id}"></div>
      </div>
    `;
    todayList.appendChild(el);
  });

  todayList.querySelectorAll(".box").forEach(node=>{
    node.onclick = ()=>{
      const id = node.getAttribute("data-id");
      buildPlanForDate(currentDateKey);
      const rec = state.records[currentDateKey];
      const entry = rec.entries.find(x=>x.id===id);
      if(!entry) return;

      const isBackfill = isBackfillDate();
      const next = !entry.taken;

      if(isBackfill && next){
        pendingBackfillAction = { type:"single", entryId:id };
        openBackfillModal(`æ‚¨å°†è¡¥å½• ${currentDateKey}ï¼š${(getMed(entry.medId)?.name||entry.name)}ï¼ˆ${entry.scheduledTime||"æœªè®¾ç½®"}ï¼‰ã€‚è¯·ç¡®è®¤æ˜¯å¦æ‰£åº“å­˜ï¼Œå¹¶è®°å½•åŸå› ï¼ˆå¯é€‰ï¼‰ã€‚`);
        return;
      }

      applyToggleEntry(id, null, false);
      renderAll();
    };
  });

  recomputeSummary(currentDateKey);
  const total = entries.length;
  const done = entries.filter(x=>x.taken).length;
  const pct = total? Math.round(done/total*100) : 0;
  todayHint.textContent = `å½“å¤©è¿›åº¦ï¼š${done}/${total}ï¼ˆ${pct}%ï¼‰`;
}

/* =========================
   Meds: Add + Edit Modal
   ========================= */
const fName = document.getElementById("fName");
const fSpec = document.getElementById("fSpec");
const fDose = document.getElementById("fDose");
const fTimes = document.getElementById("fTimes");
const fSchedule = document.getElementById("fSchedule");
const fStock = document.getElementById("fStock");
const fLow = document.getElementById("fLow");
const fNote = document.getElementById("fNote");
const btnAdd = document.getElementById("btnAdd");
const btnSeed = document.getElementById("btnSeed");
const medList = document.getElementById("medList");

btnSeed.onclick = ()=>{
  fName.value = "ç›é…¸å“Œå”‘ç½—æ±€";
  fSpec.value = "â€”";
  fDose.value = "1ç‰‡";
  fTimes.value = "1";
  fSchedule.value = "22:30";
  fStock.value = "30";
  fLow.value = "7";
  fNote.value = "éµåŒ»å˜±";
};

btnAdd.onclick = ()=>{
  const name = fName.value.trim();
  if(!name) return;

  state.meds.push({
    id: uid(),
    name,
    spec: fSpec.value.trim(),
    dose: fDose.value.trim(),
    timesPerDay: parseInt(fTimes.value,10) || 1,
    schedule: fSchedule.value.trim(),
    stock: Number(fStock.value||0),
    lowStock: Number(fLow.value||0),
    note: fNote.value.trim()
  });
  saveState();

  fName.value=""; fSpec.value=""; fDose.value="";
  fSchedule.value=""; fStock.value=""; fLow.value=""; fNote.value="";
  fTimes.value="2";

  renderAll();
};

const editMedModalWrap = document.getElementById("editMedModalWrap");
const editMedClose = document.getElementById("editMedClose");
const editMedCancel = document.getElementById("editMedCancel");
const editMedSave = document.getElementById("editMedSave");
const editMedDelete = document.getElementById("editMedDelete");
const editMedHint = document.getElementById("editMedHint");

const eName = document.getElementById("eName");
const eSpec = document.getElementById("eSpec");
const eDose = document.getElementById("eDose");
const eTimes = document.getElementById("eTimes");
const eSchedule = document.getElementById("eSchedule");
const eStock = document.getElementById("eStock");
const eLow = document.getElementById("eLow");
const eNote = document.getElementById("eNote");

let editingMedId = null;

function openEditMedModal(medId){
  const med = getMed(medId);
  if(!med) return;
  editingMedId = medId;

  editMedHint.textContent = `ç¼–è¾‘ï¼š${med.name}ï¼ˆä¿®æ”¹åªå½±å“æœªæ¥æ–°å»ºçš„â€œå½“å¤©è®¡åˆ’â€ï¼‰`;

  eName.value = med.name || "";
  eSpec.value = med.spec || "";
  eDose.value = med.dose || "";
  eTimes.value = String(med.timesPerDay || 1);
  eSchedule.value = med.schedule || "";
  eStock.value = Number(med.stock||0);
  eLow.value = Number(med.lowStock||0);
  eNote.value = med.note || "";

  editMedModalWrap.classList.add("show");
}
function closeEditMedModal(){
  editMedModalWrap.classList.remove("show");
  editingMedId = null;
}
editMedClose.onclick = closeEditMedModal;
editMedCancel.onclick = closeEditMedModal;
editMedModalWrap.onclick = (e)=>{ if(e.target === editMedModalWrap) closeEditMedModal(); };

editMedSave.onclick = ()=>{
  const med = getMed(editingMedId);
  if(!med) return;

  const name = eName.value.trim();
  if(!name) return;

  med.name = name;
  med.spec = eSpec.value.trim();
  med.dose = eDose.value.trim();
  med.timesPerDay = parseInt(eTimes.value,10) || 1;
  med.schedule = eSchedule.value.trim();
  med.stock = Number(eStock.value||0);
  med.lowStock = Number(eLow.value||0);
  med.note = eNote.value.trim();

  saveState();
  closeEditMedModal();
  renderAll();
};

editMedDelete.onclick = ()=>{
  const med = getMed(editingMedId);
  if(!med) return;

  state.meds = state.meds.filter(x=>x.id!==editingMedId);
  saveState();
  closeEditMedModal();
  renderAll();
};

function renderMeds(){
  medList.innerHTML = "";
  if(state.meds.length===0){
    medList.innerHTML = `<div class="muted">è¯ç®±ä¸ºç©ºã€‚</div>`;
    return;
  }
  state.meds.forEach(m=>{
    const stock = Number(m.stock||0);
    const low = Number(m.lowStock||0);
    const lowTag = stock<=low ? ` <span class="stateTag warn">ä½åº“å­˜</span>` : "";
    const el = document.createElement("div");
    el.className = "item";
    el.innerHTML = `
      <div class="itemTop">
        <div class="name">${m.name}${lowTag}</div>
        <div class="row" style="gap:8px;">
          <button class="btn secondary" data-edit="${m.id}" style="padding:8px 12px;">ç¼–è¾‘</button>
        </div>
      </div>
      <div class="small">
        è§„æ ¼ï¼š${m.spec||"â€”"}ã€€ç”¨é‡ï¼š${m.dose||"â€”"}ã€€æ¬¡æ•°ï¼š${m.timesPerDay||1}/å¤©<br/>
        æ—¶é—´ï¼š${m.schedule||"â€”"}ã€€åº“å­˜ï¼š${stock}ï¼ˆæé†’â‰¤${low}ï¼‰<br/>
        å¤‡æ³¨ï¼š${m.note||"â€”"}
      </div>
    `;
    medList.appendChild(el);
  });

  medList.querySelectorAll("button[data-edit]").forEach(btn=>{
    btn.onclick = ()=>{
      const id = btn.getAttribute("data-edit");
      openEditMedModal(id);
    };
  });
}

/* =========================
   Backup
   ========================= */
const btnExport = document.getElementById("btnExport");
const btnImport = document.getElementById("btnImport");
const btnReset  = document.getElementById("btnReset");
const backupBox = document.getElementById("backupBox");

btnExport.onclick = ()=>{ backupBox.value = JSON.stringify(state, null, 2); };
btnImport.onclick = ()=>{
  try{
    const obj = JSON.parse(backupBox.value);
    if(!obj || typeof obj !== "object") return;
    if(!obj.meds || !obj.records) return;
    localStorage.setItem(STORE_KEY, JSON.stringify(obj));
    location.reload();
  }catch{}
};
btnReset.onclick = ()=>{
  localStorage.removeItem(STORE_KEY);
  location.reload();
};

/* =========================
   Calendar
   ========================= */
const calendarEl = document.getElementById("calendar");
const dowRow = document.getElementById("dowRow");
const statHint = document.getElementById("statHint");
const overview = document.getElementById("overview");
const monthLabel = document.getElementById("monthLabel");
const prevMonthBtn = document.getElementById("prevMonth");
const nextMonthBtn = document.getElementById("nextMonth");

const DOW = ["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"];
dowRow.innerHTML = DOW.map(x=>`<div class="dow">${x}</div>`).join("");

let calYear = new Date().getFullYear();
let calMonth = new Date().getMonth();

prevMonthBtn.onclick = ()=>{
  calMonth -= 1;
  if(calMonth<0){ calMonth=11; calYear -= 1; }
  renderCalendar();
  renderOverview();
};
nextMonthBtn.onclick = ()=>{
  calMonth += 1;
  if(calMonth>11){ calMonth=0; calYear += 1; }
  renderCalendar();
  renderOverview();
};

function renderCalendar(){
  calendarEl.innerHTML = "";
  const first = new Date(calYear, calMonth, 1);
  const last  = new Date(calYear, calMonth+1, 0);
  const daysInMonth = last.getDate();
  const startDow = first.getDay();

  monthLabel.textContent = `${calYear}-${String(calMonth+1).padStart(2,"0")}`;

  for(let i=0;i<startDow;i++){
    const pad = document.createElement("div");
    pad.className="day";
    pad.style.opacity=".25";
    pad.textContent="";
    calendarEl.appendChild(pad);
  }

  for(let d=1; d<=daysInMonth; d++){
    const date = new Date(calYear, calMonth, d);
    const key = isoDateKey(date);

    const rec = state.records[key];
    let cls = "day";
    if(rec){
      const sum = rec.summary || {};
      if(sum.allTaken) cls += " done";
      else if(sum.miss) cls += " miss";
      else cls += " has";
    }
    if(key===currentDateKey) cls += " active";
    if(key===todayKey) cls += " today";

    const cell = document.createElement("div");
    cell.className = cls;
    cell.textContent = d;

    cell.onclick = ()=>{
      currentDateKey = key;
      buildPlanForDate(key);
      setTab("today");
      renderAll();
    };

    calendarEl.appendChild(cell);
  }

  statHint.textContent = `ç‚¹æ—¥æœŸå¯è¡¥å½•ï¼ˆæ”¯æŒåˆ‡æœˆï¼‰ã€‚ä»Šå¤©ï¼š${todayKey}`;
}

function renderOverview(){
  const last = new Date(calYear, calMonth+1, 0);
  const daysInMonth = last.getDate();

  let has=0, done=0, miss=0;
  for(let d=1; d<=daysInMonth; d++){
    const key = isoDateKey(new Date(calYear, calMonth, d));
    const rec = state.records[key];
    if(!rec) continue;
    has++;
    const sum = rec.summary || {};
    if(sum.allTaken) done++;
    else if(sum.miss) miss++;
  }

  overview.innerHTML = `
    <div class="item">
      <div class="itemTop">
        <div class="name">æœ¬æœˆè®°å½•æ¦‚è§ˆ</div>
        <div class="pill">ğŸ“Š</div>
      </div>
      <div class="small">
        æœ‰è®°å½•ï¼š${has} å¤©<br/>
        âœ… å®Œæˆï¼š${done} å¤©<br/>
        âš ï¸ éƒ¨åˆ†å®Œæˆï¼š${miss} å¤©<br/>
        ç©ºç™½ï¼š${daysInMonth - has} å¤©
      </div>
    </div>
    <div class="item">
      <div class="itemTop">
        <div class="name">è¡¥å½•æœºåˆ¶ï¼ˆæ›´å®‰å¿ƒï¼‰</div>
        <div class="pill">ğŸ§¾</div>
      </div>
      <div class="small">
        è¡¥å½•æ‰“å¡å‰ä¼šå¼¹â€œè¡¥å½•ç¡®è®¤â€ï¼šå¯é€‰æ˜¯å¦æ‰£åº“å­˜ + å¯è®°å½•åŸå› ã€‚ç¡®è®¤åæ‰å†™å…¥è®°å½•ï¼Œå‡å°‘è¯¯è§¦ã€‚
      </div>
    </div>
  `;
}

/* =========================
   Render
   ========================= */
function renderAll(){
  renderToday();
  renderMeds();
  renderCalendar();
  renderOverview();
}
renderAll();
</script>
</body>
</html>

